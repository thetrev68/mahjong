const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/card_test-BH-34wbo.js","assets/gameObjects-CDMaLxcg.js","assets/card_test-CNIz-Hj2.js","assets/card_test-B4nm8qRs.js","assets/card_test-DNrFuv2T.js"])))=>i.map(i=>d[i]);
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const o of r.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=t(s);fetch(s.href,r)}})();function Ce(c){const e=window.document.getElementById("messages");if(!e)return;const t=c.endsWith(`
`)?c:`${c}
`;e.value+=t,e.scrollTop=e.scrollHeight}function Ie(c){const e=window.document.getElementById("info");e.value=c}let D=function(){},Q=function(){};function De(c){const e=window.document.getElementById("hint-content");e.innerHTML=c}const R={cardYear:2025,useBlankTiles:!1,difficulty:"medium",trainingMode:!1,trainingHand:"",trainingTileCount:9,skipCharleston:!1,bgmVolume:20,bgmMuted:!1,sfxVolume:20,sfxMuted:!1},v="mahjong_";class Re{static load(){const e={};for(const[t,n]of Object.entries(R)){const s=v+t,r=localStorage.getItem(s);r===null?e[t]=n:e[t]=this.parseValue(r,typeof n)}return e}static save(e){for(const[t,n]of Object.entries(e)){if(!(t in R)){console.warn(`Unknown setting key: ${t}`);continue}const s=v+t;localStorage.setItem(s,String(n))}console.log("Settings saved:",e)}static get(e){if(!(e in R)){console.warn(`Unknown setting key: ${e}`);return}const t=v+e,n=localStorage.getItem(t);return n===null?R[e]:this.parseValue(n,typeof R[e])}static set(e,t){if(!(e in R)){console.warn(`Unknown setting key: ${e}`);return}const n=typeof R[e],s=typeof t;if(s!==n){console.error(`Type mismatch for ${e}: expected ${n}, got ${s}`);return}const r=v+e;localStorage.setItem(r,String(t)),console.log(`Setting updated: ${e} = ${t}`)}static reset(){for(const e of Object.keys(R)){const t=v+e;localStorage.removeItem(t)}console.log("Settings reset to defaults")}static getDefault(e){return R[e]}static getDefaults(){return{...R}}static parseValue(e,t){switch(t){case"number":return parseInt(e,10);case"boolean":return e==="true";case"string":return e;default:return console.warn(`Unknown type: ${t}`),e}}static isAvailable(){try{const e="__storage_test__";return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch(e){return console.error("localStorage is not available:",e),!1}}static exportJSON(){const e=this.load();return JSON.stringify(e,null,2)}static importJSON(e){try{const t=JSON.parse(e);for(const n of Object.keys(t))if(!(n in R))return console.error(`Invalid setting key in import: ${n}`),!1;return this.save(t),!0}catch(t){return console.error("Failed to import settings:",t),!1}}static subscribe(e,t){const n=s=>{if(s.key===v+e){const r=this.parseValue(s.newValue,typeof R[e]);t(r)}};return window.addEventListener("storage",n),()=>{window.removeEventListener("storage",n)}}}const Ne=648,we=1052,be=69,xe=52,Pe=.75,ke=4,y={INIT:0,START:1,DEAL:2,CHARLESTON1:3,CHARLESTON_QUERY:4,CHARLESTON2:6,COURTESY_QUERY:7,COURTESY:9,COURTESY_COMPLETE:10,LOOP_PICK_FROM_WALL:11,LOOP_CHOOSE_DISCARD:12,LOOP_QUERY_CLAIM_DISCARD:13,LOOP_EXPOSE_TILES:15,LOOP_EXPOSE_TILES_COMPLETE:16,END:17},H={EXPOSE_TILES:0,DISCARD_TILE:1,MAHJONG:2},g={BOTTOM:0,RIGHT:1,TOP:2,LEFT:3},i={CRACK:0,BAM:1,DOT:2,WIND:3,DRAGON:4,FLOWER:5,JOKER:6,BLANK:7,VSUIT1:8,VSUIT2:9,VSUIT3:10,VSUIT1_DRAGON:11,VSUIT2_DRAGON:12,VSUIT3_DRAGON:13,INVALID:99},C={CONSECUTIVE1:10,CONSECUTIVE2:11,CONSECUTIVE3:12,CONSECUTIVE4:13,CONSECUTIVE5:14,CONSECUTIVE6:15,CONSECUTIVE7:16,INVALID:99},P={NORTH:0,SOUTH:1,WEST:2,EAST:3},M={RED:0,GREEN:1,WHITE:2};function _e(){return!window.settingsManager||typeof window.settingsManager.getUseBlankTiles!="function"?152:window.settingsManager.getUseBlankTiles()?160:152}class X{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{const n=this.listeners.get(e);if(!n||n.length===0)return;const s=n.indexOf(t);s>-1&&(n.splice(s,1),n.length===0&&this.listeners.delete(e))}}once(e,t){const n=this.on(e,s=>{n(),t(s)})}emit(e,t){const n=this.listeners.get(e);n&&n.slice().forEach(s=>{try{s(t)}catch(r){console.error(`Error in event handler for ${e}:`,r)}})}off(e){this.listeners.delete(e)}clear(){this.listeners.clear()}}const q=[{suit:i.CRACK,textArray:["Crack"],prefix:["C"],maxNum:9,count:4},{suit:i.BAM,textArray:["Bam"],prefix:["B"],maxNum:9,count:4},{suit:i.DOT,textArray:["Dot"],prefix:["D"],maxNum:9,count:4},{suit:i.WIND,textArray:["North","South","West","East"],prefix:["N","S","W","E"],maxNum:1,count:4},{suit:i.DRAGON,textArray:["Red dragon","Green dragon","White dragon"],prefix:["DC","DB","DD"],maxNum:1,count:4},{suit:i.FLOWER,textArray:["Flower"],prefix:["F1","F2","F3","F4","F1","F2","F3","F4"],maxNum:1,count:1},{suit:i.JOKER,textArray:["Joker"],prefix:["J"],maxNum:1,count:8},{suit:i.BLANK,textArray:["Blank"],prefix:["BLANK"],maxNum:1,count:8}];class O{constructor(e,t,n=-1){this.suit=e,this.number=t,this.index=n}getText(){for(const e of q)if(e.suit===this.suit){if(this.suit<=i.DOT)return`${e.textArray[0]} ${this.number}`;if(this.suit===i.WIND)return`${e.textArray[this.number]} wind`;if(this.suit===i.DRAGON)return`${e.textArray[this.number]}`;if(this.suit===i.FLOWER)return`${e.textArray[0]} ${this.number+1}`;if(this.suit===i.JOKER)return"Joker";if(this.suit===i.BLANK)return"Blank"}return this.suit===i.INVALID?"Invalid":`Unknown tile (${this.suit}:${this.number})`}equals(e){return e?this.suit===e.suit&&this.number===e.number:!1}isSameTile(e){return e?this.index===e.index:!1}clone(){return new O(this.suit,this.number,this.index)}isJoker(){return this.suit===i.JOKER}isBlank(){return this.suit===i.BLANK}isFlower(){return this.suit===i.FLOWER}isWind(){return this.suit===i.WIND}isDragon(){return this.suit===i.DRAGON}isNumberedSuit(){return this.suit>=i.CRACK&&this.suit<=i.DOT}isInvalid(){return this.suit===i.INVALID}static fromPhaserTile(e){return new O(e.suit,e.number,e.index)}toJSON(){return{suit:this.suit,number:this.number,index:this.index}}static fromJSON(e){return new O(e.suit,e.number,e.index)}}class _{constructor(){this.tiles=[],this.exposures=[]}get exposedTileSetArray(){return this.exposures}getLength(){const e=this.exposures.reduce((t,n)=>t+n.tiles.length,0);return this.tiles.length+e}getHiddenCount(){return this.tiles.length}getHiddenTileArray(){return this.tiles}getTileArray(){return this.tiles}getAllTilesIncludingExposures(){const e=[...this.tiles];return this.exposures.forEach(t=>{e.push(...t.tiles)}),e}addTile(e){this.tiles.push(e)}removeTile(e){const t=this.tiles.findIndex(n=>n.isSameTile(e));return t!==-1?(this.tiles.splice(t,1),!0):!1}addExposure(e){this.exposures.push(e)}hasTile(e){return this.tiles.some(t=>t.equals(e))}isAllHidden(){return this.exposures.length===0}countTile(e,t){return this.tiles.filter(n=>n.suit===e&&n.number===t).length}sortBySuit(){this.tiles.sort((e,t)=>e.suit!==t.suit?e.suit-t.suit:e.number-t.number)}sortByRank(){this.tiles.sort((e,t)=>e.number!==t.number?e.number-t.number:e.suit-t.suit)}clear(){this.tiles=[],this.exposures=[]}clone(){const e=new _;return e.tiles=this.tiles.map(t=>t.clone()),e.exposures=this.exposures.map(t=>t.clone()),e}static fromPhaserHand(e){const t=new _,n=e.getHiddenTileArray();return t.tiles=n.map(s=>O.fromPhaserTile(s)),e.exposedTileSetArray.forEach(s=>{const r=new L;r.type=z(s.tileArray.length),r.tiles=s.tileArray.map(o=>O.fromPhaserTile(o)),t.exposures.push(r)}),t}toJSON(){return{tiles:this.tiles.map(e=>e.toJSON()),exposures:this.exposures.map(e=>e.toJSON())}}static fromJSON(e){const t=new _;return t.tiles=e.tiles.map(n=>O.fromJSON(n)),t.exposures=e.exposures.map(n=>L.fromJSON(n)),t}}class L{constructor(e={}){this.type=e.type||"",this.tiles=e.tiles||[]}clone(){const e=new L;return e.type=this.type,e.tiles=this.tiles.map(t=>t.clone()),e}toJSON(){return{type:this.type,tiles:this.tiles.map(e=>e.toJSON())}}get tileArray(){return this.tiles}getTileArray(){return this.tiles}getLength(){return this.tiles.length}static fromJSON(e){const t=new L;return t.type=e.type,t.tiles=e.tiles.map(n=>O.fromJSON(n)),t}}function z(c){return c===3?"PUNG":c===4?"KONG":c===5?"QUINT":"UNKNOWN"}class k{constructor(e,t=""){this.position=e,this.name=t||this.getDefaultName(),this.hand=new _,this.isHuman=e===g.BOTTOM,this.isCurrentTurn=!1,this.wind=""}getDefaultName(){return["You","Opponent 1","Opponent 2","Opponent 3"][this.position]||`Player ${this.position+1}`}clone(){const e=new k(this.position,this.name);return e.hand=this.hand.clone(),e.isHuman=this.isHuman,e.isCurrentTurn=this.isCurrentTurn,e.wind=this.wind,e}static fromPhaserPlayer(e){const t=new k(e.playerInfo.playerNum,e.playerInfo.name);return t.hand=_.fromPhaserHand(e.hand),t.wind=e.playerInfo.wind,t}toJSON(){return{position:this.position,name:this.name,hand:this.hand.toJSON(),isHuman:this.isHuman,isCurrentTurn:this.isCurrentTurn,wind:this.wind}}static fromJSON(e){const t=new k(e.position,e.name);return t.hand=_.fromJSON(e.hand),t.isHuman=e.isHuman,t.isCurrentTurn=e.isCurrentTurn,t.wind=e.wind,t}}function Z(c,e){return{type:"STATE_CHANGED",oldState:c,newState:e,timestamp:Date.now()}}function ee(c){return{type:"GAME_STARTED",players:c,timestamp:Date.now()}}function te(c=[]){return{type:"TILES_DEALT",sequence:c,timestamp:Date.now()}}function ne(c,e,t={}){return{type:"TILE_DRAWN",player:c,tile:e,animation:{type:t.type||"deal-slide",fromPosition:t.fromPosition||{x:640,y:360},toPosition:t.toPosition||{x:450,y:575},duration:t.duration||400,easing:t.easing||"Quad.easeOut",...t},timestamp:Date.now()}}function se(c,e,t={}){return{type:"TILE_DISCARDED",player:c,tile:e,animation:{type:t.type||"discard-slide",fromPosition:t.fromPosition||{x:450,y:575},toPosition:t.toPosition||{x:350,y:420},duration:t.duration||300,easing:t.easing||"Power2.easeInOut",glow:t.glow||{color:1981066,alpha:.9},...t},timestamp:Date.now()}}function re(c,e,t,n){return{type:"BLANK_EXCHANGED",player:c,blankTile:e,retrievedTile:t,discardIndex:n,timestamp:Date.now()}}function N(c,e){return{type:"HAND_UPDATED",player:c,hand:e,timestamp:Date.now()}}function K(c,e){return{type:"TURN_CHANGED",currentPlayer:c,previousPlayer:e,timestamp:Date.now()}}function ie(c,e,t){return{type:"CHARLESTON_PHASE",phase:c,passCount:e,direction:t,timestamp:Date.now()}}function oe(c,e,t,n,s={}){const o={right:1,across:2,left:3}[t]||1;return{type:"CHARLESTON_PASS",fromPlayer:c,toPlayer:e,direction:t,tiles:n,animation:{type:s.type||"pass-tiles",direction:s.direction||t,duration:s.duration||500,easing:s.easing||"Sine.easeInOut",offset:o,...s},timestamp:Date.now()}}function ae(c,e){return{type:"COURTESY_VOTE",player:c,vote:e,timestamp:Date.now()}}function le(c,e,t,n={}){return{type:"COURTESY_PASS",fromPlayer:c,toPlayer:e,tiles:t,animation:{type:n.type||"courtesy-exchange",duration:n.duration||600,easing:n.easing||"Sine.easeInOut",glow:n.glow||{color:2003199,alpha:.7},...n},timestamp:Date.now()}}function J(c,e,t,n={}){return{type:"TILES_RECEIVED",player:c,fromPlayer:t,tiles:e,animation:{type:n.type||"receive-tiles",duration:n.duration||400,easing:n.easing||"Power2.easeOut",glow:n.glow||{color:2003199,alpha:.7},...n},timestamp:Date.now()}}function ce(c,e,t){return{type:"DISCARD_CLAIMED",claimingPlayer:c,tile:e,claimType:t,timestamp:Date.now()}}function ue(c,e,t,n={}){return{type:"TILES_EXPOSED",player:c,exposureType:e,tiles:t,animation:{type:n.type||"expose-tiles",duration:n.duration||300,easing:n.easing||"Power2.easeOut",effect:n.effect||"highlight",...n},timestamp:Date.now()}}function he(c,e,t){return{type:"GAME_ENDED",reason:c,winner:e,mahjong:t,timestamp:Date.now()}}function I(c,e="info"){return{type:"MESSAGE",text:c,messageType:e,timestamp:Date.now()}}const $={1:["right","across","left"],2:["left","across","right"]},de={right:g.RIGHT,across:g.TOP,left:g.LEFT},fe=[[g.BOTTOM,4],[g.RIGHT,4],[g.TOP,4],[g.LEFT,4],[g.BOTTOM,4],[g.RIGHT,4],[g.TOP,4],[g.LEFT,4],[g.BOTTOM,4],[g.RIGHT,4],[g.TOP,4],[g.LEFT,4],[g.BOTTOM,1],[g.RIGHT,1],[g.TOP,1],[g.LEFT,1],[g.BOTTOM,1]];class ve extends X{constructor(){super(),this.state=y.INIT,this.players=[],this.wallTiles=[],this.discards=[],this.currentPlayer=0,this.settings={year:2025,difficulty:"medium",useBlankTiles:!1,skipCharleston:!1},this.debug=!1,this.charlestonState={phase:0,passCount:0,continueToPhase2:!1,courtesyVotes:[]},this.gameResult={mahjong:!1,winner:-1,winningHand:null},this.aiEngine=null,this.cardValidator=null,this.wallGenerator=null}init(e={}){this.aiEngine=e.aiEngine,this.cardValidator=e.cardValidator,this.wallGenerator=e.wallGenerator||null,e.settings&&(this.settings={...this.settings,...e.settings}),this.players=[new k(g.BOTTOM,"You"),new k(g.RIGHT,"Bot Bob"),new k(g.TOP,"Sally Bot"),new k(g.LEFT,"Stephen Bot")],this.assignPlayerWinds();const t=I(`Game initialized with ${this.settings.year} card`,"info");this.emit("MESSAGE",t)}assignPlayerWinds(){const e={[g.BOTTOM]:P.EAST,[g.RIGHT]:P.NORTH,[g.TOP]:P.WEST,[g.LEFT]:P.SOUTH};Object.entries(e).forEach(([t,n])=>{const s=this.players[t];s&&(s.wind=n)})}async startGame(){if(this.state!==y.INIT&&this.state!==y.END){console.warn("GameController: startGame called while game in progress, ignoring");return}this.setState(y.START),this.gameResult={mahjong:!1,winner:-1,winningHand:null},this.charlestonState={phase:0,passCount:0,continueToPhase2:!1,courtesyVotes:[]},this.discards=[],this.currentPlayer=g.BOTTOM,this.players.forEach(t=>t.hand.clear()),this.createWall();const e=ee(this.players.map(t=>t.toJSON()));this.emit("GAME_STARTED",e),await this.dealTiles(),this.settings.skipCharleston?await this.gameLoop():await this.charlestonPhase()}createWall(){const e=this.wallGenerator?this.wallGenerator():me(this.settings.useBlankTiles);if(!Array.isArray(e)||e.length===0)throw new Error("Failed to generate wall tiles. Wall generator returned empty set.");const t=e.map((n,s)=>U(n,s));this.wallTiles=pe(t),this.emit("WALL_CREATED",{tileCount:this.wallTiles.length}),this.emit("MESSAGE",{text:`Wall created with ${this.wallTiles.length} tiles`,type:"info"})}dealTiles(){this.setState(y.DEAL);const e=this.buildInitialDealSequence(),t=te(e);return this.emit("TILES_DEALT",t),new Promise(n=>{let s=null,r=!1;const o=()=>{r||(r=!0,s!==null&&clearTimeout(s),this.players.forEach((a,l)=>{const f=N(l,a.hand.toJSON());this.emit("HAND_UPDATED",f)}),n())};this.once("DEALING_COMPLETE",o),s=setTimeout(()=>{this.off("DEALING_COMPLETE",o),o()},3e4)})}buildInitialDealSequence(){const e=[];for(const[t,n]of fe){const s=[],r=this.players[t];for(let o=0;o<n;o++){const a=this.drawTileFromWall();r.hand.addTile(a),s.push(a.toJSON())}r.hand.sortBySuit(),e.push({player:t,tiles:s})}return e}async charlestonPhase(){if(this.settings.skipCharleston){await this.gameLoop();return}this.charlestonState.phase=1,await this.executeCharlestonPasses(1),this.setState(y.CHARLESTON_QUERY),await this.queryCharlestonContinue()&&(this.charlestonState.phase=2,await this.executeCharlestonPasses(2)),await this.courtesyPhase(),await this.gameLoop()}async executeCharlestonPasses(e){const t=$[e]||$[1];for(let n=0;n<t.length;n++){const s=t[n],r=de[s];if(typeof r!="number")continue;this.setState(e===1?y.CHARLESTON1:y.CHARLESTON2);const o=ie(e,n+1,s);this.emit("CHARLESTON_PHASE",o);const a=[];for(let l=0;l<4;l++){const f=this.players[l];let u;f.isHuman?u=await this.promptUI("CHARLESTON_PASS",{direction:s,requiredCount:3}):u=await this.aiEngine.charlestonPass(f.hand),u.forEach(p=>f.hand.removeTile(p)),(this.debug||typeof process<"u"&&!1)&&console.log(`[GameController] Player ${l} removed ${u.length} tiles, hand now has ${f.hand.tiles.length} tiles`),a[l]=u;const d=N(l,this.players[l].hand.toJSON());this.emit("HAND_UPDATED",d);const m=(l+r)%4,h=oe(l,m,s,u.map(p=>({suit:p.suit,number:p.number})),{type:"charleston-pass",direction:s,duration:600,easing:"ease-in-out"});this.emit("CHARLESTON_PASS",h)}for(let l=0;l<4;l++){const f=l,u=(l+r)%4;a[f].forEach(p=>{this.players[u].hand.addTile(p)}),(this.debug||typeof process<"u"&&!1)&&console.log(`[GameController] Player ${u} received ${a[f].length} tiles, hand now has ${this.players[u].hand.tiles.length} tiles`);const d=a[f].map(p=>({suit:p.suit,number:p.number})),m=J(u,d,f,{type:"charleston-receive",direction:s,duration:600,glow:{persist:!0,color:2003199}});this.emit("TILES_RECEIVED",m);const h=N(u,this.players[u].hand.toJSON());this.emit("HAND_UPDATED",h)}await this.sleep(500)}}async queryCharlestonContinue(){const e=await this.promptUI("CHARLESTON_CONTINUE",{question:"Continue Charleston to phase 2?",options:["Yes","No"]}),t=this.players.filter(a=>!a.isHuman).map(a=>this.aiEngine.charlestonContinueVote(a.hand)),n=[e==="Yes",...t],s=n.filter(a=>a).length,r=n.filter(a=>!a).length,o=s===4;if(o){const a=I("All players voted YES - continuing to Charleston phase 2","info");this.emit("MESSAGE",a)}else{const a=I(`Vote: ${s} Yes, ${r} No - skipping Charleston phase 2`,"info");this.emit("MESSAGE",a)}return o}async courtesyPhase(){this.setState(y.COURTESY_QUERY);const e=[];for(const n of this.players){let s;if(n.isHuman){const o=await this.promptUI("COURTESY_VOTE",{question:"Courtesy Pass: How many tiles to exchange with opposite player?",options:["0","1","2","3"]});s=parseInt(o,10),(isNaN(s)||s<0||s>3)&&(s=0)}else s=await this.aiEngine.courtesyVote(n.hand);e.push({player:n.position,vote:s});const r=ae(n.position,s);this.emit("COURTESY_VOTE",r)}if(e.filter(n=>n.vote>0).length>=2){this.setState(y.COURTESY);const n=Math.min(e[0].vote,e[2].vote),s=Math.min(e[1].vote,e[3].vote);if(n>0||s>0){const r=I(`Courtesy pass approved. P0-P2 pass ${n}, P1-P3 pass ${s}.`,"info");this.emit("MESSAGE",r);const o=[];for(let l=0;l<4;l++){const f=this.players[l],u=l===0||l===2?n:s;if(u===0){o[l]=[];continue}let d;f.isHuman?d=await this.promptUI("SELECT_TILES",{question:`Select 1â€“${u} tile(s) to pass to opposite player`,minTiles:1,maxTiles:u}):d=await this.aiEngine.courtesyPass(f.hand,u),o[l]=d,d.forEach(p=>f.hand.removeTile(p));const m=(l+2)%4,h=le(l,m,d.map(p=>({suit:p.suit,number:p.number})),{duration:500});this.emit("COURTESY_PASS",h)}for(let l=0;l<4;l++){const f=(l+2)%4,u=o[f];if(u.forEach(d=>this.players[l].hand.addTile(d)),u.length>0){const d=J(l,u.map(m=>({suit:m.suit,number:m.number})),f,{duration:500});this.emit("TILES_RECEIVED",d)}}this.players.forEach(l=>l.hand.sortBySuit()),this.players.forEach((l,f)=>{const u=N(f,l.hand.toJSON());this.emit("HAND_UPDATED",u)});const a=I("Courtesy pass complete.","info");this.emit("MESSAGE",a)}else{const r=I("Courtesy pass skipped (opposite players must both agree).","info");this.emit("MESSAGE",r)}await this.sleep(1e3)}this.setState(y.COURTESY_COMPLETE)}async gameLoop(){for(this.setState(y.LOOP_PICK_FROM_WALL);this.state!==y.END&&this.wallTiles.length>0;){if(this.shouldDrawTile()&&(await this.pickFromWall(),this.checkMahjong())){this.endGame("mahjong");return}await this.chooseDiscard();const e=await this.queryClaimDiscard();if(e.claimed){if(this.handleDiscardClaim(e),this.gameResult.mahjong)return;await this.chooseDiscard()}else this.advanceTurn()}this.wallTiles.length===0&&!this.gameResult.mahjong&&this.endGame("wall_game")}drawTileFromWall(){if(this.wallTiles.length===0)throw new Error("Attempted to draw from an empty wall");return this.wallTiles.pop()}shouldDrawTile(){const e=this.players[this.currentPlayer];return!e||!e.hand?!1:e.hand.getLength()===13}canPlayerFormExposure(e,t){if(!e||!e.hand)return!1;const n=e.hand.tiles||[];if(n.length===0)return!1;const s=n.filter(o=>o.suit===t.suit&&o.number===t.number).length,r=n.filter(o=>o.isJoker()).length;return s+r>=2}canPlayerMahjongWithTile(e,t){if(!this.cardValidator||!e||!e.hand)return!1;const n=e.hand.clone(),s=t.clone?t.clone():new O(t.suit,t.number,t.index);n.addTile(s);const r=n.tiles,o=n.exposures.length===0;try{const a=this.cardValidator.validateHand(r,o);return!!(a&&a.valid)}catch(a){return console.error("Failed to validate hand for Mahjong check:",a),!1}}async pickFromWall(){if(this.setState(y.LOOP_PICK_FROM_WALL),this.wallTiles.length===0)return;const e=this.players[this.currentPlayer],t=this.drawTileFromWall();e.hand.addTile(t),e.hand.sortBySuit();const n=ne(this.currentPlayer,t.toJSON(),{type:"wall-draw",duration:300,easing:"Quad.easeOut"});this.emit("TILE_DRAWN",n);const s=N(this.currentPlayer,e.hand.toJSON());this.emit("HAND_UPDATED",s),await this.sleep(300)}async chooseDiscard(){this.setState(y.LOOP_CHOOSE_DISCARD);const e=this.players[this.currentPlayer];let t;if(e.isHuman?t=await this.promptUI("CHOOSE_DISCARD",{hand:e.hand.toJSON()}):t=await this.aiEngine.chooseDiscard(e.hand),!t&&(console.error("chooseDiscard: No tile returned, falling back to first tile",{playerIndex:this.currentPlayer}),t=e.hand.tiles[0],!t))throw new Error("chooseDiscard: Player hand is empty, cannot discard");const n=e.hand.tiles.findIndex(f=>f.isSameTile(t));e.hand.removeTile(t)||console.error("chooseDiscard: Failed to remove tile from hand",{playerIndex:this.currentPlayer,tile:t}),this.discards.push(t);const r={suit:t.suit,number:t.number,index:t.index},o={type:"discard-arc",duration:this.currentPlayer===0?300:200,easing:"ease-out",rotation:this.currentPlayer===0?360:180};n>=0&&(o.tileIndex=n);const a=se(this.currentPlayer,r,o);this.emit("TILE_DISCARDED",a);const l=N(this.currentPlayer,e.hand.toJSON());this.emit("HAND_UPDATED",l),await this.sleep(500)}async queryClaimDiscard(){this.setState(y.LOOP_QUERY_CLAIM_DISCARD);const e=this.discards[this.discards.length-1];if(!e||e.isJoker()||e.isBlank())return{claimed:!1};for(let t=1;t<=3;t++){const n=(this.currentPlayer+t)%4,s=this.players[n];let r;if(s.isHuman){const o=this.canPlayerFormExposure(s,e),a=this.canPlayerMahjongWithTile(s,e);if(!o&&!a)continue;r=await this.promptUI("CLAIM_DISCARD",{tile:e.toJSON(),options:["Mahjong","Pung","Kong","Pass"]})}else{const o=await this.aiEngine.claimDiscard(e,n,s.hand);if(o.playerOption===H.MAHJONG)r="Mahjong";else if(o.playerOption===H.EXPOSE_TILES){const a=o.tileArray.length;a===3?r="Pung":a===4?r="Kong":a===5&&(r="Quint")}else r="Pass"}if(r!=="Pass")return{claimed:!0,player:n,claimType:r}}return{claimed:!1}}exchangeBlankWithDiscard(e,t){if(!this.settings.useBlankTiles)throw new Error("Blank exchange is disabled (house rule off)");if(this.state!==y.LOOP_CHOOSE_DISCARD)throw new Error("Blank exchange only allowed during discard selection");const n=this.players[g.BOTTOM];if(!n||!n.isHuman)throw new Error("Blank exchange only available to human player");const s=U(e),r=U(t);if(!s.isBlank())throw new Error("Selected tile is not a blank");if(!n.hand.removeTile(s))throw new Error("Blank tile not found in hand");const a=this.discards.findIndex(h=>h.isSameTile(r));if(a===-1)throw new Error("Selected discard tile no longer available");if(this.discards[a].isJoker())throw new Error("Cannot exchange blank for a joker");const[f]=this.discards.splice(a,1);this.discards.push(s),n.hand.addTile(f),n.hand.sortBySuit();const u=re(g.BOTTOM,s.toJSON(),f.toJSON(),this.discards.length-1);this.emit("BLANK_EXCHANGED",u);const d=N(g.BOTTOM,n.hand.toJSON());this.emit("HAND_UPDATED",d);const m=I(`Blank exchanged for ${f.getText()} from discards.`,"info");return this.emit("MESSAGE",m),!0}handleDiscardClaim(e){const{player:t,claimType:n}=e,s=this.discards.pop(),r=this.players[t];if(n==="Mahjong"){this.gameResult.mahjong=!0,this.gameResult.winner=t,this.endGame("mahjong");return}r.hand.addTile(s);const o={suit:s.suit,number:s.number,index:s.index},a=ce(t,o,n);this.emit("DISCARD_CLAIMED",a),this.setState(y.LOOP_EXPOSE_TILES),this.exposeTiles(t,n,s),this.currentPlayer=t;const l=K(this.currentPlayer,(this.currentPlayer+3)%4);this.emit("TURN_CHANGED",l)}exposeTiles(e,t,n){const s=this.players[e],r=s.hand.tiles.filter(E=>E.equals(n)&&!E.isSameTile(n)),o=s.hand.tiles.filter(E=>E.isJoker()),a=t==="Pung"?2:t==="Kong"?3:4;if(r.length+o.length<a){console.warn("Exposure attempted without enough tiles",{playerIndex:e,exposureType:t,claimedTile:n}),this.setState(y.LOOP_EXPOSE_TILES_COMPLETE);return}s.hand.removeTile(n)||console.warn("Failed to remove claimed tile from hand during exposure",{playerIndex:e,claimedTile:n});const u=r.slice(0,Math.min(a,r.length)),d=a-u.length,m=o.slice(0,Math.max(0,d)),h=[n,...u,...m];[...u,...m].forEach(E=>{s.hand.removeTile(E)||console.warn("Failed to remove tile during exposure",{playerIndex:e,tile:E})});const p=new L({type:t.toUpperCase(),tiles:h});s.hand.addExposure(p);const T=ue(e,t,h.map(E=>({suit:E.suit,number:E.number,index:E.index})),{duration:300});this.emit("TILES_EXPOSED",T);const A=N(e,s.hand.toJSON());this.emit("HAND_UPDATED",A),this.setState(y.LOOP_EXPOSE_TILES_COMPLETE)}checkMahjong(){const e=this.players[this.currentPlayer];if(e.hand.getLength()!==14)return!1;if(this.cardValidator){const t=e.hand.tiles,n=e.hand.exposures.length===0,s=this.cardValidator.validateHand(t,n);if(s&&s.valid)return this.gameResult.mahjong=!0,this.gameResult.winner=this.currentPlayer,!0}return!1}advanceTurn(){const e=this.currentPlayer;this.currentPlayer=(this.currentPlayer+1)%4,this.players[e].isCurrentTurn=!1,this.players[this.currentPlayer].isCurrentTurn=!0;const t=K(this.currentPlayer,e);this.emit("TURN_CHANGED",t)}endGame(e){this.setState(y.END);const t=he(e,this.gameResult.winner,this.gameResult.mahjong);if(this.emit("GAME_ENDED",t),e==="mahjong"){const n=this.players[this.gameResult.winner],s=I(`${n.name} wins with Mahjong!`,"info");this.emit("MESSAGE",s)}else if(e==="wall_game"){const n=I("Wall game - no winner","info");this.emit("MESSAGE",n)}}setState(e){const t=this.state;this.state=e;const n=Z(t,e);this.emit("STATE_CHANGED",n)}onSortHandRequest(e="suit"){const t=this.players[g.BOTTOM];if(!t||!t.hand)return;e==="rank"?t.hand.sortByRank():t.hand.sortBySuit();const n=N(g.BOTTOM,t.hand.toJSON());this.emit("HAND_UPDATED",n)}onExchangeJoker(){const e=this.players[g.BOTTOM];if(!e||!e.hand)return!1;if([y.INIT,y.DEAL,y.CHARLESTON1,y.CHARLESTON2,y.CHARLESTON_QUERY,y.COURTESY_QUERY,y.COURTESY].includes(this.state))return this.emit("MESSAGE",I("Cannot exchange jokers during this phase","warning")),!1;const n=[];for(let h=0;h<4;h++)this.players[h].hand.exposures.forEach((T,A)=>{T.tiles.forEach((E,S)=>{E.suit===i.JOKER&&n.push({playerIndex:h,exposureIndex:A,tileIndex:S,jokerTile:E,requiredTiles:this.getRequiredTilesForJoker(T)})})});if(n.length===0)return this.emit("MESSAGE",I("No exposed jokers available","info")),!1;const s=n.filter(h=>h.requiredTiles.some(p=>e.hand.tiles.some(T=>T.suit===p.suit&&T.number===p.number)));if(s.length===0)return this.emit("MESSAGE",I("No matching tiles to exchange","info")),!1;const r=s[0],o=r.requiredTiles[0],a=e.hand.tiles.findIndex(h=>h.suit===o.suit&&h.number===o.number);if(a===-1)return!1;const l=e.hand.tiles[a],f=r.jokerTile;e.hand.removeTile(l),e.hand.addTile(f);const u=this.players[r.playerIndex];u.hand.exposures[r.exposureIndex].tiles[r.tileIndex]=l,this.emit("JOKER_SWAPPED",{player:r.playerIndex,exposureIndex:r.exposureIndex,jokerIndex:f.index,replacementTile:l,recipient:g.BOTTOM});const d=N(g.BOTTOM,e.hand.toJSON());this.emit("HAND_UPDATED",d);const m=N(r.playerIndex,u.hand.toJSON());return this.emit("HAND_UPDATED",m),this.emit("MESSAGE",I(`Exchanged ${l.getText()} for joker`,"info")),!0}getRequiredTilesForJoker(e){const t=e.tiles.filter(n=>n.suit!==i.JOKER);return t.length>0?[t[0]]:[]}promptUI(e,t){return new Promise(n=>{this.emit("UI_PROMPT",{promptType:e,options:t,callback:s=>n(s)})})}sleep(e){return new Promise(t=>setTimeout(t,e))}getGameState(){return{state:this.state,currentPlayer:this.currentPlayer,players:this.players.map(e=>e.toJSON()),wallCount:this.wallTiles.length,discardCount:this.discards.length,gameResult:this.gameResult}}}function U(c,e=-1){if(c instanceof O)return c.clone();if(c&&typeof c=="object"&&typeof c.suit=="number"){const t=typeof c.index=="number"?c.index:e;return new O(c.suit,c.number??0,t)}throw new Error("Wall generator produced invalid tile data")}function me(c=!1){const e=[];let t=0;for(const n of q){if(n.suit===i.BLANK&&!c)continue;const s=Array.isArray(n.prefix)?n.prefix:[n.prefix];for(const r of s)for(let o=1;o<=n.maxNum;o++){let a=o;n.maxNum===1&&(n.suit===i.FLOWER?a=0:a=s.indexOf(r));for(let l=0;l<n.count;l++)e.push(new O(n.suit,a,t++))}}return e}function pe(c){const e=c.slice();for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}const w={[i.VSUIT1]:"green",[i.VSUIT2]:"red",[i.VSUIT3]:"blue",[i.FLOWER]:"black",[i.VSUIT1_DRAGON]:"green",[i.VSUIT2_DRAGON]:"red",[i.VSUIT3_DRAGON]:"blue",[i.WIND]:"black",[i.DRAGON]:"blue",[i.JOKER]:"gray",[i.CRACK]:"red",[i.BAM]:"green",[i.DOT]:"blue"};function G(c,e=!1,t=null){if(c.suit===i.JOKER)return{char:"J",color:w[i.JOKER],tile:c};if(c.suit===i.FLOWER)return{char:"F",color:w[i.FLOWER],tile:c};if(c.suit===i.WIND)return{char:{[P.NORTH]:"N",[P.EAST]:"E",[P.SOUTH]:"S",[P.WEST]:"W"}[c.number]||"?",color:w[i.WIND],tile:c};if(c.suit===i.DRAGON||c.suit>=i.VSUIT1_DRAGON&&c.suit<=i.VSUIT3_DRAGON){if(c.suit===i.DRAGON&&c.number===M.WHITE)return{char:"0",color:"blue",tile:c};let n="blue";if(c.suit===i.DRAGON)n={[M.RED]:"red",[M.GREEN]:"green",[M.WHITE]:"blue"}[c.number]||"blue";else if(c.suit>=i.VSUIT1_DRAGON&&c.suit<=i.VSUIT3_DRAGON)if(t){const s=t[c.suit-i.VSUIT1_DRAGON];n=w[s]||"blue"}else{const s=c.suit-i.VSUIT1_DRAGON;n=["green","red","blue"][s]||"blue"}return{char:"D",color:n,tile:c}}if(c.number>=1&&c.number<=9){if(t&&c.suit>=i.VSUIT1&&c.suit<=i.VSUIT3){const n=t[c.suit-i.VSUIT1],s=w[n]||"blue";return{char:c.number.toString(),color:s,tile:c}}return{char:c.number.toString(),color:w[c.suit]||"blue",tile:c}}if(c.number>=C.CONSECUTIVE1&&c.number<=C.CONSECUTIVE7){const n=c.number-C.CONSECUTIVE1,s=e?2+n*2:1+n*2;if(t&&c.suit>=i.VSUIT1&&c.suit<=i.VSUIT3){const r=t[c.suit-i.VSUIT1],o=w[r]||"blue";return{char:s.toString(),color:o,tile:c}}return{char:s.toString(),color:w[c.suit]||"blue",tile:c}}return c.number===0?{char:"0",color:w[c.suit]||"gray",tile:c}:{char:"?",color:"gray",tile:c}}function W(c){const e=new Map;return c.forEach(t=>{const n=`${t.suit}-${t.number}`;e.set(n,(e.get(n)||0)+1)}),e}function ge(c,e,t,n,s=null,r=null,o=null){const a=W(e),l=new Map,u=(r?W(r):a).get(`${i.JOKER}-0`)||0;let d=0,m=0;return c.map((h,p)=>{let T;if(o&&h.number>=C.CONSECUTIVE1&&h.number<=C.CONSECUTIVE7){const V=o.get(h.number);if(V!==void 0){const Y={...h,number:V};T=G(Y,n,s)}else T=G(h,n,s)}else T=G(h,n,s);const A=`${h.suit}-${h.number}`,E=t[p];let S=!1;return(a.get(A)||0)-(l.get(A)||0)>0?(S=!0,l.set(A,(l.get(A)||0)+1),h.suit===i.JOKER&&d++):E>=3&&h.suit!==i.JOKER&&d+m<u&&(S=!0,m++,T.char="J",T.color="gray"),{...T,isMatched:S}})}const j={inverted:{red:"bg-red-600 text-white border border-red-700",green:"bg-green-600 text-white border border-green-700",blue:"bg-blue-600 text-white border border-blue-700",black:"bg-black text-white border border-gray-800",gray:"bg-gray-600 text-white border border-gray-700"},normal:{red:"bg-white text-red-600 border border-red-200",green:"bg-white text-green-600 border border-green-200",blue:"bg-white text-blue-600 border border-blue-200",black:"bg-white text-black border border-gray-300",gray:"bg-white text-gray-700 border border-gray-300"}};function Te(c,e=!0){const t="tile-char",n=e&&c.isMatched,s=c.color,r=n?j.inverted:j.normal,o=r[s]||r.gray;return`${t} ${o}`}function Le(c,e,t=null){const n=[],s=[],r=c.hand.even||!1,o=new Map;c.componentInfoArray.forEach(h=>{if(h.tileArray&&h.tileArray.length>0){const p=h.component.number;if(p>=C.CONSECUTIVE1&&p<=C.CONSECUTIVE7){const T=h.tileArray.find(A=>A.suit!==i.JOKER);if(T&&o.size===0){const A=p-C.CONSECUTIVE1,E=T.number-A;for(let S=0;S<7;S++)o.set(C.CONSECUTIVE1+S,E+S)}}}}),c.componentInfoArray.forEach((h,p)=>{const T=h.component.count,A=h.tileArray?h.tileArray.length:0;if(h.tileArray&&h.tileArray.length>0&&h.tileArray.forEach(E=>{n.push(E),s.push(T)}),A<T){const E={suit:h.component.suit||i.INVALID,number:h.component.number||0};for(let S=A;S<T;S++)n.push(E),s.push(T)}if(p<c.componentInfoArray.length-1){const E=c.componentInfoArray[p+1];h.component.count===1&&E.component.count===1||(n.push({isSpacer:!0}),s.push(0))}});const a=n.filter(h=>!h.isSpacer),l=s.filter((h,p)=>!n[p].isSpacer),f=ge(a,e,l,r,c.vsuitArray,t,o),u=[];let d=0;n.forEach(h=>{h.isSpacer?u.push({isSpacer:!0}):u.push(f[d++])});let m='<div class="pattern-row">';return u.forEach(h=>{h.isSpacer?m+='<span class="component-spacer"></span>':m+=`<span class="${Te(h)}">${h.char}</span>`}),m+="</div>",m}const b={KEEP:"KEEP",PASS:"PASS",DISCARD:"DISCARD"};class He{constructor(e,t,n="medium"){this.card=e,this.tableData=t,this.difficulty=n,this.config=this.getDifficultyConfig(n)}getDifficultyConfig(e){const t={easy:{maxPatterns:2,minDiscardable:5,exposureThreshold:70,courtesyThresholds:[55,65,75],charlestonContinueThreshold:.8,blankExchangeRank:999,blankExchangeGain:999,jokerTopHands:1,jokerRankThreshold:60,jokerScaling:.8,discardRandomness:.3},medium:{maxPatterns:5,minDiscardable:4,exposureThreshold:55,courtesyThresholds:[50,60,68],charlestonContinueThreshold:.65,blankExchangeRank:85,blankExchangeGain:25,jokerTopHands:2,jokerRankThreshold:55,jokerScaling:.9,discardRandomness:.1},hard:{maxPatterns:999,minDiscardable:3,exposureThreshold:45,courtesyThresholds:[45,55,65],charlestonContinueThreshold:.6,blankExchangeRank:80,blankExchangeGain:20,jokerTopHands:3,jokerRankThreshold:50,jokerScaling:1,discardRandomness:0}};return t[e]||t.medium}calculateTileNeeds(e,t){const n=new Map;for(const s of t){const r=new Map;for(const o of s.componentInfoArray){const a=new Map;for(const l of o.tileArray)if(l.suit!==i.JOKER&&l.suit!==i.BLANK){const f=`${l.suit}-${l.number}`;a.set(f,(a.get(f)||0)+1)}for(const[l,f]of a.entries())r.set(l,(r.get(l)||0)+f)}for(const[o,a]of r.entries()){n.has(o)||n.set(o,{needed:0,have:0});const l=n.get(o);l.needed=Math.max(l.needed,a)}}for(const s of e){if(s.suit===i.JOKER||s.suit===i.BLANK)continue;const r=`${s.suit}-${s.number}`;n.has(r)||n.set(r,{needed:0,have:0}),n.get(r).have++}for(const s of n.values())s.needed=Math.min(s.needed,s.have);return n}countDiscardableTiles(e,t){const n=this.calculateTileNeeds(e,t);let s=0;for(const r of e){if(r.suit===i.JOKER||r.suit===i.BLANK)continue;const o=`${r.suit}-${r.number}`,a=n.get(o);(!a||a.needed===0)&&s++}return s}getTileRecommendations(e){const t=[],n=e.clone();for(;n.getLength()<14;)n.addTile(new O(i.INVALID,C.INVALID));const r=[...this.card.rankHandArray14(n)].sort((u,d)=>d.rank-u.rank),o=e.getTileArray();let a=r.length;for(this.config.maxPatterns<999&&(a=Math.min(a,this.config.maxPatterns));a>1;){const u=r.slice(0,a);if(this.countDiscardableTiles(o,u)>=this.config.minDiscardable)break;a--}a===0&&(a=1);const l=r.slice(0,a),f=this.calculateTileNeeds(o,l);for(const[u,d]of f.entries())D(`  ${u}: needed=${d.needed}, have=${d.have}`);for(const u of o){let d=b.DISCARD;if(u.suit===i.JOKER||u.suit===i.BLANK)d=b.KEEP;else{const m=`${u.suit}-${u.number}`,h=f.get(m);h&&h.needed>0?(d=b.KEEP,D(`  ${u.getText()}: KEEP (need.needed=${h.needed} before decrement)`),h.needed--):D(`  ${u.getText()}: DISCARD (need=${h?`${h.needed}/${h.have}`:"not found"})`)}t.push({tile:u,recommendation:d})}return t.sort((u,d)=>{const m={[b.KEEP]:0,[b.PASS]:1,[b.DISCARD]:2},h=m[u.recommendation]-m[d.recommendation];if(h===0){const p=u.tile.suit===i.JOKER||u.tile.suit===i.BLANK?1:0;return(d.tile.suit===i.JOKER||d.tile.suit===i.BLANK?1:0)-p}return h}),{recommendations:t,consideredPatternCount:a}}chooseDiscard(e){const n=this.getTileRecommendations(e).recommendations;let s=null;const r=n.filter(o=>o.recommendation==="DISCARD"&&o.tile.suit!==i.BLANK);if(this.config.discardRandomness>0&&Math.random()<this.config.discardRandomness&&r.length>0){const o=Math.floor(Math.random()*Math.min(3,r.length));s=r[o].tile}else for(let o=n.length-1;o>=0;o--){const a=n[o].tile;if(a.suit!==i.BLANK){s=a;break}}return!s&&n.length>0&&(s=n[n.length-1].tile),s}claimDiscard(e,t,n,s=!1){const r=n.clone();if(r.addTile(e.clone()),this.card.validateHand14(r).valid)return{playerOption:H.MAHJONG,tileArray:null};const a=this.card.rankHandArray14(r);this.card.sortHandRankArray(a);const l=a[0],f=n.exposures.length>0,u=s||l.rank>this.config.exposureThreshold;if(f||!l.hand.concealed&&u){let d=null;e:for(const m of l.componentInfoArray)for(const h of m.tileArray)if(h.equals(e)){d=m;break e}if(d&&this.validateComponentForExposure(d))return{playerOption:H.EXPOSE_TILES,tileArray:d.tileArray}}return{playerOption:H.DISCARD_TILE,tileArray:[e]}}validateComponentForExposure(e){return!(e.component.count<3||e.tileArray.length!==e.component.count)}charlestonPass(e){const t=[],s=this.getTileRecommendations(e).recommendations;D(`[Charleston] Total recommendations: ${s.length}`),D(`[Charleston] Jokers in hand: ${s.filter(o=>o.tile.suit===i.JOKER).length}`),D(`[Charleston] Blanks in hand: ${s.filter(o=>o.tile.suit===i.BLANK).length}`);const r=s.filter(o=>!o.tile.isJoker()&&!o.tile.isBlank());D(`[Charleston] Valid recommendations after filtering: ${r.length}`),D(`[Charleston] Jokers in valid: ${r.filter(o=>o.tile.suit===i.JOKER).length}`),D(`[Charleston] Blanks in valid: ${r.filter(o=>o.tile.suit===i.BLANK).length}`),r.sort((o,a)=>{const l={[b.DISCARD]:0,[b.PASS]:1,[b.KEEP]:2};return l[o.recommendation]-l[a.recommendation]});for(let o=0;o<3;o++)if(r.length>o){const a=r[o].tile;D(`[Charleston] Passing tile ${o}: ${a.getText()} (suit=${a.suit})`),t.push(a)}return t}courtesyVote(e){const t=e.clone(),n=new O(i.INVALID,C.INVALID);t.addTile(n);const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s);const o=s[0].rank;this.card.printHandRankArray(s,1);const a=this.config.courtesyThresholds;return o<a[0]?3:o<a[1]?2:o<a[2]?1:0}charlestonContinueVote(e){const t=e.clone(),n=new O(i.INVALID,C.INVALID);t.addTile(n);const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s);const o=s[0].rank,a=this.config.charlestonContinueThreshold||.7;let l=a;const f=this.config.courtesyThresholds;return o>=f[2]?l=a+.2:o>=f[1]?l=a+.1:o>=f[0]?l=a:l=Math.max(a-.2,.3),Math.random()<l}courtesyPass(e,t){const s=this.getTileRecommendations(e).recommendations,r=[];for(let o=s.length-1;o>=0&&r.length<t;o--){const a=s[o].tile;a.suit===i.JOKER||a.suit===i.BLANK||r.push(a)}return r}exchangeTilesForJokers(e,t){if(!t||t.length===0)return{shouldExchange:!1,tile:null};const n=this.card.rankHandArray14(e),s=[...n].sort((l,f)=>f.rank-l.rank);let r=-1e5,o=null;const a=e.tiles;for(let l=0;l<a.length;l++){const f=a[l];let u=!1;for(const T of t)if(f.suit===T.suit&&f.number===T.number){u=!0;break}if(!u)continue;const d=e.clone();d.tiles[l]=new O(i.JOKER,0);const m=this.card.rankHandArray14(d);let h=0;const p=Math.min(this.config.jokerTopHands,s.length);for(let T=0;T<p;T++){const A=s[T],E=n.indexOf(A);let S=1;A.rank>this.config.jokerRankThreshold&&(S=Math.min(A.rank*this.config.jokerScaling,100)),h+=(m[E].rank-n[E].rank)*S}h>r&&(r=h,o=f)}return o&&r>0?{shouldExchange:!0,tile:o}:{shouldExchange:!1,tile:null}}}const Ee="modulepreload",ye=function(c){return"/mahjong/"+c},F={},x=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(t.map(l=>{if(l=ye(l),l in F)return;F[l]=!0;const f=l.endsWith(".css"),u=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${l}"]${u}`))return;const d=document.createElement("link");if(d.rel=f?"stylesheet":Ee,f||(d.as="script"),d.crossOrigin="",d.href=l,a&&d.setAttribute("nonce",a),document.head.appendChild(d),f)return new Promise((m,h)=>{d.addEventListener("load",m),d.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${l}`)))})}))}function r(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return s.then(o=>{for(const a of o||[])a.status==="rejected"&&r(a.reason);return e().catch(r)})},Ae=(c,e,t)=>{const n=c[e];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((s,r)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(r.bind(null,new Error("Unknown variable dynamic import: "+e+(e.split("/").length!==t?". Note that variables only represent file names one level deep.":""))))})};class Se{constructor(){this.tileArray=[]}insert(e){this.tileArray.push(e)}getLength(){return this.tileArray.length}getTileArray(){return[...this.tileArray]}}class Oe{constructor(){this.hiddenTileSet=new Se,this.exposedTileSetArray=[],this.even=!1}insertHidden(e){this.hiddenTileSet.insert(e)}getHiddenTileArray(){return this.hiddenTileSet.getTileArray()}getLength(){return this.hiddenTileSet.getLength()+this.exposedTileSetArray.reduce((e,t)=>e+t.getLength(),0)}getTileArray(){const e=[];e.push(...this.getHiddenTileArray());for(const t of this.exposedTileSetArray)e.push(...t.getTileArray());return e}isAllHidden(){return this.exposedTileSetArray.length===0}}class Me{constructor(e){this.year=e,this.validHandGroups=null}async init(){const e=this.year,{validHandGroups:t}=await Ae(Object.assign({"./2017/card2017.js":()=>x(()=>import("./card2017-DiHQsi7-.js"),[]),"./2017/card_test.js":()=>x(()=>import("./card_test-BH-34wbo.js"),__vite__mapDeps([0,1])),"./2018/card2018.js":()=>x(()=>import("./card2018-FwuxFy17.js"),[]),"./2018/card_test.js":()=>x(()=>import("./card_test-CNIz-Hj2.js"),__vite__mapDeps([2,1])),"./2019/card2019.js":()=>x(()=>import("./card2019-v97YsYMS.js"),[]),"./2019/card_test.js":()=>x(()=>import("./card_test-B4nm8qRs.js"),__vite__mapDeps([3,1])),"./2020/card2020.js":()=>x(()=>import("./card2020-jguwJqF3.js"),[]),"./2020/card_test.js":()=>x(()=>import("./card_test-DNrFuv2T.js"),__vite__mapDeps([4,1])),"./2025/card2025.js":()=>x(()=>import("./card2025-ogfjctwD.js"),[])}),`./${e}/card${e}.js`,3);this.validHandGroups=t}generateHand(e,t){let n=t;const s=[i.CRACK,i.BAM,i.DOT],r=new Oe;let o=null;n||(n=14);e:for(const f of this.validHandGroups)for(const u of f.hands)if(u.description.valueOf()===e.valueOf()){o=u;break e}if(!o)return r;const a=[];for(let f=0;f<o.components.length;f++)a.push(0);let l=0;for(let f=0;f<n;f++){const u=o.components[l];let d=u.suit,m=u.number;if(a[l]>=4)r.insertHidden(new O(i.JOKER,0));else{let p=1;r.even&&(p=2),d>=i.VSUIT1_DRAGON?(m=s[d-i.VSUIT1_DRAGON],d=i.DRAGON):d>=i.VSUIT1&&(d=s[d-i.VSUIT1],m>9&&(m=p+m-C.CONSECUTIVE1)),r.insertHidden(new O(d,m))}a[l]++;let h=!1;for(let p=0;p<o.components.length;p++)if(l++,l>=o.components.length&&(l=0),a[l]<o.components[l].count){h=!0;break}if(!h)break}return r}validateHand14(e){const t=e.getTileArray();return this.validateHand(t,e.isAllHidden())}diagnoseInvalidHand(e){const t=this.rankHandArray14(e);this.sortHandRankArray(t);const n=t[0],s=new Set;for(const l of n.componentInfoArray)for(const f of l.tileArray)s.add(f);const r=[];r.push(...e.getHiddenTileArray());for(const l of e.exposedTileSetArray)r.push(...l.tileArray);const o=[],a=[];for(const l of r)s.has(l)?o.push(l):a.push(l);return{closestHand:n.hand.description,closestGroup:n.group.groupDescription,rank:n.rank,matchingTiles:o,nonMatchingTiles:a}}validateHand13(e,t){const n=e.getTileArray();return t&&n.push(t),this.validateHand(n,e.isAllHidden())}validateHand(e,t){const n=e.filter(o=>o.suit!==i.BLANK);if(n.length!==14)return{valid:!1,tileCount:e.length,numJokers:0,minNumLow:9999,minNumHigh:9999,suits:[],allHidden:t};const s={valid:!1,tileCount:0,numJokers:0,minNumLow:9999,minNumHigh:9999,suits:[],allHidden:t};for(const o of n){let a=o.suit;a===i.DRAGON&&(a=o.number),s.suits.indexOf(a)===-1&&s.suits.push(a),a===i.JOKER&&s.numJokers++}s.minNumLow=9999,s.minNumHigh=9999;for(const o of n)(o.suit===i.CRACK||o.suit===i.BAM||o.suit===i.DOT)&&o.number<s.minNumHigh&&(s.minNumHigh=o.number);if(s.numJokers>=3?s.minNumLow=1:s.minNumLow=s.minNumHigh,s.tileCount=n.length,s.tileCount!==14)return s;let r=!1;e:for(const o of this.validHandGroups)for(const a of o.hands)if(Q("Match hand: "+a.description+`
`),this.matchHand(n,s,o,a)){r=!0;break e}return r&&(s.valid=!0),s}matchHand(e,t,n,s){let r=!1;if(s.concealed&&!t.allHidden||t.suits.length<s.vsuitCount)return!1;const o=[[-1,-1,-1]],a=[[i.CRACK,-1,-1],[i.BAM,-1,-1],[i.DOT,-1,-1]],l=[[i.CRACK,i.BAM,-1],[i.CRACK,i.DOT,-1],[i.BAM,i.CRACK,-1],[i.BAM,i.DOT,-1],[i.DOT,i.CRACK,-1],[i.DOT,i.BAM,-1]],f=[[i.CRACK,i.BAM,i.DOT],[i.CRACK,i.DOT,i.BAM],[i.BAM,i.CRACK,i.DOT],[i.BAM,i.DOT,i.CRACK],[i.DOT,i.CRACK,i.BAM],[i.DOT,i.BAM,i.CRACK]];let u=null;switch(s.vsuitCount){case 1:u=a;break;case 2:u=l;break;case 3:u=f;break;default:u=o;break}for(let d=t.minNumLow;d<=t.minNumHigh;d++){for(const m of u)if(r=this.matchComponents(e,t,s,m,d),r)break;if(r)break}return r}matchComponents(e,t,n,s,r){let o=!0;if(r!==9999&&(n.even&&r&1||n.odd&&!(r&1)))return!1;const a=[];for(const l of e)a.push(l);for(const l of n.components){let f=0,u=l.suit,d=l.number;u>=i.VSUIT1_DRAGON?(d=s[u-i.VSUIT1_DRAGON],u=i.DRAGON):u>=i.VSUIT1&&(u=s[u-i.VSUIT1],d>9&&(d=r+d-C.CONSECUTIVE1));let m=!1;do{m=!1;for(const h of a)if(h.suit===u&&h.number===d){m=!0;const p=a.indexOf(h);a.splice(p,1),f++;break}if(!m&&l.count>2){for(const h of a)if(h.suit===i.JOKER){m=!0;const p=a.indexOf(h);a.splice(p,1),f++;break}}}while(m&&f<l.count);if(f!==l.count){o=!1;break}}return o}printValidationInfo(e){}rankHandArray14(e){const t=[];for(const n of this.validHandGroups)for(const s of n.hands){const r={group:n,hand:s,rank:0,componentInfoArray:[],vsuitArray:null};t.push(r),this.rankHand(e,r,s)}return t}rankHand(e,t,n){if(n.concealed&&!e.isAllHidden()){t.rank=0;return}const s=[[-1,-1,-1]],r=[[i.CRACK,-1,-1],[i.BAM,-1,-1],[i.DOT,-1,-1]],o=[[i.CRACK,i.BAM,-1],[i.CRACK,i.DOT,-1],[i.BAM,i.CRACK,-1],[i.BAM,i.DOT,-1],[i.DOT,i.CRACK,-1],[i.DOT,i.BAM,-1]],a=[[i.CRACK,i.BAM,i.DOT],[i.CRACK,i.DOT,i.BAM],[i.BAM,i.CRACK,i.DOT],[i.BAM,i.DOT,i.CRACK],[i.DOT,i.CRACK,i.BAM],[i.DOT,i.BAM,i.CRACK]];let l=null;switch(n.vsuitCount){case 1:l=r;break;case 2:l=o;break;case 3:l=a;break;default:l=s;break}let f=!1;for(const h of n.components)if(h.number>9){f=!0;break}let u=1,d=1,m=1;f&&(d=9,n.odd?(u=1,d=9,m=2):n.even&&(u=2,d=8,m=2));for(let h=u;h<=d;h+=m)for(const p of l){const T=this.rankFormComponents(e,h,n,p);let A=0;for(const E of T){const S=E.component,B=E.tileArray.length;A+=100*S.count/14*(B/S.count)}A>t.rank&&(t.rank=A,t.componentInfoArray=T,t.vsuitArray=p)}}rankMatchComp(e,t,n,s){let r=n.suit,o=n.number;const a={match:!1,tileArray:[]};if(e.length===0)return a;r>=i.VSUIT1_DRAGON?(o=s[r-i.VSUIT1_DRAGON],r=i.DRAGON):r>=i.VSUIT1&&(r=s[r-i.VSUIT1],o>9&&(o=t+o-C.CONSECUTIVE1));for(const l of e){let f=!1;if((l.suit===r&&l.number===o||l.suit===i.JOKER)&&(f=!0),f&&(a.tileArray.push(l),a.tileArray.length===n.count))break}return e.length===n.count&&a.tileArray.length===n.count&&(a.match=!0),a}rankFormComponents(e,t,n,s){const r=[];for(const u of n.components){const d={component:u,tileArray:[]};r.push(d)}const o=[];for(const u of r)o.push(u);for(const u of e.exposedTileSetArray){for(const m of r){if(m.tileArray.length>0)continue;const h=this.rankMatchComp(u.tileArray,t,m.component,s);if(h.match){m.tileArray=h.tileArray;break}}let d=!0;for(const m of u.tileArray){let h=!1;for(const p of r)if(p.tileArray.includes(m)){h=!0;break}if(!h){d=!1;break}}if(!d)return r}const a=e.getHiddenTileArray(),l=[],f=[];for(const u of a)u.suit===i.JOKER?f.push(u):l.push(u);for(const u of r){const d=u.component;if(u.tileArray.length>0)continue;const m=this.rankMatchComp(l,t,d,s);u.tileArray=m.tileArray;for(const h of m.tileArray){const p=l.indexOf(h);p!==-1&&l.splice(p,1)}}for(const u of f){let d=null,m=null,h=null;for(const p of o){const T=p.component.count-p.tileArray.length;if(p.component.count>=3&&T)switch(T){case 2:d=p;break;case 1:m=p;break;default:h=p;break}}m?m.tileArray.push(u):d?d.tileArray.push(u):h&&h.tileArray.push(u)}return r}sortHandRankArray(e){e.sort((t,n)=>n.rank-t.rank)}printHandRankArray(e,t){let n=e.length;t&&(n=Math.min(t,n));for(let s=0;s<n;s++){const r=e[s];D("Group = "+r.group.groupDescription+`
`),D("Hand = "+r.hand.description+`
`),D("Rank = "+r.rank+`
`);let o="";for(const a of r.componentInfoArray){o+="["+a.component.count+"] ";for(const l of a.tileArray)o+=l.getText()+" "}}}}export{He as A,Me as C,M as D,ve as G,_ as H,g as P,Re as S,ke as T,C as V,Ne as W,x as _,i as a,we as b,xe as c,D as d,be as e,Pe as f,_e as g,y as h,Ie as i,O as j,De as k,P as l,Oe as m,Ce as p,Le as r};
