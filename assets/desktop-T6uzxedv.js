import{d as P,S as B,V as C,a as m,D as R,W as F,b as f,C as Y,A as $,p,P as c,s as _,c as T,g as G,e as x,T as H,f as W,H as J,h as j,i as K,j as k,k as v,l as L,m as D,n as X,o as b,q as Q,r as A,G as q}from"./GameController-CIkwjypy.js";class Z{constructor(){this.overlay=document.getElementById("settings-overlay"),this.saveButton=document.getElementById("settings-save"),this.cancelButton=document.getElementById("settings-cancel"),this.settingsButton=document.getElementById("settings"),this.originalSettings={},this.init(),this.loadSettings()}init(){this.settingsButton.addEventListener("click",()=>{this.showSettings()}),this.saveButton.addEventListener("click",()=>{this.saveAndClose()}),this.cancelButton.addEventListener("click",()=>{this.cancelAndClose()}),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.cancelAndClose()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.overlay.style.display!=="none"&&this.cancelAndClose()});const e=document.getElementById("trainCheckbox");e&&e.addEventListener("change",()=>{this.updateTrainingFormVisibility()}),this.setupAudioControls()}showSettings(){this.overlay.style.display="flex",this.storeCurrentSettingsState(),this.saveButton.focus()}hideSettings(){this.overlay.style.display="none",this.settingsButton.focus()}storeCurrentSettingsState(){var e,t,n,i,s,a,o,r,l,d;this.originalSettings={trainingMode:((e=document.getElementById("trainCheckbox"))==null?void 0:e.checked)??!1,trainingHand:((t=document.getElementById("handSelect"))==null?void 0:t.value)??"",trainingTileCount:((n=document.getElementById("numTileSelect"))==null?void 0:n.value)??"9",skipCharleston:((i=document.getElementById("skipCharlestonCheckbox"))==null?void 0:i.checked)??!1,cardYear:((s=document.getElementById("yearSelect"))==null?void 0:s.value)??"2025",useBlankTiles:((a=document.getElementById("useBlankTiles"))==null?void 0:a.checked)??!1,bgmVolume:((o=document.getElementById("bgmVolume"))==null?void 0:o.value)??"70",bgmMuted:((r=document.getElementById("bgmMute"))==null?void 0:r.checked)??!1,sfxVolume:((l=document.getElementById("sfxVolume"))==null?void 0:l.value)??"80",sfxMuted:((d=document.getElementById("sfxMute"))==null?void 0:d.checked)??!1}}restoreOriginalSettings(){const e=document.getElementById("trainCheckbox"),t=document.getElementById("handSelect"),n=document.getElementById("numTileSelect"),i=document.getElementById("skipCharlestonCheckbox"),s=document.getElementById("yearSelect"),a=document.getElementById("useBlankTiles"),o=document.getElementById("bgmVolume"),r=document.getElementById("bgmVolumeValue"),l=document.getElementById("bgmMute"),d=document.getElementById("sfxVolume"),g=document.getElementById("sfxVolumeValue"),y=document.getElementById("sfxMute");e&&(e.checked=this.originalSettings.trainingMode),t&&(t.value=this.originalSettings.trainingHand),n&&(n.value=this.originalSettings.trainingTileCount),i&&(i.checked=this.originalSettings.skipCharleston),s&&(s.value=this.originalSettings.cardYear),a&&(a.checked=this.originalSettings.useBlankTiles),o&&(o.value=this.originalSettings.bgmVolume,r&&(r.textContent=`${this.originalSettings.bgmVolume}%`)),l&&(l.checked=this.originalSettings.bgmMuted),d&&(d.value=this.originalSettings.sfxVolume,g&&(g.textContent=`${this.originalSettings.sfxVolume}%`)),y&&(y.checked=this.originalSettings.sfxMuted),this.updateTrainingFormVisibility()}saveAndClose(){var i;const e=this.getSetting("cardYear","2025"),t=((i=document.getElementById("yearSelect"))==null?void 0:i.value)??"2025",n=e!==t;if(this.saveTrainingSettings(),this.saveDifficultySettings(),this.saveYearSettings(),this.saveHouseRuleSettings(),this.saveAudioSettings(),n&&window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const s=window.game.scene.getScene("GameScene");if(s.gGameLogic){const a=document.getElementById("handSelect");a&&(a.innerHTML=""),s.gGameLogic.init().then(()=>{})}}this.hideSettings()}cancelAndClose(){this.restoreOriginalSettings(),this.hideSettings()}getDifficulty(){return this.getSetting("difficulty","medium")}getCardYear(){return this.getSetting("cardYear","2025")}saveSetting(e,t){try{B.set(e,t)}catch(n){console.warn("Failed to save setting:",n)}}getSetting(e,t=null){return B.get(e)??t}getAllSettings(){return B.load()}loadSettings(){const e=B.load();this.applyTrainingSettings(e),this.applyDifficultySettings(e),this.applyYearSettings(e),this.applyHouseRuleSettings(e),this.applyAudioSettings(e)}applyTrainingSettings(e){const t=document.getElementById("trainCheckbox"),n=document.getElementById("handSelect"),i=document.getElementById("numTileSelect"),s=document.getElementById("skipCharlestonCheckbox");t&&Object.prototype.hasOwnProperty.call(e,"trainingMode")&&(t.checked=e.trainingMode),n&&e.trainingHand&&(n.value=e.trainingHand),i&&e.trainingTileCount&&(i.value=e.trainingTileCount.toString()),s&&Object.prototype.hasOwnProperty.call(e,"skipCharleston")&&(s.checked=e.skipCharleston),this.updateTrainingFormVisibility()}applyDifficultySettings(e){const t=document.getElementById("difficultySelect");t&&e.difficulty&&(t.value=e.difficulty)}applyYearSettings(e){const t=document.getElementById("yearSelect");t&&e.cardYear&&(t.value=e.cardYear)}updateTrainingFormVisibility(){const e=document.getElementById("trainCheckbox"),t=document.getElementById("trainfieldset2");e&&t&&(t.disabled=!e.checked)}saveTrainingSettings(){var t,n,i,s;const e={};e.trainingMode=((t=document.getElementById("trainCheckbox"))==null?void 0:t.checked)??!1,e.trainingHand=((n=document.getElementById("handSelect"))==null?void 0:n.value)??"",e.trainingTileCount=parseInt(((i=document.getElementById("numTileSelect"))==null?void 0:i.value)??"9",10),e.skipCharleston=((s=document.getElementById("skipCharlestonCheckbox"))==null?void 0:s.checked)??!0,B.save(e),window.dispatchEvent(new window.CustomEvent("settingsChanged",{detail:e}))}saveDifficultySettings(){var t;const e={};e.difficulty=((t=document.getElementById("difficultySelect"))==null?void 0:t.value)??"medium",B.save(e)}saveYearSettings(){var t;const e={};e.cardYear=parseInt(((t=document.getElementById("yearSelect"))==null?void 0:t.value)??"2025",10),B.save(e)}saveHouseRuleSettings(){var t;const e={};e.useBlankTiles=((t=document.getElementById("useBlankTiles"))==null?void 0:t.checked)??!1,B.save(e)}saveAudioSettings(){var t,n,i,s;const e={};e.bgmVolume=parseInt(((t=document.getElementById("bgmVolume"))==null?void 0:t.value)??"70",10),e.bgmMuted=((n=document.getElementById("bgmMute"))==null?void 0:n.checked)??!1,e.sfxVolume=parseInt(((i=document.getElementById("sfxVolume"))==null?void 0:i.value)??"80",10),e.sfxMuted=((s=document.getElementById("sfxMute"))==null?void 0:s.checked)??!1,B.save(e)}applyHouseRuleSettings(e){const t=document.getElementById("useBlankTiles");t&&(t.checked=e.useBlankTiles)}applyAudioSettings(e){const t=document.getElementById("bgmVolume"),n=document.getElementById("bgmVolumeValue"),i=document.getElementById("bgmMute"),s=document.getElementById("sfxVolume"),a=document.getElementById("sfxVolumeValue"),o=document.getElementById("sfxMute");t&&(t.value=e.bgmVolume,n&&(n.textContent=`${e.bgmVolume}%`)),i&&(i.checked=e.bgmMuted),s&&(s.value=e.sfxVolume,a&&(a.textContent=`${e.sfxVolume}%`)),o&&(o.checked=e.sfxMuted)}getUseBlankTiles(){return B.get("useBlankTiles")}setupAudioControls(){const e=document.getElementById("bgmVolume"),t=document.getElementById("bgmVolumeValue"),n=document.getElementById("bgmMute"),i=document.getElementById("sfxVolume"),s=document.getElementById("sfxVolumeValue"),a=document.getElementById("sfxMute");e&&e.addEventListener("input",o=>{const r=parseInt(o.target.value,10)/100;t&&(t.textContent=`${o.target.value}%`),this.updateAudioManager("bgmVolume",r)}),n&&n.addEventListener("change",o=>{const r=o.target.checked;this.updateAudioManager("bgmMuted",r)}),i&&i.addEventListener("input",o=>{const r=parseInt(o.target.value,10)/100;s&&(s.textContent=`${o.target.value}%`),this.updateAudioManager("sfxVolume",r)}),a&&a.addEventListener("change",o=>{const r=o.target.checked;this.updateAudioManager("sfxMuted",r)})}updateAudioManager(e,t){if(window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const n=window.game.scene.getScene("GameScene");if(P("GameScene found, audioManager exists:",!!n.audioManager),n.audioManager)switch(e){case"bgmVolume":n.audioManager.setBGMVolume(t);break;case"bgmMuted":n.audioManager.muteBGM(t);break;case"sfxVolume":n.audioManager.setSFXVolume(t);break;case"sfxMuted":n.audioManager.muteSFX(t);break}}}registerSettingSection(e,t){}}document.addEventListener("DOMContentLoaded",()=>{window.settingsManager=new Z;const u=document.getElementById("controldiv"),e=document.getElementById("uicenterdiv");u&&(u.style.visibility="visible"),e&&(e.style.display="none"),window.addEventListener("settingsChanged",t=>{const n=t.detail;if(console.log("Settings changed from mobile:",n),window.settingsManager&&window.settingsManager.overlay.style.display!=="none"&&window.settingsManager.loadSettings(),window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const i=window.game.scene.getScene("GameScene");if(i.gGameLogic){const s=window.settingsManager.getCardYear();n.cardYear&&s!==n.cardYear&&i.gGameLogic.init().then(()=>{P(`Card year updated to ${n.cardYear}`)})}}})});const M={[m.VSUIT1]:"green",[m.VSUIT2]:"red",[m.VSUIT3]:"blue",[m.FLOWER]:"black",[m.VSUIT1_DRAGON]:"green",[m.VSUIT2_DRAGON]:"red",[m.VSUIT3_DRAGON]:"blue",[m.WIND]:"black",[m.DRAGON]:"blue",[m.JOKER]:"gray",[m.CRACK]:"red",[m.BAM]:"green",[m.DOT]:"blue"};function V(u,e=!1,t=null){if(u.suit===m.JOKER)return{char:"J",color:M[m.JOKER],tile:u};if(u.suit===m.FLOWER)return{char:"F",color:M[m.FLOWER],tile:u};if(u.suit===m.WIND)return{char:{[F.NORTH]:"N",[F.EAST]:"E",[F.SOUTH]:"S",[F.WEST]:"W"}[u.number]||"?",color:M[m.WIND],tile:u};if(u.suit===m.DRAGON||u.suit>=m.VSUIT1_DRAGON&&u.suit<=m.VSUIT3_DRAGON){if(u.suit===m.DRAGON&&u.number===R.WHITE)return{char:"0",color:"blue",tile:u};let n="blue";if(u.suit===m.DRAGON)n={[R.RED]:"red",[R.GREEN]:"green",[R.WHITE]:"blue"}[u.number]||"blue";else if(u.suit>=m.VSUIT1_DRAGON&&u.suit<=m.VSUIT3_DRAGON)if(t){const i=t[u.suit-m.VSUIT1_DRAGON];n=M[i]||"blue"}else{const i=u.suit-m.VSUIT1_DRAGON;n=["green","red","blue"][i]||"blue"}return{char:"D",color:n,tile:u}}if(u.number>=1&&u.number<=9){if(t&&u.suit>=m.VSUIT1&&u.suit<=m.VSUIT3){const n=t[u.suit-m.VSUIT1],i=M[n]||"blue";return{char:u.number.toString(),color:i,tile:u}}return{char:u.number.toString(),color:M[u.suit]||"blue",tile:u}}if(u.number>=C.CONSECUTIVE1&&u.number<=C.CONSECUTIVE7){const n=u.number-C.CONSECUTIVE1,i=e?2+n*2:1+n*2;if(t&&u.suit>=m.VSUIT1&&u.suit<=m.VSUIT3){const s=t[u.suit-m.VSUIT1],a=M[s]||"blue";return{char:i.toString(),color:a,tile:u}}return{char:i.toString(),color:M[u.suit]||"blue",tile:u}}return u.number===0?{char:"0",color:M[u.suit]||"gray",tile:u}:{char:"?",color:"gray",tile:u}}function z(u){const e=new Map;return u.forEach(t=>{const n=`${t.suit}-${t.number}`;e.set(n,(e.get(n)||0)+1)}),e}function ee(u,e,t,n,i=null,s=null,a=null){const o=z(e),r=new Map,d=(s?z(s):o).get(`${m.JOKER}-0`)||0;let g=0,y=0;return u.map((h,S)=>{let w;if(a&&h.number>=C.CONSECUTIVE1&&h.number<=C.CONSECUTIVE7){const N=a.get(h.number);if(N!==void 0){const U={...h,number:N};w=V(U,n,i)}else w=V(h,n,i)}else w=V(h,n,i);const E=`${h.suit}-${h.number}`,O=t[S];let I=!1;return(o.get(E)||0)-(r.get(E)||0)>0?(I=!0,r.set(E,(r.get(E)||0)+1),h.suit===m.JOKER&&g++):O>=3&&h.suit!==m.JOKER&&g+y<d&&(I=!0,y++,w.char="J",w.color="gray"),{...w,isMatched:I}})}function te(u,e=!0){const t="tile-char",n=e&&u.isMatched,i=u.color;return n?`${t} bg-${i}-600 text-white border border-${i}-700`:`${t} bg-white text-${i}-600 border border-${i}-200`}function ne(u,e,t=null){const n=[],i=[],s=u.hand.even||!1,a=new Map;u.componentInfoArray.forEach(h=>{if(h.tileArray&&h.tileArray.length>0){const S=h.component.number;if(S>=C.CONSECUTIVE1&&S<=C.CONSECUTIVE7){const w=h.tileArray.find(E=>E.suit!==m.JOKER);if(w&&a.size===0){const E=S-C.CONSECUTIVE1,O=w.number-E;for(let I=0;I<7;I++)a.set(C.CONSECUTIVE1+I,O+I)}}}}),u.componentInfoArray.forEach((h,S)=>{const w=h.component.count,E=h.tileArray?h.tileArray.length:0;if(h.tileArray&&h.tileArray.length>0&&h.tileArray.forEach(O=>{n.push(O),i.push(w)}),E<w){const O={suit:h.component.suit||m.INVALID,number:h.component.number||0};for(let I=E;I<w;I++)n.push(O),i.push(w)}if(S<u.componentInfoArray.length-1){const O=u.componentInfoArray[S+1];h.component.count===1&&O.component.count===1||(n.push({isSpacer:!0}),i.push(0))}});const o=n.filter(h=>!h.isSpacer),r=i.filter((h,S)=>!n[S].isSpacer),l=ee(o,e,r,s,u.vsuitArray,t,a),d=[];let g=0;n.forEach(h=>{h.isSpacer?d.push({isSpacer:!0}):d.push(l[g++])});let y='<div class="pattern-row">';return d.forEach(h=>{h.isSpacer?y+='<span class="component-spacer"></span>':y+=`<span class="${te(h)}">${h.char}</span>`}),y+="</div>",y}class ie{constructor(e){this.gameLogic=e,this.savedGlowData=null,this.currentHintData=null,this.isPanelExpanded=!1,this.glowedTiles=[]}applyGlowToDiscardSuggestions(e){this.clearAllGlows();const t=e.filter(s=>s.tile.suit!==m.INVALID&&s.recommendation==="DISCARD"),n=this.gameLogic.table.players[c.BOTTOM].hand,i=new Set;t.forEach((s,a)=>{P(`Processing tile ${a+1}: ${s.tile.getText()} with recommendation ${s.recommendation}`);const o=this.findNextUnhighlightedTileInHand(n,s.tile,i);o?(P(`Applying red glow to tile: ${o.getText()}`),o.addGlowEffect(this.gameLogic.scene,16711680,.6),this.glowedTiles.push(o),i.add(o)):P(`Could not find tile for: ${s.tile.getText()}`)}),P(`Applied glow to ${this.glowedTiles.length} tiles out of ${t.length} discard tiles requested`),this.currentHintData={recommendations:[...e]},this.isPanelExpanded=!0}findNextUnhighlightedTileInHand(e,t,n){const i=e.getHiddenTileArray();for(const s of i)if(s.suit===t.suit&&s.number===t.number&&!n.has(s))return s;return null}clearAllGlows(){if(this.glowedTiles.length>0){let e=null;this.currentHintData&&(e=this.currentHintData.recommendations),this.savedGlowData={recommendations:e,timestamp:Date.now()}}this.glowedTiles.forEach(e=>e.removeGlowEffect()),this.glowedTiles=[],this.isPanelExpanded=!1}restoreGlowEffects(){this.savedGlowData&&this.savedGlowData.recommendations?(this.applyGlowToDiscardSuggestions(this.savedGlowData.recommendations),this.isPanelExpanded=!0,this.savedGlowData=null):this.currentHintData&&this.currentHintData.recommendations&&(this.applyGlowToDiscardSuggestions(this.currentHintData.recommendations),this.isPanelExpanded=!0)}isHintPanelExpanded(){const e=window.document.getElementById("hint-content");return e&&!e.classList.contains("hidden")}getRecommendations(){const e=this.gameLogic.table.players[c.BOTTOM].hand.dupHand();if(e.getLength()===13){const n=new H(m.INVALID,C.INVALID);e.insertHidden(n)}const t=this.gameLogic.gameAI.getTileRecommendations(e);return{recommendations:t.recommendations.reverse(),consideredPatternCount:t.consideredPatternCount}}getAllPlayerTiles(){const e=this.gameLogic.table.players[c.BOTTOM].hand,t=[...e.getHiddenTileArray()];return e.exposedTileSetArray.forEach(n=>{t.push(...n.tileArray)}),t}getHiddenPlayerTiles(){return this.gameLogic.table.players[c.BOTTOM].hand.getHiddenTileArray()}updateHintsForNewTiles(){if(!this.isHintPanelExpanded()){this.updateHintDisplayOnly();return}const e=this.getRecommendations(),t=this.gameLogic.table.players[c.BOTTOM].hand.dupHand();t.getLength()===13&&t.insertHidden(new H(m.INVALID,C.INVALID));const n=this.gameLogic.card.rankHandArray14(t);this.gameLogic.card.sortHandRankArray(n),this.applyGlowToDiscardSuggestions(e.recommendations),this.updateHintDisplay(n,e.recommendations,e.consideredPatternCount)}updateHintDisplayOnly(){const e=this.getRecommendations(),t=this.gameLogic.table.players[c.BOTTOM].hand.dupHand();t.getLength()===13&&t.insertHidden(new H(m.INVALID,C.INVALID));const n=this.gameLogic.card.rankHandArray14(t);this.gameLogic.card.sortHandRankArray(n),this.updateHintDisplay(n,e.recommendations,e.consideredPatternCount)}updateHintDisplay(e,t,n){let i="<h3>Top Possible Hands:</h3>";const s=this.getAllPlayerTiles(),a=this.getHiddenPlayerTiles();for(let l=0;l<Math.min(3,e.length);l++){const d=e[l],g=l===0||l<n,y=g?"":"opacity: 0.4;";i+=`<p style="${y}"><strong>${d.group.groupDescription}</strong> - ${d.hand.description} (Rank: ${d.rank.toFixed(2)})`,!g&&l>0&&(i+=" <em>(not considered)</em>"),i+="</p>";const h=ne(d,s,a);i+=`<div style="${y}">${h}</div>`}i+="<h3>Discard Suggestions (Best to Discard First):</h3>";const o=t.filter(l=>l.tile.suit!==m.INVALID&&l.recommendation==="DISCARD"),r=o.length;for(let l=0;l<r;l++){const d=o[l];i+=`<p>${d.tile.getText()}</p>`}W(i)}}class se{constructor(e){this.scene=e,this.state=f.INIT,this.table=null,this.card=null,this.gameAI=null,this.currPlayer=0,this.button1Function=null,this.button2Function=null,this.button3Function=null,this.button4Function=null,this.sort1Function=null,this.sort2Function=null,this.hintFunction=null,this.startButtonFunction=null,this.hintAnimationManager=null,this.errorText=null,this.errorTextArray=[],this.errorTextSemaphore=0,this.discardTile=null,this.gameResult={mahjong:!1,winner:0},this.isSwappingBlank=!1}async init(){const e=window.settingsManager.getCardYear();this.card=new Y(e),await this.card.init();const t=window.settingsManager?window.settingsManager.getDifficulty():"medium";this.gameAI=new $(this.card,this.table,t),this.hintAnimationManager=new ie(this),p("Using "+this.card.year+` Mahjong card

`);const n=window.document.getElementById("handSelect");for(const i of this.card.validHandGroups){const s=window.document.createElement("optgroup");s.label=i.groupDescription,n.add(s);for(const a of i.hands){const o=window.document.createElement("option");o.text=a.description,n.add(o)}}}start(){this.state=f.START,this.gameResult.mahjong=!1,this.gameResult.winner=0,this.table.switchPlayer(c.BOTTOM),this.table.reset(),this.hintAnimationManager.clearAllGlows(),this.scene.audioManager&&this.scene.audioManager.playBGM("bgm"),this.deal()}deal(){this.state=f.DEAL;const e=[null,null,null,null],t=this.getTrainingInfo();t.trainCheckbox&&(e[0]=this.card.generateHand(t.handDescription,t.numTiles)),this.sequentialDealTiles(e,()=>{this.table.players[c.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles()}),t.trainCheckbox&&t.skipCharlestonCheckbox?this.loop():this.charleston()}async charleston(){this.state=f.CHARLESTON1,await this.charlestonPass(c.RIGHT),this.table.players[c.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),await this.charlestonPass(c.TOP),this.table.players[c.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),await this.charlestonPass(c.LEFT),this.table.players[c.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),this.state=f.CHARLESTON_QUERY;const e=await this.yesNoQuery();this.state=f.CHARLESTON_QUERY_COMPLETE,e===!0&&(this.state=f.CHARLESTON2,await this.charlestonPass(c.LEFT),this.table.players[c.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),await this.charlestonPass(c.TOP),this.table.players[c.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),await this.charlestonPass(c.RIGHT),this.table.players[c.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles()),this.state=f.COURTESY_QUERY;const t=await this.courtesyQuery();this.state=f.COURTESY_QUERY_COMPLETE,this.state=f.COURTESY;const n=[];n[0]=t;const i=await Promise.all([this.gameAI.courtesyVote(1),this.gameAI.courtesyVote(2),this.gameAI.courtesyVote(3)]);n[1]=i[0],n[2]=i[1],n[3]=i[2];for(let s=0;s<4;s++)p("Player "+s+" wants to exchange "+n[s]+` tiles
`);if(this.table.courtesyVote(n),this.table.player02CourtesyVote>0&&await this.courtesyPass(),this.state=f.COURTESY_COMPLETE,this.table.player02CourtesyVote>0||this.table.player13CourtesyVote>0){const s=[];s[0]=this.table.players[0].hand.getSelectionHidden(),this.table.players[0].hand.resetSelection();for(const o of s[0])this.table.players[0].hand.removeHidden(o);s[1]=await this.gameAI.courtesyPass(1,this.table.player13CourtesyVote),s[2]=await this.gameAI.courtesyPass(2,this.table.player02CourtesyVote),s[3]=await this.gameAI.courtesyPass(3,this.table.player13CourtesyVote);const a=this.table.courtesyPass(s);if(a&&a.length>0){for(const o of a)o.addGlowEffect(this.scene,2003199,.7,10);setTimeout(()=>{for(const o of a)o.removeGlowEffect();this.table.players[c.BOTTOM].hand.sortSuitHidden(),this.table.players[c.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles()},2e3)}}this.table.players[c.BOTTOM].hand.getLength()>0&&this.table.player02CourtesyVote===0&&this.table.player13CourtesyVote===0&&this.hintAnimationManager.updateHintsForNewTiles(),p(`Courtesy complete
`),this.loop()}async loop(){let e=!0;for(this.currPlayer=0;this.table.switchPlayer(this.currPlayer),this.state=f.LOOP_PICK_FROM_WALL,!(!e&&!this.pickFromWall());){e=!1,this.state=f.LOOP_CHOOSE_DISCARD;const t=await this.chooseDiscard();if(this.table.players[this.currPlayer].hand.tilesWereDraggedThisTurn||this.table.players[this.currPlayer].showHand(this.currPlayer===c.BOTTOM),this.table.players[this.currPlayer].hand.tilesWereDraggedThisTurn=!1,this.currPlayer!==c.BOTTOM&&await _(500),t.playerOption===T.MAHJONG){this.gameResult.mahjong=!0,this.gameResult.winner=this.currPlayer;break}const n=t.tileArray[0];if(n.suit===m.JOKER){this.table.discards.insertDiscard(n),this.table.discards.showDiscards(),this.scene.audioManager&&this.scene.audioManager.playSFX("tile_dropping"),this.currPlayer++,this.currPlayer>3&&(this.currPlayer=0);continue}n.scale=1,n.showTile(!0,!0),n.addGlowEffect(this.scene,1981066,.9),n.sprite.depth=200,n.spriteBack.depth=200;const i=n.animate(350,420,0);i&&this.scene.audioManager&&i.on("complete",()=>{this.scene.audioManager.playSFX("tile_dropping")});const s=[];for(let l=0;l<4;l++)s[l]=await this.claimDiscard(l,n);const a=this.table.processClaimArray(this.currPlayer,s,n);if(n.removeGlowEffect(),n.sprite.depth=0,a.playerOption===T.MAHJONG){this.gameResult.mahjong=!0,this.gameResult.winner=a.winningPlayer;break}if(a.playerOption===T.EXPOSE_TILES){this.currPlayer=a.winningPlayer,e=!0;const l=n.getText();p("Player "+this.currPlayer+" *claims* "+l+` 
`),this.currPlayer===c.BOTTOM&&this.hintAnimationManager.updateHintsForNewTiles()}else this.currPlayer++,this.currPlayer>3&&(this.currPlayer=0);let o=0;o+=this.table.wall.tileArray.length,o+=this.table.discards.tileArray.length;for(let l=0;l<4;l++)o+=this.table.players[l].hand.getLength();const r=G();o!==r&&p("ERROR - total tile count is not "+r+". Tile count = "+o+`
`)}this.end()}async end(){if(this.state=f.END,this.gameResult.mahjong&&this.gameResult.winner===0)try{await this.scene.createFireworksDisplay(this.gameResult)}catch(e){console.warn("[GameLogic] Fireworks display error:",e)}}pickFromWall(){const e=this.table.wall.remove();return this.scene.updateWallTileCounter(this.table.wall.getCount()),e?(p("Player "+this.currPlayer+` picks from wall
`),P("Player "+this.currPlayer+" picks "+e.getText()+` from wall
`),this.table.players[this.currPlayer].hand.insertHidden(e),this.currPlayer===c.BOTTOM&&(e.addGlowEffect(this.scene,2003199,.7,10),setTimeout(()=>{e.removeGlowEffect(),this.table.players[c.BOTTOM].hand.sortSuitHidden(),this.table.players[c.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles(),this.state===f.LOOP_CHOOSE_DISCARD&&this.updateSwapBlankButton()},2e3)),this.table.players[this.currPlayer].showHand(this.currPlayer===c.BOTTOM),!0):!1}async chooseDiscard(){if(this.currPlayer===c.BOTTOM)return new Promise(e=>{const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=(function(){if(this.isSwappingBlank)return;const a=this.table.players[this.currPlayer].hand.removeDiscard(),o=a.getText();p("Player "+this.currPlayer+" discards "+o+` 
`);const r=[];r.push(a),e({playerOption:T.DISCARD_TILE,tileArray:r})}).bind(this),t.addEventListener("click",this.button1Function);const n=window.document.getElementById("button2");n.removeEventListener("click",this.button2Function),this.button2Function=(function(){this.isSwappingBlank||(this.table.exchangeUserSelectedTileForExposedJoker(),window.document.getElementById("button2").disabled=!0)}).bind(this),n.addEventListener("click",this.button2Function);const i=window.document.getElementById("button3");i.removeEventListener("click",this.button3Function),this.button3Function=(function(){this.isSwappingBlank||(this.table.players[this.currPlayer].hand.resetSelection(),e({playerOption:T.MAHJONG,tileArray:[]}))}).bind(this),i.addEventListener("click",this.button3Function)});{const e=await this.gameAI.chooseDiscard(this.currPlayer);if(e.playerOption===T.DISCARD_TILE){const t=e.tileArray[0].getText();p("Player "+this.currPlayer+" discards "+t+` 
`)}return e}}canPlayerClaimExposure(e,t){const i=this.table.players[e].hand.getHiddenTileArray();let s=0;for(const a of i)(a.suit===m.JOKER||a.suit===t.suit&&a.number===t.number)&&s++;return s>=2}canPlayerMahjongWithDiscard(e,t){const n=this.table.players[e].hand.dupHand();return n.insertHidden(t),this.card.validateHand14(n).valid}async claimDiscard(e,t){if(this.currPlayer===e)return new Promise(a=>{const o=[];o.push(t),a({playerOption:T.DISCARD_TILE,tileArray:o})});if(e!==c.BOTTOM)return this.gameAI.claimDiscard(e,t);const n=this.canPlayerMahjongWithDiscard(e,t),i=this.canPlayerClaimExposure(e,t);if(!n&&!i)return{playerOption:T.DISCARD_TILE,tileArray:[t]};this.state=f.LOOP_QUERY_CLAIM_DISCARD;const s=await this.yesNoQuery();if(this.state=f.LOOP_QUERY_CLAIM_DISCARD_COMPLETE,s){this.state=f.LOOP_EXPOSE_TILES,this.discardTile=t;const a=await this.exposeTiles();switch(this.state=f.LOOP_EXPOSE_TILES_COMPLETE,a.playerOption){case T.EXPOSE_TILES:return new Promise(o=>{a.tileArray.push(t),o({playerOption:T.EXPOSE_TILES,tileArray:a.tileArray})});case T.MAHJONG:return new Promise(o=>{o({playerOption:T.MAHJONG,tileArray:[]})});default:return p(`ERROR - unknown discardOption
`),new Promise(o=>{o({playerOption:T.DISCARD_TILE,tileArray:[t]})})}}return new Promise(a=>{a({playerOption:T.DISCARD_TILE,tileArray:[t]})})}yesNoQuery(){return new Promise(e=>{const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=(function(){this.isSwappingBlank||(t.removeEventListener("click",this.button1Function),n.removeEventListener("click",this.button2Function),e(!1))}).bind(this),t.addEventListener("click",this.button1Function);const n=window.document.getElementById("button2");n.removeEventListener("click",this.button2Function),this.button2Function=(function(){this.isSwappingBlank||(t.removeEventListener("click",this.button1Function),n.removeEventListener("click",this.button2Function),e(!0))}).bind(this),n.addEventListener("click",this.button2Function)})}charlestonPass(e){return new Promise(t=>{const n=["self","right","across","left"];x("Choose 3 tiles to pass "+n[e]);const i=window.document.getElementById("button1");i.removeEventListener("click",this.button1Function),this.button1Function=(async function(){const a=[];a[0]=this.table.players[0].hand.getSelectionHidden(),this.table.players[0].hand.resetSelection();for(const l of a[0])this.table.players[0].hand.removeHidden(l);const o=await Promise.all([this.gameAI.charlestonPass(1),this.gameAI.charlestonPass(2),this.gameAI.charlestonPass(3)]);a[1]=o[0],a[2]=o[1],a[3]=o[2];const r=this.table.charlestonPass(e,a);if(p("Pass "+n[e]+` complete
`),r&&r.length>0){for(const l of r)l.addGlowEffect(this.scene,2003199,.7,10);setTimeout(()=>{for(const l of r)l.removeGlowEffect();this.table.players[c.BOTTOM].hand.sortSuitHidden(),this.table.players[c.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles()},2e3)}t()}).bind(this),i.addEventListener("click",this.button1Function)})}exposeTiles(){return new Promise(e=>{const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=(function(){const a=this.playerExposeTiles();a&&e({playerOption:T.EXPOSE_TILES,tileArray:a})}).bind(this),t.addEventListener("click",this.button1Function);const n=window.document.getElementById("button2");n.removeEventListener("click",this.button2Function),this.button2Function=(function(){this.table.players[c.BOTTOM].hand.resetSelection(),e({playerOption:T.DISCARD_TILE,tileArray:[]})}).bind(this),n.addEventListener("click",this.button2Function);const i=window.document.getElementById("button3");i.removeEventListener("click",this.button3Function),this.button3Function=(function(){if(this.table.players[c.BOTTOM].hand.hasBlankTiles()){this.displayErrorText("Cannot declare Mahjong while holding blank tiles");return}this.table.players[c.BOTTOM].hand.resetSelection(),e({playerOption:T.MAHJONG,tileArray:[]})}).bind(this),i.addEventListener("click",this.button3Function)})}playerExposeTiles(){const t=this.table.players[c.BOTTOM].hand.getSelectionHidden();if(t.length<2||t.length>4)return this.displayErrorText("Invalid number of tiles selected for exposure. Select 2, 3, or 4 tiles."),null;for(const n of t)if(n.suit!==m.JOKER&&(n.suit!==this.discardTile.suit||n.number!==this.discardTile.number))return this.displayErrorText("Selected tiles must match the discarded tile or be jokers."),null;return t}courtesyQuery(){return new Promise(e=>{const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=function(){e(0)},t.addEventListener("click",this.button1Function);const n=window.document.getElementById("button2");n.removeEventListener("click",this.button2Function),this.button2Function=function(){e(1)},n.addEventListener("click",this.button2Function);const i=window.document.getElementById("button3");i.removeEventListener("click",this.button3Function),this.button3Function=function(){e(2)},i.addEventListener("click",this.button3Function);const s=window.document.getElementById("button4");s.removeEventListener("click",this.button4Function),this.button4Function=function(){e(3)},s.addEventListener("click",this.button4Function)})}courtesyPass(){return new Promise(e=>{x("Courtesy pass - select "+this.table.player02CourtesyVote+` tile(s)
`);const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=function(){e()},t.addEventListener("click",this.button1Function)})}updateUI(){const e=window.document.getElementById("button1"),t=window.document.getElementById("button2"),n=window.document.getElementById("button3"),i=window.document.getElementById("button4"),s=window.document.getElementById("start"),a=window.document.getElementById("sort1"),o=window.document.getElementById("sort2"),r=window.document.getElementById("numTileSelect"),l=window.document.getElementById("skipCharlestonCheckbox");switch(this.state){case f.INIT:p(`American Mahjong v1.00
`),p(`Press Start Game button
`),a.style.display="none",o.style.display="none",window.document.getElementById("controldiv").style.visibility="visible",window.document.getElementById("uicenterdiv").style.visibility="hidden";for(let d=1;d<=14;d++){const g=window.document.createElement("option");g.text=d,r.add(g)}r.selectedIndex=8,l.checked=!0,this.updateTrainingForm(),this.hintAnimationManager.clearAllGlows(),this.hintAnimationManager.savedGlowData=null;{const d=window.document.getElementById("hint-toggle"),g=window.document.getElementById("hint-content"),y=window.document.getElementById("hintdiv");d.addEventListener("click",()=>{const h=d.getAttribute("aria-expanded")==="true";d.setAttribute("aria-expanded",!h),g.classList.toggle("hidden"),h?this.hintAnimationManager.clearAllGlows():this.hintAnimationManager.restoreGlowEffects()}),y.style.display="none"}break;case f.START:this.scene.updateWallTileCounter(this.table.wall.getCount()),p(`Game started
`),s.disabled=!0,a.style.display="",o.style.display="",this.disableSortButtons(),e.style.display="none",t.style.display="none",n.style.display="none",i.style.display="none",window.document.getElementById("uicenterdiv").style.visibility="visible",window.document.getElementById("buttondiv").style.visibility="visible",window.document.getElementById("info").style.visibility="visible",this.disableTrainingForm(),window.document.getElementById("hintdiv").style.display="";break;case f.DEAL:p(`Shuffling wall
`),p(`Dealing hands
`),this.enableSortButtons();break;case f.CHARLESTON1:p(`Starting Charleston #1
`),e.innerText="Pass Tiles",e.disabled=!0,e.style.display="";break;case f.CHARLESTON_QUERY:p(`Charleston #1 complete
`),x("Continue Charleston?"),e.innerText="No",e.disabled=!1,e.style.display="",t.innerText="Yes",t.disabled=!1,t.style.display="";break;case f.CHARLESTON_QUERY_COMPLETE:break;case f.CHARLESTON2:p(`Starting Charleston #2
`),e.innerText="Pass Tiles",e.disabled=!0,e.style.display="",t.style.display="none";break;case f.COURTESY_QUERY:p(`Charleston #2 complete
`),x("Choose number of tiles for courtesy exchange"),e.innerText="0",e.disabled=!1,e.style.display="",t.innerText="1",t.disabled=!1,t.style.display="",n.innerText="2",n.disabled=!1,n.style.display="",i.innerText="3",i.disabled=!1,i.style.display="";break;case f.COURTESY_QUERY_COMPLETE:t.style.display="none",n.style.display="none",i.style.display="none";break;case f.COURTESY:p(`Courtesy pass
`),e.innerText="Pass Tiles",e.disabled=!0,e.style.display="";break;case f.COURTESY_COMPLETE:p(`Courtesy pass complete
`),e.disabled=!0,e.removeEventListener("click",this.button1Function);break;case f.LOOP_PICK_FROM_WALL:this.updateSwapBlankButton();break;case f.LOOP_CHOOSE_DISCARD:x(`Select one tile to discard or declare Mahjong
`),e.innerText="Discard",e.disabled=!0,e.style.display="",t.innerText="Exchange joker",t.disabled=!0,t.style.display="",n.innerText="Mahjong!",n.disabled=!1,n.style.display="",this.updateSwapBlankButton();break;case f.LOOP_QUERY_CLAIM_DISCARD:x("Claim discard?"),e.innerText="No",e.disabled=!1,e.style.display="",t.innerText="Yes",t.disabled=!1,t.style.display="",n.style.display="none",this.updateSwapBlankButton();break;case f.LOOP_QUERY_CLAIM_DISCARD_COMPLETE:break;case f.LOOP_EXPOSE_TILES:x("Form a pung/kong/quint with claimed tile"),e.innerText="Expose tiles",e.disabled=!0,e.style.display="",t.innerText="Return claimed discard",t.disabled=!1,t.style.display="",n.innerText="Mahjong!",n.disabled=!1,n.style.display="";break;case f.LOOP_EXPOSE_TILES_COMPLETE:t.style.display="none",n.style.display="none",i.style.display="none";break;case f.END:if(p(`===============================
`),this.gameResult.mahjong){const d=this.table.players[this.gameResult.winner].hand;if(this.card.validateHand14(d).valid){const y=this.card.rankHandArray14(d);this.card.sortHandRankArray(y);let h="Game over - Mahjong by player "+this.gameResult.winner;p(h+`
`),x(h),h="Group = "+y[0].group.groupDescription+`
`,p(h),h="Hand = "+y[0].hand.description+`
`,p(h),d.sortSuitHidden(),this.table.players[this.gameResult.winner].showHand(!0)}else{const y=this.card.diagnoseInvalidHand(d);let h="Game over - Invalid Mahjong by player "+this.gameResult.winner;p(h+`
`),x(h),h="Closest hand: "+y.closestGroup+" - "+y.closestHand,p(h+`
`),x(h),h="Rank: "+y.rank.toFixed(2)+"% match",p(h+`
`),d.sortSuitHidden(),this.table.players[this.gameResult.winner].showHand(!0),this.highlightInvalidMahjongTiles(y)}}else{const d="Game over - Wall game";p(d+`
`),x(d);for(let g=0;g<4;g++){const y=this.table.players[g];y.hand.sortSuitHidden(),y.showHand(!0)}}p(`===============================
`),p(`Click 'Start Game' to play again
`),e.style.display="none",t.style.display="none",n.style.display="none",i.style.display="none",this.disableSortButtons(),a.style.display="none",o.style.display="none",this.enableTrainingForm(),window.document.getElementById("controldiv").style.visibility="visible",s.style.display="",s.disabled=!1;break;default:p(`ERROR - updateUI - unknown state
`);break}}updateSwapBlankButton(){if(!window.settingsManager||!window.settingsManager.getUseBlankTiles()){window.document.getElementById("button4").style.display="none";return}const n=this.table.players[c.BOTTOM].hand.getHiddenTileArray().some(o=>o.suit===m.BLANK),s=this.table.discards.tileArray.some(o=>o.suit!==m.JOKER),a=window.document.getElementById("button4");n&&s?(a.innerText="Swap Blank",a.disabled=!1,a.style.display="",a.removeEventListener("click",this.button4Function),this.button4Function=(function(){this.initiateBlankSwap()}).bind(this),a.addEventListener("click",this.button4Function)):a.style.display="none"}initiateBlankSwap(){this.isSwappingBlank=!0,this.disableAllButtons();const t=this.table.players[c.BOTTOM].hand.getHiddenTileArray().filter(a=>a.suit===m.BLANK);if(t.length===0){this.displayErrorText("No blank tiles in hand"),this.isSwappingBlank=!1,this.enableAllButtons();return}if(this.table.discards.getSelectableDiscards().length===0){this.displayErrorText("No tiles available to swap for"),this.isSwappingBlank=!1,this.enableAllButtons();return}this.displayErrorText("Click a blank tile to swap, then select a discard tile");const i={tile:null},s=a=>()=>{i.tile&&i.tile.sprite.clearTint(),i.tile=a,a.sprite.setTint(43520),this.table.discards.enableDiscardSelection(o=>{this.swapBlankForDiscard(a,o)})};for(const a of t)a.sprite.setInteractive(),a.sprite.setTint(65280),a.sprite.on("pointerup",s(a))}swapBlankForDiscard(e,t){P("Swapping blank tile for discard tile:",t.getText());const n=this.table.players[c.BOTTOM].hand;n.removeHidden(e),this.table.discards.removeDiscardTile(t),t.sprite&&(t.sprite.destroy(),t.sprite=null),t.spriteBack&&(t.spriteBack.destroy(),t.spriteBack=null),t.mask&&t.mask.geometryMask&&(t.mask.geometryMask.destroy(),t.mask=null),t.create(),n.insertHidden(t),e.sprite&&(e.sprite.destroy(),e.sprite=null),e.spriteBack&&(e.spriteBack.destroy(),e.spriteBack=null),e.mask&&e.mask.geometryMask&&(e.mask.geometryMask.destroy(),e.mask=null),e.create(),this.table.discards.insertDiscard(e),this.table.discards.disableDiscardSelection();const i=n.getHiddenTileArray().filter(s=>s.suit===m.BLANK);for(const s of i)s.sprite.clearTint(),s.sprite.removeInteractive(),s.sprite.off("pointerup");n.sortSuitHidden(),this.table.players[c.BOTTOM].showHand(!0),this.table.discards.showDiscards(),this.isSwappingBlank=!1,this.hintAnimationManager.updateHintsForNewTiles(),this.displayErrorText("Blank swapped successfully! Select a tile to discard.")}enableSortButtons(){const e=window.document.getElementById("sort1"),t=window.document.getElementById("sort2");e.disabled=!1,t.disabled=!1,this.sort1Function&&(e.removeEventListener("click",this.sort1Function),this.sort1Function=null),this.sort2Function&&(t.removeEventListener("click",this.sort2Function),this.sort2Function=null),this.sort1Function=(function(){this.table.players[c.BOTTOM].hand.sortSuitHidden(),this.table.players[c.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles()}).bind(this),this.sort2Function=(function(){this.table.players[c.BOTTOM].hand.sortRankHidden(),this.table.players[c.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles()}).bind(this),e.addEventListener("click",this.sort1Function),t.addEventListener("click",this.sort2Function)}disableSortButtons(){const e=window.document.getElementById("sort1"),t=window.document.getElementById("sort2");e.disabled=!0,t.disabled=!0,this.sort1Function&&(e.removeEventListener("click",this.sort1Function),this.sort1Function=null),this.sort2Function&&(t.removeEventListener("click",this.sort2Function),this.sort2Function=null)}getTrainingInfo(){const e=window.document.getElementById("trainCheckbox"),t=window.document.getElementById("handSelect"),n=window.document.getElementById("numTileSelect"),i=window.document.getElementById("skipCharlestonCheckbox"),s={trainCheckbox:!1,handDescription:"",numTiles:0,skipCharlestonCheckbox:!1};return s.trainCheckbox=e.checked,s.handDescription=t.value,s.numTiles=parseInt(n.value,10),s.skipCharlestonCheckbox=i.checked,s}updateTrainingForm(){const e=this.getTrainingInfo(),t=window.document.getElementById("trainfieldset2");t.disabled=!e.trainCheckbox}enableTrainingForm(){const e=window.document.getElementById("trainfieldset1");e.disabled=!1,this.updateTrainingForm()}disableTrainingForm(){const e=window.document.getElementById("trainfieldset1"),t=window.document.getElementById("trainfieldset2");e.disabled=!0,t.disabled=!0}displayErrorText(e){this.errorTextArray.length&&e===this.errorTextArray[this.errorTextArray.length-1]||(this.errorTextSemaphore===0?(this.errorTextSemaphore++,this.errorTextArray.push(e),this.displayAllError()):(this.errorTextSemaphore++,this.errorTextArray.push(e)))}highlightInvalidMahjongTiles(e){for(const t of e.matchingTiles)t.addGlowEffect(this.scene,65280,.7);for(const t of e.nonMatchingTiles)t.addGlowEffect(this.scene,16711680,.7)}async displayAllError(){for(this.errorText.visible=!0;this.errorTextSemaphore;){const e=this.errorTextArray.shift();this.errorText.setText(e),await _(4e3),this.errorTextSemaphore--}this.errorText.visible=!1}sequentialDealTiles(e,t){this.table.wall.shuffle(),this.table.applyTrainingHands(e);const n=[[c.BOTTOM,4],[c.RIGHT,4],[c.TOP,4],[c.LEFT,4],[c.BOTTOM,4],[c.RIGHT,4],[c.TOP,4],[c.LEFT,4],[c.BOTTOM,4],[c.RIGHT,4],[c.TOP,4],[c.LEFT,4],[c.BOTTOM,1],[c.RIGHT,1],[c.TOP,1],[c.LEFT,1],[c.BOTTOM,1]];let i=0;const s=()=>{if(i>=n.length){this.table.finalizeInitialHands(),t&&t();return}const[a,o]=n[i];for(let d=0;d<o;d++){const g=this.table.wall.remove();if(!g)throw new Error("No tiles remaining in wall during dealing sequence");this.table.players[a].hand.insertHidden(g)}this.table.players[a].showHand(!1),this.scene.updateWallTileCounter(this.table.wall.getCount());const r=this.table.players[a].hand,l=r.hiddenTileSet.tileArray[r.hiddenTileSet.tileArray.length-1];l&&l.tween?l.tween.once("complete",()=>{i++,this.scene.time.delayedCall(150,s)}):(i++,this.scene.time.delayedCall(150,s))};s()}disableAllButtons(){const e=window.document.getElementById("button1"),t=window.document.getElementById("button2"),n=window.document.getElementById("button3"),i=window.document.getElementById("button4");e&&(e.disabled=!0),t&&(t.disabled=!0),n&&(n.disabled=!0),i&&(i.disabled=!0)}enableAllButtons(){const e=window.document.getElementById("button1"),t=window.document.getElementById("button2"),n=window.document.getElementById("button3"),i=window.document.getElementById("button4");e&&(e.disabled=!1),t&&(t.disabled=!1),n&&(n.disabled=!1),i&&(i.disabled=!1)}}class ae{constructor(e,t,n){this.playerInfo=n;const i=n.id===c.BOTTOM;this.hand=new J(e,t,i)}create(){}showHand(e){this.hand.showHand(this.playerInfo,e)}}const oe=[{id:c.BOTTOM,x:200,y:600,angle:0,rectX:0,rectY:600-k/2,rectWidth:v,rectHeight:k},{id:c.RIGHT,x:1e3,y:520,angle:270,rectX:1e3-k*D/2,rectY:0,rectWidth:k*D,rectHeight:L},{id:c.TOP,x:750,y:50,angle:180,rectX:0,rectY:50-k*D/2,rectWidth:v,rectHeight:k*D},{id:c.LEFT,x:50,y:50,angle:90,rectX:50-k*D/2,rectY:0,rectWidth:k*D,rectHeight:L}];class re{constructor(e,t){this.scene=e,this.gameLogic=t,this.wall=new j(e),this.discards=new K,this.boxes=[];for(let n=0;n<4;n++)this.boxes[n]=null;this.players=[];for(let n=0;n<4;n++)this.players[n]=new ae(e,t,oe[n]);this.player02CourtesyVote=0,this.player13CourtesyVote=0}create(e=!1){for(let t=0;t<4;t++){const n=this.scene.add.graphics(0,0);this.boxes[t]=n}this.wall.create(e)}reset(){for(let t=0;t<4;t++)this.players[t].hand.reset(this.wall);for(;this.discards.tileArray.length;)this.wall.insert(this.discards.tileArray.pop());const e=G();this.wall.tileArray.length!==e&&p("ERROR - table.reset() - total tile count is not "+e+". Tile count = "+this.wall.tileArray.length+`
`)}switchPlayer(e){for(let t=0;t<4;t++)this.boxes[t].visible=!1;this.boxes[e].visible=!0}applyTrainingHands(e){for(let t=0;t<4;t++){const n=e[t];if(n){for(let i=0;i<n.hiddenTileSet.getLength();i++){const s=n.hiddenTileSet.tileArray[i],a=this.wall.findAndRemove(s);a&&this.players[t].hand.insertHidden(a)}for(const i of n.exposedTileSetArray){const s=[];for(let a=0;a<i.getLength();a++){const o=i.tileArray[a],r=this.wall.findAndRemove(o);r&&s.push(r)}this.players[t].hand.insertExposed(s)}}}}finalizeInitialHands(){for(let e=0;e<4;e++)this.players[e].hand.sortSuitHidden(),e===c.BOTTOM?this.players[e].showHand(!0):this.players[e].showHand(!1)}deal(e){this.applyTrainingHands(e);for(let t=0;t<4;t++){let n=13;t===0&&(n=14);const i=n-this.players[t].hand.getLength();for(let s=0;s<i;s++){const a=this.wall.remove();this.players[t].hand.insertHidden(a)}}this.finalizeInitialHands(),this.gameLogic.scene.updateWallTileCounter(this.wall.getCount())}charlestonPass(e,t){const n=e-c.BOTTOM,i=[];for(let s=0;s<4;s++){const a=s;let o=s+n;o>3&&(o-=4);for(const r of t[a])this.players[o].hand.insertHidden(r),o===c.BOTTOM&&i.push(r)}for(let s=0;s<4;s++)s!==0&&this.players[s].hand.sortSuitHidden(),this.players[s].showHand(s===c.BOTTOM);return i}courtesyVote(e){this.player02CourtesyVote=Math.min(e[0],e[2]),this.player13CourtesyVote=Math.min(e[1],e[3])}courtesyPass(e){const n=[];for(let i=0;i<4;i++){const s=i;let a=i+2;a>3&&(a-=4);for(const o of e[s])this.players[a].hand.insertHidden(o),a===c.BOTTOM&&n.push(o)}for(let i=0;i<4;i++)i!==0&&this.players[i].hand.sortSuitHidden(),this.players[i].showHand(i===c.BOTTOM);return n}processClaimArray(e,t,n){let i=0,s=0;for(let r=0;r<4;r++)switch(t[r].playerOption){case T.EXPOSE_TILES:break;case T.DISCARD_TILE:i++;break;case T.MAHJONG:s++;break;default:p(`ERROR - processClaimArray. Unknown claim type
`);break}if(i===4)return this.discards.insertDiscard(n),this.discards.showDiscards(),{playerOption:T.DISCARD_TILE,winningPlayer:0};let a=T.EXPOSE_TILES;s&&(a=T.MAHJONG);let o=e;for(let r=0;r<3&&(o++,o>3&&(o=0),t[o].playerOption!==a);r++);if(a===T.MAHJONG)this.players[o].hand.insertHidden(n);else{const r=t[o].tileArray,l=this.players[o].hand,d=[],g=[...l.getHiddenTileArray()];for(const y of r)if(y!==n){const h=g.findIndex(S=>S.suit===y.suit&&S.number===y.number);h!==-1&&(d.push(g[h]),g.splice(h,1))}for(const y of d)l.removeHidden(y);l.insertExposed(r)}return this.players[o].showHand(o===c.BOTTOM),{playerOption:a,winningPlayer:o}}exchangeUserSelectedTileForExposedJoker(){const e=this.players[c.BOTTOM].hand.removeDiscard(),t=e.getText();p("Player 0 exchanged "+t+` for joker
`);for(let n=0;n<4;n++)for(const i of this.players[n].hand.exposedTileSetArray)if(i.getSelectionCount()===1){const a=i.getSelection()[0];i.resetSelection(),i.remove(a),this.players[c.BOTTOM].hand.insertHidden(a),i.insert(e);break}for(let n=0;n<4;n++)this.players[n].showHand(n===c.BOTTOM)}getExposedJokerArray(){const e=[];for(let t=0;t<4;t++)for(const n of this.players[t].hand.exposedTileSetArray){let i=null;for(const s of n.tileArray)if(s.suit!==m.JOKER){i=s;break}if(i)for(const s of n.tileArray)s.suit===m.JOKER&&e.push(i)}return e}exchangeJoker(e,t,n){e:for(let i=0;i<4;i++)for(const s of this.players[i].hand.exposedTileSetArray){let a=null;for(const o of s.tileArray)if(o.suit!==m.JOKER){a=o;break}if(a&&a.suit===n.suit&&a.number===n.number){for(const o of s.tileArray)if(o.suit===m.JOKER){const r=n.getText();p("Player "+e+" *exchanged* "+r+` for joker
`),t.removeHidden(n),s.insert(n),s.remove(o),t.insertHidden(o);for(let l=0;l<4;l++)this.players[l].showHand();break e}}}}}class le{constructor(e,t){this.scene=e,this.wall=t,this.tileArray=[],this.animationState="idle",this.isAnimating=!1,this.onAnimationComplete=null}createScatteredTiles(){const e=window.settingsManager?window.settingsManager.getUseBlankTiles():!1;let t=0;for(const n of X)if(!(n.suit===m.BLANK&&!e))for(const i of n.prefix)for(let s=1;s<=n.maxNum;s++){let a=s;n.maxNum===1&&(n.suit===m.FLOWER?a=0:a=n.prefix.indexOf(i));let o=i;n.maxNum!==1&&(o=s+o),o+=".png";for(let r=0;r<n.count;r++){const l=new H(this.scene,n.suit,a,o);l.create(),l.index=t++,this.tileArray.push(l)}}for(let n=0;n<this.tileArray.length;n++){const i=this.tileArray[n],{x:s,y:a,scale:o,angle:r}=this.generateRandomPosition();i.x=s,i.y=a,i.scale=o,i.angle=r,i.sprite.setDepth(n),i.showTile(!0,!1),Math.random()<.7&&i.showTile(!0,!0)}}generateRandomPosition(){const e=this.scene.sys.game.config.width/2,t=this.scene.sys.game.config.height/2,n=200,i=100;let s=0,a=0;for(;s===0;)s=Math.random();for(;a===0;)a=Math.random();let o=Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*a);const r=e+o*n;for(s=0,a=0;s===0;)s=Math.random();for(;a===0;)a=Math.random();o=Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*a);const l=t+o*i,d=b.Math.FloatBetween(.55,.65),g=b.Math.Between(-90,90);return{x:r,y:l,scale:d,angle:g}}async animateToPileAndStartGame(){this.isAnimating=!0,this.animationState="gathering",await this.animateJumpAndFlip(),await this.animateFlyOffScreen(),this.isAnimating=!1,this.animationState="complete",this.onAnimationComplete&&this.onAnimationComplete()}animateJumpAndFlip(){const e=[];return this.tileArray.forEach(t=>{e.push(new Promise(n=>{const i=t.y,s=b.Math.Between(5,15),a=b.Math.Between(0,150);t.withRaisedDepth(()=>{const o=this.scene.tweens.add({targets:{},duration:800+a,onComplete:()=>{}});return this.scene.tweens.add({targets:t,y:i-s,scale:.65,duration:400,ease:b.Math.Easing.Cubic.Out,delay:a}),this.scene.tweens.add({targets:t,y:i,scale:.6,duration:400,ease:b.Math.Easing.Cubic.In,delay:a+400}),o}),this.scene.tweens.add({targets:{scaleY:t.sprite.scaleY},scaleY:0,duration:400,ease:b.Math.Easing.Cubic.In,delay:a,onUpdate:o=>{t.sprite.scaleY=o.targets[0].scaleY,t.spriteBack.scaleY=o.targets[0].scaleY},onComplete:()=>{t.showTile(!0,!1),this.scene.tweens.add({targets:{scaleY:0},scaleY:.6,duration:400,ease:b.Math.Easing.Cubic.Out,onUpdate:o=>{t.sprite.scaleY=o.targets[0].scaleY,t.spriteBack.scaleY=o.targets[0].scaleY},onComplete:()=>{n()}})}})}))}),Promise.all(e)}animateFlyOffScreen(){const e=[];for(let i=0;i<this.tileArray.length;i+=20){const s=this.tileArray.slice(i,i+20);e.push(new Promise(a=>{this.scene.time.delayedCall(i/20*150,()=>{const o=s.map(r=>new Promise(l=>{const d=b.Math.Between(1200,2e3),g=b.Math.Between(-200,-50),y=b.Math.Between(-200,-50),h=b.Math.Between(r.x-100,r.x+100),S=b.Math.Between(r.y-200,r.y),w=new b.Curves.QuadraticBezier(new b.Math.Vector2(r.x,r.y),new b.Math.Vector2(h,S),new b.Math.Vector2(g,y)),E={t:0,vec:new b.Math.Vector2};this.scene.tweens.add({targets:E,t:1,duration:d,ease:"Cubic.In",onUpdate:()=>{w.getPoint(E.t,E.vec),r.x=E.vec.x,r.y=E.vec.y},onComplete:()=>{r.showTile(!1,!1),l()}})}));Promise.all(o).then(a)})}))}return Promise.all(e)}async transitionToWallSystem(){await this.wall.receiveOrganizedTilesFromHomePage(this.tileArray)}cleanup(){this.tileArray=[]}calculatePlayerHandPositions(){const e=[],n=Q*.6,i=k*.6;for(let s=0;s<13;s++)e.push({x:v/2-6.5*n+s*n,y:L-i-10,angle:0});for(let s=0;s<13;s++)e.push({x:v/2-6.5*n+s*n,y:i+10,angle:180});for(let s=0;s<13;s++)e.push({x:i+10,y:L/2-6.5*n+s*n,angle:-90});for(let s=0;s<13;s++)e.push({x:v-i-10,y:L/2-6.5*n+s*n,angle:90});return e}}class ce{constructor(e,t){this.scene=e,this.settingsManager=t,this.bgm=null,this.currentBGMKey=null,this.bgmVolume=this.settingsManager.getSetting("bgmVolume",.25),this.bgmMuted=this.settingsManager.getSetting("bgmMuted",!1),this.sfxVolume=this.settingsManager.getSetting("sfxVolume",.7),this.sfxMuted=this.settingsManager.getSetting("sfxMuted",!1)}playBGM(e){this.bgm&&this.bgm.isPlaying&&this.bgm.stop(),this.currentBGMKey=e,this.bgm=this.scene.sound.add(e,{loop:!0,volume:this.bgmMuted?0:this.bgmVolume}),this.bgm.play()}stopBGM(){this.bgm&&this.bgm.isPlaying&&this.bgm.stop()}setBGMVolume(e){this.bgmVolume=Math.max(0,Math.min(1,e)),this.bgm&&!this.bgmMuted&&this.bgm.setVolume(this.bgmVolume)}muteBGM(e){this.bgmMuted=e,this.bgm&&this.bgm.setVolume(this.bgmMuted?0:this.bgmVolume)}getBGMVolume(){return this.bgmVolume}isBGMMuted(){return this.bgmMuted}playSFX(e){this.sfxMuted||this.scene.sound.play(e,{volume:this.sfxVolume})}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}muteSFX(e){this.sfxMuted=e}getSFXVolume(){return this.sfxVolume}isSFXMuted(){return this.sfxMuted}destroy(){this.bgm&&(this.bgm.stop(),this.bgm.destroy())}}class de{constructor(e,t,n,i){this.gameController=e,this.scene=t,this.table=n,this.gameLogic=i,this.tileMap=new Map,this.pendingPromptCallback=null,this.currentPromptType=null,this.tilesRemovedFromWall=0,this.setupEventListeners()}setupEventListeners(){const e=this.gameController;e.on("STATE_CHANGED",t=>this.onStateChanged(t)),e.on("GAME_STARTED",t=>this.onGameStarted(t)),e.on("GAME_ENDED",t=>this.onGameEnded(t)),e.on("TILES_DEALT",t=>this.onTilesDealt(t)),e.on("TILE_DRAWN",t=>this.onTileDrawn(t)),e.on("TILE_DISCARDED",t=>this.onTileDiscarded(t)),e.on("DISCARD_CLAIMED",t=>this.onDiscardClaimed(t)),e.on("TILES_EXPOSED",t=>this.onTilesExposed(t)),e.on("JOKER_SWAPPED",t=>this.onJokerSwapped(t)),e.on("HAND_UPDATED",t=>this.onHandUpdated(t)),e.on("TURN_CHANGED",t=>this.onTurnChanged(t)),e.on("CHARLESTON_PHASE",t=>this.onCharlestonPhase(t)),e.on("CHARLESTON_PASS",t=>this.onCharlestonPass(t)),e.on("COURTESY_VOTE",t=>this.onCourtesyVote(t)),e.on("COURTESY_PASS",t=>this.onCourtesyPass(t)),e.on("MESSAGE",t=>this.onMessage(t)),e.on("UI_PROMPT",t=>this.onUIPrompt(t))}createPhaserTile(e){if(this.tileMap.has(e.index))return this.tileMap.get(e.index);const t=this.findTileInWall(e.index);if(t)return this.tileMap.set(e.index,t),t;console.warn(`Creating new tile for index ${e.index} - this shouldn't happen!`);const n=this.getTileSpriteName(e),i=new H(this.scene,e.suit,e.number,n);return i.index=e.index,i.create(),this.tileMap.set(e.index,i),i}findTileInWall(e){for(const t of this.table.wall.tileArray)if(t.index===e)return t;return null}findPhaserTile(e){return this.tileMap.get(e.index)||null}getTileSpriteName(e){const{suit:t,number:n}=e;return t===m.CRACK?`${n}C.png`:t===m.BAM?`${n}B.png`:t===m.DOT?`${n}D.png`:t===m.WIND?`${["N","S","W","E"][n]}.png`:t===m.DRAGON?`${["DC","DB","DD"][n]}.png`:t===m.FLOWER?`F${n%4+1}.png`:t===m.JOKER?"J.png":t===m.BLANK?"BLANK.png":`tile_${t}_${n}.png`}convertToPhaserTiles(e){return e.map(t=>this.createPhaserTile(t))}onStateChanged(e){const{oldState:t,newState:n}=e;console.log(`State: ${t}  ${n}`),this.gameLogic.state=n,this.updateButtonState(n)}updateButtonState(){this.hideButtons()}onGameStarted(){p("Game started!"),this.table.reset();const e=document.getElementById("start");e&&(e.style.display="none")}onGameEnded(e){const{reason:t,winner:n,mahjong:i}=e;if(i){const a=this.table.players[n];p(`${a.playerInfo.name} wins with Mahjong!`),this.scene.audioManager&&this.scene.audioManager.playFireworks()}else t==="wall_game"&&p("Wall game - no winner");const s=document.getElementById("start");s&&(s.style.display="block")}onTilesDealt(e){const t=e.players.reduce((i,s)=>i+s.tileCount,0),n=this.table.wall.getCount()-t;this.scene.updateWallTileCounter&&this.scene.updateWallTileCounter(n),p("Tiles dealt to all players")}onTileDrawn(e){const{player:t,tile:n}=e,i=this.table.players[t],s=A.fromJSON(n),a=this.createPhaserTile(s);a.sprite.setPosition(640,360),a.sprite.setAlpha(0),i.hand.insertHidden(a);const l=i.hand.calculateTilePosition(i.playerInfo,i.hand.hiddenTileSet.getLength()-1);if(this.scene.tweens.add({targets:a.sprite,x:l.x,y:l.y,alpha:1,duration:200,ease:"Power2",onComplete:()=>{i.showHand(t===c.BOTTOM)}}),this.tilesRemovedFromWall++,this.scene.updateWallTileCounter){const g=(this.gameController.settings.useBlankTiles?160:152)-this.tilesRemovedFromWall;this.scene.updateWallTileCounter(g)}t===c.BOTTOM&&x(`You drew: ${s.getText()}`)}onTileDiscarded(e){const{player:t,tile:n}=e,i=this.table.players[t],s=A.fromJSON(n),a=this.findPhaserTile(s);a&&(i.hand.removeHidden(a),this.table.discards.insertDiscard(a),this.table.discards.showDiscards(),p(`${i.playerInfo.name} discarded ${s.getText()}`))}onDiscardClaimed(e){const{player:t,tile:n,claimType:i}=e,s=A.fromJSON(n);p(`${this.table.players[t].playerInfo.name} claimed ${s.getText()} for ${i}`)}onTilesExposed(e){const{player:t,exposureType:n,tiles:i}=e,s=this.table.players[t],a=i.map(r=>this.findPhaserTile(A.fromJSON(r))),o=new window.TileSet(this.scene,this.gameLogic,!1);a.forEach(r=>{s.hand.hiddenTileSet.remove(r),o.insert(r)}),s.hand.exposedTileSetArray.push(o),s.showHand(t===0),p(`${s.playerInfo.name} exposed ${n}: ${a.length} tiles`)}onJokerSwapped(e){this.handleJokerSwap(e)}handleJokerSwap(e={}){const{player:t,exposureIndex:n=0,jokerIndex:i=null,replacementTile:s,recipient:a=c.BOTTOM}=e;if(typeof t!="number"){p("JOKER_SWAPPED event missing player index");return}const o=this.table.players[t];if(!o||!o.hand){p(`JOKER_SWAPPED ignore: player ${t} missing hand`);return}const l=(o.hand.exposedTileSetArray||[])[n];if(!l){p(`JOKER_SWAPPED ignore: exposure ${n} missing for player ${t}`);return}const d=this.findJokerTile(l,i);if(!d){p(`JOKER_SWAPPED ignore: joker index ${i??"auto"} missing for player ${t}`);return}l.remove(d);const g=s instanceof A?s:s?A.fromJSON(s):null;if(g){const h=this.createPhaserTile(g);h&&(h.showTile(!0,!0),l.insert(h))}const y=this.table.players[a]||this.table.players[c.BOTTOM];y&&y.hand?y.hand.insertHidden(d):this.table.wall.insert(d),this.table.players.forEach((h,S)=>{h.showHand(S===c.BOTTOM)}),g?x(`${o.playerInfo.name} swapped a joker for ${g.getText()}`):x(`${o.playerInfo.name} joker swap complete`)}findJokerTile(e,t){if(!e||!Array.isArray(e.tileArray))return null;if(typeof t=="number"){const n=e.tileArray.find(i=>i.index===t);if(n)return n}return e.tileArray.find(n=>n.suit===m.JOKER)||null}onHandUpdated(e){const{player:t,hand:n}=e;console.log(`Hand updated for player ${t}: ${n.tiles.length} hidden, ${n.exposures.length} exposed`),t===c.BOTTOM&&this.gameLogic.hintAnimationManager&&this.gameLogic.hintAnimationManager.updateHintsForNewTiles()}onTurnChanged(e){const{currentPlayer:t}=e;this.table.switchPlayer(t);const n=this.table.players[t];p(`${n.playerInfo.name}'s turn`)}onCharlestonPhase(e){const{phase:t,passCount:n,direction:i}=e;p(`Charleston Phase ${t}, Pass ${n}: Pass ${i}`)}onCharlestonPass(e){const{player:t,direction:n}=e,i=this.table.players[t];p(`${i.playerInfo.name} passed 3 tiles ${n}`)}onCourtesyVote(e){const{player:t,vote:n}=e,i=this.table.players[t];p(`${i.playerInfo.name} voted ${n?"YES":"NO"} for courtesy pass`)}onCourtesyPass(e){const{fromPlayer:t,toPlayer:n,tile:i}=e,s=A.fromJSON(i);p(`Courtesy pass: ${this.table.players[t].playerInfo.name}  ${this.table.players[n].playerInfo.name} (${s.getText()})`)}onMessage(e){const{text:t,type:n}=e;if(n==="info")x(t);else if(n==="error")p(`ERROR: ${t}`);else if(n==="hint"){const i=document.getElementById("hint-content");if(i){const s=document.createElement("div");s.className="hint-message",s.textContent=t,i.appendChild(s),i.scrollTop=i.scrollHeight}}else p(t)}onUIPrompt(e){const{promptType:t,options:n,callback:i}=e;this.pendingPromptCallback=i,this.currentPromptType=t;const s=document.getElementById("info"),a=document.getElementById("buttondiv");s&&(s.style.visibility="visible"),a&&(a.style.visibility="visible"),t==="CHOOSE_DISCARD"?this.setupDiscardPrompt(n):t==="CLAIM_DISCARD"?this.setupClaimPrompt(n):t==="CHARLESTON_PASS"?this.setupCharlestonPassPrompt(n):t==="CHARLESTON_CONTINUE"?this.setupCharlestonContinuePrompt(n):t==="COURTESY_VOTE"&&this.setupCourtesyVotePrompt(n)}setupDiscardPrompt(){const e=this.table.players[c.BOTTOM];x("Select a tile to discard"),e.hand.enableTileSelection(t=>{if(this.pendingPromptCallback){const n=A.fromPhaserTile(t);this.pendingPromptCallback(n),this.pendingPromptCallback=null,this.currentPromptType=null}})}setupClaimPrompt(e){const{tile:t,options:n}=e,i=A.fromJSON(t);x(`Claim ${i.getText()}?`);const s=["button1","button2","button3","button4"],a=["Mahjong","Pung","Kong","Pass"];s.forEach((o,r)=>{const l=document.getElementById(o),d=a[r];n.includes(d)||d==="Pass"?(l.textContent=d,l.disabled=!1,l.style.display="block",l.onclick=()=>this.respondToClaim(d)):(l.style.display="none",l.disabled=!0,l.onclick=null)})}respondToClaim(e){this.pendingPromptCallback&&(this.pendingPromptCallback(e),this.pendingPromptCallback=null,this.currentPromptType=null),this.hideButtons()}setupCharlestonPassPrompt(e){const{direction:t,requiredCount:n}=e,i=this.table.players[c.BOTTOM];x(`Choose ${n} tiles to pass ${t}`);const s=document.getElementById("button1");s.textContent="Pass",s.disabled=!0,s.style.display="block";const a=()=>{i.hand.hiddenTileSet.getSelection().length===n?s.disabled=!1:s.disabled=!0};s.onclick=()=>{const r=i.hand.hiddenTileSet.getSelection();if(r.length===n&&this.pendingPromptCallback){const l=r.map(d=>A.fromPhaserTile(d));i.hand.hiddenTileSet.resetSelection(),this.pendingPromptCallback(l),this.pendingPromptCallback=null,this.currentPromptType=null,this.hideButtons()}};const o=window.setInterval(()=>{if(this.currentPromptType!=="CHARLESTON_PASS"){window.clearInterval(o);return}a()},100);document.getElementById("button2").style.display="none",document.getElementById("button3").style.display="none",document.getElementById("button4").style.display="none"}setupCharlestonContinuePrompt(e){const{question:t}=e;x(t);const n=document.getElementById("button1"),i=document.getElementById("button2");n.textContent="Yes",n.disabled=!1,n.style.display="block",n.onclick=()=>this.respondYesNo("Yes"),i.textContent="No",i.disabled=!1,i.style.display="block",i.onclick=()=>this.respondYesNo("No"),document.getElementById("button3").style.display="none",document.getElementById("button4").style.display="none"}setupCourtesyVotePrompt(e){const{question:t}=e;x(t);const n=document.getElementById("button1"),i=document.getElementById("button2");n.textContent="Yes",n.disabled=!1,n.style.display="block",n.onclick=()=>this.respondYesNo("Yes"),i.textContent="No",i.disabled=!1,i.style.display="block",i.onclick=()=>this.respondYesNo("No"),document.getElementById("button3").style.display="none",document.getElementById("button4").style.display="none"}respondYesNo(e){this.pendingPromptCallback&&(this.pendingPromptCallback(e),this.pendingPromptCallback=null,this.currentPromptType=null),this.hideButtons()}hideButtons(){["button1","button2","button3","button4"].forEach(i=>{const s=document.getElementById(i);s&&(s.style.display="none",s.disabled=!0,s.onclick=null)});const t=document.getElementById("info"),n=document.getElementById("buttondiv");t&&(t.style.visibility="hidden"),n&&(n.style.visibility="hidden")}destroy(){this.gameController.clear(),this.tileMap.clear(),this.pendingPromptCallback=null}}const he="/mahjong/assets/tiles-imJ8iwem.png",ue=[{filename:"1B.png",frame:{x:0,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"1C.png",frame:{x:52,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"1D.png",frame:{x:104,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2B.png",frame:{x:156,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2C.png",frame:{x:208,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2D.png",frame:{x:260,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3B.png",frame:{x:312,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3C.png",frame:{x:364,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3D.png",frame:{x:416,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4B.png",frame:{x:468,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4C.png",frame:{x:520,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4D.png",frame:{x:572,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5B.png",frame:{x:624,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5C.png",frame:{x:676,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5D.png",frame:{x:728,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6B.png",frame:{x:780,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6C.png",frame:{x:832,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6D.png",frame:{x:884,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7B.png",frame:{x:936,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7C.png",frame:{x:988,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7D.png",frame:{x:1040,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8B.png",frame:{x:1092,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8C.png",frame:{x:1144,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8D.png",frame:{x:1196,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9B.png",frame:{x:1248,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9C.png",frame:{x:1300,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9D.png",frame:{x:1352,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DB.png",frame:{x:1404,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DC.png",frame:{x:1456,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DD.png",frame:{x:1508,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"E.png",frame:{x:1560,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F1.png",frame:{x:1612,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F2.png",frame:{x:1664,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F3.png",frame:{x:1716,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F4.png",frame:{x:1768,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"J.png",frame:{x:1820,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"N.png",frame:{x:1872,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"S.png",frame:{x:1924,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"W.png",frame:{x:1976,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}}],me={app:"https://www.codeandweb.com/texturepacker",version:"1.0",image:"tiles.png",format:"RGBA8888",size:{w:2028,h:69},scale:"1",smartupdate:"$TexturePacker:SmartUpdate:baa73215de891ffd3d2987c3955d687c:7fb101c424dd8f5d293fdd929aadebef:accbe1e7e294ded8391337fc1c446319$"},ge={frames:ue,meta:me},pe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADQAAABFCAYAAAAFBsWPAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAAJBJREFUaEPt27ENgCAUBmFwGhNqo8Nq4zKiTiOxx4YhTnJf9ed1N8CL+7bWMaXQg/cpIV75qNO8tNO/3WcOQ9vdMIjOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6Ayi6y6osx+8Ej5OSBM+UQfkQgAAAABJRU5ErkJggg==";class ye extends b.Scene{constructor(){super({key:"GameScene"}),this.commandBarManualPosition=!1,this.commandBarPosition=null,this.homePageTileManager=null}preload(){this.load.atlas("tiles",he,ge),this.load.image("back",pe);const e=document.createElement("canvas");e.width=4,e.height=4;const t=e.getContext("2d");t&&(t.fillStyle="white",t.fillRect(0,0,4,4)),this.textures.addCanvas("particle",e),this.load.audio("bgm","./assets/audio/2406haidao_bgm_loop.mp3"),this.load.audio("rack_tile","./assets/audio/rack_tile.mp3"),this.load.audio("tile_dropping","./assets/audio/tile_dropping.mp3"),this.load.audio("fireworks","./assets/audio/fireworks.mp3")}async create(){this.input.dragDistanceThreshold=20,this.scale.on("resize",this.resize,this),this.audioManager=new ce(this,window.settingsManager),this.gGameLogic=new se(this),this.gTable=new re(this,this.gGameLogic),this.gGameLogic.table=this.gTable,await this.gGameLogic.init(),this.gGameLogic.gameAI.table=this.gTable,this.gameController=new q,await this.gameController.init({aiEngine:this.gGameLogic.gameAI,cardValidator:this.gGameLogic.card,settings:{year:window.settingsManager.getCardYear(),difficulty:window.settingsManager.getDifficulty(),useBlankTiles:window.settingsManager.getUseBlankTiles(),skipCharleston:window.settingsManager.getSetting("skipCharleston",!1)}}),this.adapter=new de(this.gameController,this,this.gTable,this.gGameLogic),window.gameController=this.gameController,this.gGameLogic.wallCounter=this.createWallTileCounter(),this.gGameLogic.errorText=this.add.text(400,400,"",{font:"14px Arial",fill:"#ff8080",backgroundColor:"rgba(0,0,0,1)",align:"left"}),this.gGameLogic.errorText.visible=!1,this.gTable.create(!0),this.homePageTileManager=new le(this,this.gTable.wall),this.homePageTileManager.createScatteredTiles(),this.enableCommandBarDrag(),this.resize(this.sys.game.canvas.width,this.sys.game.canvas.height);const e=document.getElementById("start");e&&e.addEventListener("click",async()=>{e.style.display="none";const t=document.getElementById("uicenterdiv");t&&(t.style.display="flex"),this.homePageTileManager?(this.homePageTileManager.onAnimationComplete=async()=>{await this.homePageTileManager.transitionToWallSystem(),this.homePageTileManager.cleanup(),this.homePageTileManager=null,await this.gameController.startGame()},this.homePageTileManager.animateToPileAndStartGame()):await this.gameController.startGame()})}createWallTileCounter(){const e=this.add.container(v/2-150,160),t=this.add.graphics();t.fillStyle(2763306,1),t.fillRoundedRect(0,0,300,20,5);const n=this.add.graphics(),i=G(),s=this.add.text(150,10,"Wall Tiles Remaining: "+i,{fontFamily:"Arial, sans-serif",fontSize:"16px",fontStyle:"bold",color:"#ffffff",stroke:"#000000",strokeThickness:4});return s.setOrigin(.5,.5),s.setResolution(2),e.add([t,n,s]),e.setVisible(!1),e.setDepth(100),{bar:e,fill:n,text:s,maxTiles:i}}updateWallTileCounter(e){if(!this.gGameLogic.wallCounter)return;const{bar:t,fill:n,text:i,maxTiles:s}=this.gGameLogic.wallCounter;n.clear(),(e<0||e>s)&&(console.error("Invalid wall count:",e),e=Math.max(0,Math.min(e,s))),n.fillStyle(4886754,1);const a=e/s*300;n.fillRoundedRect(0,0,a,20,5),i.setText(`Wall Tiles Remaining: ${e}`),t.setVisible(!0)}update(){}getDragBounds(){const e=document.getElementById("parentdiv");return e?e.getBoundingClientRect():this.sys.canvas.getBoundingClientRect()}getClampedCommandBarPosition(e,t,n,i){const a=n.getBoundingClientRect(),o=(a.width||n.offsetWidth||0)/2,r=a.height||n.offsetHeight||0;let l=i.left+o+16,d=i.right-o-16;if(l>d){const w=i.left+i.width/2;l=w,d=w}let g=i.top+16,y=i.bottom-r-16;if(g>y){const w=i.top+i.height/2;g=w,y=w}const h=Math.min(Math.max(e,l),d),S=Math.min(Math.max(t,g),y);return{left:h,top:S}}getDefaultCommandBarPosition(e,t,n){const i=e.offsetWidth||0,s=e.offsetHeight||0,a=t.right-i/2-36,o=t.bottom-s-110;return this.getClampedCommandBarPosition(a,o,e,n)}enableCommandBarDrag(){const e=document.getElementById("uicenterdiv"),t=this.sys.canvas;if(!e||!t)return;const n=document.documentElement.style;let i=!1,s=0,a=0;const o=d=>{if(!i)return;const g=this.getDragBounds(),y=e.getBoundingClientRect(),h=d.clientX-s+(y.width||e.offsetWidth||0)/2,S=d.clientY-a,{left:w,top:E}=this.getClampedCommandBarPosition(h,S,e,g);n.setProperty("--command-bar-left",`${w}px`),n.setProperty("--command-bar-top",`${E}px`),this.commandBarPosition={left:w,top:E},this.commandBarManualPosition=!0},r=d=>{if(i){i=!1,e.classList.remove("command-bar--dragging");try{e.releasePointerCapture(d.pointerId)}catch{}window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),window.removeEventListener("pointercancel",r)}},l=d=>{if(d.button!==0||d.target.closest("#buttondiv"))return;const g=e.getBoundingClientRect();s=d.clientX-g.left,a=d.clientY-g.top,i=!0,e.classList.add("command-bar--dragging");try{e.setPointerCapture(d.pointerId)}catch{}window.addEventListener("pointermove",o),window.addEventListener("pointerup",r),window.addEventListener("pointercancel",r),d.preventDefault()};e.addEventListener("pointerdown",l),this.events.once(b.Scenes.Events.SHUTDOWN,()=>{e.removeEventListener("pointerdown",l),window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),window.removeEventListener("pointercancel",r)})}resize(e,t,n,i){const s=document.getElementById("uicenterdiv"),a=this.sys.canvas;if(!s||!a)return;const o=a.getBoundingClientRect(),r=this.getDragBounds(),l=document.documentElement.style;if(this.commandBarManualPosition&&this.commandBarPosition){const{left:y,top:h}=this.getClampedCommandBarPosition(this.commandBarPosition.left,this.commandBarPosition.top,s,r);this.commandBarPosition={left:y,top:h},l.setProperty("--command-bar-left",`${y}px`),l.setProperty("--command-bar-top",`${h}px`);return}const{left:d,top:g}=this.getDefaultCommandBarPosition(s,o,r);this.commandBarPosition={left:d,top:g},l.setProperty("--command-bar-left",`${d}px`),l.setProperty("--command-bar-top",`${g}px`)}createFireworksDisplay(e){return new Promise(t=>{if(!e.mahjong||e.winner!==0){t();return}const n=this.sys.game.canvas.width,i=this.sys.game.canvas.height,s=b.Math.Between(5,7),a=[];try{for(let r=0;r<s;r++){const l=b.Math.Between(100,n-100),d=b.Math.Between(100,i-200),g=this.add.particles(l,d,"particle",{speed:{min:200,max:400},angle:{min:0,max:360},lifespan:{min:1200,max:1800},gravityY:300,scale:{start:.8,end:0},alpha:{start:1,end:0},tint:[16773222,6737151,16737988,65382,16737792,13395711],blendMode:"ADD"});g.setDepth(300),a.push(g),this.time.delayedCall(r*300,()=>{const y=b.Math.Between(15,25);g.emitParticleAt(l,d,y)})}const o=(s-1)*300+2e3;this.time.delayedCall(o,()=>{a.forEach(r=>r.destroy()),t()})}catch(o){console.warn("[GameScene] Fireworks display failed:",o),a.forEach(r=>{try{r.destroy()}catch{}}),t()}})}}const fe=window.location.search.includes("playwright=true")||window.navigator.userAgent.includes("Playwright"),be={type:fe?b.CANVAS:b.AUTO,width:v,height:L,transparent:!0,hideBanner:!0,parent:"gamediv",scene:[ye],scale:{mode:b.Scale.FIT,autoCenter:b.Scale.CENTER_BOTH},render:{antialias:!0,mipmapFilter:"LINEAR_MIPMAP_LINEAR",powerPreference:"high-performance"}},we=new b.Game(be);window.game=we;
