import{S as m,r as V,H as B,a as p,j as E,l as S,D as R,P as v,h as A,C as q,A as z,G as X}from"./card-COOX9W03.js";class J{constructor(){this.deferredPrompt=null,this.installBanner=null,this.init()}init(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,console.log("PWA install prompt captured"),this.checkShouldShowPrompt()}),window.addEventListener("appinstalled",()=>{console.log("PWA installed successfully"),this.markAsInstalled(),this.hidePrompt()}),this.createBannerUI()}checkShouldShowPrompt(){if(this.isAlreadyInstalled()){console.log("App already installed, skipping prompt");return}if(this.wasRecentlyDismissed()){console.log("User dismissed prompt recently, skipping");return}const e=this.getGamesPlayed();console.log(`Games played: ${e}`),e>=2&&setTimeout(()=>{this.showPrompt()},2e3)}getGamesPlayed(){return parseInt(localStorage.getItem("gamesPlayed")||"0",10)}static incrementGamesPlayed(){const e=parseInt(localStorage.getItem("gamesPlayed")||"0",10);localStorage.setItem("gamesPlayed",(e+1).toString()),console.log(`Games played: ${e+1}`)}isAlreadyInstalled(){return window.matchMedia("(display-mode: standalone)").matches?!0:localStorage.getItem("appInstalled")==="true"}wasRecentlyDismissed(){const e=localStorage.getItem("installPromptDismissedAt");if(!e)return!1;const t=parseInt(e,10),s=7*24*60*60*1e3;return Date.now()-t<s}markAsInstalled(){localStorage.setItem("appInstalled","true")}createBannerUI(){this.installBanner=document.createElement("div"),this.installBanner.id="install-banner",this.installBanner.className="install-banner",this.installBanner.style.display="none",this.installBanner.innerHTML=`
            <div class="install-banner__content">
                <div class="install-banner__icon">
                    <svg width="48" height="48" viewBox="0 0 64 64">
                        <rect x="4" y="4" width="56" height="56" rx="12" fill="#0c6d3a"/>
                        <rect x="15" y="15" width="34" height="34" rx="6" fill="rgba(4, 24, 14, 0.65)" stroke="#f5fbf7" stroke-width="2"/>
                        <rect x="19" y="19" width="26" height="26" rx="4" fill="#ffd166"/>
                    </svg>
                </div>
                <div class="install-banner__text">
                    <h3 class="install-banner__title">Install Mahjong</h3>
                    <p class="install-banner__message">Add to home screen for quick access</p>
                </div>
                <div class="install-banner__actions">
                    <button class="install-banner__btn install-banner__btn--install" id="install-btn">
                        Install
                    </button>
                    <button class="install-banner__btn install-banner__btn--dismiss" id="dismiss-btn">
                        Not Now
                    </button>
                </div>
            </div>
        `,document.body.appendChild(this.installBanner);const e=this.installBanner.querySelector("#install-btn"),t=this.installBanner.querySelector("#dismiss-btn");e.addEventListener("click",()=>this.handleInstall()),t.addEventListener("click",()=>this.handleDismiss()),this.injectStyles()}injectStyles(){const e=document.createElement("style");e.textContent=`
            .install-banner {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to top, rgba(4, 36, 21, 0.98), rgba(4, 36, 21, 0.95));
                backdrop-filter: blur(10px);
                border-top: 2px solid #ffd166;
                padding: 16px;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                animation: slideUp 0.3s ease-out;
            }

            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }

            .install-banner__content {
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 600px;
                margin: 0 auto;
            }

            .install-banner__icon {
                flex-shrink: 0;
            }

            .install-banner__text {
                flex: 1;
                min-width: 0;
            }

            .install-banner__title {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
                color: #f5fbf7;
                font-family: var(--font-stack, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif);
            }

            .install-banner__message {
                margin: 4px 0 0;
                font-size: 13px;
                color: rgba(245, 251, 247, 0.8);
                font-family: var(--font-stack, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif);
            }

            .install-banner__actions {
                display: flex;
                flex-direction: column;
                gap: 8px;
                flex-shrink: 0;
            }

            .install-banner__btn {
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                font-family: var(--font-stack, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif);
                cursor: pointer;
                transition: all 0.2s;
                min-width: 100px;
            }

            .install-banner__btn--install {
                background: #ffd166;
                color: #1f1400;
            }

            .install-banner__btn--install:hover {
                background: #ffda7a;
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(255, 209, 102, 0.4);
            }

            .install-banner__btn--dismiss {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(245, 251, 247, 0.9);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .install-banner__btn--dismiss:hover {
                background: rgba(255, 255, 255, 0.15);
            }

            /* Mobile responsive */
            @media (max-width: 480px) {
                .install-banner__content {
                    flex-wrap: wrap;
                }

                .install-banner__actions {
                    flex-direction: row;
                    width: 100%;
                    margin-top: 8px;
                }

                .install-banner__btn {
                    flex: 1;
                }
            }
        `,document.head.appendChild(e)}showPrompt(){if(!this.deferredPrompt){console.log("No deferred prompt available");return}this.installBanner.style.display="block",console.log("Install banner shown")}hidePrompt(){this.installBanner&&(this.installBanner.style.display="none")}async handleInstall(){if(!this.deferredPrompt){console.error("No deferred prompt available");return}this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;console.log(`Install prompt outcome: ${e}`),e==="accepted"?(console.log("User accepted install"),this.markAsInstalled()):(console.log("User dismissed install"),this.handleDismiss()),this.deferredPrompt=null,this.hidePrompt()}handleDismiss(){localStorage.setItem("installPromptDismissedAt",Date.now().toString()),console.log("Install prompt dismissed by user"),this.hidePrompt()}}class j{constructor(){this.sheet=null,this.settingsButton=null,this.isOpen=!1,this.createUI(),this.loadSettings(),this.attachEventListeners()}createUI(){const e=m.getDefaults(),t=document.createElement("div");t.id="settings-overlay-mobile",t.className="settings-overlay-mobile";const s=document.createElement("div");s.id="settings-sheet",s.className="settings-sheet",s.innerHTML=`
            <div class="settings-sheet__header">
                <h2 class="settings-sheet__title">Settings</h2>
                <button class="settings-sheet__close" aria-label="Close settings">Ã—</button>
            </div>

            <div class="settings-sheet__content">
                <!-- Game Settings Section -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Game</h3>

                    <div class="settings-item">
                        <label for="mobile-year">Card Year</label>
                        <select id="mobile-year" class="settings-select">
                            <option value="2025">2025</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                        </select>
                    </div>

                    <div class="settings-item">
                        <label for="mobile-difficulty">AI Difficulty</label>
                        <select id="mobile-difficulty" class="settings-select">
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>

                    <div class="settings-item settings-item--toggle">
                        <label for="mobile-blank-tiles">Use Blank Tiles</label>
                        <input type="checkbox" id="mobile-blank-tiles" class="settings-checkbox">
                    </div>
                </section>

                <!-- Audio Settings Section -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Audio</h3>

                    <div class="settings-item">
                        <label for="mobile-bgm-volume">
                            Music Volume
                            <span class="volume-value" id="mobile-bgm-value">${e.bgmVolume}</span>
                        </label>
                        <div class="volume-control">
                            <input type="range" id="mobile-bgm-volume" class="settings-slider"
                                   min="0" max="100" step="1" value="${e.bgmVolume}">
                            <label class="mute-toggle">
                                <input type="checkbox" id="mobile-bgm-mute">
                                <span>Mute</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label for="mobile-sfx-volume">
                            Sound Effects
                            <span class="volume-value" id="mobile-sfx-value">${e.sfxVolume}</span>
                        </label>
                        <div class="volume-control">
                            <input type="range" id="mobile-sfx-volume" class="settings-slider"
                                   min="0" max="100" step="1" value="${e.sfxVolume}">
                            <label class="mute-toggle">
                                <input type="checkbox" id="mobile-sfx-mute">
                                <span>Mute</span>
                            </label>
                        </div>
                    </div>
                </section>

                <!-- Training Mode Section (Optional) -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Training Mode</h3>

                    <div class="settings-item settings-item--toggle">
                        <label for="mobile-training-mode">Enable Training Mode</label>
                        <input type="checkbox" id="mobile-training-mode" class="settings-checkbox">
                    </div>

                    <div class="settings-item" id="mobile-training-controls" style="display: none;">
                        <label for="mobile-training-tiles">Starting Tiles</label>
                        <select id="mobile-training-tiles" class="settings-select">
                            <option value="9">9 tiles</option>
                            <option value="10">10 tiles</option>
                            <option value="11">11 tiles</option>
                            <option value="12">12 tiles</option>
                            <option value="13">13 tiles</option>
                            <option value="14">14 tiles</option>
                        </select>
                    </div>

                    <div class="settings-item settings-item--toggle" id="mobile-training-skip" style="display: none;">
                        <label for="mobile-skip-charleston">Skip Charleston</label>
                        <input type="checkbox" id="mobile-skip-charleston" class="settings-checkbox">
                    </div>
                </section>
            </div>

            <div class="settings-sheet__footer">
                <button class="settings-btn settings-btn--secondary" id="mobile-settings-reset">
                    Reset to Defaults
                </button>
                <button class="settings-btn settings-btn--primary" id="mobile-settings-save">
                    Save & Close
                </button>
            </div>
        `,t.appendChild(s),document.body.appendChild(t),this.sheet=s,this.overlay=t}loadSettings(){const e=m.load();document.getElementById("mobile-year").value=e.cardYear,document.getElementById("mobile-difficulty").value=e.difficulty,document.getElementById("mobile-blank-tiles").checked=e.useBlankTiles,document.getElementById("mobile-bgm-volume").value=e.bgmVolume,document.getElementById("mobile-bgm-value").textContent=e.bgmVolume,document.getElementById("mobile-bgm-mute").checked=e.bgmMuted,document.getElementById("mobile-sfx-volume").value=e.sfxVolume,document.getElementById("mobile-sfx-value").textContent=e.sfxVolume,document.getElementById("mobile-sfx-mute").checked=e.sfxMuted,document.getElementById("mobile-training-mode").checked=e.trainingMode,document.getElementById("mobile-training-tiles").value=e.trainingTileCount,document.getElementById("mobile-skip-charleston").checked=e.skipCharleston,this.updateTrainingVisibility(e.trainingMode)}attachEventListeners(){const e=document.getElementById("mobile-settings-btn");e&&e.addEventListener("click",()=>this.open()),this.sheet.querySelector(".settings-sheet__close").addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.close()}),document.getElementById("mobile-bgm-volume").addEventListener("input",t=>{document.getElementById("mobile-bgm-value").textContent=t.target.value}),document.getElementById("mobile-sfx-volume").addEventListener("input",t=>{document.getElementById("mobile-sfx-value").textContent=t.target.value}),document.getElementById("mobile-training-mode").addEventListener("change",t=>{this.updateTrainingVisibility(t.target.checked)}),document.getElementById("mobile-settings-save").addEventListener("click",()=>{this.saveSettings(),this.close()}),document.getElementById("mobile-settings-reset").addEventListener("click",()=>{window.confirm("Reset all settings to defaults?")&&(m.reset(),this.loadSettings())})}saveSettings(){var t,s,i,n,r,l,c,d,h,f;const e={cardYear:parseInt(((t=document.getElementById("mobile-year"))==null?void 0:t.value)??m.getDefault("cardYear").toString()),difficulty:((s=document.getElementById("mobile-difficulty"))==null?void 0:s.value)??m.getDefault("difficulty"),useBlankTiles:((i=document.getElementById("mobile-blank-tiles"))==null?void 0:i.checked)??m.getDefault("useBlankTiles"),bgmVolume:parseInt(((n=document.getElementById("mobile-bgm-volume"))==null?void 0:n.value)??m.getDefault("bgmVolume").toString()),bgmMuted:((r=document.getElementById("mobile-bgm-mute"))==null?void 0:r.checked)??m.getDefault("bgmMuted"),sfxVolume:parseInt(((l=document.getElementById("mobile-sfx-volume"))==null?void 0:l.value)??m.getDefault("sfxVolume").toString()),sfxMuted:((c=document.getElementById("mobile-sfx-mute"))==null?void 0:c.checked)??m.getDefault("sfxMuted"),trainingMode:((d=document.getElementById("mobile-training-mode"))==null?void 0:d.checked)??m.getDefault("trainingMode"),trainingTileCount:parseInt(((h=document.getElementById("mobile-training-tiles"))==null?void 0:h.value)??m.getDefault("trainingTileCount").toString()),skipCharleston:((f=document.getElementById("mobile-skip-charleston"))==null?void 0:f.checked)??m.getDefault("skipCharleston"),trainingHand:m.getDefault("trainingHand")};m.save(e),console.log("Settings saved:",e),window.dispatchEvent(new window.CustomEvent("settingsChanged",{detail:e}))}updateTrainingVisibility(e){const t=document.getElementById("mobile-training-controls"),s=document.getElementById("mobile-training-skip");t&&(t.style.display=e?"block":"none"),s&&(s.style.display=e?"flex":"none")}open(){this.isOpen=!0,this.overlay.classList.add("open"),this.sheet.classList.add("open"),document.body.style.overflow="hidden"}close(){this.isOpen=!1,this.overlay.classList.remove("open"),this.sheet.classList.remove("open"),document.body.style.overflow=""}}class Q{constructor(e,t){if(!e)throw new Error("WallCounter requires a container element");if(!t)throw new Error("WallCounter requires a gameController instance");this.container=e,this.gameController=t,this.unsubscribeFns=[],this.render(),this.setupListeners()}render(){const e=this.container.querySelector(".wall-tiles");e&&(e.textContent=this.getWallCount())}setupListeners(){const e=()=>this.update();this.unsubscribeFns.push(this.gameController.on("TILE_DRAWN",e));const t=()=>this.update();this.unsubscribeFns.push(this.gameController.on("GAME_STARTED",t));const s=()=>this.update();this.unsubscribeFns.push(this.gameController.on("TILES_DEALT",s))}getWallCount(){return this.gameController.wallTiles?this.gameController.wallTiles.length:0}update(){const e=this.container.querySelector(".wall-tiles");if(e){const t=this.getWallCount();e.textContent=t,t<=8?e.classList.add("low-count"):e.classList.remove("low-count")}}destroy(){this.unsubscribeFns.forEach(e=>{typeof e=="function"&&e()}),this.unsubscribeFns=[],this.container=null,this.gameController=null}}class Z{constructor(e,t,s){if(!e)throw new Error("HintsPanel requires a container element");if(!t)throw new Error("HintsPanel requires a gameController instance");if(!s)throw new Error("HintsPanel requires an aiEngine instance");this.container=e,this.gameController=t,this.aiEngine=s,this.isExpanded=!1,this.unsubscribeFns=[],this._disabled=!1,this._onToggle=this.toggle.bind(this),this.render(),this.setupListeners()}render(){if(this.toggleBtn=this.container.querySelector("#hints-toggle"),this.contentEl=this.container.querySelector("#hints-content"),!this.toggleBtn||!this.contentEl){console.error("HintsPanel: Missing required DOM elements"),this._disabled=!0,this.destroy();return}this.toggleBtn.addEventListener("click",this._onToggle),this.contentEl.style.display="none"}setupListeners(){const e=s=>{if(s.player===0){const i=B.fromJSON(s.hand);this.updateHints(i)}};this.unsubscribeFns.push(this.gameController.on("HAND_UPDATED",e));const t=()=>{this.clearHints()};this.unsubscribeFns.push(this.gameController.on("GAME_ENDED",t))}updateHints(e){if(!(this._disabled||!this.contentEl)){if(!e||!e.tiles||e.tiles.length===0){this.clearHints();return}try{const t=this.aiEngine.card.rankHandArray14(e);if(console.log("HintsPanel: rankCardHands:",t),!t||t.length===0){console.log("HintsPanel: No patterns available"),this.contentEl.innerHTML=`
                    <div class="hint-item">
                        <span class="hint-label">No patterns available</span>
                    </div>
                `;return}const i=[...t].sort((c,d)=>d.rank-c.rank).slice(0,3);console.log("HintsPanel: top3Patterns:",i);const n=e.getTileArray(),r=e.tiles;let l='<div class="hint-item">';i.forEach((c,d)=>{var b,I,U,G,W,F;const h=V(c,n,r),f=this.compactText((b=c.group)==null?void 0:b.groupDescription),y=this.compactText((I=c.hand)==null?void 0:I.description),C=((U=c.rank)==null?void 0:U.toFixed(2))||"0.00",w=((G=c.card)==null?void 0:G.year)||((W=this.gameController.settings)==null?void 0:W.year)||"",x=((F=c.hand)==null?void 0:F.concealed)===!0?'<span class="concealed-badge" title="Concealed">C</span>':"",o=[w,f,y].filter(Boolean);l+=`
                    <div class="hint-pattern" title="${f}${y?" - "+y:""}">
                        <div class="hint-pattern-header">
                            ${x}<strong>${d+1}. ${o.join(" - ")}</strong>
                            <span class="hint-rank">(Rank: ${C})</span>
                        </div>
                        ${h}
                    </div>
                `}),l+="</div>",this.contentEl.innerHTML=l}catch(t){console.error("HintsPanel: Error generating hints:",t),this.contentEl.innerHTML=`
                <div class="hint-item">
                    <span class="hint-label">Unable to generate hints</span>
                </div>
            `}}}formatTile(e){if(!e)return"Unknown";if(typeof e.getText=="function")return e.getText();const{suit:t,number:s}=e;return t===0||t==="CRACK"?`${s}C`:t===1||t==="BAM"?`${s}B`:t===2||t==="DOT"?`${s}D`:t===3||t==="WIND"?["N","S","W","E"][s]||`W${s}`:t===4||t==="DRAGON"?["Red","Green","White"][s]||`D${s}`:t===5||t==="FLOWER"?`F${s+1}`:t===6||t==="JOKER"?"J":`${t}-${s}`}compactText(e=""){return e.replace(/\s*\(.*?\)/g,"").trim()}clearHints(){this._disabled||!this.contentEl||(this.contentEl.innerHTML=`
            <div class="hint-item">
                <span class="hint-label">Play to see recommendations</span>
            </div>
        `)}toggle(){if(this._disabled||!this.contentEl||!this.toggleBtn){console.log("HintsPanel: toggle blocked - disabled or missing DOM");return}this.isExpanded=!this.isExpanded,console.log("HintsPanel: toggled to",this.isExpanded?"expanded":"collapsed"),this.contentEl.style.display=this.isExpanded?"block":"none",this.toggleBtn.setAttribute("aria-expanded",String(this.isExpanded))}destroy(){this.unsubscribeFns.forEach(e=>{typeof e=="function"&&e()}),this.unsubscribeFns=[],this.toggleBtn&&this._onToggle&&this.toggleBtn.removeEventListener("click",this._onToggle),this._disabled=!0,this.container=null,this.gameController=null,this.aiEngine=null,this.toggleBtn=null,this.contentEl=null,this._onToggle=null}}class ee{constructor(){this.tileIndices=new Map,this.initMapping()}initMapping(){let e=0;for(let t=1;t<=9;t++)this.tileIndices.set(`BAM-${t}`,e++),this.tileIndices.set(`CRACK-${t}`,e++),this.tileIndices.set(`DOT-${t}`,e++);this.tileIndices.set("DRAGON-1",e++),this.tileIndices.set("DRAGON-0",e++),this.tileIndices.set("DRAGON-2",e++),this.tileIndices.set("WIND-3",30);for(let t=0;t<8;t++){const s=t%4;this.tileIndices.set(`FLOWER-${t}`,31+s),this.tileIndices.set(`FLOWER-${t+1}`,31+s)}for(let t=0;t<8;t++)this.tileIndices.set(`JOKER-${t}`,35);this.tileIndices.set("WIND-0",36),this.tileIndices.set("WIND-1",37),this.tileIndices.set("WIND-2",38);for(let t=0;t<8;t++)this.tileIndices.set(`BLANK-${t}`,-1)}getSpritePosition(e){const t=this.getTileKey(e),s=this.tileIndices.get(t);return s===void 0?(console.warn("No sprite index found for tile:",e,t),{xPct:0,yPct:0}):{xPct:s/38*100,yPct:0}}getTileKey(e){if(!e)return"unknown";let t=e.suit;const s=e.number;return(t===0||t==="CRACK")&&(t="CRACK"),(t===1||t==="BAM")&&(t="BAM"),(t===2||t==="DOT")&&(t="DOT"),(t===3||t==="WIND")&&(t="WIND"),(t===4||t==="DRAGON")&&(t="DRAGON"),(t===5||t==="FLOWER")&&(t="FLOWER"),(t===6||t==="JOKER")&&(t="JOKER"),(t===7||t==="BLANK")&&(t="BLANK"),`${t}-${s}`}createTileElement(e,t="normal"){const s=document.createElement("div");s.className=`tile tile--${t}`;const i=this.getTileKey(e),n=this.tileIndices.get(i);if(n===-1)s.style.backgroundImage="url('/mahjong/pwa/assets/back.png')",s.style.backgroundPosition="center",s.style.backgroundSize="contain";else if(n===void 0)console.error("createTileElement: No sprite index for tile",e,"key:",i),s.style.backgroundImage="url('/mahjong/pwa/assets/back.png')",s.style.backgroundPosition="center",s.style.backgroundSize="contain";else{const r=this.getSpritePosition(e);s.style.backgroundPosition=`${r.xPct}% ${r.yPct}%`}return s.dataset.tileId=i,s}}const M=new ee,te={[p.CRACK]:"CRACK",[p.BAM]:"BAM",[p.DOT]:"DOT",[p.WIND]:"WIND",[p.DRAGON]:"DRAGON",[p.FLOWER]:"FLOWER",[p.JOKER]:"JOKER",[p.BLANK]:"BLANK"},se={[S.NORTH]:"N",[S.SOUTH]:"S",[S.WEST]:"W",[S.EAST]:"E"},ie={[R.RED]:"R",[R.GREEN]:"G",[R.WHITE]:"0"};class ne{constructor(e,t){if(!e)throw new Error("HandRenderer requires a container element");this.container=e,this.gameController=t,this.tiles=[],this.selectedIndices=new Set,this.selectionKeyByIndex=new Map,this.selectionBehavior={mode:"multiple",maxSelectable:1/0,allowToggle:!0},this.selectionListener=null,this.unsubscribeFns=[],this.interactive=!0,this.handContainer=null,this.exposedSection=null,this.currentHandData=null,this.currentSortMode=null,this.newlyDrawnTileIndex=null,this.setupDOM(),this.setupEventListeners()}setupDOM(){this.container.innerHTML="",this.container.classList.add("hand-section"),this.exposedSection=document.createElement("div"),this.exposedSection.className="exposed-section",this.container.appendChild(this.exposedSection),this.handContainer=document.createElement("div"),this.handContainer.className="hand-container hand-grid",this.container.appendChild(this.handContainer)}setupEventListeners(){if(!this.gameController||typeof this.gameController.on!="function")return;const e=(n={})=>{if(n.player===0){this.currentSortMode=null;const r=B.fromJSON(n.hand);this.render(r)}};this.unsubscribeFns.push(this.gameController.on("HAND_UPDATED",e));const t=(n={})=>{if(typeof n.index=="number"){this.selectTile(n.index,{toggle:n.toggle!==!1,clearOthers:!!n.exclusive,state:n.state});return}Array.isArray(n.indices)&&(n.clearExisting&&this.clearSelection(),n.indices.forEach(r=>{typeof r=="number"&&this.selectTile(r,{state:n.state??"on",toggle:!1})}))};this.unsubscribeFns.push(this.gameController.on("TILE_SELECTED",t));const s=(n={})=>{n.player===0&&n.tile&&(this.newlyDrawnTileIndex=n.tile.index)};this.unsubscribeFns.push(this.gameController.on("TILE_DRAWN",s));const i=(n={})=>{n.player===0&&(this.newlyDrawnTileIndex=null,this.tiles.forEach(r=>{r&&r.classList.remove("tile--newly-drawn")}))};this.unsubscribeFns.push(this.gameController.on("TILE_DISCARDED",i))}render(e){if(!e){this.renderExposures([]),this.clearTiles(),this.currentHandData=null;return}this.currentSortMode===null&&e.sortBySuit&&e.sortBySuit(),this.currentHandData=e,this.renderExposures(Array.isArray(e.exposures)?e.exposures:[]),this.clearTiles();const t=new Set;this.selectionKeyByIndex.clear(),(Array.isArray(e.tiles)?e.tiles:[]).forEach((i,n)=>{const r=this.getTileSelectionKey(i,n);this.selectionKeyByIndex.set(n,r);const l=this.createTileButton(i,n,r);this.selectedIndices.has(r)&&(l.classList.add("selected"),t.add(r)),this.newlyDrawnTileIndex!==null&&i.index===this.newlyDrawnTileIndex&&l.classList.add("tile--newly-drawn"),this.tiles.push(l),this.handContainer.appendChild(l)}),this.selectedIndices=t,this.setInteractive(this.interactive)}renderExposures(e){this.exposedSection&&(this.exposedSection.innerHTML="",!(!Array.isArray(e)||e.length===0)&&e.forEach(t=>{if(!t||!Array.isArray(t.tiles))return;const s=document.createElement("div");s.className="exposure-set",t.type&&(s.dataset.type=t.type),t.tiles.forEach(i=>{const n=document.createElement("div");if(n.className="tile tile--small",n.setAttribute("role","img"),i){const l=M.getSpritePosition(i);n.style.backgroundPosition=`${l.xPct}% ${l.yPct}%`}n.dataset.suit=this.getSuitName(i==null?void 0:i.suit),n.dataset.number=this.getDataNumber(i);const r=this.formatTileText(i);r&&n.setAttribute("aria-label",r),s.appendChild(n)}),this.exposedSection.appendChild(s)}))}clearTiles(){this.tiles.forEach(e=>{const t=e.__handRendererHandler;t&&(e.removeEventListener("click",t),delete e.__handRendererHandler)}),this.tiles=[],this.selectionKeyByIndex.clear(),this.handContainer&&(this.handContainer.innerHTML="")}createTileButton(e,t,s){const i=document.createElement("button");if(i.type="button",i.className="tile tile--normal",e){const l=M.getSpritePosition(e);i.style.backgroundPosition=`${l.xPct}% ${l.yPct}%`}i.dataset.suit=this.getSuitName(e==null?void 0:e.suit),i.dataset.number=this.getDataNumber(e),i.dataset.index=String(t),i.dataset.selectionKey=s;const n=this.formatTileText(e);n&&i.setAttribute("aria-label",n),i.disabled=!this.interactive;const r=l=>{l.preventDefault(),l.stopPropagation(),this.interactive&&this.handleTileClick(t)};return i.__handRendererHandler=r,i.addEventListener("click",r),i}setSelectionBehavior(e={}){this.selectionBehavior={...this.selectionBehavior,...e}}setSelectionListener(e){this.selectionListener=typeof e=="function"?e:null}handleTileClick(e){const t=this.selectionKeyByIndex.get(e);if(!t)return;const s=this.selectedIndices.has(t),{mode:i,maxSelectable:n,allowToggle:r}=this.selectionBehavior;if(i==="single"){s&&r!==!1?this.selectTile(e,{state:"off",toggle:!1}):(this.clearSelection(!0),this.selectTile(e,{state:"on",toggle:!1}));return}if(s)r!==!1&&this.selectTile(e,{state:"off",toggle:!1});else{if(this.selectedIndices.size>=n)return;this.selectTile(e,{state:"on",toggle:!1})}}selectTile(e,t={}){const s=this.tiles[e];if(!s)return!1;const i=this.selectionKeyByIndex.get(e);if(!i)return!1;const{state:n,toggle:r=!0,clearOthers:l=!1,silent:c=!1}=t;l&&this.clearSelection(!0);let d;n==="on"?d=!0:n==="off"?d=!1:r?d=!this.selectedIndices.has(i):d=!0;let h=!1;return d?this.selectedIndices.has(i)||(this.selectedIndices.add(i),s.classList.add("selected"),h=!0):this.selectedIndices.delete(i)&&(s.classList.remove("selected"),h=!0),h&&!c&&this.notifySelectionChange(),h}clearSelection(e=!1){return this.selectedIndices.size===0?!1:(this.selectedIndices.clear(),this.tiles.forEach(t=>t.classList.remove("selected")),e||this.notifySelectionChange(),!0)}getSelectedTileIndices(){const e=[];for(const[t,s]of this.selectionKeyByIndex.entries())this.selectedIndices.has(s)&&e.push(t);return e}getSelectedTiles(){if(!this.currentHandData||!Array.isArray(this.currentHandData.tiles))return[];const e=[];for(const[t,s]of this.selectionKeyByIndex.entries()){if(!this.selectedIndices.has(s))continue;const i=this.currentHandData.tiles[t];if(!i)continue;const n=this.toTileData(i);n&&e.push(n)}return e}getSelectionState(){const e=this.getSelectedTileIndices();return{count:e.length,indices:e,tiles:this.getSelectedTiles()}}getLastTileElement(){return this.tiles&&this.tiles.length>0?this.tiles[this.tiles.length-1]:null}notifySelectionChange(){typeof this.selectionListener=="function"&&this.selectionListener(this.getSelectionState())}sortHand(e="suit"){var s;if(!this.currentHandData)return;if(typeof((s=this.gameController)==null?void 0:s.sortHand)=="function"){this.gameController.sortHand(0,e);return}this.currentSortMode=e;const t=this.cloneHandData(this.currentHandData);t&&(e==="rank"?typeof t.sortByRank=="function"?t.sortByRank():Array.isArray(t.tiles)&&t.tiles.sort((i,n)=>i.number!==n.number?i.number-n.number:i.suit-n.suit):typeof t.sortBySuit=="function"?t.sortBySuit():Array.isArray(t.tiles)&&t.tiles.sort((i,n)=>i.suit!==n.suit?i.suit-n.suit:i.number-n.number),this.render(t))}setInteractive(e){this.interactive=!!e,this.tiles.forEach(t=>{t.disabled=!this.interactive})}destroy(){this.unsubscribeFns.forEach(e=>{typeof e=="function"&&e()}),this.unsubscribeFns=[],this.clearTiles(),this.clearSelection(!0),this.exposedSection&&(this.exposedSection.innerHTML=""),this.container=null,this.gameController=null,this.handContainer=null,this.exposedSection=null,this.currentHandData=null,this.selectionListener=null}getSuitName(e){return te[e]||"UNKNOWN"}getDataNumber(e){return!e||typeof e.number>"u"?"":String(e.number)}formatTileText(e){if(!e)return"";const{suit:t,number:s}=e;return t===p.CRACK?`${s}C`:t===p.BAM?`${s}B`:t===p.DOT?`${s}D`:t===p.WIND?se[s]||"":t===p.DRAGON?ie[s]||"D":t===p.FLOWER?`F${typeof s=="number"?s+1:1}`:t===p.JOKER?"J":t===p.BLANK?"BL":`${s??""}`}getTileSelectionKey(e,t){return e?typeof e.index=="number"&&e.index>=0?`idx-${e.index}`:`${e.suit}:${e.number}:${t}`:`missing-${t}`}cloneHandData(e){return e?typeof e.clone=="function"?e.clone():{tiles:Array.isArray(e.tiles)?e.tiles.map(t=>({...t})):[],exposures:Array.isArray(e.exposures)?e.exposures.map(t=>({type:t==null?void 0:t.type,tiles:Array.isArray(t==null?void 0:t.tiles)?t.tiles.map(s=>({...s})):[]})):[]}:null}toTileData(e){return e?e instanceof E?e.clone():E.fromJSON(e):null}}class k{constructor(e,t={}){this.tileData=e,this.options={width:45,height:60,state:"normal",size:"normal",...t},this.element=null,this.currentState=this.options.state}createElement(){const e=M.createTileElement(this.tileData,this.options.size);e.classList.add("mobile-tile"),e.dataset.suit=this.tileData.suit,e.dataset.number=this.tileData.number,this.tileData.index!==void 0&&(e.dataset.index=this.tileData.index);const t=this._getSizeDefaults(this.options.size);if(this.options.width!==t.width||this.options.height!==t.height){e.style.width=`${this.options.width}px`,e.style.height=`${this.options.height}px`;const s=this.options.width/33.33,i=Math.round(1300*s);e.style.backgroundSize=`${i}px auto`}return this.element=e,this.setState(this.options.state),e}_getSizeDefaults(e){const t={normal:{width:45,height:60},small:{width:32,height:42},discard:{width:30,height:40}};return t[e]||t.normal}setState(e){if(this.currentState=e,!!this.element)switch(this.element.classList.remove("selected","disabled","highlighted"),e){case"selected":this.element.classList.add("selected");break;case"disabled":this.element.classList.add("disabled");break;case"highlighted":this.element.classList.add("highlighted");break}}getData(){return this.tileData}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}static createHandTile(e,t="normal"){return new k(e,{size:"normal",state:t})}static createExposedTile(e,t="normal"){return new k(e,{size:"small",state:t})}static createDiscardTile(e,t="normal"){return new k(e,{size:"discard",state:t})}}class le{constructor(e,t=null){this.container=e,this.gameController=t,this.discards=[],this.element=null,this.eventUnsubscribers=[],this._onResize=this.updateTileSizing.bind(this),this.render(),this.gameController&&this.setupEventListeners()}render(){this.element=document.createElement("div"),this.element.className="discard-pile",this.container.appendChild(this.element),this.updateTileSizing(),window.addEventListener("resize",this._onResize,{passive:!0})}setupEventListeners(){!this.gameController||typeof this.gameController.on!="function"||(this.eventUnsubscribers.push(this.gameController.on("TILE_DISCARDED",e=>{const t=E.fromJSON(e.tile);this.addDiscard(t,e.player)})),this.eventUnsubscribers.push(this.gameController.on("DISCARD_CLAIMED",()=>{this.removeLatestDiscard()})),this.eventUnsubscribers.push(this.gameController.on("GAME_STARTED",()=>{this.clear()})))}addDiscard(e,t){this.discards.push({tile:e,player:t});const s=this.createDiscardTile(e,t);this.element.appendChild(s),this.highlightLatest(s),this.scrollToLatest()}createDiscardTile(e,t){const s=k.createDiscardTile(e).createElement();return s.classList.add("discard-tile"),s.dataset.player=t,s.title=`Discarded by ${this.getPlayerName(t)}`,s.addEventListener("click",()=>{this.showDiscardInfo(e,t)}),s}getTileText(e){return e.getText()}getPlayerName(e){return["You","Opponent 1","Opponent 2","Opponent 3"][e]||"Unknown"}highlightLatest(e){this.element.querySelectorAll(".discard-tile").forEach(t=>{t.classList.remove("latest")}),e.classList.add("latest")}removeLatestDiscard(){if(this.discards.length>0){this.discards.pop();const e=this.element.querySelector(".discard-tile:last-child");e&&e.remove()}}getLatestDiscardElement(){return this.element.querySelector(".discard-tile:last-child")}showDiscardInfo(e,t){alert(`${e.getText()}
Discarded by: ${this.getPlayerName(t)}`)}scrollToLatest(){this.element.scrollTo({top:this.element.scrollHeight,left:this.element.scrollWidth,behavior:"smooth"})}updateTileSizing(){if(!this.container||!this.element)return;const e=this.container.clientWidth||window.innerWidth,t=4,s=8,i=Math.max(26,Math.floor((e-8*t-2*s)/9));this.element.style.setProperty("--discard-tile-width",`${i}px`),this.element.style.setProperty("--discard-gap",`${t}px`),this.element.style.setProperty("--discard-padding",`${s}px`)}clear(){this.discards=[],this.element.innerHTML=""}destroy(){this.eventUnsubscribers.forEach(e=>e()),this.eventUnsubscribers=[],window.removeEventListener("resize",this._onResize),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}}class re{constructor(e,t){this.container=e,this.playerData=t,this.element=null,this.render()}render(){this.element=document.createElement("div"),this.element.className="opponent-bar",this.element.dataset.player=this.playerData.position,this.element.innerHTML=`
            <div class="opponent-info">
                <span class="opponent-name"></span>
                <span class="tile-count"></span>
            </div>
            <div class="exposures"></div>
        `,this.container.appendChild(this.element),this.update(this.playerData)}update(e){if(!this.element)return;this.playerData=e;const t=this.element.querySelector(".opponent-name"),s=this.getWindLabel(e);t.textContent=s?`${e.name} (${s})`:e.name;const i=this.element.querySelector(".tile-count");i.textContent="",this.updateExposures(this.getExposures(e)),this.setCurrentTurn(e.isCurrentTurn)}getWindLabel(e={}){if(typeof e.wind=="string"&&e.wind)return e.wind;const t=e.wind,s={[S.NORTH]:"North",[S.SOUTH]:"South",[S.WEST]:"West",[S.EAST]:"East"};return t in s?s[t]:{[v.RIGHT]:"North",[v.TOP]:"West",[v.LEFT]:"South",[v.BOTTOM]:"East"}[e.position]||""}getTileCount(e={}){if(typeof e.tileCount=="number")return e.tileCount;const t=e.hand;if(!t)return null;const s=Array.isArray(t.tiles)?t.tiles.length:0,i=Array.isArray(t.exposures)?t.exposures.reduce((r,l)=>r+(Array.isArray(l.tiles)?l.tiles.length:0),0):0,n=s+i;return n>0?n:0}getExposures(e={}){return Array.isArray(e.exposures)?e.exposures:e.hand&&Array.isArray(e.hand.exposures)?e.hand.exposures:[]}updateExposures(e){const t=this.element.querySelector(".exposures");t.innerHTML="",!(!e||e.length===0)&&e.forEach(s=>{s.tiles.forEach(i=>{const n=k.createExposedTile(i).createElement();n.classList.add("exposure-icon"),n.title=this.getExposureTooltip(s),t.appendChild(n)})})}getExposureLabel(e){return{PUNG:"P",KONG:"K",QUINT:"Q"}[e]||"?"}getExposureTooltip(e){const t=e.tiles.map(s=>s.getText()).join(", ");return`${e.type}: ${t}`}setCurrentTurn(e){this.element&&(e?this.element.classList.add("current-turn"):this.element.classList.remove("current-turn"))}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}}class oe{constructor(e){this.container=e,this.element=null,e&&this.render()}render(){this.element=document.createElement("div"),this.element.className="player-rack",this.element.innerHTML=`
            <div class="player-rack__exposed"></div>
        `,this.container.appendChild(this.element)}update(e){if(!this.element||!e)return;const t=this.element.querySelector(".player-rack__exposed");e.exposures&&e.exposures.length>0?this.renderExposures(e.exposures,t):t.innerHTML=""}renderExposures(e,t){if(!t||!t.innerHTML){console.warn("PlayerRack.renderExposures: Invalid container provided");return}if(t.innerHTML="",!e||!Array.isArray(e)){console.warn("PlayerRack.renderExposures: Invalid exposures array provided");return}e.forEach((s,i)=>{if(!s){console.warn(`PlayerRack.renderExposures: Skipping null/undefined exposure at index ${i}`);return}const n=Array.isArray(s.tiles)?s.tiles:[];n.length===0&&console.warn(`PlayerRack.renderExposures: Empty or invalid tiles array for exposure at index ${i}`);const r=document.createElement("div");r.className="exposure-set",n.forEach(l=>{if(l){const c=M.createTileElement(l,"small");c.classList.add("exposed-tile"),r.appendChild(c)}}),r.children.length>0&&t.appendChild(r)})}}const N=["tile-drawing","tile-discarding","tile-claiming-pulse","tile-claiming-move","tile-exposing"],Y=["turn-starting","turn-ending"],O="hand-sorting",H="invalid-action",ae=[{x:0,y:0},{x:90,y:-60},{x:0,y:-140},{x:-90,y:-60}],ce=500,de=400,he=600,ue=300,me=500,K=50,pe=16,g=(a,e=0)=>`${typeof a=="number"&&!Number.isNaN(a)?a:e}px`,ge=a=>a?Array.isArray(a)?a.filter(Boolean):Array.from(a).filter(Boolean):[];class fe{constructor(e={}){this.duration=typeof e.duration=="number"?e.duration:300,this.easing=e.easing||"ease-out",this.prefersReducedMotion=typeof window<"u"&&typeof window.matchMedia=="function"?window.matchMedia("(prefers-reduced-motion: reduce)").matches:!1,this._elementTimers=new WeakMap}animateTileDraw(e,t={},s={}){return new Promise(i=>{if(!e){i();return}this._resetElementAnimation(e,N);const n={"--start-x":g(t.x,0),"--start-y":g(t.y,-200),"--end-x":g(s.x,0),"--end-y":g(s.y,0),"--tile-draw-duration":`${this.duration}ms`,"--tile-draw-easing":this.easing};this._setCssVariables(e,n),this._applyAnimationClass(e,"tile-drawing"),this._scheduleTimer(e,this.duration,()=>{e.classList.remove("tile-drawing"),this._clearCssVariables(e,Object.keys(n)),i()})})}animateTileDiscard(e,t={}){return new Promise(s=>{if(!e){s();return}this._resetElementAnimation(e,N);const i=this.duration+100,n={"--start-x":g(0),"--start-y":g(0),"--target-x":g(t.x,0),"--target-y":g(t.y,100),"--tile-discard-duration":`${i}ms`,"--tile-discard-easing":"ease-in"};this._setCssVariables(e,n),this._applyAnimationClass(e,"tile-discarding"),this._scheduleTimer(e,i,()=>{e.classList.remove("tile-discarding"),this._clearCssVariables(e,Object.keys(n)),s()})})}animateTileClaim(e,t=0,s={}){return new Promise(i=>{if(!e){i();return}this._resetElementAnimation(e,N);const n=ae[t]||{x:0,y:-200},r={"--claim-offset-x":g(n.x,0),"--claim-offset-y":g(n.y,-200),"--target-x":g(s.x,0),"--target-y":g(s.y,0),"--tile-claim-duration":`${this.duration}ms`};this._setCssVariables(e,r),this._applyAnimationClass(e,"tile-claiming-pulse"),this._scheduleTimer(e,ce,()=>{e.classList.remove("tile-claiming-pulse"),this._applyAnimationClass(e,"tile-claiming-move"),this._scheduleTimer(e,this.duration,()=>{e.classList.remove("tile-claiming-move"),this._clearCssVariables(e,Object.keys(r)),i()})})})}animateTurnStart(e){return this._runSimpleAnimation(e,"turn-starting",he)}animateTurnEnd(e){return this._runSimpleAnimation(e,"turn-ending",ue)}animateHandSort(e){return this._runSimpleAnimation(e,O,de)}animateExposure(e,t={}){const s=ge(e);return new Promise(i=>{if(!s.length){i();return}s.forEach((l,c)=>{this._resetElementAnimation(l,N);const d={"--target-x":g(t.x,0),"--target-y":g(t.y,0)};this._setCssVariables(l,d),l.style.animationDelay=this.prefersReducedMotion?"0ms":`${c*K}ms`,this._applyAnimationClass(l,"tile-exposing")});const n=this.duration+s.length*K,r=s[0];this._scheduleTimer(r,n,()=>{s.forEach(l=>{l.classList.remove("tile-exposing"),l.style.animationDelay="",this._clearCssVariables(l,["--target-x","--target-y"])}),i()})})}animateInvalidAction(e){return this._runSimpleAnimation(e,H,me)}_runSimpleAnimation(e,t,s){return new Promise(i=>{if(!e){i();return}const n=[];Y.includes(t)?n.push(...Y):t===O?n.push(O):t===H&&n.push(H),this._resetElementAnimation(e,n),this._applyAnimationClass(e,t),this._scheduleTimer(e,s,()=>{e.classList.remove(t),i()})})}_resetElementAnimation(e,t=[]){e&&(this._cancelTimers(e),t.forEach(s=>e.classList.remove(s)))}_setCssVariables(e,t={}){!e||!e.style||Object.entries(t).forEach(([s,i])=>{i==null?e.style.removeProperty(s):e.style.setProperty(s,i)})}_clearCssVariables(e,t=[]){!e||!e.style||t.forEach(s=>e.style.removeProperty(s))}_applyAnimationClass(e,t){e&&(e.classList.remove(t),e.offsetWidth,e.classList.add(t))}_scheduleTimer(e,t,s){const i=this.prefersReducedMotion?Math.min(t,pe):t,n=setTimeout(()=>{this._deregisterTimer(e,n),s()},i);return this._registerTimer(e,n),n}_registerTimer(e,t){if(!e)return;let s=this._elementTimers.get(e);s||(s=new Set,this._elementTimers.set(e,s)),s.add(t)}_deregisterTimer(e,t){if(!e)return;const s=this._elementTimers.get(e);s&&(s.delete(t),s.size===0&&this._elementTimers.delete(e))}_cancelTimers(e){if(!e)return;const t=this._elementTimers.get(e);t&&(t.forEach(s=>clearTimeout(s)),this._elementTimers.delete(e))}}const D=v.BOTTOM;class be{constructor(e={}){if(!e.gameController)throw new Error("MobileRenderer requires a GameController instance");this.gameController=e.gameController,this.statusElement=e.statusElement||null,this.subscriptions=[],this.handRenderer=new ne(e.handContainer,null),this.discardPile=new le(e.discardContainer),this.playerRack=e.playerRackContainer?new oe(e.playerRackContainer):null,this.animationController=new fe,this.handRenderer.setSelectionBehavior({mode:"multiple",maxSelectable:1/0,allowToggle:!0}),this.handRenderer.setSelectionListener(t=>this.onHandSelectionChange(t)),this.opponentBars=this.createOpponentBars(e.opponentContainers||{}),this.actionButton=document.getElementById("new-game-btn"),this.drawButton=document.getElementById("draw-btn"),this.sortButton=document.getElementById("sort-btn"),this.promptUI=this.createPromptUI(e.promptRoot||document.body),this.pendingPrompt=null,this.latestHandSnapshot=null,this.latestHandSnapshot=null,this.setupButtonListeners(),this.registerEventListeners(),this.sortButton&&(this.sortButton.style.display="none"),this.drawButton&&(this.drawButton.style.display="none"),this.hintsPanel=document.getElementById("hints-panel"),this.hintsPanel&&(this.hintsPanel.style.display="none"),this.updateActionButton({label:"Start",onClick:()=>this.startGame()})}destroy(){var e,t,s,i;this.subscriptions.forEach(n=>{typeof n=="function"&&n()}),this.subscriptions=[],(e=this.handRenderer)==null||e.destroy(),(t=this.discardPile)==null||t.destroy(),(i=(s=this.promptUI)==null?void 0:s.container)==null||i.remove(),this.pendingPrompt=null}registerEventListeners(){const e=this.gameController;this.subscriptions.push(e.on("GAME_STARTED",t=>this.onGameStarted(t))),this.subscriptions.push(e.on("GAME_ENDED",t=>this.onGameEnded(t))),this.subscriptions.push(e.on("STATE_CHANGED",t=>this.onStateChanged(t))),this.subscriptions.push(e.on("TILES_DEALT",()=>{e.emit("DEALING_COMPLETE")})),this.subscriptions.push(e.on("HAND_UPDATED",t=>this.onHandUpdated(t))),this.subscriptions.push(e.on("TURN_CHANGED",t=>this.onTurnChanged(t))),this.subscriptions.push(e.on("TILE_DISCARDED",t=>this.onTileDiscarded(t))),this.subscriptions.push(e.on("DISCARD_CLAIMED",()=>this.discardPile.removeLatestDiscard())),this.subscriptions.push(e.on("TILES_EXPOSED",()=>this.refreshOpponentBars())),this.subscriptions.push(e.on("MESSAGE",t=>this.onMessage(t))),this.subscriptions.push(e.on("CHARLESTON_PHASE",t=>{this.updateStatus(`Charleston ${t.phase}: Pass ${t.round}`)})),this.subscriptions.push(e.on("COURTESY_VOTE",t=>{this.updateStatus(`Player ${t.player} voted ${t.vote} for courtesy pass`)})),this.subscriptions.push(e.on("COURTESY_PASS",()=>{this.refreshOpponentBars()})),this.subscriptions.push(e.on("UI_PROMPT",t=>this.handleUIPrompt(t)))}createOpponentBars(e){const t=[];return[{key:"top",playerIndex:v.RIGHT},{key:"left",playerIndex:v.TOP},{key:"right",playerIndex:v.LEFT}].forEach(({key:i,playerIndex:n})=>{const r=e[i];if(!r)return;const l=this.gameController.players[n],c=new re(r,l);t.push({playerIndex:n,bar:c})}),t}createPromptUI(e){const t=document.createElement("div");t.className="mobile-prompt hidden";const s=document.createElement("div");s.className="mobile-prompt__message",t.appendChild(s);const i=document.createElement("div");i.className="mobile-prompt__hint",t.appendChild(i);const n=document.createElement("div");return n.className="mobile-prompt__actions",t.appendChild(n),e.appendChild(t),{container:t,message:s,hint:i,actions:n,primaryButton:null}}setupButtonListeners(){const e=this.drawButton,t=this.sortButton;e&&e.addEventListener("click",()=>this.onDrawClicked()),t&&t.addEventListener("click",()=>this.onSortClicked())}onDrawClicked(){this.canDrawTile()&&this.gameController.drawTile()}onSortClicked(){if(!this.latestHandSnapshot||!Array.isArray(this.latestHandSnapshot.tiles))return;const e=typeof this.latestHandSnapshot.clone=="function"?this.latestHandSnapshot.clone():B.fromJSON(this.latestHandSnapshot);typeof e.sortBySuit=="function"?e.sortBySuit():e.tiles.sort((t,s)=>t.suit!==s.suit?t.suit-s.suit:t.number-s.number),this.latestHandSnapshot=e,this.handRenderer.render(e),this.animationController.animateHandSort(this.handRenderer.container)}canDrawTile(){var t,s;const e=((t=this.gameController)==null?void 0:t.state)??((s=this.gameController)==null?void 0:s.gameState);return this.gameController.currentPlayer===D&&(e===A.LOOP_PICK_FROM_WALL||e==="LOOP_PICK_FROM_WALL")}onGameStarted(){this.discardPile.clear(),this.resetHandSelection(),this.updateStatus("Game started - dealing tiles..."),this.refreshOpponentBars(),this.playerRack&&this.playerRack.update(new B),this.updateActionButton({label:"Start",onClick:()=>this.startGame(),disabled:!0,visible:!0}),this.hintsPanel&&(this.hintsPanel.style.display="block")}onGameEnded(e){var s;const t=(e==null?void 0:e.reason)??"end";if(t==="mahjong"){const i=(s=this.gameController.players)==null?void 0:s[e.winner];this.updateStatus(i?`${i.name} wins!`:"Mahjong!")}else t==="wall_game"?this.updateStatus("Wall game - no winner"):this.updateStatus("Game ended");this.hidePrompt(),this.resetHandSelection(),this.updateActionButton({label:"Start",onClick:()=>this.startGame(),disabled:!1,visible:!0})}onStateChanged(e){if(!e)return;this.updateStatus(`State: ${e.newState}`);const t=this.drawButton,s=this.sortButton;if(t){const i=this.canDrawTile();t.style.display=i?"flex":"none",t.disabled=!i}if(s){const i=e.newState>=A.LOOP_PICK_FROM_WALL&&e.newState<=A.LOOP_EXPOSE_TILES_COMPLETE;s.style.display=i?"flex":"none"}this.updateActionButtonStateForGame(e.newState)}onHandUpdated(e){if(!e)return;const t=this.gameController.players[e.player];if(t)if(e.player===D){const s=B.fromJSON(e.hand);if(this.latestHandSnapshot=s,this.handRenderer.render(s),this.playerRack&&this.playerRack.update(s),s.tiles.length%3===2){const i=this.handRenderer.getLastTileElement();i&&this.animationController.animateTileDraw(i)}}else{const s=this.opponentBars.find(i=>i.playerIndex===e.player);s&&s.bar.update(t)}}onTurnChanged(e){const t=(e==null?void 0:e.currentPlayer)??this.gameController.currentPlayer;if(this.gameController.players.forEach((s,i)=>{s.isCurrentTurn=i===t}),this.refreshOpponentBars(),t===D)this.updateStatus("Your turn"),this.animationController.animateTurnStart(this.handRenderer.container);else{const s=this.opponentBars.find(i=>i.playerIndex===t);s&&s.bar.container&&this.animationController.animateTurnStart(s.bar.container)}this.updateActionButtonStateForGame(this.gameController.state)}onTileDiscarded(e){if(!(e!=null&&e.tile))return;const t=E.fromJSON(e.tile);if(this.discardPile.addDiscard(t,e.player),e.player===D){const s=this.discardPile.getLatestDiscardElement();s&&this.animationController.animateTileDiscard(s)}}onMessage(e){e!=null&&e.text&&this.updateStatus(e.text)}refreshOpponentBars(){this.opponentBars.forEach(({playerIndex:e,bar:t})=>{const s=this.gameController.players[e];s&&t.update(s)})}updateStatus(e){this.statusElement&&(this.statusElement.textContent=e)}handleUIPrompt(e){var t,s,i,n,r,l,c,d,h,f,y,C,w,L,x;if(e)switch(this.pendingPrompt&&(console.warn("MobileRenderer: New prompt received while previous prompt pending. Clearing previous prompt state."),this.resetHandSelection(),this.hidePrompt(),this.pendingPrompt=null),e.promptType){case"CHOOSE_DISCARD":this.startTileSelectionPrompt({title:"Choose a tile to discard",hint:"Tap one tile and press Discard",min:1,max:1,confirmLabel:"Discard",cancelLabel:null,fallback:null,useActionButton:!0,callback:o=>{if(!o||o.length===0){e.callback(null);return}e.callback(o[0])}}),this.updateActionButton({label:"Discard",onClick:()=>this.confirmPendingSelection(),disabled:!0,visible:!0});break;case"CHARLESTON_PASS":this.startTileSelectionPrompt({title:`Charleston Pass (${((t=e.options)==null?void 0:t.direction)??"?"})`,hint:`Select ${((s=e.options)==null?void 0:s.requiredCount)??3} tiles to pass`,min:((i=e.options)==null?void 0:i.requiredCount)??3,max:((n=e.options)==null?void 0:n.requiredCount)??3,confirmLabel:"Pass Tiles",cancelLabel:null,fallback:null,callback:o=>e.callback(o)});break;case"SELECT_TILES":this.startTileSelectionPrompt({title:((r=e.options)==null?void 0:r.question)??"Select tiles",hint:`Select ${((l=e.options)==null?void 0:l.minTiles)??1}â€“${((c=e.options)==null?void 0:c.maxTiles)??3} tiles`,min:((d=e.options)==null?void 0:d.minTiles)??1,max:((h=e.options)==null?void 0:h.maxTiles)??3,confirmLabel:"Confirm",cancelLabel:"Cancel",fallback:()=>{var o;return this.getFallbackTiles(Math.max(1,((o=e.options)==null?void 0:o.minTiles)??1))},callback:o=>e.callback(o)});break;case"CLAIM_DISCARD":{const o=(f=e.options)==null?void 0:f.tile,b=o instanceof E?o:o?E.fromJSON(o):null;this.showChoicePrompt({title:b?`Claim ${b.getText()}?`:"Claim discard?",hint:"Choose how to react",options:(((y=e.options)==null?void 0:y.options)||[]).map(I=>({label:I,value:I})),onSelect:I=>e.callback(I)});break}case"EXPOSE_TILES":this.showChoicePrompt({title:"Expose selected tiles?",hint:"Exposed tiles become visible to everyone",options:[{label:"Expose",value:!0,primary:!0},{label:"Keep Hidden",value:!1}],onSelect:o=>e.callback(o)});break;case"YES_NO":this.showChoicePrompt({title:((C=e.options)==null?void 0:C.message)??"Continue?",hint:"",options:[{label:"Yes",value:!0,primary:!0},{label:"No",value:!1}],onSelect:o=>e.callback(o)});break;case"CHARLESTON_CONTINUE":this.showChoicePrompt({title:((w=e.options)==null?void 0:w.question)??"Continue to Charleston phase 2?",hint:"",options:[{label:"Yes",value:"Yes",primary:!0},{label:"No",value:"No"}],onSelect:o=>e.callback(o)});break;case"COURTESY_VOTE":this.showChoicePrompt({title:((L=e.options)==null?void 0:L.question)??"Courtesy pass vote",hint:"How many tiles to exchange?",options:(((x=e.options)==null?void 0:x.options)||["0","1","2","3"]).map(o=>({label:o,value:o})),onSelect:o=>e.callback(o)});break;default:console.warn(`Unhandled UI prompt: ${e.promptType}`),e.callback(null)}}startTileSelectionPrompt(e){this.updateStatus(e.title),this.pendingPrompt={type:"tile-selection",min:e.min,max:e.max,callback:e.callback,fallback:e.fallback,confirmUsesActionButton:!!e.useActionButton},this.handRenderer.setSelectionBehavior({mode:e.max===1?"single":"multiple",maxSelectable:e.max,allowToggle:!0}),this.handRenderer.clearSelection(!0);const t=e.useActionButton?[]:[{label:e.confirmLabel??"Confirm",primary:!0,disabled:!0,onClick:()=>this.resolveTileSelectionPrompt()}];e.cancelLabel&&t.push({label:e.cancelLabel,onClick:()=>this.cancelTileSelectionPrompt()}),e.useActionButton&&this.updateActionButton({label:e.confirmLabel??"Confirm",onClick:()=>this.confirmPendingSelection(),disabled:!0,visible:!0}),this.showPrompt(e.title,e.hint,t),this.updateTileSelectionHint()}onHandSelectionChange(e){!this.pendingPrompt||this.pendingPrompt.type!=="tile-selection"||this.updateTileSelectionHint(e)}updateTileSelectionHint(e=this.handRenderer.getSelectionState()){if(!this.pendingPrompt||this.pendingPrompt.type!=="tile-selection")return;const{min:t,max:s}=this.pendingPrompt,i=e.count,n=i>=t&&i<=s;this.setPromptHint(`Selected ${i}/${s}${t===s?"":` (need at least ${t})`}`),this.setPrimaryEnabled(n),this.actionButton&&this.pendingPrompt.confirmUsesActionButton&&(this.actionButton.disabled=!n)}resolveTileSelectionPrompt(){if(!this.pendingPrompt||this.pendingPrompt.type!=="tile-selection")return;const e=this.handRenderer.getSelectionState(),{min:t,max:s}=this.pendingPrompt;if(e.count<t||e.count>s)return;const i=this.pendingPrompt.callback;this.resetHandSelection(),this.hidePrompt(),this.pendingPrompt=null,i(e.tiles)}cancelTileSelectionPrompt(){if(!this.pendingPrompt||this.pendingPrompt.type!=="tile-selection")return;const e=this.pendingPrompt.fallback,t=typeof e=="function"?e():[],s=this.pendingPrompt.callback;this.resetHandSelection(),this.hidePrompt(),this.pendingPrompt=null,s(t)}resetHandSelection(){this.handRenderer.clearSelection(!0),this.handRenderer.setSelectionBehavior({mode:"multiple",maxSelectable:1/0,allowToggle:!0})}showChoicePrompt({title:e,hint:t,options:s,onSelect:i}){this.updateStatus(e);const n=(s||[]).map(r=>({label:r.label,primary:r.primary,onClick:()=>{this.hidePrompt(),i(r.value)}}));this.showPrompt(e,t,n)}showPrompt(e,t,s){this.promptUI.message.textContent=e,this.setPromptHint(t),this.promptUI.actions.innerHTML="",this.promptUI.primaryButton=null,s.forEach(i=>{const n=document.createElement("button");n.textContent=i.label,i.primary&&(n.classList.add("primary"),this.promptUI.primaryButton=n),i.disabled&&(n.disabled=!0),n.addEventListener("click",i.onClick),this.promptUI.actions.appendChild(n)}),this.promptUI.container.classList.remove("hidden")}hidePrompt(){this.promptUI.container.classList.add("hidden"),this.promptUI.primaryButton=null}setPromptHint(e){this.promptUI.hint&&(this.promptUI.hint.textContent=e??"")}setPrimaryEnabled(e){this.promptUI.primaryButton&&(this.promptUI.primaryButton.disabled=!e)}getFallbackTiles(e=1){return!this.latestHandSnapshot||!Array.isArray(this.latestHandSnapshot.tiles)?[]:this.latestHandSnapshot.tiles.slice(0,e).map(t=>t instanceof E?t.clone():E.fromJSON(t)).filter(Boolean)}updateActionButton({label:e,onClick:t,disabled:s=!1,visible:i=!0}={}){this.actionButton&&(e&&(this.actionButton.textContent=e),this.actionButton.onclick=t||null,this.actionButton.disabled=!!s,this.actionButton.style.display=i?"flex":"none")}updateActionButtonStateForGame(e){var n;if(!this.actionButton)return;const t=this.gameController.currentPlayer===D;if(e===A.LOOP_CHOOSE_DISCARD&&t&&((n=this.pendingPrompt)==null?void 0:n.type)==="tile-selection"){this.pendingPrompt.confirmUsesActionButton=!0;const r=this.handRenderer.getSelectionState(),l=r.count>=(this.pendingPrompt.min||1)&&r.count<=(this.pendingPrompt.max||1);this.updateActionButton({label:"Discard",onClick:()=>this.confirmPendingSelection(),disabled:!l,visible:!0});return}const i=e===A.INIT||e===A.START||e===A.DEAL;this.updateActionButton({label:"Start",onClick:()=>this.startGame(),disabled:!1,visible:i})}confirmPendingSelection(){var e;((e=this.pendingPrompt)==null?void 0:e.type)==="tile-selection"&&this.resolveTileSelectionPrompt()}startGame(){typeof this.gameController.startGame=="function"&&this.gameController.startGame()}handleAssetError(e,t){console.error(`Failed to load ${e}: ${t}`),e==="tiles.png"&&(this.showAssetError("Tile graphics failed to load. Using text mode."),this.enableTextModeFallback())}showAssetError(e){const t=document.createElement("div");t.className="error-banner",t.textContent=e,document.body.appendChild(t),setTimeout(()=>t.remove(),5e3)}enableTextModeFallback(){console.warn("Text mode fallback requested but not fully implemented in HandRenderer yet")}}const _={IDLE:"idle",TOUCHING:"touching",MOVED:"moved"};class ye{constructor(e,t={}){this.rootElement=e,this.options={tapMaxDuration:300,tapMaxMovement:10,doubleTapWindow:500,doubleTapDistance:20,longPressDuration:500,swipeMinDistance:50,enableDoubleTap:!1,enableLongPress:!1,enableSwipe:!1,...t},this.listeners={tap:[],doubletap:[],longpress:[],swipeup:[]},this.state=this.createInitialState(),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleTouchCancel=this.handleTouchCancel.bind(this)}createInitialState(){return{current:_.IDLE,startTime:null,startX:null,startY:null,currentX:null,currentY:null,element:null,lastTapTime:null,lastTapX:null,lastTapY:null,longPressTimer:null}}init(){this.rootElement.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.rootElement.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.rootElement.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),this.rootElement.addEventListener("touchcancel",this.handleTouchCancel,{passive:!1})}on(e,t){if(!this.listeners[e])throw new Error(`Unknown gesture type: ${e}`);this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(s=>s!==t))}emit(e,t){t.element&&!document.body.contains(t.element)||this.listeners[e]&&this.listeners[e].forEach(s=>s(t))}destroy(){this.rootElement.removeEventListener("touchstart",this.handleTouchStart),this.rootElement.removeEventListener("touchmove",this.handleTouchMove),this.rootElement.removeEventListener("touchend",this.handleTouchEnd),this.rootElement.removeEventListener("touchcancel",this.handleTouchCancel),clearTimeout(this.state.longPressTimer)}getElementAtPoint(e,t){return document.elementFromPoint(e,t)}resetState(){clearTimeout(this.state.longPressTimer),this.state=this.createInitialState()}handleTouchStart(e){if(e.touches.length>1){this.resetState();return}const t=e.touches[0];this.state.current=_.TOUCHING,this.state.startTime=Date.now(),this.state.startX=t.clientX,this.state.startY=t.clientY,this.state.currentX=t.clientX,this.state.currentY=t.clientY,this.state.element=this.getElementAtPoint(t.clientX,t.clientY),this.options.enableLongPress&&(this.state.longPressTimer=setTimeout(()=>{this.state.current===_.TOUCHING&&Math.sqrt(Math.pow(this.state.currentX-this.state.startX,2)+Math.pow(this.state.currentY-this.state.startY,2))<this.options.tapMaxMovement&&(this.emit("longpress",{type:"longpress",element:this.state.element,coordinates:{x:this.state.startX,y:this.state.startY},timestamp:Date.now()}),this.resetState())},this.options.longPressDuration))}handleTouchMove(e){if(this.state.current===_.IDLE)return;const t=e.touches[0];this.state.currentX=t.clientX,this.state.currentY=t.clientY;const s=this.state.currentX-this.state.startX,i=this.state.currentY-this.state.startY;Math.sqrt(s*s+i*i)>this.options.tapMaxMovement&&(this.state.current=_.MOVED,clearTimeout(this.state.longPressTimer))}handleTouchEnd(e){if(this.state.current===_.IDLE)return;const t=e.changedTouches[0],s=Date.now()-this.state.startTime,i=Math.abs(t.clientX-this.state.startX),n=Math.abs(t.clientY-this.state.startY),r=Math.sqrt(i*i+n*n);if(clearTimeout(this.state.longPressTimer),this.state.current===_.TOUCHING&&s<this.options.tapMaxDuration&&r<this.options.tapMaxMovement)this.state.element&&this.state.element.closest(".tile")&&this.handleTileTap(this.state.element.closest(".tile")),this.emit("tap",{type:"tap",element:this.state.element,coordinates:{x:t.clientX,y:t.clientY},timestamp:Date.now(),target:e.target}),this.options.enableDoubleTap?this.checkDoubleTap(t.clientX,t.clientY):this.resetState();else if(n>this.options.swipeMinDistance&&n>i){const l=t.clientY<this.state.startY?"up":"down";l==="up"&&this.state.element&&this.state.element.closest(".tile")&&this.handleTileDrag(this.state.element.closest(".tile"),n),this.emit(`swipe${l}`,{type:`swipe${l}`,element:this.state.element,distance:n,timestamp:Date.now()}),this.resetState()}else if(i>this.options.swipeMinDistance&&i>n){const l=t.clientX<this.state.startX?"left":"right";this.emit(`swipe${l}`,{type:`swipe${l}`,element:this.state.element,distance:i,timestamp:Date.now()}),this.resetState()}else this.resetState();document.querySelectorAll(".tile--selected").forEach(l=>{l.classList.remove("tile--selected")})}handleTileTap(e){const t=e.dataset.tileId;this.emit("tile-touched",{tileId:t,element:e})}handleTileDrag(e,t){this.emit("tile-swiped",{tileId:e.dataset.tileId,direction:"up",element:e})}handleTouchCancel(e){this.resetState()}checkDoubleTap(e,t){const s=Date.now(),i=this.state.lastTapTime,n=this.state.lastTapX,r=this.state.lastTapY,l=this.state.element;if(this.resetState(),i!==null){const c=s-i,d=Math.abs(e-n),h=Math.abs(t-r),f=Math.sqrt(d*d+h*h);if(c<this.options.doubleTapWindow&&f<this.options.doubleTapDistance){this.emit("doubletap",{type:"doubletap",element:l,coordinates:{x:e,y:t},timestamp:s});return}}this.state.lastTapTime=s,this.state.lastTapX=e,this.state.lastTapY=t}}let T,P,u,$;function Te(){J.incrementGamesPlayed()}function Ee(){const a=document.createElement("div");return a.className="bottom-menu",document.body.appendChild(a),a}document.addEventListener("DOMContentLoaded",()=>{console.log("Mobile Mahjong app initializing...");const a=document.getElementById("loading");if(a&&(a.style.display="none"),!document.getElementById("mobile-settings-btn")){const e=document.querySelector(".bottom-menu")||Ee(),t=document.createElement("button");t.id="mobile-settings-btn",t.className="menu-btn",t.innerHTML="âš™ï¸ SETTINGS",e.appendChild(t)}Se()});async function Se(){console.log("Initializing mobile game...");const a=document.getElementById("hand-container"),e=document.getElementById("player-rack-container"),t=document.getElementById("discard-container"),s=document.getElementById("game-status"),i=document.getElementById("opponent-left"),n=document.getElementById("opponent-top"),r=document.getElementById("opponent-right"),l=m.load();console.log("Loaded settings:",l);const c=new q(l.cardYear);await c.init(),P=new z(c,null,l.difficulty);const h=new URLSearchParams(window.location.search).get("skipCharleston"),f=h!==null?h==="true":l.skipCharleston;T=new X,await T.init({aiEngine:P,cardValidator:c,settings:{year:l.cardYear,difficulty:l.difficulty,skipCharleston:f,trainingMode:l.trainingMode,trainingTileCount:l.trainingTileCount,useBlankTiles:l.useBlankTiles}}),u=new be({gameController:T,handContainer:a,discardContainer:t,statusElement:s,opponentContainers:{left:i,top:n,right:r},playerRackContainer:e,promptRoot:document.body});const y=new ye(document.body,{enableSwipe:!0,swipeMinDistance:30});y.init(),y.on("tap",o=>{if(o.element&&o.element.classList.contains("tile")){const b=parseInt(o.element.dataset.index,10);!isNaN(b)&&u.handRenderer&&u.handRenderer.handleTileClick(b)}}),y.on("swipeup",o=>{if(o.element&&o.element.classList.contains("tile")){const b=parseInt(o.element.dataset.index,10);!isNaN(b)&&u.handRenderer&&u.handRenderer.handleTileClick(b)}});const C=document.getElementById("wall-counter");C&&(new Q(C,T),console.log("WallCounter initialized"));const w=document.getElementById("hints-panel");w&&(new Z(w,T,P),console.log("HintsPanel initialized")),T.on("GAME_ENDED",()=>Te());const L=document.getElementById("new-game-btn");L&&(L.onclick=async()=>{console.log("Start button clicked!");try{console.log("Starting game...",T),u==null||u.updateStatus("Starting game..."),await T.startGame(),console.log("Game started successfully")}catch(o){console.error("Error starting game:",o),u==null||u.updateStatus(`Error: ${o.message}`)}});const x=document.getElementById("mobile-settings-btn");x&&!$&&($=new j,x.onclick=()=>{$.open()}),window.addEventListener("settingsChanged",o=>{console.log("Settings changed, will take effect on next game:",o.detail),u==null||u.updateStatus("Settings saved! Start a new game for changes to take effect."),o.detail.difficulty&&P&&(P.difficulty=o.detail.difficulty,console.log("AI difficulty updated to:",o.detail.difficulty))}),u==null||u.updateStatus(""),window.location.search.includes("playwright=true")&&(window.gameController=T,window.aiEngine=P,window.mobileRenderer=u),console.log("Mobile game initialized successfully")}
