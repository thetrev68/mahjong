import{d as v,S as I,a as c,T as D,P as b,V as k,D as F,W as V,b as y,C as J,p as f,c as h,s as z,g as U,e as x,f as W,H as j,h as K,i as X,j as P,k as H,l as R,m as L,n as Q,o as w,q,r as O,G as Z}from"./GameController-DDguyC2P.js";class ee{constructor(){this.overlay=document.getElementById("settings-overlay"),this.saveButton=document.getElementById("settings-save"),this.cancelButton=document.getElementById("settings-cancel"),this.settingsButton=document.getElementById("settings"),this.originalSettings={},this.init(),this.loadSettings()}init(){this.settingsButton.addEventListener("click",()=>{this.showSettings()}),this.saveButton.addEventListener("click",()=>{this.saveAndClose()}),this.cancelButton.addEventListener("click",()=>{this.cancelAndClose()}),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.cancelAndClose()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.overlay.style.display!=="none"&&this.cancelAndClose()});const e=document.getElementById("trainCheckbox");e&&e.addEventListener("change",()=>{this.updateTrainingFormVisibility()}),this.setupAudioControls()}showSettings(){this.overlay.style.display="flex",this.storeCurrentSettingsState(),this.saveButton.focus()}hideSettings(){this.overlay.style.display="none",this.settingsButton.focus()}storeCurrentSettingsState(){var e,t,n,s,i,a,o,r,l,d;this.originalSettings={trainingMode:((e=document.getElementById("trainCheckbox"))==null?void 0:e.checked)??!1,trainingHand:((t=document.getElementById("handSelect"))==null?void 0:t.value)??"",trainingTileCount:((n=document.getElementById("numTileSelect"))==null?void 0:n.value)??"9",skipCharleston:((s=document.getElementById("skipCharlestonCheckbox"))==null?void 0:s.checked)??!1,cardYear:((i=document.getElementById("yearSelect"))==null?void 0:i.value)??"2025",useBlankTiles:((a=document.getElementById("useBlankTiles"))==null?void 0:a.checked)??!1,bgmVolume:((o=document.getElementById("bgmVolume"))==null?void 0:o.value)??"70",bgmMuted:((r=document.getElementById("bgmMute"))==null?void 0:r.checked)??!1,sfxVolume:((l=document.getElementById("sfxVolume"))==null?void 0:l.value)??"80",sfxMuted:((d=document.getElementById("sfxMute"))==null?void 0:d.checked)??!1}}restoreOriginalSettings(){const e=document.getElementById("trainCheckbox"),t=document.getElementById("handSelect"),n=document.getElementById("numTileSelect"),s=document.getElementById("skipCharlestonCheckbox"),i=document.getElementById("yearSelect"),a=document.getElementById("useBlankTiles"),o=document.getElementById("bgmVolume"),r=document.getElementById("bgmVolumeValue"),l=document.getElementById("bgmMute"),d=document.getElementById("sfxVolume"),m=document.getElementById("sfxVolumeValue"),p=document.getElementById("sfxMute");e&&(e.checked=this.originalSettings.trainingMode),t&&(t.value=this.originalSettings.trainingHand),n&&(n.value=this.originalSettings.trainingTileCount),s&&(s.checked=this.originalSettings.skipCharleston),i&&(i.value=this.originalSettings.cardYear),a&&(a.checked=this.originalSettings.useBlankTiles),o&&(o.value=this.originalSettings.bgmVolume,r&&(r.textContent=`${this.originalSettings.bgmVolume}%`)),l&&(l.checked=this.originalSettings.bgmMuted),d&&(d.value=this.originalSettings.sfxVolume,m&&(m.textContent=`${this.originalSettings.sfxVolume}%`)),p&&(p.checked=this.originalSettings.sfxMuted),this.updateTrainingFormVisibility()}saveAndClose(){var s;const e=this.getSetting("cardYear","2025"),t=((s=document.getElementById("yearSelect"))==null?void 0:s.value)??"2025",n=e!==t;if(this.saveTrainingSettings(),this.saveDifficultySettings(),this.saveYearSettings(),this.saveHouseRuleSettings(),this.saveAudioSettings(),n&&window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const i=window.game.scene.getScene("GameScene");if(i.gGameLogic){const a=document.getElementById("handSelect");a&&(a.innerHTML=""),i.gGameLogic.init().then(()=>{})}}this.hideSettings()}cancelAndClose(){this.restoreOriginalSettings(),this.hideSettings()}getDifficulty(){return this.getSetting("aiDifficulty","medium")}getCardYear(){return this.getSetting("cardYear","2025")}saveSetting(e,t){try{I.set(e,t)}catch(n){console.warn("Failed to save setting:",n)}}getSetting(e,t=null){return I.get(e)??t}getAllSettings(){return I.load()}loadSettings(){const e=I.load();this.applyTrainingSettings(e),this.applyDifficultySettings(e),this.applyYearSettings(e),this.applyHouseRuleSettings(e),this.applyAudioSettings(e)}applyTrainingSettings(e){const t=document.getElementById("trainCheckbox"),n=document.getElementById("handSelect"),s=document.getElementById("numTileSelect"),i=document.getElementById("skipCharlestonCheckbox");t&&Object.prototype.hasOwnProperty.call(e,"trainingMode")&&(t.checked=e.trainingMode),n&&e.trainingHand&&(n.value=e.trainingHand),s&&e.trainingTileCount&&(s.value=e.trainingTileCount.toString()),i&&Object.prototype.hasOwnProperty.call(e,"skipCharleston")&&(i.checked=e.skipCharleston),this.updateTrainingFormVisibility()}applyDifficultySettings(e){const t=document.getElementById("difficultySelect");t&&e.aiDifficulty&&(t.value=e.aiDifficulty)}applyYearSettings(e){const t=document.getElementById("yearSelect");t&&e.cardYear&&(t.value=e.cardYear)}updateTrainingFormVisibility(){const e=document.getElementById("trainCheckbox"),t=document.getElementById("trainfieldset2");e&&t&&(t.disabled=!e.checked)}saveTrainingSettings(){var t,n,s,i;const e={};e.trainingMode=((t=document.getElementById("trainCheckbox"))==null?void 0:t.checked)??!1,e.trainingHand=((n=document.getElementById("handSelect"))==null?void 0:n.value)??"",e.trainingTileCount=parseInt(((s=document.getElementById("numTileSelect"))==null?void 0:s.value)??"9",10),e.skipCharleston=((i=document.getElementById("skipCharlestonCheckbox"))==null?void 0:i.checked)??!0,I.save(e),window.dispatchEvent(new window.CustomEvent("settingsChanged",{detail:e}))}saveDifficultySettings(){var t;const e={};e.difficulty=((t=document.getElementById("difficultySelect"))==null?void 0:t.value)??"medium",I.save(e)}saveYearSettings(){var t;const e={};e.cardYear=parseInt(((t=document.getElementById("yearSelect"))==null?void 0:t.value)??"2025",10),I.save(e)}saveHouseRuleSettings(){var t;const e={};e.useBlankTiles=((t=document.getElementById("useBlankTiles"))==null?void 0:t.checked)??!1,I.save(e)}saveAudioSettings(){var t,n,s,i;const e={};e.bgmVolume=parseInt(((t=document.getElementById("bgmVolume"))==null?void 0:t.value)??"70",10),e.bgmMuted=((n=document.getElementById("bgmMute"))==null?void 0:n.checked)??!1,e.sfxVolume=parseInt(((s=document.getElementById("sfxVolume"))==null?void 0:s.value)??"80",10),e.sfxMuted=((i=document.getElementById("sfxMute"))==null?void 0:i.checked)??!1,I.save(e)}applyHouseRuleSettings(e){const t=document.getElementById("useBlankTiles");t&&(t.checked=e.useBlankTiles)}applyAudioSettings(e){const t=document.getElementById("bgmVolume"),n=document.getElementById("bgmVolumeValue"),s=document.getElementById("bgmMute"),i=document.getElementById("sfxVolume"),a=document.getElementById("sfxVolumeValue"),o=document.getElementById("sfxMute");t&&(t.value=e.bgmVolume,n&&(n.textContent=`${e.bgmVolume}%`)),s&&(s.checked=e.bgmMuted),i&&(i.value=e.sfxVolume,a&&(a.textContent=`${e.sfxVolume}%`)),o&&(o.checked=e.sfxMuted)}getUseBlankTiles(){return I.get("useBlankTiles")}setupAudioControls(){const e=document.getElementById("bgmVolume"),t=document.getElementById("bgmVolumeValue"),n=document.getElementById("bgmMute"),s=document.getElementById("sfxVolume"),i=document.getElementById("sfxVolumeValue"),a=document.getElementById("sfxMute");I.load(),e&&e.addEventListener("input",o=>{const r=parseInt(o.target.value,10)/100;t&&(t.textContent=`${o.target.value}%`),this.updateAudioManager("bgmVolume",r)}),n&&n.addEventListener("change",o=>{const r=o.target.checked;this.updateAudioManager("bgmMuted",r)}),s&&s.addEventListener("input",o=>{const r=parseInt(o.target.value,10)/100;i&&(i.textContent=`${o.target.value}%`),this.updateAudioManager("sfxVolume",r)}),a&&a.addEventListener("change",o=>{const r=o.target.checked;this.updateAudioManager("sfxMuted",r)})}updateAudioManager(e,t){if(window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const n=window.game.scene.getScene("GameScene");if(v("GameScene found, audioManager exists:",!!n.audioManager),n.audioManager)switch(e){case"bgmVolume":n.audioManager.setBGMVolume(t);break;case"bgmMuted":n.audioManager.muteBGM(t);break;case"sfxVolume":n.audioManager.setSFXVolume(t);break;case"sfxMuted":n.audioManager.muteSFX(t);break}}}registerSettingSection(e,t){}}document.addEventListener("DOMContentLoaded",()=>{window.settingsManager=new ee,window.addEventListener("settingsChanged",g=>{const e=g.detail;if(console.log("Settings changed from mobile:",e),window.settingsManager&&window.settingsManager.overlay.style.display!=="none"&&window.settingsManager.loadSettings(),window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const t=window.game.scene.getScene("GameScene");if(t.gGameLogic){const n=window.settingsManager.getCardYear();e.cardYear&&n!==e.cardYear&&t.gGameLogic.init().then(()=>{v(`Card year updated to ${e.cardYear}`)})}}})});const B={KEEP:"KEEP",PASS:"PASS",DISCARD:"DISCARD"};class te{constructor(e,t,n="medium"){this.card=e,this.table=t,this.difficulty=n,this.config=this.getDifficultyConfig(n)}getDifficultyConfig(e){const t={easy:{maxPatterns:2,minDiscardable:5,exposureThreshold:70,courtesyThresholds:[55,65,75],blankExchangeRank:999,blankExchangeGain:999,jokerTopHands:1,jokerRankThreshold:60,jokerScaling:.8,discardRandomness:.3},medium:{maxPatterns:5,minDiscardable:4,exposureThreshold:55,courtesyThresholds:[50,60,68],blankExchangeRank:85,blankExchangeGain:25,jokerTopHands:2,jokerRankThreshold:55,jokerScaling:.9,discardRandomness:.1},hard:{maxPatterns:999,minDiscardable:3,exposureThreshold:45,courtesyThresholds:[45,55,65],blankExchangeRank:80,blankExchangeGain:20,jokerTopHands:3,jokerRankThreshold:50,jokerScaling:1,discardRandomness:0}};return t[e]||t.medium}calculateTileNeeds(e,t){const n=new Map;for(const s of t){const i=new Map;for(const a of s.componentInfoArray)for(const o of a.tileArray){const r=`${o.suit}-${o.number}`;i.set(r,(i.get(r)||0)+1)}for(const[a,o]of i.entries()){n.has(a)||n.set(a,{needed:0,have:0});const r=n.get(a);r.needed=Math.max(r.needed,o)}}for(const s of e){if(s.suit===c.JOKER||s.suit===c.BLANK)continue;const i=`${s.suit}-${s.number}`;n.has(i)||n.set(i,{needed:0,have:0}),n.get(i).have++}for(const s of n.values())s.needed=Math.min(s.needed,s.have);return n}countDiscardableTiles(e,t){const n=this.calculateTileNeeds(e,t);let s=0;for(const i of e){if(i.suit===c.JOKER||i.suit===c.BLANK)continue;const a=`${i.suit}-${i.number}`,o=n.get(a);(!o||o.needed===0)&&s++}return s}getTileRecommendations(e){const t=[],s=[...this.card.rankHandArray14(e)].sort((l,d)=>d.rank-l.rank),i=e.getHiddenTileArray();let a=s.length;for(this.config.maxPatterns<999&&(a=Math.min(a,this.config.maxPatterns));a>1;){const l=s.slice(0,a);if(this.countDiscardableTiles(i,l)>=this.config.minDiscardable)break;a--}a===0&&(a=1);const o=s.slice(0,a),r=this.calculateTileNeeds(i,o);for(const l of i){let d=B.DISCARD;if(l.suit===c.JOKER||l.suit===c.BLANK)d=B.KEEP;else{const m=`${l.suit}-${l.number}`,p=r.get(m);p&&p.needed>0&&(d=B.KEEP,p.needed--)}t.push({tile:l,recommendation:d})}return t.sort((l,d)=>{const m={[B.KEEP]:0,[B.PASS]:1,[B.DISCARD]:2},p=m[l.recommendation]-m[d.recommendation];if(p===0){const u=l.tile.suit===c.JOKER||l.tile.suit===c.BLANK?1:0;return(d.tile.suit===c.JOKER||d.tile.suit===c.BLANK?1:0)-u}return p}),{recommendations:t,consideredPatternCount:a}}exchangeTilesForJokers(e,t){const n=this.table.getExposedJokerArray(),s=this.card.rankHandArray14(t),i=[...s].sort((l,d)=>d.rank-l.rank);let a=-1e5,o=null;const r=t.getHiddenTileArray();for(let l=0;l<r.length;l++){const d=r[l];let m=!1;for(const S of n)if(d.suit===S.suit&&d.number===S.number){m=!0;break}if(!m)continue;const p=t.dupHand();p.hiddenTileSet.tileArray[l]=new D(c.JOKER,0);const u=this.card.rankHandArray14(p);let E=0;const T=Math.min(this.config.jokerTopHands,i.length);for(let S=0;S<T;S++){const A=i[S],C=s.indexOf(A);let N=1;A.rank>this.config.jokerRankThreshold&&(N=Math.min(A.rank*this.config.jokerScaling,100)),E+=(u[C].rank-s[C].rank)*N}E>a&&(a=E,o=d)}return o&&a>0?(this.table.exchangeJoker(e,t,o),!0):!1}exchangeBlanksForDiscards(e,t){const n=t.getHiddenTileArray().filter(d=>d.suit===c.BLANK);if(n.length===0)return!1;const s=this.table.discards.tileArray.filter(d=>d.suit!==c.JOKER&&d.suit!==c.BLANK);if(s.length===0)return!1;const o=[...this.card.rankHandArray14(t)].sort((d,m)=>m.rank-d.rank)[0].rank;if(o<this.config.blankExchangeRank)return!1;let r=null,l=this.config.blankExchangeGain;for(const d of n)for(const m of s){const p=t.dupHand(),u=p.hiddenTileSet.tileArray.indexOf(d);if(u===-1)continue;p.hiddenTileSet.tileArray[u]=new D(m.suit,m.number);const A=[...this.card.rankHandArray14(p)].sort((C,N)=>N.rank-C.rank)[0].rank-o;v("exchangeBlanksForDiscards: Blank -> "+m.getText()+" would give rank gain: "+A+`
`),A>l&&(l=A,r={blank:d,discard:m})}if(r&&l>20){t.removeHidden(r.blank),this.table.discards.removeDiscardTile(r.discard),r.discard.sprite&&(r.discard.sprite.destroy(),r.discard.sprite=null),r.discard.spriteBack&&(r.discard.spriteBack.destroy(),r.discard.spriteBack=null),r.discard.mask&&r.discard.mask.geometryMask&&(r.discard.mask.geometryMask.destroy(),r.discard.mask=null),r.discard.scene=t.scene,r.discard.create(),t.insertHidden(r.discard),this.table.discards.insertDiscard(r.blank);for(let d=0;d<4;d++)this.table.players[d].showHand();return this.table.discards.showDiscards(),!0}return!1}async chooseDiscard(e){const t=this.table.players[e].hand;let n=this.card.validateHand14(t);if(n.valid)return{playerOption:b.MAHJONG,tileArray:null};let s=!1;do if(s=this.exchangeTilesForJokers(e,t),s&&(n=this.card.validateHand14(t),n.valid))return{playerOption:b.MAHJONG,tileArray:null};while(s);do if(s=this.exchangeBlanksForDiscards(e,t),s&&(n=this.card.validateHand14(t),n.valid))return{playerOption:b.MAHJONG,tileArray:null};while(s);const a=this.getTileRecommendations(t).recommendations;let o=null;const r=a.filter(l=>l.recommendation==="DISCARD"&&l.tile.suit!==c.BLANK);if(this.config.discardRandomness>0&&Math.random()<this.config.discardRandomness){const l=Math.floor(Math.random()*Math.min(3,r.length));o=r[l].tile}else for(let l=a.length-1;l>=0;l--){const d=a[l].tile;if(d.suit!==c.BLANK){o=d;break}}return!o&&a.length>0&&(o=a[a.length-1].tile),this.table.players[e].hand.removeHidden(o),this.table.players[e].hand.sortSuitHidden(),{playerOption:b.DISCARD_TILE,tileArray:[o]}}validateComponentForExposure(e,t){return!(t.component.count<3||t.tileArray.length!==t.component.count)}async claimDiscard(e,t){const n=this.table.players[e].hand.dupHand();if(n.insertHidden(t),this.card.validateHand14(n).valid)return{playerOption:b.MAHJONG,tileArray:null};const i=this.card.rankHandArray14(n);this.card.sortHandRankArray(i);const a=i[0];if(!n.isAllHidden()||!a.hand.concealed&&a.rank>this.config.exposureThreshold){let o=null;e:for(const r of a.componentInfoArray)for(const l of r.tileArray)if(l===t){o=r;break e}if(o&&this.validateComponentForExposure(e,o,t))return{playerOption:b.EXPOSE_TILES,tileArray:o.tileArray}}return{playerOption:b.DISCARD_TILE,tileArray:[t]}}async charlestonPass(e){const t=this.table.players[e].hand,n=[],s=t.dupHand(),i=new D(c.INVALID,k.INVALID);s.insertHidden(i);const r=this.getTileRecommendations(s).recommendations.filter(l=>l.tile!==i&&l.tile.suit!==c.JOKER&&l.tile.suit!==c.BLANK);r.sort((l,d)=>{const m={[B.DISCARD]:0,[B.PASS]:1,[B.KEEP]:2};return m[l.recommendation]-m[d.recommendation]});for(let l=0;l<3;l++)if(r.length>l){const d=r[l].tile;n.push(d),t.removeHidden(d)}return n}async courtesyVote(e){const t=this.table.players[e].hand.dupHand(),n=new D(c.INVALID,k.INVALID);t.insertHidden(n);const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s);const a=s[0].rank;this.card.printHandRankArray(s,1);const o=this.config.courtesyThresholds;return a<o[0]?3:a<o[1]?2:a<o[2]?1:0}courtesyPass(e,t){const s=this.getTileRecommendations(this.table.players[e].hand).recommendations,i=[];for(let a=s.length-1;a>=0&&i.length<t;a--){const o=s[a].tile;o.suit===c.JOKER||o.suit===c.BLANK||(this.table.players[e].hand.removeHidden(o),i.push(o))}return i}}const M={[c.VSUIT1]:"green",[c.VSUIT2]:"red",[c.VSUIT3]:"blue",[c.FLOWER]:"black",[c.VSUIT1_DRAGON]:"green",[c.VSUIT2_DRAGON]:"red",[c.VSUIT3_DRAGON]:"blue",[c.WIND]:"black",[c.DRAGON]:"blue",[c.JOKER]:"gray",[c.CRACK]:"red",[c.BAM]:"green",[c.DOT]:"blue"};function _(g,e=!1,t=null){if(g.suit===c.JOKER)return{char:"J",color:M[c.JOKER],tile:g};if(g.suit===c.FLOWER)return{char:"F",color:M[c.FLOWER],tile:g};if(g.suit===c.WIND)return{char:{[V.NORTH]:"N",[V.EAST]:"E",[V.SOUTH]:"S",[V.WEST]:"W"}[g.number]||"?",color:M[c.WIND],tile:g};if(g.suit===c.DRAGON||g.suit>=c.VSUIT1_DRAGON&&g.suit<=c.VSUIT3_DRAGON){if(g.suit===c.DRAGON&&g.number===F.WHITE)return{char:"0",color:"blue",tile:g};let n="blue";if(g.suit===c.DRAGON)n={[F.RED]:"red",[F.GREEN]:"green",[F.WHITE]:"blue"}[g.number]||"blue";else if(g.suit>=c.VSUIT1_DRAGON&&g.suit<=c.VSUIT3_DRAGON)if(t){const s=t[g.suit-c.VSUIT1_DRAGON];n=M[s]||"blue"}else{const s=g.suit-c.VSUIT1_DRAGON;n=["green","red","blue"][s]||"blue"}return{char:"D",color:n,tile:g}}if(g.number>=1&&g.number<=9){if(t&&g.suit>=c.VSUIT1&&g.suit<=c.VSUIT3){const n=t[g.suit-c.VSUIT1],s=M[n]||"blue";return{char:g.number.toString(),color:s,tile:g}}return{char:g.number.toString(),color:M[g.suit]||"blue",tile:g}}if(g.number>=k.CONSECUTIVE1&&g.number<=k.CONSECUTIVE7){const n=g.number-k.CONSECUTIVE1,s=e?2+n*2:1+n*2;if(t&&g.suit>=c.VSUIT1&&g.suit<=c.VSUIT3){const i=t[g.suit-c.VSUIT1],a=M[i]||"blue";return{char:s.toString(),color:a,tile:g}}return{char:s.toString(),color:M[g.suit]||"blue",tile:g}}return g.number===0?{char:"0",color:M[g.suit]||"gray",tile:g}:{char:"?",color:"gray",tile:g}}function $(g){const e=new Map;return g.forEach(t=>{const n=`${t.suit}-${t.number}`;e.set(n,(e.get(n)||0)+1)}),e}function ne(g,e,t,n,s=null,i=null,a=null){const o=$(e),r=new Map,d=(i?$(i):o).get(`${c.JOKER}-0`)||0;let m=0,p=0;return g.map((u,E)=>{let T;if(a&&u.number>=k.CONSECUTIVE1&&u.number<=k.CONSECUTIVE7){const G=a.get(u.number);if(G!==void 0){const Y={...u,number:G};T=_(Y,n,s)}else T=_(u,n,s)}else T=_(u,n,s);const S=`${u.suit}-${u.number}`,A=t[E];let C=!1;return(o.get(S)||0)-(r.get(S)||0)>0?(C=!0,r.set(S,(r.get(S)||0)+1),u.suit===c.JOKER&&m++):A>=3&&u.suit!==c.JOKER&&m+p<d&&(C=!0,p++,T.char="J",T.color="gray"),{...T,isMatched:C}})}function se(g,e=!0){const t="tile-char",n=e&&g.isMatched,s=g.color;return n?`${t} bg-${s}-600 text-white border border-${s}-700`:`${t} bg-white text-${s}-600 border border-${s}-200`}function ie(g,e,t=null){const n=[],s=[],i=g.hand.even||!1,a=new Map;g.componentInfoArray.forEach(u=>{if(u.tileArray&&u.tileArray.length>0){const E=u.component.number;if(E>=k.CONSECUTIVE1&&E<=k.CONSECUTIVE7){const T=u.tileArray.find(S=>S.suit!==c.JOKER);if(T&&a.size===0){const S=E-k.CONSECUTIVE1,A=T.number-S;for(let C=0;C<7;C++)a.set(k.CONSECUTIVE1+C,A+C)}}}}),g.componentInfoArray.forEach((u,E)=>{const T=u.component.count,S=u.tileArray?u.tileArray.length:0;if(u.tileArray&&u.tileArray.length>0&&u.tileArray.forEach(A=>{n.push(A),s.push(T)}),S<T){const A={suit:u.component.suit||c.INVALID,number:u.component.number||0};for(let C=S;C<T;C++)n.push(A),s.push(T)}if(E<g.componentInfoArray.length-1){const A=g.componentInfoArray[E+1];u.component.count===1&&A.component.count===1||(n.push({isSpacer:!0}),s.push(0))}});const o=n.filter(u=>!u.isSpacer),r=s.filter((u,E)=>!n[E].isSpacer),l=ne(o,e,r,i,g.vsuitArray,t,a),d=[];let m=0;n.forEach(u=>{u.isSpacer?d.push({isSpacer:!0}):d.push(l[m++])});let p='<div class="pattern-row">';return d.forEach(u=>{u.isSpacer?p+='<span class="component-spacer"></span>':p+=`<span class="${se(u)}">${u.char}</span>`}),p+="</div>",p}class ae{constructor(e){this.gameLogic=e,this.savedGlowData=null,this.currentHintData=null,this.isPanelExpanded=!1,this.glowedTiles=[]}applyGlowToDiscardSuggestions(e){this.clearAllGlows();const t=e.filter(i=>i.tile.suit!==c.INVALID&&i.recommendation==="DISCARD"),n=this.gameLogic.table.players[h.BOTTOM].hand,s=new Set;t.forEach((i,a)=>{v(`Processing tile ${a+1}: ${i.tile.getText()} with recommendation ${i.recommendation}`);const o=this.findNextUnhighlightedTileInHand(n,i.tile,s);o?(v(`Applying red glow to tile: ${o.getText()}`),o.addGlowEffect(this.gameLogic.scene,16711680,.6),this.glowedTiles.push(o),s.add(o)):v(`Could not find tile for: ${i.tile.getText()}`)}),v(`Applied glow to ${this.glowedTiles.length} tiles out of ${t.length} discard tiles requested`),this.currentHintData={recommendations:[...e]},this.isPanelExpanded=!0}findNextUnhighlightedTileInHand(e,t,n){const s=e.getHiddenTileArray();for(const i of s)if(i.suit===t.suit&&i.number===t.number&&!n.has(i))return i;return null}clearAllGlows(){if(this.glowedTiles.length>0){let e=null;this.currentHintData&&(e=this.currentHintData.recommendations),this.savedGlowData={recommendations:e,timestamp:Date.now()}}this.glowedTiles.forEach(e=>e.removeGlowEffect()),this.glowedTiles=[],this.isPanelExpanded=!1}restoreGlowEffects(){this.savedGlowData&&this.savedGlowData.recommendations?(this.applyGlowToDiscardSuggestions(this.savedGlowData.recommendations),this.isPanelExpanded=!0,this.savedGlowData=null):this.currentHintData&&this.currentHintData.recommendations&&(this.applyGlowToDiscardSuggestions(this.currentHintData.recommendations),this.isPanelExpanded=!0)}isHintPanelExpanded(){const e=window.document.getElementById("hint-content");return e&&!e.classList.contains("hidden")}getRecommendations(){const e=this.gameLogic.table.players[h.BOTTOM].hand.dupHand();if(e.getLength()===13){const n=new D(c.INVALID,k.INVALID);e.insertHidden(n)}const t=this.gameLogic.gameAI.getTileRecommendations(e);return{recommendations:t.recommendations.reverse(),consideredPatternCount:t.consideredPatternCount}}getAllPlayerTiles(){const e=this.gameLogic.table.players[h.BOTTOM].hand,t=[...e.getHiddenTileArray()];return e.exposedTileSetArray.forEach(n=>{t.push(...n.tileArray)}),t}getHiddenPlayerTiles(){return this.gameLogic.table.players[h.BOTTOM].hand.getHiddenTileArray()}updateHintsForNewTiles(){if(!this.isHintPanelExpanded()){this.updateHintDisplayOnly();return}const e=this.getRecommendations(),t=this.gameLogic.table.players[h.BOTTOM].hand.dupHand();t.getLength()===13&&t.insertHidden(new D(c.INVALID,k.INVALID));const n=this.gameLogic.card.rankHandArray14(t);this.gameLogic.card.sortHandRankArray(n),this.applyGlowToDiscardSuggestions(e.recommendations),this.updateHintDisplay(n,e.recommendations,e.consideredPatternCount)}updateHintDisplayOnly(){const e=this.getRecommendations(),t=this.gameLogic.table.players[h.BOTTOM].hand.dupHand();t.getLength()===13&&t.insertHidden(new D(c.INVALID,k.INVALID));const n=this.gameLogic.card.rankHandArray14(t);this.gameLogic.card.sortHandRankArray(n),this.updateHintDisplay(n,e.recommendations,e.consideredPatternCount)}updateHintDisplay(e,t,n){let s="<h3>Top Possible Hands:</h3>";const i=this.getAllPlayerTiles(),a=this.getHiddenPlayerTiles();for(let l=0;l<Math.min(3,e.length);l++){const d=e[l],m=l===0||l<n,p=m?"":"opacity: 0.4;";s+=`<p style="${p}"><strong>${d.group.groupDescription}</strong> - ${d.hand.description} (Rank: ${d.rank.toFixed(2)})`,!m&&l>0&&(s+=" <em>(not considered)</em>"),s+="</p>";const u=ie(d,i,a);s+=`<div style="${p}">${u}</div>`}s+="<h3>Discard Suggestions (Best to Discard First):</h3>";const o=t.filter(l=>l.tile.suit!==c.INVALID&&l.recommendation==="DISCARD"),r=o.length;for(let l=0;l<r;l++){const d=o[l];s+=`<p>${d.tile.getText()}</p>`}W(s)}}class oe{constructor(e){this.scene=e,this.state=y.INIT,this.table=null,this.card=null,this.gameAI=null,this.currPlayer=0,this.button1Function=null,this.button2Function=null,this.button3Function=null,this.button4Function=null,this.sort1Function=null,this.sort2Function=null,this.hintFunction=null,this.startButtonFunction=null,this.hintAnimationManager=null,this.errorText=null,this.errorTextArray=[],this.errorTextSemaphore=0,this.discardTile=null,this.gameResult={mahjong:!1,winner:0},this.isSwappingBlank=!1}async init(){const e=window.settingsManager.getCardYear();this.card=new J(e),await this.card.init();const t=window.settingsManager?window.settingsManager.getDifficulty():"medium";this.gameAI=new te(this.card,this.table,t),this.hintAnimationManager=new ae(this),f("Using "+this.card.year+` Mahjong card

`);const n=window.document.getElementById("handSelect");for(const s of this.card.validHandGroups){const i=window.document.createElement("optgroup");i.label=s.groupDescription,n.add(i);for(const a of s.hands){const o=window.document.createElement("option");o.text=a.description,n.add(o)}}}start(){this.state=y.START,this.updateUI(),this.gameResult.mahjong=!1,this.gameResult.winner=0,this.table.switchPlayer(h.BOTTOM),this.table.reset(),this.hintAnimationManager.clearAllGlows(),this.scene.audioManager&&this.scene.audioManager.playBGM("bgm"),this.deal()}deal(){this.state=y.DEAL,this.updateUI();const e=[null,null,null,null],t=this.getTrainingInfo();t.trainCheckbox&&(e[0]=this.card.generateHand(t.handDescription,t.numTiles)),this.sequentialDealTiles(e,()=>{this.table.players[h.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles()}),t.trainCheckbox&&t.skipCharlestonCheckbox?this.loop():this.charleston()}async charleston(){this.state=y.CHARLESTON1,this.updateUI(),await this.charlestonPass(h.RIGHT),this.table.players[h.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),await this.charlestonPass(h.TOP),this.table.players[h.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),await this.charlestonPass(h.LEFT),this.table.players[h.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),this.state=y.CHARLESTON_QUERY,this.updateUI();const e=await this.yesNoQuery();this.state=y.CHARLESTON_QUERY_COMPLETE,this.updateUI(),e===!0&&(this.state=y.CHARLESTON2,this.updateUI(),await this.charlestonPass(h.LEFT),this.table.players[h.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),await this.charlestonPass(h.TOP),this.table.players[h.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles(),await this.charlestonPass(h.RIGHT),this.table.players[h.BOTTOM].hand.getLength()>0&&this.hintAnimationManager.updateHintsForNewTiles()),this.state=y.COURTESY_QUERY,this.updateUI();const t=await this.courtesyQuery();this.state=y.COURTESY_QUERY_COMPLETE,this.updateUI(),this.state=y.COURTESY,this.updateUI();const n=[];n[0]=t;const s=await Promise.all([this.gameAI.courtesyVote(1),this.gameAI.courtesyVote(2),this.gameAI.courtesyVote(3)]);n[1]=s[0],n[2]=s[1],n[3]=s[2];for(let i=0;i<4;i++)f("Player "+i+" wants to exchange "+n[i]+` tiles
`);if(this.table.courtesyVote(n),this.table.player02CourtesyVote>0&&await this.courtesyPass(),this.state=y.COURTESY_COMPLETE,this.updateUI(),this.table.player02CourtesyVote>0||this.table.player13CourtesyVote>0){const i=[];i[0]=this.table.players[0].hand.getSelectionHidden(),this.table.players[0].hand.resetSelection();for(const o of i[0])this.table.players[0].hand.removeHidden(o);i[1]=await this.gameAI.courtesyPass(1,this.table.player13CourtesyVote),i[2]=await this.gameAI.courtesyPass(2,this.table.player02CourtesyVote),i[3]=await this.gameAI.courtesyPass(3,this.table.player13CourtesyVote);const a=this.table.courtesyPass(i);if(a&&a.length>0){for(const o of a)o.addGlowEffect(this.scene,2003199,.7,10);setTimeout(()=>{for(const o of a)o.removeGlowEffect();this.table.players[h.BOTTOM].hand.sortSuitHidden(),this.table.players[h.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles()},2e3)}}this.table.players[h.BOTTOM].hand.getLength()>0&&this.table.player02CourtesyVote===0&&this.table.player13CourtesyVote===0&&this.hintAnimationManager.updateHintsForNewTiles(),f(`Courtesy complete
`),this.loop()}async loop(){let e=!0;for(this.currPlayer=0;this.table.switchPlayer(this.currPlayer),this.state=y.LOOP_PICK_FROM_WALL,this.updateUI(),!(!e&&!this.pickFromWall());){e=!1,this.state=y.LOOP_CHOOSE_DISCARD,this.updateUI();const t=await this.chooseDiscard();if(this.table.players[this.currPlayer].hand.tilesWereDraggedThisTurn||this.table.players[this.currPlayer].showHand(this.currPlayer===h.BOTTOM),this.table.players[this.currPlayer].hand.tilesWereDraggedThisTurn=!1,this.currPlayer!==h.BOTTOM&&await z(500),t.playerOption===b.MAHJONG){this.gameResult.mahjong=!0,this.gameResult.winner=this.currPlayer;break}const n=t.tileArray[0];if(n.suit===c.JOKER){this.table.discards.insertDiscard(n),this.table.discards.showDiscards(),this.scene.audioManager&&this.scene.audioManager.playSFX("tile_dropping"),this.currPlayer++,this.currPlayer>3&&(this.currPlayer=0);continue}n.scale=1,n.showTile(!0,!0),n.addGlowEffect(this.scene,1981066,.9),n.sprite.depth=200,n.spriteBack.depth=200;const s=n.animate(350,420,0);s&&this.scene.audioManager&&s.on("complete",()=>{this.scene.audioManager.playSFX("tile_dropping")});const i=[];for(let l=0;l<4;l++)i[l]=await this.claimDiscard(l,n);const a=this.table.processClaimArray(this.currPlayer,i,n);if(n.removeGlowEffect(),n.sprite.depth=0,a.playerOption===b.MAHJONG){this.gameResult.mahjong=!0,this.gameResult.winner=a.winningPlayer;break}if(a.playerOption===b.EXPOSE_TILES){this.currPlayer=a.winningPlayer,e=!0;const l=n.getText();f("Player "+this.currPlayer+" *claims* "+l+` 
`),this.currPlayer===h.BOTTOM&&this.hintAnimationManager.updateHintsForNewTiles()}else this.currPlayer++,this.currPlayer>3&&(this.currPlayer=0);let o=0;o+=this.table.wall.tileArray.length,o+=this.table.discards.tileArray.length;for(let l=0;l<4;l++)o+=this.table.players[l].hand.getLength();const r=U();o!==r&&f("ERROR - total tile count is not "+r+". Tile count = "+o+`
`)}this.end()}async end(){if(this.state=y.END,this.gameResult.mahjong&&this.gameResult.winner===0)try{await this.scene.createFireworksDisplay(this.gameResult)}catch(e){console.warn("[GameLogic] Fireworks display error:",e)}this.updateUI()}pickFromWall(){const e=this.table.wall.remove();return this.scene.updateWallTileCounter(this.table.wall.getCount()),e?(f("Player "+this.currPlayer+` picks from wall
`),v("Player "+this.currPlayer+" picks "+e.getText()+` from wall
`),this.table.players[this.currPlayer].hand.insertHidden(e),this.currPlayer===h.BOTTOM&&(e.addGlowEffect(this.scene,2003199,.7,10),setTimeout(()=>{e.removeGlowEffect(),this.table.players[h.BOTTOM].hand.sortSuitHidden(),this.table.players[h.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles(),this.state===y.LOOP_CHOOSE_DISCARD&&this.updateSwapBlankButton()},2e3)),this.table.players[this.currPlayer].showHand(this.currPlayer===h.BOTTOM),!0):!1}async chooseDiscard(){if(this.currPlayer===h.BOTTOM)return new Promise(e=>{const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=(function(){if(this.isSwappingBlank)return;const a=this.table.players[this.currPlayer].hand.removeDiscard(),o=a.getText();f("Player "+this.currPlayer+" discards "+o+` 
`);const r=[];r.push(a),e({playerOption:b.DISCARD_TILE,tileArray:r})}).bind(this),t.addEventListener("click",this.button1Function);const n=window.document.getElementById("button2");n.removeEventListener("click",this.button2Function),this.button2Function=(function(){this.isSwappingBlank||(this.table.exchangeUserSelectedTileForExposedJoker(),window.document.getElementById("button2").disabled=!0)}).bind(this),n.addEventListener("click",this.button2Function);const s=window.document.getElementById("button3");s.removeEventListener("click",this.button3Function),this.button3Function=(function(){this.isSwappingBlank||(this.table.players[this.currPlayer].hand.resetSelection(),e({playerOption:b.MAHJONG,tileArray:[]}))}).bind(this),s.addEventListener("click",this.button3Function)});{const e=await this.gameAI.chooseDiscard(this.currPlayer);if(e.playerOption===b.DISCARD_TILE){const t=e.tileArray[0].getText();f("Player "+this.currPlayer+" discards "+t+` 
`)}return e}}canPlayerClaimExposure(e,t){const s=this.table.players[e].hand.getHiddenTileArray();let i=0;for(const a of s)(a.suit===c.JOKER||a.suit===t.suit&&a.number===t.number)&&i++;return i>=2}canPlayerMahjongWithDiscard(e,t){const n=this.table.players[e].hand.dupHand();return n.insertHidden(t),this.card.validateHand14(n).valid}async claimDiscard(e,t){if(this.currPlayer===e)return new Promise(a=>{const o=[];o.push(t),a({playerOption:b.DISCARD_TILE,tileArray:o})});if(e!==h.BOTTOM)return this.gameAI.claimDiscard(e,t);const n=this.canPlayerMahjongWithDiscard(e,t),s=this.canPlayerClaimExposure(e,t);if(!n&&!s)return{playerOption:b.DISCARD_TILE,tileArray:[t]};this.state=y.LOOP_QUERY_CLAIM_DISCARD,this.updateUI();const i=await this.yesNoQuery();if(this.state=y.LOOP_QUERY_CLAIM_DISCARD_COMPLETE,this.updateUI(),i){this.state=y.LOOP_EXPOSE_TILES,this.updateUI(),this.discardTile=t;const a=await this.exposeTiles();switch(this.state=y.LOOP_EXPOSE_TILES_COMPLETE,this.updateUI(),a.playerOption){case b.EXPOSE_TILES:return new Promise(o=>{a.tileArray.push(t),o({playerOption:b.EXPOSE_TILES,tileArray:a.tileArray})});case b.MAHJONG:return new Promise(o=>{o({playerOption:b.MAHJONG,tileArray:[]})});default:return f(`ERROR - unknown discardOption
`),new Promise(o=>{o({playerOption:b.DISCARD_TILE,tileArray:[t]})})}}return new Promise(a=>{a({playerOption:b.DISCARD_TILE,tileArray:[t]})})}yesNoQuery(){return new Promise(e=>{const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=(function(){this.isSwappingBlank||(t.removeEventListener("click",this.button1Function),n.removeEventListener("click",this.button2Function),e(!1))}).bind(this),t.addEventListener("click",this.button1Function);const n=window.document.getElementById("button2");n.removeEventListener("click",this.button2Function),this.button2Function=(function(){this.isSwappingBlank||(t.removeEventListener("click",this.button1Function),n.removeEventListener("click",this.button2Function),e(!0))}).bind(this),n.addEventListener("click",this.button2Function)})}charlestonPass(e){return new Promise(t=>{const n=["self","right","across","left"];x("Choose 3 tiles to pass "+n[e]);const s=window.document.getElementById("button1");s.removeEventListener("click",this.button1Function),this.button1Function=(async function(){const a=[];a[0]=this.table.players[0].hand.getSelectionHidden(),this.table.players[0].hand.resetSelection();for(const l of a[0])this.table.players[0].hand.removeHidden(l);const o=await Promise.all([this.gameAI.charlestonPass(1),this.gameAI.charlestonPass(2),this.gameAI.charlestonPass(3)]);a[1]=o[0],a[2]=o[1],a[3]=o[2];const r=this.table.charlestonPass(e,a);if(f("Pass "+n[e]+` complete
`),r&&r.length>0){for(const l of r)l.addGlowEffect(this.scene,2003199,.7,10);setTimeout(()=>{for(const l of r)l.removeGlowEffect();this.table.players[h.BOTTOM].hand.sortSuitHidden(),this.table.players[h.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles()},2e3)}t()}).bind(this),s.addEventListener("click",this.button1Function)})}exposeTiles(){return new Promise(e=>{const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=(function(){const a=this.playerExposeTiles();a&&e({playerOption:b.EXPOSE_TILES,tileArray:a})}).bind(this),t.addEventListener("click",this.button1Function);const n=window.document.getElementById("button2");n.removeEventListener("click",this.button2Function),this.button2Function=(function(){this.table.players[h.BOTTOM].hand.resetSelection(),e({playerOption:b.DISCARD_TILE,tileArray:[]})}).bind(this),n.addEventListener("click",this.button2Function);const s=window.document.getElementById("button3");s.removeEventListener("click",this.button3Function),this.button3Function=(function(){if(this.table.players[h.BOTTOM].hand.hasBlankTiles()){this.displayErrorText("Cannot declare Mahjong while holding blank tiles");return}this.table.players[h.BOTTOM].hand.resetSelection(),e({playerOption:b.MAHJONG,tileArray:[]})}).bind(this),s.addEventListener("click",this.button3Function)})}playerExposeTiles(){const t=this.table.players[h.BOTTOM].hand.getSelectionHidden();if(t.length<2||t.length>4)return this.displayErrorText("Invalid number of tiles selected for exposure. Select 2, 3, or 4 tiles."),null;for(const n of t)if(n.suit!==c.JOKER&&(n.suit!==this.discardTile.suit||n.number!==this.discardTile.number))return this.displayErrorText("Selected tiles must match the discarded tile or be jokers."),null;return t}courtesyQuery(){return new Promise(e=>{const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=function(){e(0)},t.addEventListener("click",this.button1Function);const n=window.document.getElementById("button2");n.removeEventListener("click",this.button2Function),this.button2Function=function(){e(1)},n.addEventListener("click",this.button2Function);const s=window.document.getElementById("button3");s.removeEventListener("click",this.button3Function),this.button3Function=function(){e(2)},s.addEventListener("click",this.button3Function);const i=window.document.getElementById("button4");i.removeEventListener("click",this.button4Function),this.button4Function=function(){e(3)},i.addEventListener("click",this.button4Function)})}courtesyPass(){return new Promise(e=>{x("Courtesy pass - select "+this.table.player02CourtesyVote+` tile(s)
`);const t=window.document.getElementById("button1");t.removeEventListener("click",this.button1Function),this.button1Function=function(){e()},t.addEventListener("click",this.button1Function)})}updateUI(){const e=window.document.getElementById("button1"),t=window.document.getElementById("button2"),n=window.document.getElementById("button3"),s=window.document.getElementById("button4"),i=window.document.getElementById("start"),a=window.document.getElementById("sort1"),o=window.document.getElementById("sort2"),r=window.document.getElementById("numTileSelect"),l=window.document.getElementById("skipCharlestonCheckbox");switch(this.state){case y.INIT:f(`American Mahjong v1.00
`),f(`Press Start Game button
`),a.style.display="none",o.style.display="none",window.document.getElementById("controldiv").style.visibility="visible",window.document.getElementById("uicenterdiv").style.visibility="hidden";for(let d=1;d<=14;d++){const m=window.document.createElement("option");m.text=d,r.add(m)}r.selectedIndex=8,l.checked=!0,this.updateTrainingForm(),this.hintAnimationManager.clearAllGlows(),this.hintAnimationManager.savedGlowData=null;{const d=window.document.getElementById("hint-toggle"),m=window.document.getElementById("hint-content"),p=window.document.getElementById("hintdiv");d.addEventListener("click",()=>{const u=d.getAttribute("aria-expanded")==="true";d.setAttribute("aria-expanded",!u),m.classList.toggle("hidden"),u?this.hintAnimationManager.clearAllGlows():this.hintAnimationManager.restoreGlowEffects()}),p.style.display="none"}break;case y.START:this.scene.updateWallTileCounter(this.table.wall.getCount()),f(`Game started
`),i.disabled=!0,a.style.display="",o.style.display="",this.disableSortButtons(),e.style.display="none",t.style.display="none",n.style.display="none",s.style.display="none",window.document.getElementById("uicenterdiv").style.visibility="visible",window.document.getElementById("buttondiv").style.visibility="visible",window.document.getElementById("info").style.visibility="visible",this.disableTrainingForm(),window.document.getElementById("hintdiv").style.display="";break;case y.DEAL:f(`Shuffling wall
`),f(`Dealing hands
`),this.enableSortButtons();break;case y.CHARLESTON1:f(`Starting Charleston #1
`),e.innerText="Pass Tiles",e.disabled=!0,e.style.display="";break;case y.CHARLESTON_QUERY:f(`Charleston #1 complete
`),x("Continue Charleston?"),e.innerText="No",e.disabled=!1,e.style.display="",t.innerText="Yes",t.disabled=!1,t.style.display="";break;case y.CHARLESTON_QUERY_COMPLETE:break;case y.CHARLESTON2:f(`Starting Charleston #2
`),e.innerText="Pass Tiles",e.disabled=!0,e.style.display="",t.style.display="none";break;case y.COURTESY_QUERY:f(`Charleston #2 complete
`),x("Choose number of tiles for courtesy exchange"),e.innerText="0",e.disabled=!1,e.style.display="",t.innerText="1",t.disabled=!1,t.style.display="",n.innerText="2",n.disabled=!1,n.style.display="",s.innerText="3",s.disabled=!1,s.style.display="";break;case y.COURTESY_QUERY_COMPLETE:t.style.display="none",n.style.display="none",s.style.display="none";break;case y.COURTESY:f(`Courtesy pass
`),e.innerText="Pass Tiles",e.disabled=!0,e.style.display="";break;case y.COURTESY_COMPLETE:f(`Courtesy pass complete
`),e.disabled=!0,e.removeEventListener("click",this.button1Function);break;case y.LOOP_PICK_FROM_WALL:this.updateSwapBlankButton();break;case y.LOOP_CHOOSE_DISCARD:x(`Select one tile to discard or declare Mahjong
`),e.innerText="Discard",e.disabled=!0,e.style.display="",t.innerText="Exchange joker",t.disabled=!0,t.style.display="",n.innerText="Mahjong!",n.disabled=!1,n.style.display="",this.updateSwapBlankButton();break;case y.LOOP_QUERY_CLAIM_DISCARD:x("Claim discard?"),e.innerText="No",e.disabled=!1,e.style.display="",t.innerText="Yes",t.disabled=!1,t.style.display="",n.style.display="none",this.updateSwapBlankButton();break;case y.LOOP_QUERY_CLAIM_DISCARD_COMPLETE:break;case y.LOOP_EXPOSE_TILES:x("Form a pung/kong/quint with claimed tile"),e.innerText="Expose tiles",e.disabled=!0,e.style.display="",t.innerText="Return claimed discard",t.disabled=!1,t.style.display="",n.innerText="Mahjong!",n.disabled=!1,n.style.display="";break;case y.LOOP_EXPOSE_TILES_COMPLETE:t.style.display="none",n.style.display="none",s.style.display="none";break;case y.END:if(f(`===============================
`),this.gameResult.mahjong){const d=this.table.players[this.gameResult.winner].hand;if(this.card.validateHand14(d).valid){const p=this.card.rankHandArray14(d);this.card.sortHandRankArray(p);let u="Game over - Mahjong by player "+this.gameResult.winner;f(u+`
`),x(u),u="Group = "+p[0].group.groupDescription+`
`,f(u),u="Hand = "+p[0].hand.description+`
`,f(u),d.sortSuitHidden(),this.table.players[this.gameResult.winner].showHand(!0)}else{const p=this.card.diagnoseInvalidHand(d);let u="Game over - Invalid Mahjong by player "+this.gameResult.winner;f(u+`
`),x(u),u="Closest hand: "+p.closestGroup+" - "+p.closestHand,f(u+`
`),x(u),u="Rank: "+p.rank.toFixed(2)+"% match",f(u+`
`),d.sortSuitHidden(),this.table.players[this.gameResult.winner].showHand(!0),this.highlightInvalidMahjongTiles(p)}}else{const d="Game over - Wall game";f(d+`
`),x(d);for(let m=0;m<4;m++){const p=this.table.players[m];p.hand.sortSuitHidden(),p.showHand(!0)}}f(`===============================
`),f(`Click 'Start Game' to play again
`),e.style.display="none",t.style.display="none",n.style.display="none",s.style.display="none",this.disableSortButtons(),a.style.display="none",o.style.display="none",this.enableTrainingForm(),window.document.getElementById("controldiv").style.visibility="visible",i.style.display="",i.disabled=!1;break;default:f(`ERROR - updateUI - unknown state
`);break}}updateSwapBlankButton(){if(!window.settingsManager||!window.settingsManager.getUseBlankTiles()){window.document.getElementById("button4").style.display="none";return}const n=this.table.players[h.BOTTOM].hand.getHiddenTileArray().some(o=>o.suit===c.BLANK),i=this.table.discards.tileArray.some(o=>o.suit!==c.JOKER),a=window.document.getElementById("button4");n&&i?(a.innerText="Swap Blank",a.disabled=!1,a.style.display="",a.removeEventListener("click",this.button4Function),this.button4Function=(function(){this.initiateBlankSwap()}).bind(this),a.addEventListener("click",this.button4Function)):a.style.display="none"}initiateBlankSwap(){this.isSwappingBlank=!0,this.disableAllButtons();const t=this.table.players[h.BOTTOM].hand.getHiddenTileArray().filter(a=>a.suit===c.BLANK);if(t.length===0){this.displayErrorText("No blank tiles in hand"),this.isSwappingBlank=!1,this.enableAllButtons();return}if(this.table.discards.getSelectableDiscards().length===0){this.displayErrorText("No tiles available to swap for"),this.isSwappingBlank=!1,this.enableAllButtons();return}this.displayErrorText("Click a blank tile to swap, then select a discard tile");const s={tile:null},i=a=>()=>{s.tile&&s.tile.sprite.clearTint(),s.tile=a,a.sprite.setTint(43520),this.table.discards.enableDiscardSelection(o=>{this.swapBlankForDiscard(a,o)})};for(const a of t)a.sprite.setInteractive(),a.sprite.setTint(65280),a.sprite.on("pointerup",i(a))}swapBlankForDiscard(e,t){v("Swapping blank tile for discard tile:",t.getText());const n=this.table.players[h.BOTTOM].hand;n.removeHidden(e),this.table.discards.removeDiscardTile(t),t.sprite&&(t.sprite.destroy(),t.sprite=null),t.spriteBack&&(t.spriteBack.destroy(),t.spriteBack=null),t.mask&&t.mask.geometryMask&&(t.mask.geometryMask.destroy(),t.mask=null),t.create(),n.insertHidden(t),e.sprite&&(e.sprite.destroy(),e.sprite=null),e.spriteBack&&(e.spriteBack.destroy(),e.spriteBack=null),e.mask&&e.mask.geometryMask&&(e.mask.geometryMask.destroy(),e.mask=null),e.create(),this.table.discards.insertDiscard(e),this.table.discards.disableDiscardSelection();const s=n.getHiddenTileArray().filter(i=>i.suit===c.BLANK);for(const i of s)i.sprite.clearTint(),i.sprite.removeInteractive(),i.sprite.off("pointerup");n.sortSuitHidden(),this.table.players[h.BOTTOM].showHand(!0),this.table.discards.showDiscards(),this.isSwappingBlank=!1,this.updateUI(),this.hintAnimationManager.updateHintsForNewTiles(),this.displayErrorText("Blank swapped successfully! Select a tile to discard.")}enableSortButtons(){const e=window.document.getElementById("sort1"),t=window.document.getElementById("sort2");e.disabled=!1,t.disabled=!1,this.sort1Function&&(e.removeEventListener("click",this.sort1Function),this.sort1Function=null),this.sort2Function&&(t.removeEventListener("click",this.sort2Function),this.sort2Function=null),this.sort1Function=(function(){this.table.players[h.BOTTOM].hand.sortSuitHidden(),this.table.players[h.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles()}).bind(this),this.sort2Function=(function(){this.table.players[h.BOTTOM].hand.sortRankHidden(),this.table.players[h.BOTTOM].showHand(!0),this.hintAnimationManager.updateHintsForNewTiles()}).bind(this),e.addEventListener("click",this.sort1Function),t.addEventListener("click",this.sort2Function)}disableSortButtons(){const e=window.document.getElementById("sort1"),t=window.document.getElementById("sort2");e.disabled=!0,t.disabled=!0,this.sort1Function&&(e.removeEventListener("click",this.sort1Function),this.sort1Function=null),this.sort2Function&&(t.removeEventListener("click",this.sort2Function),this.sort2Function=null)}getTrainingInfo(){const e=window.document.getElementById("trainCheckbox"),t=window.document.getElementById("handSelect"),n=window.document.getElementById("numTileSelect"),s=window.document.getElementById("skipCharlestonCheckbox"),i={trainCheckbox:!1,handDescription:"",numTiles:0,skipCharlestonCheckbox:!1};return i.trainCheckbox=e.checked,i.handDescription=t.value,i.numTiles=parseInt(n.value,10),i.skipCharlestonCheckbox=s.checked,i}updateTrainingForm(){const e=this.getTrainingInfo(),t=window.document.getElementById("trainfieldset2");t.disabled=!e.trainCheckbox}enableTrainingForm(){const e=window.document.getElementById("trainfieldset1");e.disabled=!1,this.updateTrainingForm()}disableTrainingForm(){const e=window.document.getElementById("trainfieldset1"),t=window.document.getElementById("trainfieldset2");e.disabled=!0,t.disabled=!0}displayErrorText(e){this.errorTextArray.length&&e===this.errorTextArray[this.errorTextArray.length-1]||(this.errorTextSemaphore===0?(this.errorTextSemaphore++,this.errorTextArray.push(e),this.displayAllError()):(this.errorTextSemaphore++,this.errorTextArray.push(e)))}highlightInvalidMahjongTiles(e){for(const t of e.matchingTiles)t.addGlowEffect(this.scene,65280,.7);for(const t of e.nonMatchingTiles)t.addGlowEffect(this.scene,16711680,.7)}async displayAllError(){for(this.errorText.visible=!0;this.errorTextSemaphore;){const e=this.errorTextArray.shift();this.errorText.setText(e),await z(4e3),this.errorTextSemaphore--}this.errorText.visible=!1}sequentialDealTiles(e,t){this.table.wall.shuffle(),this.table.applyTrainingHands(e);const n=[[h.BOTTOM,4],[h.RIGHT,4],[h.TOP,4],[h.LEFT,4],[h.BOTTOM,4],[h.RIGHT,4],[h.TOP,4],[h.LEFT,4],[h.BOTTOM,4],[h.RIGHT,4],[h.TOP,4],[h.LEFT,4],[h.BOTTOM,1],[h.RIGHT,1],[h.TOP,1],[h.LEFT,1],[h.BOTTOM,1]];let s=0;const i=()=>{if(s>=n.length){this.table.finalizeInitialHands(),t&&t();return}const[a,o]=n[s];for(let d=0;d<o;d++){const m=this.table.wall.remove();if(!m)throw new Error("No tiles remaining in wall during dealing sequence");this.table.players[a].hand.insertHidden(m)}this.table.players[a].showHand(!1),this.scene.updateWallTileCounter(this.table.wall.getCount());const r=this.table.players[a].hand,l=r.hiddenTileSet.tileArray[r.hiddenTileSet.tileArray.length-1];l&&l.tween?l.tween.once("complete",()=>{s++,this.scene.time.delayedCall(150,i)}):(s++,this.scene.time.delayedCall(150,i))};i()}disableAllButtons(){const e=window.document.getElementById("button1"),t=window.document.getElementById("button2"),n=window.document.getElementById("button3"),s=window.document.getElementById("button4");e&&(e.disabled=!0),t&&(t.disabled=!0),n&&(n.disabled=!0),s&&(s.disabled=!0)}enableAllButtons(){const e=window.document.getElementById("button1"),t=window.document.getElementById("button2"),n=window.document.getElementById("button3"),s=window.document.getElementById("button4");e&&(e.disabled=!1),t&&(t.disabled=!1),n&&(n.disabled=!1),s&&(s.disabled=!1)}}class re{constructor(e,t,n){this.playerInfo=n;const s=n.id===h.BOTTOM;this.hand=new j(e,t,s)}create(){}showHand(e){this.hand.showHand(this.playerInfo,e)}}const le=[{id:h.BOTTOM,x:200,y:600,angle:0,rectX:0,rectY:600-P/2,rectWidth:H,rectHeight:P},{id:h.RIGHT,x:1e3,y:520,angle:270,rectX:1e3-P*L/2,rectY:0,rectWidth:P*L,rectHeight:R},{id:h.TOP,x:750,y:50,angle:180,rectX:0,rectY:50-P*L/2,rectWidth:H,rectHeight:P*L},{id:h.LEFT,x:50,y:50,angle:90,rectX:50-P*L/2,rectY:0,rectWidth:P*L,rectHeight:R}];class de{constructor(e,t){this.scene=e,this.gameLogic=t,this.wall=new K(e),this.discards=new X,this.boxes=[];for(let n=0;n<4;n++)this.boxes[n]=null;this.players=[];for(let n=0;n<4;n++)this.players[n]=new re(e,t,le[n]);this.player02CourtesyVote=0,this.player13CourtesyVote=0}create(e=!1){for(let t=0;t<4;t++){const n=this.scene.add.graphics(0,0);this.boxes[t]=n}this.wall.create(e)}reset(){for(let t=0;t<4;t++)this.players[t].hand.reset(this.wall);for(;this.discards.tileArray.length;)this.wall.insert(this.discards.tileArray.pop());const e=U();this.wall.tileArray.length!==e&&f("ERROR - table.reset() - total tile count is not "+e+". Tile count = "+this.wall.tileArray.length+`
`)}switchPlayer(e){for(let t=0;t<4;t++)this.boxes[t].visible=!1;this.boxes[e].visible=!0}applyTrainingHands(e){for(let t=0;t<4;t++){const n=e[t];if(n){for(let s=0;s<n.hiddenTileSet.getLength();s++){const i=n.hiddenTileSet.tileArray[s],a=this.wall.findAndRemove(i);a&&this.players[t].hand.insertHidden(a)}for(const s of n.exposedTileSetArray){const i=[];for(let a=0;a<s.getLength();a++){const o=s.tileArray[a],r=this.wall.findAndRemove(o);r&&i.push(r)}this.players[t].hand.insertExposed(i)}}}}finalizeInitialHands(){for(let e=0;e<4;e++)this.players[e].hand.sortSuitHidden(),e===h.BOTTOM?this.players[e].showHand(!0):this.players[e].showHand(!1)}deal(e){this.applyTrainingHands(e);for(let t=0;t<4;t++){let n=13;t===0&&(n=14);const s=n-this.players[t].hand.getLength();for(let i=0;i<s;i++){const a=this.wall.remove();this.players[t].hand.insertHidden(a)}}this.finalizeInitialHands(),this.gameLogic.scene.updateWallTileCounter(this.wall.getCount())}charlestonPass(e,t){const n=e-h.BOTTOM,s=[];for(let i=0;i<4;i++){const a=i;let o=i+n;o>3&&(o-=4);for(const r of t[a])this.players[o].hand.insertHidden(r),o===h.BOTTOM&&s.push(r)}for(let i=0;i<4;i++)i!==0&&this.players[i].hand.sortSuitHidden(),this.players[i].showHand(i===h.BOTTOM);return s}courtesyVote(e){this.player02CourtesyVote=Math.min(e[0],e[2]),this.player13CourtesyVote=Math.min(e[1],e[3])}courtesyPass(e){const n=[];for(let s=0;s<4;s++){const i=s;let a=s+2;a>3&&(a-=4);for(const o of e[i])this.players[a].hand.insertHidden(o),a===h.BOTTOM&&n.push(o)}for(let s=0;s<4;s++)s!==0&&this.players[s].hand.sortSuitHidden(),this.players[s].showHand(s===h.BOTTOM);return n}processClaimArray(e,t,n){let s=0,i=0;for(let r=0;r<4;r++)switch(t[r].playerOption){case b.EXPOSE_TILES:break;case b.DISCARD_TILE:s++;break;case b.MAHJONG:i++;break;default:f(`ERROR - processClaimArray. Unknown claim type
`);break}if(s===4)return this.discards.insertDiscard(n),this.discards.showDiscards(),{playerOption:b.DISCARD_TILE,winningPlayer:0};let a=b.EXPOSE_TILES;i&&(a=b.MAHJONG);let o=e;for(let r=0;r<3&&(o++,o>3&&(o=0),t[o].playerOption!==a);r++);if(a===b.MAHJONG)this.players[o].hand.insertHidden(n);else{const r=t[o].tileArray,l=this.players[o].hand,d=[],m=[...l.getHiddenTileArray()];for(const p of r)if(p!==n){const u=m.findIndex(E=>E.suit===p.suit&&E.number===p.number);u!==-1&&(d.push(m[u]),m.splice(u,1))}for(const p of d)l.removeHidden(p);l.insertExposed(r)}return this.players[o].showHand(o===h.BOTTOM),{playerOption:a,winningPlayer:o}}exchangeUserSelectedTileForExposedJoker(){const e=this.players[h.BOTTOM].hand.removeDiscard(),t=e.getText();f("Player 0 exchanged "+t+` for joker
`);for(let n=0;n<4;n++)for(const s of this.players[n].hand.exposedTileSetArray)if(s.getSelectionCount()===1){const a=s.getSelection()[0];s.resetSelection(),s.remove(a),this.players[h.BOTTOM].hand.insertHidden(a),s.insert(e);break}for(let n=0;n<4;n++)this.players[n].showHand(n===h.BOTTOM)}getExposedJokerArray(){const e=[];for(let t=0;t<4;t++)for(const n of this.players[t].hand.exposedTileSetArray){let s=null;for(const i of n.tileArray)if(i.suit!==c.JOKER){s=i;break}if(s)for(const i of n.tileArray)i.suit===c.JOKER&&e.push(s)}return e}exchangeJoker(e,t,n){e:for(let s=0;s<4;s++)for(const i of this.players[s].hand.exposedTileSetArray){let a=null;for(const o of i.tileArray)if(o.suit!==c.JOKER){a=o;break}if(a&&a.suit===n.suit&&a.number===n.number){for(const o of i.tileArray)if(o.suit===c.JOKER){const r=n.getText();f("Player "+e+" *exchanged* "+r+` for joker
`),t.removeHidden(n),i.insert(n),i.remove(o),t.insertHidden(o);for(let l=0;l<4;l++)this.players[l].showHand();break e}}}}}class ce{constructor(e,t){this.scene=e,this.wall=t,this.tileArray=[],this.animationState="idle",this.isAnimating=!1,this.onAnimationComplete=null}createScatteredTiles(){for(const e of Q)for(const t of e.prefix)for(let n=1;n<=e.maxNum;n++){let s=n;e.maxNum===1&&(e.suit===c.FLOWER?s=0:s=e.prefix.indexOf(t));let i=t;e.maxNum!==1&&(i=n+i),i+=".png";for(let a=0;a<e.count;a++){const o=new D(this.scene,e.suit,s,i);o.create(),this.tileArray.push(o)}}for(let e=0;e<this.tileArray.length;e++){const t=this.tileArray[e],{x:n,y:s,scale:i,angle:a}=this.generateRandomPosition();t.x=n,t.y=s,t.scale=i,t.angle=a,t.sprite.setDepth(e),t.showTile(!0,!1),Math.random()<.7&&t.showTile(!0,!0)}}generateRandomPosition(){const e=this.scene.sys.game.config.width/2,t=this.scene.sys.game.config.height/2,n=200,s=100;let i=0,a=0;for(;i===0;)i=Math.random();for(;a===0;)a=Math.random();let o=Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*a);const r=e+o*n;for(i=0,a=0;i===0;)i=Math.random();for(;a===0;)a=Math.random();o=Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*a);const l=t+o*s,d=w.Math.FloatBetween(.55,.65),m=w.Math.Between(-90,90);return{x:r,y:l,scale:d,angle:m}}async animateToPileAndStartGame(){this.isAnimating=!0,this.animationState="gathering",await this.animateJumpAndFlip(),await this.animateFlyOffScreen(),this.isAnimating=!1,this.animationState="complete",this.onAnimationComplete&&this.onAnimationComplete()}animateJumpAndFlip(){const e=[];return this.tileArray.forEach(t=>{e.push(new Promise(n=>{const s=t.y,i=w.Math.Between(5,15),a=w.Math.Between(0,150);t.withRaisedDepth(()=>{const o=this.scene.tweens.add({targets:{},duration:800+a,onComplete:()=>{}});return this.scene.tweens.add({targets:t,y:s-i,scale:.65,duration:400,ease:w.Math.Easing.Cubic.Out,delay:a}),this.scene.tweens.add({targets:t,y:s,scale:.6,duration:400,ease:w.Math.Easing.Cubic.In,delay:a+400}),o}),this.scene.tweens.add({targets:{scaleY:t.sprite.scaleY},scaleY:0,duration:400,ease:w.Math.Easing.Cubic.In,delay:a,onUpdate:o=>{t.sprite.scaleY=o.targets[0].scaleY,t.spriteBack.scaleY=o.targets[0].scaleY},onComplete:()=>{t.showTile(!0,!1),this.scene.tweens.add({targets:{scaleY:0},scaleY:.6,duration:400,ease:w.Math.Easing.Cubic.Out,onUpdate:o=>{t.sprite.scaleY=o.targets[0].scaleY,t.spriteBack.scaleY=o.targets[0].scaleY},onComplete:()=>{n()}})}})}))}),Promise.all(e)}animateFlyOffScreen(){const e=[];for(let s=0;s<this.tileArray.length;s+=20){const i=this.tileArray.slice(s,s+20);e.push(new Promise(a=>{this.scene.time.delayedCall(s/20*150,()=>{const o=i.map(r=>new Promise(l=>{const d=w.Math.Between(1200,2e3),m=w.Math.Between(-200,-50),p=w.Math.Between(-200,-50),u=w.Math.Between(r.x-100,r.x+100),E=w.Math.Between(r.y-200,r.y),T=new w.Curves.QuadraticBezier(new w.Math.Vector2(r.x,r.y),new w.Math.Vector2(u,E),new w.Math.Vector2(m,p)),S={t:0,vec:new w.Math.Vector2};this.scene.tweens.add({targets:S,t:1,duration:d,ease:"Cubic.In",onUpdate:()=>{T.getPoint(S.t,S.vec),r.x=S.vec.x,r.y=S.vec.y},onComplete:()=>{r.showTile(!1,!1),l()}})}));Promise.all(o).then(a)})}))}return Promise.all(e)}async transitionToWallSystem(){await this.wall.receiveOrganizedTilesFromHomePage(this.tileArray)}cleanup(){this.tileArray=[]}calculatePlayerHandPositions(){const e=[],n=q*.6,s=P*.6;for(let i=0;i<13;i++)e.push({x:H/2-6.5*n+i*n,y:R-s-10,angle:0});for(let i=0;i<13;i++)e.push({x:H/2-6.5*n+i*n,y:s+10,angle:180});for(let i=0;i<13;i++)e.push({x:s+10,y:R/2-6.5*n+i*n,angle:-90});for(let i=0;i<13;i++)e.push({x:H-s-10,y:R/2-6.5*n+i*n,angle:90});return e}}class he{constructor(e,t){this.scene=e,this.settingsManager=t,this.bgm=null,this.currentBGMKey=null,this.bgmVolume=this.settingsManager.getSetting("bgmVolume",.25),this.bgmMuted=this.settingsManager.getSetting("bgmMuted",!1),this.sfxVolume=this.settingsManager.getSetting("sfxVolume",.7),this.sfxMuted=this.settingsManager.getSetting("sfxMuted",!1)}playBGM(e){this.bgm&&this.bgm.isPlaying&&this.bgm.stop(),this.currentBGMKey=e,this.bgm=this.scene.sound.add(e,{loop:!0,volume:this.bgmMuted?0:this.bgmVolume}),this.bgm.play()}stopBGM(){this.bgm&&this.bgm.isPlaying&&this.bgm.stop()}setBGMVolume(e){this.bgmVolume=Math.max(0,Math.min(1,e)),this.bgm&&!this.bgmMuted&&this.bgm.setVolume(this.bgmVolume)}muteBGM(e){this.bgmMuted=e,this.bgm&&this.bgm.setVolume(this.bgmMuted?0:this.bgmVolume)}getBGMVolume(){return this.bgmVolume}isBGMMuted(){return this.bgmMuted}playSFX(e){this.sfxMuted||this.scene.sound.play(e,{volume:this.sfxVolume})}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}muteSFX(e){this.sfxMuted=e}getSFXVolume(){return this.sfxVolume}isSFXMuted(){return this.sfxMuted}destroy(){this.bgm&&(this.bgm.stop(),this.bgm.destroy())}}class ue{constructor(e,t,n,s){this.gameController=e,this.scene=t,this.table=n,this.gameLogic=s,this.tileMap=new Map,this.pendingPromptCallback=null,this.currentPromptType=null,this.setupEventListeners()}setupEventListeners(){const e=this.gameController;e.on("STATE_CHANGED",t=>this.onStateChanged(t)),e.on("GAME_STARTED",t=>this.onGameStarted(t)),e.on("GAME_ENDED",t=>this.onGameEnded(t)),e.on("TILES_DEALT",t=>this.onTilesDealt(t)),e.on("TILE_DRAWN",t=>this.onTileDrawn(t)),e.on("TILE_DISCARDED",t=>this.onTileDiscarded(t)),e.on("DISCARD_CLAIMED",t=>this.onDiscardClaimed(t)),e.on("TILES_EXPOSED",t=>this.onTilesExposed(t)),e.on("JOKER_SWAPPED",t=>this.onJokerSwapped(t)),e.on("HAND_UPDATED",t=>this.onHandUpdated(t)),e.on("TURN_CHANGED",t=>this.onTurnChanged(t)),e.on("CHARLESTON_PHASE",t=>this.onCharlestonPhase(t)),e.on("CHARLESTON_PASS",t=>this.onCharlestonPass(t)),e.on("COURTESY_VOTE",t=>this.onCourtesyVote(t)),e.on("COURTESY_PASS",t=>this.onCourtesyPass(t)),e.on("MESSAGE",t=>this.onMessage(t)),e.on("UI_PROMPT",t=>this.onUIPrompt(t))}createPhaserTile(e){if(this.tileMap.has(e.index))return this.tileMap.get(e.index);const t=this.findTileInWall(e.index);if(t)return this.tileMap.set(e.index,t),t;console.warn(`Creating new tile for index ${e.index} - this shouldn't happen!`);const n=this.getTileSpriteName(e),s=new D(this.scene,e.suit,e.number,n);return s.index=e.index,s.create(),this.tileMap.set(e.index,s),s}findTileInWall(e){for(const t of this.table.wall.tileArray)if(t.index===e)return t;return null}findPhaserTile(e){return this.tileMap.get(e.index)||null}getTileSpriteName(e){const{suit:t,number:n}=e;return t===c.CRACK?`${n}C.png`:t===c.BAM?`${n}B.png`:t===c.DOT?`${n}D.png`:t===c.WIND?`${["N","S","W","E"][n]}.png`:t===c.DRAGON?`${["DC","DB","DD"][n]}.png`:t===c.FLOWER?`F${n%4+1}.png`:t===c.JOKER?"J.png":t===c.BLANK?"BLANK.png":`tile_${t}_${n}.png`}convertToPhaserTiles(e){return e.map(t=>this.createPhaserTile(t))}onStateChanged(e){const{oldState:t,newState:n}=e;console.log(`State: ${t}  ${n}`),this.gameLogic.state=n,this.updateButtonState(n)}updateButtonState(e){this.hideButtons()}onGameStarted(e){f("Game started!"),this.table.reset();const t=document.getElementById("start");t&&(t.style.display="none")}onGameEnded(e){const{reason:t,winner:n,mahjong:s}=e;if(s){const a=this.table.players[n];f(`${a.playerInfo.name} wins with Mahjong!`),this.scene.audioManager&&this.scene.audioManager.playFireworks()}else t==="wall_game"&&f("Wall game - no winner");const i=document.getElementById("start");i&&(i.style.display="block")}onTilesDealt(e){const t=e.players.reduce((s,i)=>s+i.tileCount,0),n=this.table.wall.getLength()-t;this.scene.updateWallTileCounter&&this.scene.updateWallTileCounter(n),f("Tiles dealt to all players")}onTileDrawn(e){const{player:t,tile:n}=e,s=this.table.players[t],i=O.fromJSON(n),a=this.createPhaserTile(i);a.sprite.setPosition(640,360),a.sprite.setAlpha(0),s.hand.insertHidden(a);const l=s.hand.calculateTilePosition(s.playerInfo,s.hand.hiddenTileSet.getLength()-1);this.scene.tweens.add({targets:a.sprite,x:l.x,y:l.y,alpha:1,duration:200,ease:"Power2",onComplete:()=>{s.showHand(t===h.BOTTOM)}}),this.scene.updateWallTileCounter&&this.scene.updateWallTileCounter(this.table.wall.getLength()),t===h.BOTTOM&&x(`You drew: ${i.getText()}`)}onTileDiscarded(e){const{player:t,tile:n}=e,s=this.table.players[t],i=O.fromJSON(n),a=this.findPhaserTile(i);if(a){const o=a.sprite.x,r=a.sprite.y;s.hand.removeTile(a),this.table.discards.add(a,s.playerInfo);const l=a.sprite.x,d=a.sprite.y;a.sprite.setPosition(o,r),this.scene.tweens.add({targets:a.sprite,x:l,y:d,duration:250,ease:"Power2"}),f(`${s.playerInfo.name} discarded ${i.getText()}`)}}onDiscardClaimed(e){const{player:t,tile:n,claimType:s}=e,i=O.fromJSON(n);f(`${this.table.players[t].playerInfo.name} claimed ${i.getText()} for ${s}`)}onTilesExposed(e){const{player:t,exposureType:n,tiles:s}=e,i=this.table.players[t],a=s.map(r=>this.findPhaserTile(O.fromJSON(r))),o=new window.TileSet(this.scene,this.gameLogic,!1);a.forEach(r=>{i.hand.hiddenTileSet.remove(r),o.insert(r)}),i.hand.exposedTileSetArray.push(o),i.showHand(t===0),f(`${i.playerInfo.name} exposed ${n}: ${a.length} tiles`)}onJokerSwapped(e){this.handleJokerSwap(e)}handleJokerSwap(e={}){const{player:t,exposureIndex:n=0,jokerIndex:s=null,replacementTile:i,recipient:a=h.BOTTOM}=e;if(typeof t!="number"){f("JOKER_SWAPPED event missing player index");return}const o=this.table.players[t];if(!o||!o.hand){f(`JOKER_SWAPPED ignore: player ${t} missing hand`);return}const l=(o.hand.exposedTileSetArray||[])[n];if(!l){f(`JOKER_SWAPPED ignore: exposure ${n} missing for player ${t}`);return}const d=this.findJokerTile(l,s);if(!d){f(`JOKER_SWAPPED ignore: joker index ${s??"auto"} missing for player ${t}`);return}l.remove(d);const m=i instanceof O?i:i?O.fromJSON(i):null;if(m){const u=this.createPhaserTile(m);u&&(u.showTile(!0,!0),l.insert(u))}const p=this.table.players[a]||this.table.players[h.BOTTOM];p&&p.hand?p.hand.insertHidden(d):this.table.wall.insert(d),this.table.players.forEach((u,E)=>{u.showHand(E===h.BOTTOM)}),m?x(`${o.playerInfo.name} swapped a joker for ${m.getText()}`):x(`${o.playerInfo.name} joker swap complete`)}findJokerTile(e,t){if(!e||!Array.isArray(e.tileArray))return null;if(typeof t=="number"){const n=e.tileArray.find(s=>s.index===t);if(n)return n}return e.tileArray.find(n=>n.suit===c.JOKER)||null}onHandUpdated(e){const{player:t,hand:n}=e;this.table.players[t],console.log(`Hand updated for player ${t}: ${n.tiles.length} hidden, ${n.exposures.length} exposed`),t===h.BOTTOM&&this.gameLogic.hintAnimationManager&&this.gameLogic.hintAnimationManager.updateHintsForNewTiles()}onTurnChanged(e){const{currentPlayer:t,previousPlayer:n}=e;this.table.switchPlayer(t);const s=this.table.players[t];f(`${s.playerInfo.name}'s turn`)}onCharlestonPhase(e){const{phase:t,passCount:n,direction:s}=e;f(`Charleston Phase ${t}, Pass ${n}: Pass ${s}`)}onCharlestonPass(e){const{player:t,tiles:n,direction:s}=e,i=this.table.players[t];f(`${i.playerInfo.name} passed 3 tiles ${s}`)}onCourtesyVote(e){const{player:t,vote:n}=e,s=this.table.players[t];f(`${s.playerInfo.name} voted ${n?"YES":"NO"} for courtesy pass`)}onCourtesyPass(e){const{fromPlayer:t,toPlayer:n,tile:s}=e,i=O.fromJSON(s);f(`Courtesy pass: ${this.table.players[t].playerInfo.name}  ${this.table.players[n].playerInfo.name} (${i.getText()})`)}onMessage(e){const{text:t,type:n}=e;if(n==="info")x(t);else if(n==="error")f(`ERROR: ${t}`);else if(n==="hint"){const s=document.getElementById("hint-content");if(s){const i=document.createElement("div");i.className="hint-message",i.textContent=t,s.appendChild(i),s.scrollTop=s.scrollHeight}}else f(t)}onUIPrompt(e){const{promptType:t,options:n,callback:s}=e;this.pendingPromptCallback=s,this.currentPromptType=t,t==="CHOOSE_DISCARD"?this.setupDiscardPrompt(n):t==="CLAIM_DISCARD"?this.setupClaimPrompt(n):t==="CHARLESTON_PASS"?this.setupCharlestonPassPrompt(n):t==="CHARLESTON_CONTINUE"?this.setupCharlestonContinuePrompt(n):t==="COURTESY_VOTE"&&this.setupCourtesyVotePrompt(n)}setupDiscardPrompt(e){const t=this.table.players[h.BOTTOM];x("Select a tile to discard"),t.hand.enableTileSelection(n=>{if(this.pendingPromptCallback){const s=O.fromPhaserTile(n);this.pendingPromptCallback(s),this.pendingPromptCallback=null,this.currentPromptType=null}})}setupClaimPrompt(e){const{tile:t,options:n}=e,s=O.fromJSON(t);x(`Claim ${s.getText()}?`);const i=["button1","button2","button3","button4"],a=["Mahjong","Pung","Kong","Pass"];i.forEach((o,r)=>{const l=document.getElementById(o),d=a[r];n.includes(d)||d==="Pass"?(l.textContent=d,l.disabled=!1,l.style.display="block",l.onclick=()=>this.respondToClaim(d)):(l.style.display="none",l.disabled=!0,l.onclick=null)})}respondToClaim(e){this.pendingPromptCallback&&(this.pendingPromptCallback(e),this.pendingPromptCallback=null,this.currentPromptType=null),this.hideButtons()}setupCharlestonPassPrompt(e){const{direction:t,requiredCount:n}=e,s=this.table.players[h.BOTTOM];x(`Choose ${n} tiles to pass ${t}`);const i=document.getElementById("button1");i.textContent="Pass",i.disabled=!0,i.style.display="block";const a=()=>{s.hand.hiddenTileSet.getSelection().length===n?i.disabled=!1:i.disabled=!0};i.onclick=()=>{const r=s.hand.hiddenTileSet.getSelection();if(r.length===n&&this.pendingPromptCallback){const l=r.map(d=>O.fromPhaserTile(d));s.hand.hiddenTileSet.resetSelection(),this.pendingPromptCallback(l),this.pendingPromptCallback=null,this.currentPromptType=null,this.hideButtons()}};const o=window.setInterval(()=>{if(this.currentPromptType!=="CHARLESTON_PASS"){window.clearInterval(o);return}a()},100);document.getElementById("button2").style.display="none",document.getElementById("button3").style.display="none",document.getElementById("button4").style.display="none"}setupCharlestonContinuePrompt(e){const{question:t}=e;x(t);const n=document.getElementById("button1"),s=document.getElementById("button2");n.textContent="Yes",n.disabled=!1,n.style.display="block",n.onclick=()=>this.respondYesNo("Yes"),s.textContent="No",s.disabled=!1,s.style.display="block",s.onclick=()=>this.respondYesNo("No"),document.getElementById("button3").style.display="none",document.getElementById("button4").style.display="none"}setupCourtesyVotePrompt(e){const{question:t}=e;x(t);const n=document.getElementById("button1"),s=document.getElementById("button2");n.textContent="Yes",n.disabled=!1,n.style.display="block",n.onclick=()=>this.respondYesNo("Yes"),s.textContent="No",s.disabled=!1,s.style.display="block",s.onclick=()=>this.respondYesNo("No"),document.getElementById("button3").style.display="none",document.getElementById("button4").style.display="none"}respondYesNo(e){this.pendingPromptCallback&&(this.pendingPromptCallback(e),this.pendingPromptCallback=null,this.currentPromptType=null),this.hideButtons()}hideButtons(){["button1","button2","button3","button4"].forEach(t=>{const n=document.getElementById(t);n&&(n.style.display="none",n.disabled=!0,n.onclick=null)})}destroy(){this.gameController.clear(),this.tileMap.clear(),this.pendingPromptCallback=null}}const me="/mahjong/assets/tiles-imJ8iwem.png",ge=[{filename:"1B.png",frame:{x:0,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"1C.png",frame:{x:52,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"1D.png",frame:{x:104,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2B.png",frame:{x:156,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2C.png",frame:{x:208,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2D.png",frame:{x:260,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3B.png",frame:{x:312,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3C.png",frame:{x:364,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3D.png",frame:{x:416,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4B.png",frame:{x:468,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4C.png",frame:{x:520,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4D.png",frame:{x:572,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5B.png",frame:{x:624,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5C.png",frame:{x:676,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5D.png",frame:{x:728,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6B.png",frame:{x:780,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6C.png",frame:{x:832,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6D.png",frame:{x:884,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7B.png",frame:{x:936,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7C.png",frame:{x:988,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7D.png",frame:{x:1040,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8B.png",frame:{x:1092,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8C.png",frame:{x:1144,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8D.png",frame:{x:1196,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9B.png",frame:{x:1248,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9C.png",frame:{x:1300,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9D.png",frame:{x:1352,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DB.png",frame:{x:1404,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DC.png",frame:{x:1456,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DD.png",frame:{x:1508,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"E.png",frame:{x:1560,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F1.png",frame:{x:1612,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F2.png",frame:{x:1664,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F3.png",frame:{x:1716,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F4.png",frame:{x:1768,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"J.png",frame:{x:1820,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"N.png",frame:{x:1872,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"S.png",frame:{x:1924,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"W.png",frame:{x:1976,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}}],pe={app:"https://www.codeandweb.com/texturepacker",version:"1.0",image:"tiles.png",format:"RGBA8888",size:{w:2028,h:69},scale:"1",smartupdate:"$TexturePacker:SmartUpdate:baa73215de891ffd3d2987c3955d687c:7fb101c424dd8f5d293fdd929aadebef:accbe1e7e294ded8391337fc1c446319$"},fe={frames:ge,meta:pe},ye="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADQAAABFCAYAAAAFBsWPAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAAJBJREFUaEPt27ENgCAUBmFwGhNqo8Nq4zKiTiOxx4YhTnJf9ed1N8CL+7bWMaXQg/cpIV75qNO8tNO/3WcOQ9vdMIjOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6Ayi6y6osx+8Ej5OSBM+UQfkQgAAAABJRU5ErkJggg==";class be extends w.Scene{constructor(){super({key:"GameScene"}),this.commandBarManualPosition=!1,this.commandBarPosition=null,this.homePageTileManager=null}preload(){this.load.atlas("tiles",me,fe),this.load.image("back",ye);const e=document.createElement("canvas");e.width=4,e.height=4;const t=e.getContext("2d");t&&(t.fillStyle="white",t.fillRect(0,0,4,4)),this.textures.addCanvas("particle",e),this.load.audio("bgm","./assets/audio/2406haidao_bgm_loop.mp3"),this.load.audio("rack_tile","./assets/audio/rack_tile.mp3"),this.load.audio("tile_dropping","./assets/audio/tile_dropping.mp3"),this.load.audio("fireworks","./assets/audio/fireworks.mp3")}async create(){this.input.dragDistanceThreshold=20,this.scale.on("resize",this.resize,this),this.audioManager=new he(this,window.settingsManager),this.gGameLogic=new oe(this),this.gTable=new de(this,this.gGameLogic),this.gGameLogic.table=this.gTable,await this.gGameLogic.init(),this.gGameLogic.gameAI.table=this.gTable,this.gameController=new Z,await this.gameController.init({aiEngine:this.gGameLogic.gameAI,cardValidator:this.gGameLogic.card,settings:{year:window.settingsManager.getCardYear(),difficulty:window.settingsManager.getDifficulty(),useBlankTiles:window.settingsManager.getUseBlankTiles(),skipCharleston:!1}}),this.adapter=new ue(this.gameController,this,this.gTable,this.gGameLogic),window.gameController=this.gameController,this.gGameLogic.updateUI(),this.gGameLogic.wallCounter=this.createWallTileCounter(),this.gGameLogic.errorText=this.add.text(400,400,"",{font:"14px Arial",fill:"#ff8080",backgroundColor:"rgba(0,0,0,1)",align:"left"}),this.gGameLogic.errorText.visible=!1,this.gTable.create(!0),this.homePageTileManager=new ce(this,this.gTable.wall),this.homePageTileManager.createScatteredTiles(),this.enableCommandBarDrag(),this.resize(this.sys.game.canvas.width,this.sys.game.canvas.height);const e=document.getElementById("start");e&&e.addEventListener("click",async()=>{e.style.display="none",this.homePageTileManager?(this.homePageTileManager.onAnimationComplete=async()=>{await this.homePageTileManager.transitionToWallSystem(),this.homePageTileManager.cleanup(),this.homePageTileManager=null,await this.gameController.startGame()},this.homePageTileManager.animateToPileAndStartGame()):await this.gameController.startGame()})}createWallTileCounter(){const e=this.add.container(H/2-150,160),t=this.add.graphics();t.fillStyle(2763306,1),t.fillRoundedRect(0,0,300,20,5);const n=this.add.graphics(),s=U(),i=this.add.text(150,10,"Wall Tiles Remaining: "+s,{fontFamily:"Arial, sans-serif",fontSize:"16px",fontStyle:"bold",color:"#ffffff",stroke:"#000000",strokeThickness:4});return i.setOrigin(.5,.5),i.setResolution(2),e.add([t,n,i]),e.setVisible(!1),e.setDepth(100),{bar:e,fill:n,text:i,maxTiles:s}}updateWallTileCounter(e){if(!this.gGameLogic.wallCounter)return;const{bar:t,fill:n,text:s,maxTiles:i}=this.gGameLogic.wallCounter;n.clear(),(e<0||e>i)&&(console.error("Invalid wall count:",e),e=Math.max(0,Math.min(e,i))),n.fillStyle(4886754,1);const a=e/i*300;n.fillRoundedRect(0,0,a,20,5),s.setText(`Wall Tiles Remaining: ${e}`),t.setVisible(!0)}update(){}getDragBounds(){const e=document.getElementById("parentdiv");return e?e.getBoundingClientRect():this.sys.canvas.getBoundingClientRect()}getClampedCommandBarPosition(e,t,n,s){const a=n.getBoundingClientRect(),o=(a.width||n.offsetWidth||0)/2,r=a.height||n.offsetHeight||0;let l=s.left+o+16,d=s.right-o-16;if(l>d){const T=s.left+s.width/2;l=T,d=T}let m=s.top+16,p=s.bottom-r-16;if(m>p){const T=s.top+s.height/2;m=T,p=T}const u=Math.min(Math.max(e,l),d),E=Math.min(Math.max(t,m),p);return{left:u,top:E}}getDefaultCommandBarPosition(e,t,n){const s=e.offsetWidth||0,i=e.offsetHeight||0,a=t.right-s/2-36,o=t.bottom-i-110;return this.getClampedCommandBarPosition(a,o,e,n)}enableCommandBarDrag(){const e=document.getElementById("uicenterdiv"),t=this.sys.canvas;if(!e||!t)return;const n=document.documentElement.style;let s=!1,i=0,a=0;const o=d=>{if(!s)return;const m=this.getDragBounds(),p=e.getBoundingClientRect(),u=d.clientX-i+(p.width||e.offsetWidth||0)/2,E=d.clientY-a,{left:T,top:S}=this.getClampedCommandBarPosition(u,E,e,m);n.setProperty("--command-bar-left",`${T}px`),n.setProperty("--command-bar-top",`${S}px`),this.commandBarPosition={left:T,top:S},this.commandBarManualPosition=!0},r=d=>{if(s){s=!1,e.classList.remove("command-bar--dragging");try{e.releasePointerCapture(d.pointerId)}catch{}window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),window.removeEventListener("pointercancel",r)}},l=d=>{if(d.button!==0||d.target.closest("#buttondiv"))return;const m=e.getBoundingClientRect();i=d.clientX-m.left,a=d.clientY-m.top,s=!0,e.classList.add("command-bar--dragging");try{e.setPointerCapture(d.pointerId)}catch{}window.addEventListener("pointermove",o),window.addEventListener("pointerup",r),window.addEventListener("pointercancel",r),d.preventDefault()};e.addEventListener("pointerdown",l),this.events.once(w.Scenes.Events.SHUTDOWN,()=>{e.removeEventListener("pointerdown",l),window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),window.removeEventListener("pointercancel",r)})}resize(e,t,n,s){const i=document.getElementById("uicenterdiv"),a=this.sys.canvas;if(!i||!a)return;const o=a.getBoundingClientRect(),r=this.getDragBounds(),l=document.documentElement.style;if(this.commandBarManualPosition&&this.commandBarPosition){const{left:p,top:u}=this.getClampedCommandBarPosition(this.commandBarPosition.left,this.commandBarPosition.top,i,r);this.commandBarPosition={left:p,top:u},l.setProperty("--command-bar-left",`${p}px`),l.setProperty("--command-bar-top",`${u}px`);return}const{left:d,top:m}=this.getDefaultCommandBarPosition(i,o,r);this.commandBarPosition={left:d,top:m},l.setProperty("--command-bar-left",`${d}px`),l.setProperty("--command-bar-top",`${m}px`)}createFireworksDisplay(e){return new Promise(t=>{if(!e.mahjong||e.winner!==0){t();return}const n=this.sys.game.canvas.width,s=this.sys.game.canvas.height,i=w.Math.Between(5,7),a=[];try{for(let r=0;r<i;r++){const l=w.Math.Between(100,n-100),d=w.Math.Between(100,s-200),m=this.add.particles(l,d,"particle",{speed:{min:200,max:400},angle:{min:0,max:360},lifespan:{min:1200,max:1800},gravityY:300,scale:{start:.8,end:0},alpha:{start:1,end:0},tint:[16773222,6737151,16737988,65382,16737792,13395711],blendMode:"ADD"});m.setDepth(300),a.push(m),this.time.delayedCall(r*300,()=>{const p=w.Math.Between(15,25);m.emitParticleAt(l,d,p)})}const o=(i-1)*300+2e3;this.time.delayedCall(o,()=>{a.forEach(r=>r.destroy()),t()})}catch(o){console.warn("[GameScene] Fireworks display failed:",o),a.forEach(r=>{try{r.destroy()}catch{}}),t()}})}}const we=window.location.search.includes("playwright=true")||window.navigator.userAgent.includes("Playwright"),Te={type:we?w.CANVAS:w.AUTO,width:H,height:R,transparent:!0,parent:"gamediv",scene:[be],scale:{mode:w.Scale.FIT,autoCenter:w.Scale.CENTER_BOTH},render:{antialias:!0,mipmapFilter:"LINEAR_MIPMAP_LINEAR",powerPreference:"high-performance"}},Se=new w.Game(Te);window.game=Se;
