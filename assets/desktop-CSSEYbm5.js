import{d as V,S as A,P as g,H as W,W as F,D as J,a as P,b as C,c as M,g as Y,p as w,e as O,f as c,h as v,i as j,T as R,j as p,k as $,l as G,m as T,n as B,o as k,V as x,q as H,r as N,s as X,G as K}from"./GameController-B4Z9wUCn.js";class q{constructor(){this.overlay=document.getElementById("settings-overlay"),this.saveButton=document.getElementById("settings-save"),this.cancelButton=document.getElementById("settings-cancel"),this.settingsButton=document.getElementById("settings"),this.originalSettings={},this.init(),this.loadSettings()}init(){this.settingsButton.addEventListener("click",()=>{this.showSettings()}),this.saveButton.addEventListener("click",()=>{this.saveAndClose()}),this.cancelButton.addEventListener("click",()=>{this.cancelAndClose()}),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.cancelAndClose()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.overlay.style.display!=="none"&&this.cancelAndClose()});const e=document.getElementById("trainCheckbox");e&&e.addEventListener("change",()=>{this.updateTrainingFormVisibility()}),this.setupAudioControls()}showSettings(){this.overlay.style.display="flex",this.storeCurrentSettingsState(),this.saveButton.focus()}hideSettings(){this.overlay.style.display="none",this.settingsButton.focus()}storeCurrentSettingsState(){var e,t,s,n,i,a,o,r,d,h;this.originalSettings={trainingMode:((e=document.getElementById("trainCheckbox"))==null?void 0:e.checked)??!1,trainingHand:((t=document.getElementById("handSelect"))==null?void 0:t.value)??"",trainingTileCount:((s=document.getElementById("numTileSelect"))==null?void 0:s.value)??"9",skipCharleston:((n=document.getElementById("skipCharlestonCheckbox"))==null?void 0:n.checked)??!1,cardYear:((i=document.getElementById("yearSelect"))==null?void 0:i.value)??"2025",useBlankTiles:((a=document.getElementById("useBlankTiles"))==null?void 0:a.checked)??!1,bgmVolume:((o=document.getElementById("bgmVolume"))==null?void 0:o.value)??"70",bgmMuted:((r=document.getElementById("bgmMute"))==null?void 0:r.checked)??!1,sfxVolume:((d=document.getElementById("sfxVolume"))==null?void 0:d.value)??"80",sfxMuted:((h=document.getElementById("sfxMute"))==null?void 0:h.checked)??!1}}restoreOriginalSettings(){const e=document.getElementById("trainCheckbox"),t=document.getElementById("handSelect"),s=document.getElementById("numTileSelect"),n=document.getElementById("skipCharlestonCheckbox"),i=document.getElementById("yearSelect"),a=document.getElementById("useBlankTiles"),o=document.getElementById("bgmVolume"),r=document.getElementById("bgmVolumeValue"),d=document.getElementById("bgmMute"),h=document.getElementById("sfxVolume"),m=document.getElementById("sfxVolumeValue"),f=document.getElementById("sfxMute");e&&(e.checked=this.originalSettings.trainingMode),t&&(t.value=this.originalSettings.trainingHand),s&&(s.value=this.originalSettings.trainingTileCount),n&&(n.checked=this.originalSettings.skipCharleston),i&&(i.value=this.originalSettings.cardYear),a&&(a.checked=this.originalSettings.useBlankTiles),o&&(o.value=this.originalSettings.bgmVolume,r&&(r.textContent=`${this.originalSettings.bgmVolume}%`)),d&&(d.checked=this.originalSettings.bgmMuted),h&&(h.value=this.originalSettings.sfxVolume,m&&(m.textContent=`${this.originalSettings.sfxVolume}%`)),f&&(f.checked=this.originalSettings.sfxMuted),this.updateTrainingFormVisibility()}saveAndClose(){var n;const e=this.getSetting("cardYear","2025"),t=((n=document.getElementById("yearSelect"))==null?void 0:n.value)??"2025",s=e!==t;if(this.saveTrainingSettings(),this.saveDifficultySettings(),this.saveYearSettings(),this.saveHouseRuleSettings(),this.saveAudioSettings(),s&&window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const i=window.game.scene.getScene("GameScene");if(i.gGameLogic){const a=document.getElementById("handSelect");a&&(a.innerHTML=""),i.gGameLogic.init().then(()=>{})}}this.hideSettings()}cancelAndClose(){this.restoreOriginalSettings(),this.hideSettings()}getDifficulty(){return this.getSetting("difficulty","medium")}getCardYear(){return this.getSetting("cardYear","2025")}saveSetting(e,t){try{A.set(e,t)}catch(s){console.warn("Failed to save setting:",s)}}getSetting(e,t=null){return A.get(e)??t}getAllSettings(){return A.load()}loadSettings(){const e=A.load();this.applyTrainingSettings(e),this.applyDifficultySettings(e),this.applyYearSettings(e),this.applyHouseRuleSettings(e),this.applyAudioSettings(e)}applyTrainingSettings(e){const t=document.getElementById("trainCheckbox"),s=document.getElementById("handSelect"),n=document.getElementById("numTileSelect"),i=document.getElementById("skipCharlestonCheckbox");t&&Object.prototype.hasOwnProperty.call(e,"trainingMode")&&(t.checked=e.trainingMode),s&&e.trainingHand&&(s.value=e.trainingHand),n&&e.trainingTileCount&&(n.value=e.trainingTileCount.toString()),i&&Object.prototype.hasOwnProperty.call(e,"skipCharleston")&&(i.checked=e.skipCharleston),this.updateTrainingFormVisibility()}applyDifficultySettings(e){const t=document.getElementById("difficultySelect");t&&e.difficulty&&(t.value=e.difficulty)}applyYearSettings(e){const t=document.getElementById("yearSelect");t&&e.cardYear&&(t.value=e.cardYear)}updateTrainingFormVisibility(){const e=document.getElementById("trainCheckbox"),t=document.getElementById("trainfieldset2");e&&t&&(t.disabled=!e.checked)}saveTrainingSettings(){var t,s,n,i;const e={};e.trainingMode=((t=document.getElementById("trainCheckbox"))==null?void 0:t.checked)??!1,e.trainingHand=((s=document.getElementById("handSelect"))==null?void 0:s.value)??"",e.trainingTileCount=parseInt(((n=document.getElementById("numTileSelect"))==null?void 0:n.value)??"9",10),e.skipCharleston=((i=document.getElementById("skipCharlestonCheckbox"))==null?void 0:i.checked)??!0,A.save(e),window.dispatchEvent(new window.CustomEvent("settingsChanged",{detail:e}))}saveDifficultySettings(){var t;const e={};e.difficulty=((t=document.getElementById("difficultySelect"))==null?void 0:t.value)??"medium",A.save(e)}saveYearSettings(){var t;const e={};e.cardYear=parseInt(((t=document.getElementById("yearSelect"))==null?void 0:t.value)??"2025",10),A.save(e)}saveHouseRuleSettings(){var t;const e={};e.useBlankTiles=((t=document.getElementById("useBlankTiles"))==null?void 0:t.checked)??!1,A.save(e)}saveAudioSettings(){var t,s,n,i;const e={};e.bgmVolume=parseInt(((t=document.getElementById("bgmVolume"))==null?void 0:t.value)??"70",10),e.bgmMuted=((s=document.getElementById("bgmMute"))==null?void 0:s.checked)??!1,e.sfxVolume=parseInt(((n=document.getElementById("sfxVolume"))==null?void 0:n.value)??"80",10),e.sfxMuted=((i=document.getElementById("sfxMute"))==null?void 0:i.checked)??!1,A.save(e)}applyHouseRuleSettings(e){const t=document.getElementById("useBlankTiles");t&&(t.checked=e.useBlankTiles)}applyAudioSettings(e){const t=document.getElementById("bgmVolume"),s=document.getElementById("bgmVolumeValue"),n=document.getElementById("bgmMute"),i=document.getElementById("sfxVolume"),a=document.getElementById("sfxVolumeValue"),o=document.getElementById("sfxMute");t&&(t.value=e.bgmVolume,s&&(s.textContent=`${e.bgmVolume}%`)),n&&(n.checked=e.bgmMuted),i&&(i.value=e.sfxVolume,a&&(a.textContent=`${e.sfxVolume}%`)),o&&(o.checked=e.sfxMuted)}getUseBlankTiles(){return A.get("useBlankTiles")}setupAudioControls(){const e=document.getElementById("bgmVolume"),t=document.getElementById("bgmVolumeValue"),s=document.getElementById("bgmMute"),n=document.getElementById("sfxVolume"),i=document.getElementById("sfxVolumeValue"),a=document.getElementById("sfxMute");e&&e.addEventListener("input",o=>{const r=parseInt(o.target.value,10)/100;t&&(t.textContent=`${o.target.value}%`),this.updateAudioManager("bgmVolume",r)}),s&&s.addEventListener("change",o=>{const r=o.target.checked;this.updateAudioManager("bgmMuted",r)}),n&&n.addEventListener("input",o=>{const r=parseInt(o.target.value,10)/100;i&&(i.textContent=`${o.target.value}%`),this.updateAudioManager("sfxVolume",r)}),a&&a.addEventListener("change",o=>{const r=o.target.checked;this.updateAudioManager("sfxMuted",r)})}updateAudioManager(e,t){if(window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const s=window.game.scene.getScene("GameScene");if(V("GameScene found, audioManager exists:",!!s.audioManager),s.audioManager)switch(e){case"bgmVolume":s.audioManager.setBGMVolume(t);break;case"bgmMuted":s.audioManager.muteBGM(t);break;case"sfxVolume":s.audioManager.setSFXVolume(t);break;case"sfxMuted":s.audioManager.muteSFX(t);break}}}registerSettingSection(e,t){}}document.addEventListener("DOMContentLoaded",()=>{window.settingsManager=new q;const l=document.getElementById("controldiv"),e=document.getElementById("uicenterdiv");l&&(l.style.visibility="visible"),e&&(e.style.display="none"),window.addEventListener("settingsChanged",t=>{const s=t.detail;if(console.log("Settings changed from mobile:",s),window.settingsManager&&window.settingsManager.overlay.style.display!=="none"&&window.settingsManager.loadSettings(),window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const n=window.game.scene.getScene("GameScene");if(n.gGameLogic){const i=window.settingsManager.getCardYear();s.cardYear&&i!==s.cardYear&&n.gGameLogic.init().then(()=>{V(`Card year updated to ${s.cardYear}`)})}}})});class Q{constructor(e,t,s){this.playerInfo=t;const n=t.id===g.BOTTOM;this.hand=new W(e,s,n)}create(){}showHand(e){this.hand.showHand(this.playerInfo,e)}}const Z=[{id:g.BOTTOM,x:200,y:600,angle:0,rectX:0,rectY:600-P/2,rectWidth:C,rectHeight:P},{id:g.RIGHT,x:1e3,y:520,angle:270,rectX:1e3-P*v/2,rectY:0,rectWidth:P*v,rectHeight:M},{id:g.TOP,x:750,y:50,angle:180,rectX:0,rectY:50-P*v/2,rectWidth:C,rectHeight:P*v},{id:g.LEFT,x:50,y:50,angle:90,rectX:50-P*v/2,rectY:0,rectWidth:P*v,rectHeight:M}];class ee{constructor(e){this.scene=e,this.gameLogic=null,this.wall=new F(e),this.discards=new J,this.boxes=[];for(let t=0;t<4;t++)this.boxes[t]=null;this.players=[];for(let t=0;t<4;t++)this.players[t]=new Q(e,Z[t],this);this.player02CourtesyVote=0,this.player13CourtesyVote=0}create(e=!1){for(let t=0;t<4;t++){const s=this.scene.add.graphics(0,0);this.boxes[t]=s}this.wall.create(e)}reset(){for(let t=0;t<4;t++)this.players[t].hand.reset(this.wall);for(;this.discards.tileArray.length;)this.wall.insert(this.discards.tileArray.pop());const e=Y();this.wall.tileArray.length!==e&&w("ERROR - table.reset() - total tile count is not "+e+". Tile count = "+this.wall.tileArray.length+`
`)}switchPlayer(e){for(let t=0;t<4;t++)this.boxes[t].visible=!1;this.boxes[e].visible=!0}applyTrainingHands(e){for(let t=0;t<4;t++){const s=e[t];if(s){for(let n=0;n<s.hiddenTileSet.getLength();n++){const i=s.hiddenTileSet.tileArray[n],a=this.wall.findAndRemove(i);a&&this.players[t].hand.insertHidden(a)}for(const n of s.exposedTileSetArray){const i=[];for(let a=0;a<n.getLength();a++){const o=n.tileArray[a],r=this.wall.findAndRemove(o);r&&i.push(r)}this.players[t].hand.insertExposed(i)}}}}finalizeInitialHands(){for(let e=0;e<4;e++)this.players[e].hand.sortSuitHidden(),e===g.BOTTOM?this.players[e].showHand(!0):this.players[e].showHand(!1)}deal(e){this.applyTrainingHands(e);for(let t=0;t<4;t++){let s=13;t===0&&(s=14);const n=s-this.players[t].hand.getLength();for(let i=0;i<n;i++){const a=this.wall.remove();this.players[t].hand.insertHidden(a)}}this.finalizeInitialHands(),this.scene.updateWallTileCounter&&this.scene.updateWallTileCounter(this.wall.getCount())}charlestonPass(e,t){const s=e-g.BOTTOM,n=[];for(let i=0;i<4;i++){const a=i;let o=i+s;o>3&&(o-=4);for(const r of t[a])this.players[o].hand.insertHidden(r),o===g.BOTTOM&&n.push(r)}for(let i=0;i<4;i++)i!==0&&this.players[i].hand.sortSuitHidden(),this.players[i].showHand(i===g.BOTTOM);return n}courtesyVote(e){this.player02CourtesyVote=Math.min(e[0],e[2]),this.player13CourtesyVote=Math.min(e[1],e[3])}courtesyPass(e){const s=[];for(let n=0;n<4;n++){const i=n;let a=n+2;a>3&&(a-=4);for(const o of e[i])this.players[a].hand.insertHidden(o),a===g.BOTTOM&&s.push(o)}for(let n=0;n<4;n++)n!==0&&this.players[n].hand.sortSuitHidden(),this.players[n].showHand(n===g.BOTTOM);return s}processClaimArray(e,t,s){let n=0,i=0;for(let r=0;r<4;r++)switch(t[r].playerOption){case O.EXPOSE_TILES:break;case O.DISCARD_TILE:n++;break;case O.MAHJONG:i++;break;default:w(`ERROR - processClaimArray. Unknown claim type
`);break}if(n===4)return this.discards.insertDiscard(s),this.discards.showDiscards(),{playerOption:O.DISCARD_TILE,winningPlayer:0};let a=O.EXPOSE_TILES;i&&(a=O.MAHJONG);let o=e;for(let r=0;r<3&&(o++,o>3&&(o=0),t[o].playerOption!==a);r++);if(a===O.MAHJONG)this.players[o].hand.insertHidden(s);else{const r=t[o].tileArray,d=this.players[o].hand,h=[],m=[...d.getHiddenTileArray()];for(const f of r)if(f!==s){const u=m.findIndex(b=>b.suit===f.suit&&b.number===f.number);u!==-1&&(h.push(m[u]),m.splice(u,1))}for(const f of h)d.removeHidden(f);d.insertExposed(r)}return this.players[o].showHand(o===g.BOTTOM),{playerOption:a,winningPlayer:o}}exchangeUserSelectedTileForExposedJoker(){const e=this.players[g.BOTTOM].hand.removeDiscard(),t=e.getText();w("Player 0 exchanged "+t+` for joker
`);for(let s=0;s<4;s++)for(const n of this.players[s].hand.exposedTileSetArray)if(n.getSelectionCount()===1){const a=n.getSelection()[0];n.resetSelection(),n.remove(a),this.players[g.BOTTOM].hand.insertHidden(a),n.insert(e);break}for(let s=0;s<4;s++)this.players[s].showHand(s===g.BOTTOM)}getExposedJokerArray(){const e=[];for(let t=0;t<4;t++)for(const s of this.players[t].hand.exposedTileSetArray){let n=null;for(const i of s.tileArray)if(i.suit!==c.JOKER){n=i;break}if(n)for(const i of s.tileArray)i.suit===c.JOKER&&e.push(n)}return e}exchangeJoker(e,t,s){e:for(let n=0;n<4;n++)for(const i of this.players[n].hand.exposedTileSetArray){let a=null;for(const o of i.tileArray)if(o.suit!==c.JOKER){a=o;break}if(a&&a.suit===s.suit&&a.number===s.number){for(const o of i.tileArray)if(o.suit===c.JOKER){const r=s.getText();w("Player "+e+" *exchanged* "+r+` for joker
`),t.removeHidden(s),i.insert(s),i.remove(o),t.insertHidden(o);for(let d=0;d<4;d++)this.players[d].showHand();break e}}}}}class te{constructor(e,t){this.scene=e,this.wall=t,this.tileArray=[],this.animationState="idle",this.isAnimating=!1,this.onAnimationComplete=null}createScatteredTiles(){const e=window.settingsManager?window.settingsManager.getUseBlankTiles():!1;let t=0;for(const s of j)if(!(s.suit===c.BLANK&&!e))for(const n of s.prefix)for(let i=1;i<=s.maxNum;i++){let a=i;s.maxNum===1&&(s.suit===c.FLOWER?a=0:a=s.prefix.indexOf(n));let o=n;s.maxNum!==1&&(o=i+o),o+=".png";for(let r=0;r<s.count;r++){const d=new R(this.scene,s.suit,a,o);d.create(),d.index=t++,this.tileArray.push(d)}}for(let s=0;s<this.tileArray.length;s++){const n=this.tileArray[s],{x:i,y:a,scale:o,angle:r}=this.generateRandomPosition();n.x=i,n.y=a,n.scale=o,n.angle=r,n.sprite.setDepth(s),n.showTile(!0,!1),Math.random()<.7&&n.showTile(!0,!0)}}generateRandomPosition(){const e=this.scene.sys.game.config.width/2,t=this.scene.sys.game.config.height/2,s=200,n=100;let i=0,a=0;for(;i===0;)i=Math.random();for(;a===0;)a=Math.random();let o=Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*a);const r=e+o*s;for(i=0,a=0;i===0;)i=Math.random();for(;a===0;)a=Math.random();o=Math.sqrt(-2*Math.log(i))*Math.cos(2*Math.PI*a);const d=t+o*n,h=p.Math.FloatBetween(.55,.65),m=p.Math.Between(-90,90);return{x:r,y:d,scale:h,angle:m}}async animateToPileAndStartGame(){this.isAnimating=!0,this.animationState="gathering",await this.animateJumpAndFlip(),await this.animateFlyOffScreen(),this.isAnimating=!1,this.animationState="complete",this.onAnimationComplete&&this.onAnimationComplete()}animateJumpAndFlip(){const e=[];return this.tileArray.forEach(t=>{e.push(new Promise(s=>{const n=t.y,i=p.Math.Between(5,15),a=p.Math.Between(0,150);t.withRaisedDepth(()=>{const o=this.scene.tweens.add({targets:{},duration:800+a,onComplete:()=>{}});return this.scene.tweens.add({targets:t,y:n-i,scale:.65,duration:400,ease:p.Math.Easing.Cubic.Out,delay:a}),this.scene.tweens.add({targets:t,y:n,scale:.6,duration:400,ease:p.Math.Easing.Cubic.In,delay:a+400}),o}),this.scene.tweens.add({targets:{scaleY:t.sprite.scaleY},scaleY:0,duration:400,ease:p.Math.Easing.Cubic.In,delay:a,onUpdate:o=>{t.sprite.scaleY=o.targets[0].scaleY,t.spriteBack.scaleY=o.targets[0].scaleY},onComplete:()=>{t.showTile(!0,!1),this.scene.tweens.add({targets:{scaleY:0},scaleY:.6,duration:400,ease:p.Math.Easing.Cubic.Out,onUpdate:o=>{t.sprite.scaleY=o.targets[0].scaleY,t.spriteBack.scaleY=o.targets[0].scaleY},onComplete:()=>{s()}})}})}))}),Promise.all(e)}animateFlyOffScreen(){const e=[];for(let n=0;n<this.tileArray.length;n+=20){const i=this.tileArray.slice(n,n+20);e.push(new Promise(a=>{this.scene.time.delayedCall(n/20*150,()=>{const o=i.map(r=>new Promise(d=>{const h=p.Math.Between(1200,2e3),m=p.Math.Between(-200,-50),f=p.Math.Between(-200,-50),u=p.Math.Between(r.x-100,r.x+100),b=p.Math.Between(r.y-200,r.y),y=new p.Curves.QuadraticBezier(new p.Math.Vector2(r.x,r.y),new p.Math.Vector2(u,b),new p.Math.Vector2(m,f)),S={t:0,vec:new p.Math.Vector2};this.scene.tweens.add({targets:S,t:1,duration:h,ease:"Cubic.In",onUpdate:()=>{y.getPoint(S.t,S.vec),r.x=S.vec.x,r.y=S.vec.y},onComplete:()=>{r.showTile(!1,!1),d()}})}));Promise.all(o).then(a)})}))}return Promise.all(e)}async transitionToWallSystem(){await this.wall.receiveOrganizedTilesFromHomePage(this.tileArray)}cleanup(){this.tileArray=[]}calculatePlayerHandPositions(){const e=[],s=$*.6,n=P*.6;for(let i=0;i<13;i++)e.push({x:C/2-6.5*s+i*s,y:M-n-10,angle:0});for(let i=0;i<13;i++)e.push({x:C/2-6.5*s+i*s,y:n+10,angle:180});for(let i=0;i<13;i++)e.push({x:n+10,y:M/2-6.5*s+i*s,angle:-90});for(let i=0;i<13;i++)e.push({x:C-n-10,y:M/2-6.5*s+i*s,angle:90});return e}}class se{constructor(e,t){this.scene=e,this.settingsManager=t,this.bgm=null,this.currentBGMKey=null,this.bgmVolume=this.settingsManager.getSetting("bgmVolume",.25),this.bgmMuted=this.settingsManager.getSetting("bgmMuted",!1),this.sfxVolume=this.settingsManager.getSetting("sfxVolume",.7),this.sfxMuted=this.settingsManager.getSetting("sfxMuted",!1)}playBGM(e){this.bgm&&this.bgm.isPlaying&&this.bgm.stop(),this.currentBGMKey=e,this.bgm=this.scene.sound.add(e,{loop:!0,volume:this.bgmMuted?0:this.bgmVolume}),this.bgm.play()}stopBGM(){this.bgm&&this.bgm.isPlaying&&this.bgm.stop()}setBGMVolume(e){this.bgmVolume=Math.max(0,Math.min(1,e)),this.bgm&&!this.bgmMuted&&this.bgm.setVolume(this.bgmVolume)}muteBGM(e){this.bgmMuted=e,this.bgm&&this.bgm.setVolume(this.bgmMuted?0:this.bgmVolume)}getBGMVolume(){return this.bgmVolume}isBGMMuted(){return this.bgmMuted}playSFX(e){this.sfxMuted||this.scene.sound.play(e,{volume:this.sfxVolume})}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}muteSFX(e){this.sfxMuted=e}getSFXVolume(){return this.sfxVolume}isSFXMuted(){return this.sfxMuted}destroy(){this.bgm&&(this.bgm.stop(),this.bgm.destroy())}}function ne(l,e,t=150,s=null){return l?new Promise(n=>{l.scene.tweens.add({targets:l,y:e.y,duration:t,ease:"Quad.easeOut",onComplete:()=>{s&&s(),n()}})}):Promise.resolve()}function ie(l,e,t=150,s=null){return l?new Promise(n=>{l.scene.tweens.add({targets:l,y:e.y,duration:t,ease:"Quad.easeOut",onComplete:()=>{s&&s(),n()}})}):Promise.resolve()}class ae{constructor(e,t){this.scene=e,this.table=t,this.tileSprites=new Map,this.selectedTiles=new Set,this.onTileSelected=null,this.onTileDeselected=null,this.dragEnabledPlayers=new Set}getHandLayout(e,t=14){const n=$*v+G;switch(e){case g.BOTTOM:return{startX:(C-t*n)/2,startY:M-80,spacing:n,direction:"horizontal"};case g.RIGHT:return{startX:C-60,startY:(M-t*n)/2,spacing:n,direction:"vertical"};case g.TOP:return{startX:(C+t*n)/2,startY:60,spacing:n,direction:"horizontal-reverse"};case g.LEFT:return{startX:40,startY:(M+t*n)/2,spacing:n,direction:"vertical-reverse"};default:throw new Error(`Invalid player index: ${e}`)}}getTileScreenPosition(e,t,s=14){const n=this.getHandLayout(e,s);switch(n.direction){case"horizontal":return{x:n.startX+t*n.spacing,y:n.startY};case"horizontal-reverse":return{x:n.startX-t*n.spacing,y:n.startY};case"vertical":return{x:n.startX,y:n.startY+t*n.spacing};case"vertical-reverse":return{x:n.startX,y:n.startY-t*n.spacing};default:return{x:0,y:0}}}getExposurePosition(e){switch(e){case g.BOTTOM:return{x:C-150,y:M-200,direction:"horizontal"};case g.RIGHT:return{x:C-150,y:100,direction:"vertical"};case g.TOP:return{x:150,y:60,direction:"horizontal"};case g.LEFT:return{x:40,y:M-150,direction:"vertical"};default:return{x:0,y:0}}}createTileSprite(e){return this.tileSprites.has(e.index)?this.tileSprites.get(e.index):null}registerTileSprite(e,t){t&&this.tileSprites.set(e.index,t)}destroyTileSprite(e){const t=this.tileSprites.get(e.index);t&&(t.destroy(),this.tileSprites.delete(e.index))}getTileSprite(e){const t=typeof e=="number"?e:e.index;return this.tileSprites.get(t)||null}updateHandDisplay(e,t){if(!t||t.length===0)return;const s=t.length;t.forEach((n,i)=>{if(n){const a=this.getTileScreenPosition(e,i,s);n.setPosition(a.x,a.y),n.setDepth(i)}})}updateExposuresDisplay(e,t){if(!t||t.length===0)return;const s=this.getExposurePosition(e);let n=s.x,i=s.y;const a=$*v+G;t.forEach(o=>{o&&o.tiles&&o.tiles.length>0&&(o.tiles.forEach((r,d)=>{if(r){let h=n,m=i;s.direction==="horizontal"?h=n+d*a:m=i+d*a,r.setPosition(h,m),r.setDepth(1e3+d)}}),s.direction==="horizontal"?n+=o.tiles.length*a+20:i+=o.tiles.length*a+20)})}selectTile(e){if(!e)return Promise.resolve();const t=this.findTileIndexBySprite(e);if(t===null||this.selectedTiles.has(t))return Promise.resolve();this.selectedTiles.add(t);const n=e.y-30;return ne(e,{y:n},150,()=>{this.onTileSelected&&this.onTileSelected(e,t)})}deselectTile(e){if(!e)return Promise.resolve();const t=this.findTileIndexBySprite(e);if(t===null||!this.selectedTiles.has(t))return Promise.resolve();this.selectedTiles.delete(t);const n=e.y+30;return ie(e,{y:n},150,()=>{this.onTileDeselected&&this.onTileDeselected(e,t)})}isSelectedTile(e){let t;return typeof e=="number"?t=e:t=this.findTileIndexBySprite(e),t!==null&&this.selectedTiles.has(t)}getSelectedTiles(){const e=[];return this.selectedTiles.forEach(t=>{const s=this.tileSprites.get(t);s&&e.push(s)}),e}getSelectedTileIndices(){return Array.from(this.selectedTiles)}async resetSelection(){const e=[],t=this.getSelectedTiles();for(const s of t)e.push(this.deselectTile(s));await Promise.all(e),this.selectedTiles.clear()}findTileIndexBySprite(e){for(const[t,s]of this.tileSprites)if(s===e)return t;return null}enableTileDragForPlayer(e){this.dragEnabledPlayers.add(e)}disableTileDragForPlayer(e){this.dragEnabledPlayers.delete(e)}sortTiles(e,t){return new Promise(s=>{this.updateHandDisplay(e,t);const n=300,i=[];t.forEach((a,o)=>{if(a){const r=this.getTileScreenPosition(e,o,t.length),d=new Promise(h=>{this.scene.tweens.add({targets:a,x:r.x,y:r.y,duration:n,ease:"Quad.easeOut",onComplete:h})});i.push(d)}}),Promise.all(i).then(s)})}highlightTile(e,t=16776960){e&&e.setTint(t)}unhighlightTile(e){e&&e.clearTint()}clearHighlights(){this.tileSprites.forEach(e=>{e.clearTint()})}getTileAtHandPosition(e,t){if(!this.table||!this.table.players)return null;const s=this.table.players[e];if(!s||!s.hand||!s.hand.tiles)return null;const n=s.hand.tiles[t];return n?this.getTileSprite(n):null}disableAllInteraction(){this.dragEnabledPlayers.clear(),this.tileSprites.forEach(e=>{e.setInteractive&&e.disableInteractive()})}enableAllInteraction(){}}class oe{constructor(e,t){this.scene=e,this.gameController=t,this.buttons={button1:document.getElementById("button1"),button2:document.getElementById("button2"),button3:document.getElementById("button3"),button4:document.getElementById("button4"),start:document.getElementById("start"),settings:document.getElementById("settings"),sort1:document.getElementById("sort1"),sort2:document.getElementById("sort2")},this.buttonCallbacks=new Map,this.currentState=T.INIT,this.setupButtonListeners()}setupButtonListeners(){Object.entries(this.buttons).forEach(([e,t])=>{t&&t.addEventListener("click",()=>this.onButtonClicked(e))})}onButtonClicked(e){const t=this.buttonCallbacks.get(e);t&&typeof t=="function"&&t()}updateForState(e){switch(this.currentState=e,this.clearAllCallbacks(),e){case T.INIT:case T.START:this.showStartButtons();break;case T.DEAL:this.showDealButtons();break;case T.CHARLESTON1:this.showCharlestonPassButtons();break;case T.CHARLESTON_QUERY:this.showCharlestonContinueButtons();break;case T.CHARLESTON2:this.showCharlestonPassButtons();break;case T.COURTESY_QUERY:this.showCourtesyVoteButtons();break;case T.COURTESY:this.showCourtesyPassButtons();break;case T.LOOP_PICK_FROM_WALL:this.showWallPickButtons();break;case T.LOOP_CHOOSE_DISCARD:this.showDiscardChoiceButtons();break;case T.LOOP_QUERY_CLAIM_DISCARD:this.showClaimButtons();break;case T.LOOP_EXPOSE_TILES:this.showExposureButtons();break;case T.END:this.showGameEndButtons();break;default:this.hideAllGameButtons()}}showStartButtons(){this.show(["start","settings"]),this.hide(["button1","button2","button3","button4","sort1","sort2"]),this.buttonCallbacks.set("start",()=>{this.gameController.startGame()}),this.buttonCallbacks.set("settings",()=>{})}showDealButtons(){this.show(["sort1","sort2"]),this.hide(["start","settings","button1","button2","button3","button4"]),this.buttonCallbacks.set("sort1",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("suit")}),this.buttonCallbacks.set("sort2",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("rank")})}showCharlestonPassButtons(){this.show(["button1"]),this.hide(["button2","button3","button4","start","settings","sort1","sort2"]),this.setText("button1","Pass Tiles"),this.setDisabled("button1",!0),this.buttonCallbacks.set("button1",()=>{this.gameController.onCharlestonPass&&this.gameController.onCharlestonPass()})}showCharlestonContinueButtons(){this.show(["button1","button2"]),this.hide(["button3","button4","start","settings","sort1","sort2"]),this.setText("button1","No"),this.setText("button2","Yes"),this.setDisabled("button1",!1),this.setDisabled("button2",!1),this.buttonCallbacks.set("button1",()=>{this.gameController.onCharlestonContinueQuery&&this.gameController.onCharlestonContinueQuery(!1)}),this.buttonCallbacks.set("button2",()=>{this.gameController.onCharlestonContinueQuery&&this.gameController.onCharlestonContinueQuery(!0)})}showCourtesyVoteButtons(){this.show(["button1","button2","button3","button4"]),this.hide(["start","settings","sort1","sort2"]),this.setText("button1","0 Tiles"),this.setText("button2","1 Tile"),this.setText("button3","2 Tiles"),this.setText("button4","3 Tiles"),this.buttonCallbacks.set("button1",()=>{this.gameController.onCourtesyVote&&this.gameController.onCourtesyVote(0)}),this.buttonCallbacks.set("button2",()=>{this.gameController.onCourtesyVote&&this.gameController.onCourtesyVote(1)}),this.buttonCallbacks.set("button3",()=>{this.gameController.onCourtesyVote&&this.gameController.onCourtesyVote(2)}),this.buttonCallbacks.set("button4",()=>{this.gameController.onCourtesyVote&&this.gameController.onCourtesyVote(3)})}showCourtesyPassButtons(){this.show(["button1"]),this.hide(["button2","button3","button4","start","settings","sort1","sort2"]),this.setText("button1","Exchange Tiles"),this.setDisabled("button1",!0),this.buttonCallbacks.set("button1",()=>{this.gameController.onCourtesyPass&&this.gameController.onCourtesyPass()})}showWallPickButtons(){this.hide(["button1","button2","button3","button4","start","settings","sort1","sort2"])}showDiscardChoiceButtons(){this.show(["button1","button2","button3","sort1","sort2"]),this.hide(["button4","start","settings"]),this.setText("button1","Discard"),this.setText("button2","Exchange Joker"),this.setText("button3","Mahjong!"),this.setDisabled("button1",!0),this.setDisabled("button2",!0),this.setDisabled("button3",!0),this.buttonCallbacks.set("button1",()=>{this.gameController.onChooseDiscard&&this.gameController.onChooseDiscard()}),this.buttonCallbacks.set("button2",()=>{this.gameController.onExchangeJoker&&this.gameController.onExchangeJoker()}),this.buttonCallbacks.set("button3",()=>{this.gameController.onMahjong&&this.gameController.onMahjong()}),this.buttonCallbacks.set("sort1",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("suit")}),this.buttonCallbacks.set("sort2",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("rank")})}showClaimButtons(){this.show(["button1","button2","button3","button4"]),this.hide(["start","settings","sort1","sort2"]),this.setText("button1","Claim"),this.setText("button2","Pung"),this.setText("button3","Kong"),this.setText("button4","Pass"),this.buttonCallbacks.set("button1",()=>{this.gameController.onClaimDiscard&&this.gameController.onClaimDiscard("claim")}),this.buttonCallbacks.set("button2",()=>{this.gameController.onClaimDiscard&&this.gameController.onClaimDiscard("pung")}),this.buttonCallbacks.set("button3",()=>{this.gameController.onClaimDiscard&&this.gameController.onClaimDiscard("kong")}),this.buttonCallbacks.set("button4",()=>{this.gameController.onClaimDiscard&&this.gameController.onClaimDiscard("pass")})}showExposureButtons(){this.show(["button1","button2"]),this.hide(["button3","button4","start","settings","sort1","sort2"]),this.setText("button1","Select Exposure"),this.setText("button2","Skip"),this.buttonCallbacks.set("button1",()=>{this.gameController.onExposeTiles&&this.gameController.onExposeTiles()}),this.buttonCallbacks.set("button2",()=>{this.gameController.onSkipExposure&&this.gameController.onSkipExposure()})}showGameEndButtons(){this.show(["button1","start"]),this.hide(["button2","button3","button4","settings","sort1","sort2"]),this.setText("button1","View Results"),this.setText("start","Start New Game"),this.buttonCallbacks.set("button1",()=>{}),this.buttonCallbacks.set("start",()=>{this.gameController.startGame()})}show(e){e.forEach(t=>{this.buttons[t]&&(this.buttons[t].style.display="block",this.buttons[t].disabled=!1)})}hide(e){e.forEach(t=>{this.buttons[t]&&(this.buttons[t].style.display="none")})}setText(e,t){this.buttons[e]&&(this.buttons[e].textContent=t)}setDisabled(e,t){this.buttons[e]&&(this.buttons[e].disabled=t)}hideAllGameButtons(){this.hide(["button1","button2","button3","button4","sort1","sort2"])}clearAllCallbacks(){this.buttonCallbacks.clear()}registerCallback(e,t){typeof t=="function"&&this.buttonCallbacks.set(e,t)}enableButton(e){this.setDisabled(e,!1)}disableButton(e){this.setDisabled(e,!0)}}class re{constructor(e){this.scene=e,this.dialogOverlay=null,this.pendingCallback=null,this.isOpen=!1}showYesNoDialog(e,t){return new Promise(s=>{this.pendingCallback=t,this.showModalDialog(e,[{label:"No",value:!1},{label:"Yes",value:!0}],n=>{t&&t(n),s(n)})})}showCharlestonPassDialog(e){return new Promise(t=>{this.pendingCallback=e,this.showModalDialog("Select 3 tiles to pass",[{label:"Cancel",value:null},{label:"Pass Selected",value:"pass"}],s=>{e&&e(s),t(s)})})}showCourtesyPassDialog(e=3,t){return new Promise(s=>{this.pendingCallback=t;const n=[{label:"Cancel",value:null},{label:`Exchange ${e} Tiles`,value:e}];this.showModalDialog(`Select up to ${e} tiles to exchange`,n,i=>{t&&t(i),s(i)})})}showExposureDialog(e,t){return new Promise(s=>{this.pendingCallback=t;const n=(e||[]).map(i=>({label:i,value:i}));n.push({label:"Cancel",value:null}),this.showModalDialog("Select how to expose these tiles",n,i=>{t&&t(i),s(i)})})}showClaimDialog(e,t){return new Promise(s=>{this.pendingCallback=t;const n=(e||[]).map(i=>({label:i,value:i}));n.push({label:"Pass",value:"pass"}),this.showModalDialog("Claim this discard?",n,i=>{t&&t(i),s(i)})})}showCourtesyVoteDialog(e){return new Promise(t=>{this.pendingCallback=e,this.showModalDialog("How many tiles for courtesy pass?",[{label:"0 Tiles",value:0},{label:"1 Tile",value:1},{label:"2 Tiles",value:2},{label:"3 Tiles",value:3}],s=>{e&&e(s),t(s)})})}showMessageDialog(e,t){return new Promise(s=>{this.showModalDialog(e,[{label:"OK",value:!0}],n=>{t&&t(),s(n)})})}showModalDialog(e,t,s){this.closeDialog(),this.dialogOverlay=document.createElement("div"),this.dialogOverlay.className="dialog-overlay",this.dialogOverlay.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;const n=document.createElement("div");n.className="dialog-box",n.style.cssText=`
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        `;const i=document.createElement("p");i.textContent=e,i.style.cssText=`
            margin: 0 0 20px 0;
            font-size: 18px;
            color: #333;
        `,n.appendChild(i);const a=document.createElement("div");a.className="dialog-buttons",a.style.cssText=`
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        `,t.forEach(o=>{const r=document.createElement("button");r.textContent=o.label,r.className="dialog-button",r.style.cssText=`
                padding: 10px 20px;
                margin: 5px;
                font-size: 14px;
                border: none;
                border-radius: 4px;
                background: #007bff;
                color: white;
                cursor: pointer;
                transition: background 0.3s;
            `,r.addEventListener("mouseover",()=>{r.style.background="#0056b3"}),r.addEventListener("mouseout",()=>{r.style.background="#007bff"}),r.addEventListener("click",()=>{this.closeDialog(),s&&s(o.value)}),a.appendChild(r)}),n.appendChild(a),this.dialogOverlay.appendChild(n),document.body.appendChild(this.dialogOverlay),this.isOpen=!0,this.scene.input&&(this.scene.input.enabled=!1)}closeDialog(){this.dialogOverlay&&this.dialogOverlay.parentNode&&this.dialogOverlay.parentNode.removeChild(this.dialogOverlay),this.dialogOverlay=null,this.isOpen=!1,this.pendingCallback=null,this.scene.input&&(this.scene.input.enabled=!0)}hasOpenDialog(){return this.isOpen}showError(e){const t=document.createElement("div");return t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        `,t.textContent=e,document.body.appendChild(t),new Promise(s=>{setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),s()},3e3)})}showSuccess(e){const t=document.createElement("div");return t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        `,t.textContent=e,document.body.appendChild(t),new Promise(s=>{setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),s()},2e3)})}showNotification(e,t="info",s=3e3){const n={info:"#17a2b8",success:"#28a745",error:"#dc3545",warning:"#ffc107"},i=document.createElement("div");i.style.cssText=`
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: ${n[t]||n.info};
            color: ${t==="warning"?"black":"white"};
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 9999;
            animation: slideUp 0.3s ease-out;
        `,i.textContent=e,document.body.appendChild(i),setTimeout(()=>{i.parentNode&&i.parentNode.removeChild(i)},s)}}class le{constructor(e,t,s){this.gameController=e,this.scene=t,this.table=s,this.tileMap=new Map,this.tilesRemovedFromWall=0,this.tileManager=new ae(t,s),this.buttonManager=new oe(t,e),this.dialogManager=new re(t),this.setupEventListeners()}setupEventListeners(){const e=this.gameController;e.on("STATE_CHANGED",t=>this.onStateChanged(t)),e.on("GAME_STARTED",t=>this.onGameStarted(t)),e.on("GAME_ENDED",t=>this.onGameEnded(t)),e.on("TILES_DEALT",t=>this.onTilesDealt(t)),e.on("TILE_DRAWN",t=>this.onTileDrawn(t)),e.on("TILE_DISCARDED",t=>this.onTileDiscarded(t)),e.on("DISCARD_CLAIMED",t=>this.onDiscardClaimed(t)),e.on("TILES_EXPOSED",t=>this.onTilesExposed(t)),e.on("JOKER_SWAPPED",t=>this.onJokerSwapped(t)),e.on("HAND_UPDATED",t=>this.onHandUpdated(t)),e.on("TURN_CHANGED",t=>this.onTurnChanged(t)),e.on("CHARLESTON_PHASE",t=>this.onCharlestonPhase(t)),e.on("CHARLESTON_PASS",t=>this.onCharlestonPass(t)),e.on("COURTESY_VOTE",t=>this.onCourtesyVote(t)),e.on("COURTESY_PASS",t=>this.onCourtesyPass(t)),e.on("MESSAGE",t=>this.onMessage(t)),e.on("UI_PROMPT",t=>this.onUIPrompt(t))}createPhaserTile(e){if(this.tileMap.has(e.index))return this.tileMap.get(e.index);const t=this.findTileInWall(e.index);if(t)return this.tileMap.set(e.index,t),t;console.warn(`Creating new tile for index ${e.index} - this shouldn't happen!`);const s=this.getTileSpriteName(e),n=new R(this.scene,e.suit,e.number,s);return n.index=e.index,n.create(),this.tileMap.set(e.index,n),n}findTileInWall(e){for(const t of this.table.wall.tileArray)if(t.index===e)return t;return null}findPhaserTile(e){return this.tileMap.get(e.index)||null}getTileSpriteName(e){const{suit:t,number:s}=e;return t===c.CRACK?`${s}C.png`:t===c.BAM?`${s}B.png`:t===c.DOT?`${s}D.png`:t===c.WIND?`${["N","S","W","E"][s]}.png`:t===c.DRAGON?`${["DC","DB","DD"][s]}.png`:t===c.FLOWER?`F${s%4+1}.png`:t===c.JOKER?"J.png":t===c.BLANK?"BLANK.png":`tile_${t}_${s}.png`}convertToPhaserTiles(e){return e.map(t=>this.createPhaserTile(t))}onStateChanged(e){const{oldState:t,newState:s}=e;console.log(`State: ${t} → ${s}`),this.buttonManager.updateForState(s);const n=this.table.players[0].hand;switch(s){case"CHARLESTON1":case"CHARLESTON2":n.setValidationMode("charleston");break;case"COURTESY":n.setValidationMode("courtesy");break;case"LOOP_CHOOSE_DISCARD":n.setValidationMode("play");break;case"LOOP_EXPOSE_TILES":n.setValidationMode("expose");break;default:n.setValidationMode(null)}}onGameStarted(){w("Game started!"),this.table.reset();const e=document.getElementById("start");e&&(e.style.display="none"),this.tilesRemovedFromWall=0}onGameEnded(e){const{reason:t,winner:s,mahjong:n}=e;if(n){const a=this.table.players[s];w(`${a.playerInfo.name} wins with Mahjong!`),this.scene.audioManager&&this.scene.audioManager.playFireworks()}else t==="wall_game"&&w("Wall game - no winner");const i=document.getElementById("start");i&&(i.style.display="block")}onTilesDealt(){if(this.scene.updateWallTileCounter){const t=(this.gameController.settings.useBlankTiles?160:152)-this.tilesRemovedFromWall;this.scene.updateWallTileCounter(t)}}onTileDrawn(e){const{player:t,tile:s}=e,n=this.table.players[t],i=B.fromJSON(s),a=this.createPhaserTile(i);a.sprite.setPosition(640,360),a.sprite.setAlpha(0),n.hand.insertHidden(a);const d=n.hand.calculateTilePosition(n.playerInfo,n.hand.hiddenTileSet.getLength()-1);if(this.scene.tweens.add({targets:a.sprite,x:d.x,y:d.y,alpha:1,duration:200,ease:"Power2",onComplete:()=>{n.showHand(t===g.BOTTOM)}}),this.tilesRemovedFromWall++,this.scene.updateWallTileCounter){const m=(this.gameController.settings.useBlankTiles?160:152)-this.tilesRemovedFromWall;this.scene.updateWallTileCounter(m)}t===g.BOTTOM&&k(`You drew: ${i.getText()}`)}onTileDiscarded(e){const{player:t,tile:s}=e,n=this.table.players[t],i=B.fromJSON(s),a=this.findPhaserTile(i);a&&(n.hand.removeHidden(a),this.table.discards.insertDiscard(a),t===g.BOTTOM&&this.table.players[g.BOTTOM].hand.setDiscardTile(a),this.table.discards.showDiscards(),w(`${n.playerInfo.name} discarded ${i.getText()}`))}onDiscardClaimed(e){const{player:t,tile:s,claimType:n}=e,i=B.fromJSON(s);w(`${this.table.players[t].playerInfo.name} claimed ${i.getText()} for ${n}`)}onTilesExposed(e){const{player:t,exposureType:s,tiles:n}=e,i=this.table.players[t],a=n.map(r=>this.findPhaserTile(B.fromJSON(r))),o=new window.TileSet(this.scene,this.table,!1);a.forEach(r=>{i.hand.hiddenTileSet.remove(r),o.insert(r)}),i.hand.exposedTileSetArray.push(o),i.showHand(t===0),w(`${i.playerInfo.name} exposed ${s}: ${a.length} tiles`)}onJokerSwapped(e){this.handleJokerSwap(e)}handleJokerSwap(e={}){const{player:t,exposureIndex:s=0,jokerIndex:n=null,replacementTile:i,recipient:a=g.BOTTOM}=e;if(typeof t!="number"){w("JOKER_SWAPPED event missing player index");return}const o=this.table.players[t];if(!o||!o.hand){w(`JOKER_SWAPPED ignore: player ${t} missing hand`);return}const d=(o.hand.exposedTileSetArray||[])[s];if(!d){w(`JOKER_SWAPPED ignore: exposure ${s} missing for player ${t}`);return}const h=this.findJokerTile(d,n);if(!h){w(`JOKER_SWAPPED ignore: joker index ${n??"auto"} missing for player ${t}`);return}d.remove(h);const m=i instanceof B?i:i?B.fromJSON(i):null;if(m){const u=this.createPhaserTile(m);u&&(u.showTile(!0,!0),d.insert(u))}const f=this.table.players[a]||this.table.players[g.BOTTOM];f&&f.hand?f.hand.insertHidden(h):this.table.wall.insert(h),this.table.players.forEach((u,b)=>{u.showHand(b===g.BOTTOM)}),m?k(`${o.playerInfo.name} swapped a joker for ${m.getText()}`):k(`${o.playerInfo.name} joker swap complete`)}findJokerTile(e,t){if(!e||!Array.isArray(e.tileArray))return null;if(typeof t=="number"){const s=e.tileArray.find(n=>n.index===t);if(s)return s}return e.tileArray.find(s=>s.suit===c.JOKER)||null}onHandUpdated(e){const{player:t,hand:s}=e;console.log(`Hand updated for player ${t}: ${s.tiles.length} hidden, ${s.exposures.length} exposed`),t===g.BOTTOM&&this.scene.hintAnimationManager&&this.scene.hintAnimationManager.updateHintsForNewTiles()}onTurnChanged(e){const{currentPlayer:t}=e;this.table.switchPlayer(t);const s=this.table.players[t];w(`${s.playerInfo.name}'s turn`)}onCharlestonPhase(e){const{phase:t,passCount:s,direction:n}=e;w(`Charleston Phase ${t}, Pass ${s}: Pass ${n}`)}onCharlestonPass(e){const{player:t,direction:s}=e,n=this.table.players[t];w(`${n.playerInfo.name} passed 3 tiles ${s}`)}onCourtesyVote(e){const{player:t,vote:s}=e,n=this.table.players[t];w(`${n.playerInfo.name} voted ${s?"YES":"NO"} for courtesy pass`)}onCourtesyPass(e){const{fromPlayer:t,toPlayer:s,tile:n}=e,i=B.fromJSON(n);w(`Courtesy pass: ${this.table.players[t].playerInfo.name} → ${this.table.players[s].playerInfo.name} (${i.getText()})`)}onMessage(e){const{text:t,type:s}=e;if(s==="info")k(t);else if(s==="error")w(`ERROR: ${t}`),this.dialogManager.showError(t);else if(s==="hint"){const n=document.getElementById("hint-content");if(n){const i=document.createElement("div");i.className="hint-message",i.textContent=t,n.appendChild(i),n.scrollTop=n.scrollHeight}}else w(t)}onUIPrompt(e){const{promptType:t,options:s,callback:n}=e;switch(t){case"CHOOSE_DISCARD":this.handleDiscardPrompt(n);break;case"CLAIM_DISCARD":this.handleClaimPrompt(s,n);break;case"CHARLESTON_PASS":this.handleCharlestonPassPrompt(s,n);break;case"CHARLESTON_CONTINUE":this.handleCharlestonContinuePrompt(n);break;case"COURTESY_VOTE":this.handleCourtesyVotePrompt(n);break;case"COURTESY_PASS":this.handleCourtesyPassPrompt(s,n);break;default:console.warn(`Unknown prompt type: ${t}`),n&&n(null)}}handleDiscardPrompt(e){const t=this.table.players[g.BOTTOM];k("Select a tile to discard"),t.hand.enableTileSelection(s=>{if(e){const n=B.fromPhaserTile(s);e(n)}})}handleClaimPrompt(e,t){const{options:s}=e;this.dialogManager.showClaimDialog(s,n=>{t&&t(n)})}handleCharlestonPassPrompt(e,t){const{direction:s,requiredCount:n}=e,i=this.table.players[g.BOTTOM];k(`Choose ${n} tiles to pass ${s}`),this.dialogManager.showCharlestonPassDialog(a=>{if(a==="pass"&&t){const o=i.hand.hiddenTileSet.getSelection();if(o.length===n){const r=o.map(d=>B.fromPhaserTile(d));i.hand.hiddenTileSet.resetSelection(),t(r)}}})}handleCharlestonContinuePrompt(e){this.dialogManager.showYesNoDialog("Continue to next Charleston phase?",t=>{e&&e(t)})}handleCourtesyVotePrompt(e){this.dialogManager.showCourtesyVoteDialog(t=>{e&&e(t)})}handleCourtesyPassPrompt(e,t){const{maxTiles:s}=e;this.dialogManager.showCourtesyPassDialog(s,n=>{t&&t(n)})}destroy(){this.gameController.clear(),this.tileMap.clear(),this.dialogManager&&this.dialogManager.closeDialog()}}const I={[c.VSUIT1]:"green",[c.VSUIT2]:"red",[c.VSUIT3]:"blue",[c.FLOWER]:"black",[c.VSUIT1_DRAGON]:"green",[c.VSUIT2_DRAGON]:"red",[c.VSUIT3_DRAGON]:"blue",[c.WIND]:"black",[c.DRAGON]:"blue",[c.JOKER]:"gray",[c.CRACK]:"red",[c.BAM]:"green",[c.DOT]:"blue"};function z(l,e=!1,t=null){if(l.suit===c.JOKER)return{char:"J",color:I[c.JOKER],tile:l};if(l.suit===c.FLOWER)return{char:"F",color:I[c.FLOWER],tile:l};if(l.suit===c.WIND)return{char:{[N.NORTH]:"N",[N.EAST]:"E",[N.SOUTH]:"S",[N.WEST]:"W"}[l.number]||"?",color:I[c.WIND],tile:l};if(l.suit===c.DRAGON||l.suit>=c.VSUIT1_DRAGON&&l.suit<=c.VSUIT3_DRAGON){if(l.suit===c.DRAGON&&l.number===H.WHITE)return{char:"0",color:"blue",tile:l};let s="blue";if(l.suit===c.DRAGON)s={[H.RED]:"red",[H.GREEN]:"green",[H.WHITE]:"blue"}[l.number]||"blue";else if(l.suit>=c.VSUIT1_DRAGON&&l.suit<=c.VSUIT3_DRAGON)if(t){const n=t[l.suit-c.VSUIT1_DRAGON];s=I[n]||"blue"}else{const n=l.suit-c.VSUIT1_DRAGON;s=["green","red","blue"][n]||"blue"}return{char:"D",color:s,tile:l}}if(l.number>=1&&l.number<=9){if(t&&l.suit>=c.VSUIT1&&l.suit<=c.VSUIT3){const s=t[l.suit-c.VSUIT1],n=I[s]||"blue";return{char:l.number.toString(),color:n,tile:l}}return{char:l.number.toString(),color:I[l.suit]||"blue",tile:l}}if(l.number>=x.CONSECUTIVE1&&l.number<=x.CONSECUTIVE7){const s=l.number-x.CONSECUTIVE1,n=e?2+s*2:1+s*2;if(t&&l.suit>=c.VSUIT1&&l.suit<=c.VSUIT3){const i=t[l.suit-c.VSUIT1],a=I[i]||"blue";return{char:n.toString(),color:a,tile:l}}return{char:n.toString(),color:I[l.suit]||"blue",tile:l}}return l.number===0?{char:"0",color:I[l.suit]||"gray",tile:l}:{char:"?",color:"gray",tile:l}}function _(l){const e=new Map;return l.forEach(t=>{const s=`${t.suit}-${t.number}`;e.set(s,(e.get(s)||0)+1)}),e}function de(l,e,t,s,n=null,i=null,a=null){const o=_(e),r=new Map,h=(i?_(i):o).get(`${c.JOKER}-0`)||0;let m=0,f=0;return l.map((u,b)=>{let y;if(a&&u.number>=x.CONSECUTIVE1&&u.number<=x.CONSECUTIVE7){const L=a.get(u.number);if(L!==void 0){const U={...u,number:L};y=z(U,s,n)}else y=z(u,s,n)}else y=z(u,s,n);const S=`${u.suit}-${u.number}`,D=t[b];let E=!1;return(o.get(S)||0)-(r.get(S)||0)>0?(E=!0,r.set(S,(r.get(S)||0)+1),u.suit===c.JOKER&&m++):D>=3&&u.suit!==c.JOKER&&m+f<h&&(E=!0,f++,y.char="J",y.color="gray"),{...y,isMatched:E}})}function ce(l,e=!0){const t="tile-char",s=e&&l.isMatched,n=l.color;return s?`${t} bg-${n}-600 text-white border border-${n}-700`:`${t} bg-white text-${n}-600 border border-${n}-200`}function he(l,e,t=null){const s=[],n=[],i=l.hand.even||!1,a=new Map;l.componentInfoArray.forEach(u=>{if(u.tileArray&&u.tileArray.length>0){const b=u.component.number;if(b>=x.CONSECUTIVE1&&b<=x.CONSECUTIVE7){const y=u.tileArray.find(S=>S.suit!==c.JOKER);if(y&&a.size===0){const S=b-x.CONSECUTIVE1,D=y.number-S;for(let E=0;E<7;E++)a.set(x.CONSECUTIVE1+E,D+E)}}}}),l.componentInfoArray.forEach((u,b)=>{const y=u.component.count,S=u.tileArray?u.tileArray.length:0;if(u.tileArray&&u.tileArray.length>0&&u.tileArray.forEach(D=>{s.push(D),n.push(y)}),S<y){const D={suit:u.component.suit||c.INVALID,number:u.component.number||0};for(let E=S;E<y;E++)s.push(D),n.push(y)}if(b<l.componentInfoArray.length-1){const D=l.componentInfoArray[b+1];u.component.count===1&&D.component.count===1||(s.push({isSpacer:!0}),n.push(0))}});const o=s.filter(u=>!u.isSpacer),r=n.filter((u,b)=>!s[b].isSpacer),d=de(o,e,r,i,l.vsuitArray,t,a),h=[];let m=0;s.forEach(u=>{u.isSpacer?h.push({isSpacer:!0}):h.push(d[m++])});let f='<div class="pattern-row">';return h.forEach(u=>{u.isSpacer?f+='<span class="component-spacer"></span>':f+=`<span class="${ce(u)}">${u.char}</span>`}),f+="</div>",f}class ue{constructor(e,t,s,n){this.scene=e,this.table=t,this.aiEngine=s,this.card=n,this.savedGlowData=null,this.currentHintData=null,this.isPanelExpanded=!1,this.glowedTiles=[]}applyGlowToDiscardSuggestions(e){this.clearAllGlows();const t=e.filter(i=>i.tile.suit!==c.INVALID&&i.recommendation==="DISCARD"),s=this.table.players[g.BOTTOM].hand,n=new Set;t.forEach((i,a)=>{V(`Processing tile ${a+1}: ${i.tile.getText()} with recommendation ${i.recommendation}`);const o=this.findNextUnhighlightedTileInHand(s,i.tile,n);o?(V(`Applying red glow to tile: ${o.getText()}`),o.addGlowEffect(this.scene,16711680,.6),this.glowedTiles.push(o),n.add(o)):V(`Could not find tile for: ${i.tile.getText()}`)}),V(`Applied glow to ${this.glowedTiles.length} tiles out of ${t.length} discard tiles requested`),this.currentHintData={recommendations:[...e]},this.isPanelExpanded=!0}findNextUnhighlightedTileInHand(e,t,s){const n=e.getHiddenTileArray();for(const i of n)if(i.suit===t.suit&&i.number===t.number&&!s.has(i))return i;return null}clearAllGlows(){if(this.glowedTiles.length>0){let e=null;this.currentHintData&&(e=this.currentHintData.recommendations),this.savedGlowData={recommendations:e,timestamp:Date.now()}}this.glowedTiles.forEach(e=>e.removeGlowEffect()),this.glowedTiles=[],this.isPanelExpanded=!1}restoreGlowEffects(){this.savedGlowData&&this.savedGlowData.recommendations?(this.applyGlowToDiscardSuggestions(this.savedGlowData.recommendations),this.isPanelExpanded=!0,this.savedGlowData=null):this.currentHintData&&this.currentHintData.recommendations&&(this.applyGlowToDiscardSuggestions(this.currentHintData.recommendations),this.isPanelExpanded=!0)}isHintPanelExpanded(){const e=window.document.getElementById("hint-content");return e&&!e.classList.contains("hidden")}getRecommendations(){const e=this.table.players[g.BOTTOM].hand.dupHand();if(e.getLength()===13){const s=new R(c.INVALID,x.INVALID);e.insertHidden(s)}const t=this.aiEngine.getTileRecommendations(e);return{recommendations:t.recommendations.reverse(),consideredPatternCount:t.consideredPatternCount}}getAllPlayerTiles(){const e=this.table.players[g.BOTTOM].hand,t=[...e.getHiddenTileArray()];return e.exposedTileSetArray.forEach(s=>{t.push(...s.tileArray)}),t}getHiddenPlayerTiles(){return this.table.players[g.BOTTOM].hand.getHiddenTileArray()}updateHintsForNewTiles(){if(!this.isHintPanelExpanded()){this.updateHintDisplayOnly();return}const e=this.getRecommendations(),t=this.table.players[g.BOTTOM].hand.dupHand();t.getLength()===13&&t.insertHidden(new R(c.INVALID,x.INVALID));const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s),this.applyGlowToDiscardSuggestions(e.recommendations),this.updateHintDisplay(s,e.recommendations,e.consideredPatternCount)}updateHintDisplayOnly(){const e=this.getRecommendations(),t=this.table.players[g.BOTTOM].hand.dupHand();t.getLength()===13&&t.insertHidden(new R(c.INVALID,x.INVALID));const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s),this.updateHintDisplay(s,e.recommendations,e.consideredPatternCount)}updateHintDisplay(e,t,s){let n="<h3>Top Possible Hands:</h3>";const i=this.getAllPlayerTiles(),a=this.getHiddenPlayerTiles();for(let d=0;d<Math.min(3,e.length);d++){const h=e[d],m=d===0||d<s,f=m?"":"opacity: 0.4;";n+=`<p style="${f}"><strong>${h.group.groupDescription}</strong> - ${h.hand.description} (Rank: ${h.rank.toFixed(2)})`,!m&&d>0&&(n+=" <em>(not considered)</em>"),n+="</p>";const u=he(h,i,a);n+=`<div style="${f}">${u}</div>`}n+="<h3>Discard Suggestions (Best to Discard First):</h3>";const o=t.filter(d=>d.tile.suit!==c.INVALID&&d.recommendation==="DISCARD"),r=o.length;for(let d=0;d<r;d++){const h=o[d];n+=`<p>${h.tile.getText()}</p>`}X(n)}}const me="/mahjong/assets/tiles-imJ8iwem.png",ge=[{filename:"1B.png",frame:{x:0,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"1C.png",frame:{x:52,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"1D.png",frame:{x:104,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2B.png",frame:{x:156,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2C.png",frame:{x:208,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"2D.png",frame:{x:260,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3B.png",frame:{x:312,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3C.png",frame:{x:364,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"3D.png",frame:{x:416,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4B.png",frame:{x:468,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4C.png",frame:{x:520,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"4D.png",frame:{x:572,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5B.png",frame:{x:624,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5C.png",frame:{x:676,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"5D.png",frame:{x:728,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6B.png",frame:{x:780,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6C.png",frame:{x:832,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"6D.png",frame:{x:884,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7B.png",frame:{x:936,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7C.png",frame:{x:988,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"7D.png",frame:{x:1040,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8B.png",frame:{x:1092,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8C.png",frame:{x:1144,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"8D.png",frame:{x:1196,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9B.png",frame:{x:1248,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9C.png",frame:{x:1300,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"9D.png",frame:{x:1352,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DB.png",frame:{x:1404,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DC.png",frame:{x:1456,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"DD.png",frame:{x:1508,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"E.png",frame:{x:1560,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F1.png",frame:{x:1612,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F2.png",frame:{x:1664,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F3.png",frame:{x:1716,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"F4.png",frame:{x:1768,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"J.png",frame:{x:1820,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"N.png",frame:{x:1872,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"S.png",frame:{x:1924,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}},{filename:"W.png",frame:{x:1976,y:0,w:52,h:69},rotated:!1,trimmed:!1,spriteSourceSize:{x:0,y:0,w:52,h:69},sourceSize:{w:52,h:69}}],fe={app:"https://www.codeandweb.com/texturepacker",version:"1.0",image:"tiles.png",format:"RGBA8888",size:{w:2028,h:69},scale:"1",smartupdate:"$TexturePacker:SmartUpdate:baa73215de891ffd3d2987c3955d687c:7fb101c424dd8f5d293fdd929aadebef:accbe1e7e294ded8391337fc1c446319$"},pe={frames:ge,meta:fe},ye="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAADQAAABFCAYAAAAFBsWPAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAAadEVYdFNvZnR3YXJlAFBhaW50Lk5FVCB2My41LjEwMPRyoQAAAJBJREFUaEPt27ENgCAUBmFwGhNqo8Nq4zKiTiOxx4YhTnJf9ed1N8CL+7bWMaXQg/cpIV75qNO8tNO/3WcOQ9vdMIjOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6AyiM4jOIDqD6Ayi6y6osx+8Ej5OSBM+UQfkQgAAAABJRU5ErkJggg==";class be extends p.Scene{constructor(){super({key:"GameScene"}),this.commandBarManualPosition=!1,this.commandBarPosition=null,this.homePageTileManager=null}preload(){this.load.atlas("tiles",me,pe),this.load.image("back",ye);const e=document.createElement("canvas");e.width=4,e.height=4;const t=e.getContext("2d");t&&(t.fillStyle="white",t.fillRect(0,0,4,4)),this.textures.addCanvas("particle",e),this.load.audio("bgm","./assets/audio/2406haidao_bgm_loop.mp3"),this.load.audio("rack_tile","./assets/audio/rack_tile.mp3"),this.load.audio("tile_dropping","./assets/audio/tile_dropping.mp3"),this.load.audio("fireworks","./assets/audio/fireworks.mp3")}async create(){this.input.dragDistanceThreshold=20,this.scale.on("resize",this.resize,this),this.audioManager=new se(this,window.settingsManager),this.gTable=new ee(this),this.gameController=new K,await this.gameController.init({sharedTable:this.gTable,settings:{year:window.settingsManager.getCardYear(),difficulty:window.settingsManager.getDifficulty(),useBlankTiles:window.settingsManager.getUseBlankTiles(),skipCharleston:window.settingsManager.getSetting("skipCharleston",!1)}}),this.hintAnimationManager=new ue(this,this.gTable,this.gameController.aiEngine,this.gameController.cardValidator);for(let t=0;t<this.gTable.players.length;t++){this.gTable.players[t].hand.table=this.gTable,this.gTable.players[t].hand.hiddenTileSet.table=this.gTable;for(const s of this.gTable.players[t].hand.exposedTileSetArray)s.table=this.gTable}this.adapter=new le(this.gameController,this,this.gTable),window.gameController=this.gameController,this.wallCounter=this.createWallTileCounter(),this.errorText=this.add.text(400,400,"",{font:"14px Arial",fill:"#ff8080",backgroundColor:"rgba(0,0,0,1)",align:"left"}),this.errorText.visible=!1,this.gTable.create(!0),this.homePageTileManager=new te(this,this.gTable.wall),this.homePageTileManager.createScatteredTiles(),this.enableCommandBarDrag(),this.resize(this.sys.game.canvas.width,this.sys.game.canvas.height);const e=document.getElementById("start");e&&e.addEventListener("click",async()=>{e.style.display="none";const t=document.getElementById("uicenterdiv");t&&(t.style.display="flex"),this.homePageTileManager?(this.homePageTileManager.onAnimationComplete=async()=>{await this.homePageTileManager.transitionToWallSystem(),this.homePageTileManager.cleanup(),this.homePageTileManager=null,await this.gameController.startGame()},this.homePageTileManager.animateToPileAndStartGame()):await this.gameController.startGame()})}createWallTileCounter(){const e=this.add.container(C/2-150,160),t=this.add.graphics();t.fillStyle(2763306,1),t.fillRoundedRect(0,0,300,20,5);const s=this.add.graphics(),n=Y(),i=this.add.text(150,10,"Wall Tiles Remaining: "+n,{fontFamily:"Arial, sans-serif",fontSize:"16px",fontStyle:"bold",color:"#ffffff",stroke:"#000000",strokeThickness:4});return i.setOrigin(.5,.5),i.setResolution(2),e.add([t,s,i]),e.setVisible(!1),e.setDepth(100),{bar:e,fill:s,text:i,maxTiles:n}}updateWallTileCounter(e){if(!this.wallCounter)return;const{bar:t,fill:s,text:n,maxTiles:i}=this.wallCounter;s.clear(),(e<0||e>i)&&(console.error("Invalid wall count:",e),e=Math.max(0,Math.min(e,i))),s.fillStyle(4886754,1);const a=e/i*300;s.fillRoundedRect(0,0,a,20,5),n.setText(`Wall Tiles Remaining: ${e}`),t.setVisible(!0)}update(){}getDragBounds(){const e=document.getElementById("parentdiv");return e?e.getBoundingClientRect():this.sys.canvas.getBoundingClientRect()}getClampedCommandBarPosition(e,t,s,n){const a=s.getBoundingClientRect(),o=(a.width||s.offsetWidth||0)/2,r=a.height||s.offsetHeight||0;let d=n.left+o+16,h=n.right-o-16;if(d>h){const y=n.left+n.width/2;d=y,h=y}let m=n.top+16,f=n.bottom-r-16;if(m>f){const y=n.top+n.height/2;m=y,f=y}const u=Math.min(Math.max(e,d),h),b=Math.min(Math.max(t,m),f);return{left:u,top:b}}getDefaultCommandBarPosition(e,t,s){const n=e.offsetWidth||0,i=e.offsetHeight||0,a=t.right-n/2-36,o=t.bottom-i-110;return this.getClampedCommandBarPosition(a,o,e,s)}enableCommandBarDrag(){const e=document.getElementById("uicenterdiv"),t=this.sys.canvas;if(!e||!t)return;const s=document.documentElement.style;let n=!1,i=0,a=0;const o=h=>{if(!n)return;const m=this.getDragBounds(),f=e.getBoundingClientRect(),u=h.clientX-i+(f.width||e.offsetWidth||0)/2,b=h.clientY-a,{left:y,top:S}=this.getClampedCommandBarPosition(u,b,e,m);s.setProperty("--command-bar-left",`${y}px`),s.setProperty("--command-bar-top",`${S}px`),this.commandBarPosition={left:y,top:S},this.commandBarManualPosition=!0},r=h=>{if(n){n=!1,e.classList.remove("command-bar--dragging");try{e.releasePointerCapture(h.pointerId)}catch{}window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),window.removeEventListener("pointercancel",r)}},d=h=>{if(h.button!==0||h.target.closest("#buttondiv"))return;const m=e.getBoundingClientRect();i=h.clientX-m.left,a=h.clientY-m.top,n=!0,e.classList.add("command-bar--dragging");try{e.setPointerCapture(h.pointerId)}catch{}window.addEventListener("pointermove",o),window.addEventListener("pointerup",r),window.addEventListener("pointercancel",r),h.preventDefault()};e.addEventListener("pointerdown",d),this.events.once(p.Scenes.Events.SHUTDOWN,()=>{e.removeEventListener("pointerdown",d),window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),window.removeEventListener("pointercancel",r)})}resize(e,t,s,n){const i=document.getElementById("uicenterdiv"),a=this.sys.canvas;if(!i||!a)return;const o=a.getBoundingClientRect(),r=this.getDragBounds(),d=document.documentElement.style;if(this.commandBarManualPosition&&this.commandBarPosition){const{left:f,top:u}=this.getClampedCommandBarPosition(this.commandBarPosition.left,this.commandBarPosition.top,i,r);this.commandBarPosition={left:f,top:u},d.setProperty("--command-bar-left",`${f}px`),d.setProperty("--command-bar-top",`${u}px`);return}const{left:h,top:m}=this.getDefaultCommandBarPosition(i,o,r);this.commandBarPosition={left:h,top:m},d.setProperty("--command-bar-left",`${h}px`),d.setProperty("--command-bar-top",`${m}px`)}createFireworksDisplay(e){return new Promise(t=>{if(!e.mahjong||e.winner!==0){t();return}const s=this.sys.game.canvas.width,n=this.sys.game.canvas.height,i=p.Math.Between(5,7),a=[];try{for(let r=0;r<i;r++){const d=p.Math.Between(100,s-100),h=p.Math.Between(100,n-200),m=this.add.particles(d,h,"particle",{speed:{min:200,max:400},angle:{min:0,max:360},lifespan:{min:1200,max:1800},gravityY:300,scale:{start:.8,end:0},alpha:{start:1,end:0},tint:[16773222,6737151,16737988,65382,16737792,13395711],blendMode:"ADD"});m.setDepth(300),a.push(m),this.time.delayedCall(r*300,()=>{const f=p.Math.Between(15,25);m.emitParticleAt(d,h,f)})}const o=(i-1)*300+2e3;this.time.delayedCall(o,()=>{a.forEach(r=>r.destroy()),t()})}catch(o){console.warn("[GameScene] Fireworks display failed:",o),a.forEach(r=>{try{r.destroy()}catch{}}),t()}})}}const we=window.location.search.includes("playwright=true")||window.navigator.userAgent.includes("Playwright"),Se={type:we?p.CANVAS:p.AUTO,width:C,height:M,transparent:!0,hideBanner:!0,parent:"gamediv",scene:[be],scale:{mode:p.Scale.FIT,autoCenter:p.Scale.CENTER_BOTH},render:{antialias:!0,mipmapFilter:"LINEAR_MIPMAP_LINEAR",powerPreference:"high-performance"}},Te=new p.Game(Se);window.game=Te;
