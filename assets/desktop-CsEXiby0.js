import{d as H,S as u,g as N,p as M,a as C,W as D,b as E,c as I,e as v,P as d,f as A,T as G,h as P,U as $,i as S,j as b,k as V,B as J,V as K,r as Q,l as Z,C as ee,A as te,G as ie}from"./card-B3T6KEcQ.js";import{W as ne,D as se,g as ae,T as W,p}from"./gameObjects-BPit_JIc.js";class oe{constructor(){this.overlay=document.getElementById("settings-overlay"),this.saveButton=document.getElementById("settings-save"),this.cancelButton=document.getElementById("settings-cancel"),this.settingsButton=document.getElementById("settings"),this.originalSettings={},u.isAvailable()||console.error("[DesktopSettings] localStorage is not available!"),this.init(),this.loadSettings()}init(){this.settingsButton.addEventListener("click",()=>{this.showSettings()}),this.saveButton.addEventListener("click",()=>{this.saveAndClose()}),this.cancelButton.addEventListener("click",()=>{this.cancelAndClose()}),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.cancelAndClose()}),document.addEventListener("keydown",t=>{t.key==="Escape"&&this.overlay.style.display!=="none"&&this.cancelAndClose()});const e=document.getElementById("trainCheckbox");e&&e.addEventListener("change",()=>{this.updateTrainingFormVisibility()}),this.setupAudioControls()}showSettings(){this.loadSettings(),this.overlay.style.display="flex",this.storeCurrentSettingsState(),this.saveButton.focus()}hideSettings(){this.overlay.style.display="none",this.settingsButton.focus()}storeCurrentSettingsState(){var e,t,i,n,s,a,o,r,l,c;this.originalSettings={trainingMode:((e=document.getElementById("trainCheckbox"))==null?void 0:e.checked)??u.getDefault("trainingMode"),trainingHand:((t=document.getElementById("handSelect"))==null?void 0:t.value)??u.getDefault("trainingHand"),trainingTileCount:((i=document.getElementById("numTileSelect"))==null?void 0:i.value)??u.getDefault("trainingTileCount").toString(),skipCharleston:((n=document.getElementById("skipCharlestonCheckbox"))==null?void 0:n.checked)??u.getDefault("skipCharleston"),cardYear:((s=document.getElementById("yearSelect"))==null?void 0:s.value)??u.getDefault("cardYear").toString(),useBlankTiles:((a=document.getElementById("useBlankTiles"))==null?void 0:a.checked)??u.getDefault("useBlankTiles"),bgmVolume:((o=document.getElementById("bgmVolume"))==null?void 0:o.value)??u.getDefault("bgmVolume").toString(),bgmMuted:((r=document.getElementById("bgmMute"))==null?void 0:r.checked)??u.getDefault("bgmMuted"),sfxVolume:((l=document.getElementById("sfxVolume"))==null?void 0:l.value)??u.getDefault("sfxVolume").toString(),sfxMuted:((c=document.getElementById("sfxMute"))==null?void 0:c.checked)??u.getDefault("sfxMuted")}}restoreOriginalSettings(){const e=document.getElementById("trainCheckbox"),t=document.getElementById("handSelect"),i=document.getElementById("numTileSelect"),n=document.getElementById("skipCharlestonCheckbox"),s=document.getElementById("yearSelect"),a=document.getElementById("useBlankTiles"),o=document.getElementById("bgmVolume"),r=document.getElementById("bgmVolumeValue"),l=document.getElementById("bgmMute"),c=document.getElementById("sfxVolume"),h=document.getElementById("sfxVolumeValue"),g=document.getElementById("sfxMute");e&&(e.checked=this.originalSettings.trainingMode),t&&(t.value=this.originalSettings.trainingHand),i&&(i.value=this.originalSettings.trainingTileCount),n&&(n.checked=this.originalSettings.skipCharleston),s&&(s.value=this.originalSettings.cardYear),a&&(a.checked=this.originalSettings.useBlankTiles),o&&(o.value=this.originalSettings.bgmVolume,r&&(r.textContent=`${this.originalSettings.bgmVolume}%`)),l&&(l.checked=this.originalSettings.bgmMuted),c&&(c.value=this.originalSettings.sfxVolume,h&&(h.textContent=`${this.originalSettings.sfxVolume}%`)),g&&(g.checked=this.originalSettings.sfxMuted),this.updateTrainingFormVisibility()}saveAndClose(){var s;const e=Number(this.getSetting("cardYear",u.getDefault("cardYear"))),t=parseInt(((s=document.getElementById("yearSelect"))==null?void 0:s.value)??u.getDefault("cardYear").toString(),10),i=e!==t;this.saveGameSettings(),this.saveTrainingSettings(),this.saveDifficultySettings(),this.saveYearSettings(),this.saveHouseRuleSettings(),this.saveAudioSettings();const n=u.load();if(window.dispatchEvent(new window.CustomEvent("settingsChanged",{detail:{...n,source:"desktop"}})),i&&window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const a=window.game.scene.getScene("GameScene");if(a.gGameLogic){const o=document.getElementById("handSelect");o&&(o.innerHTML=""),a.gGameLogic.init().then(()=>{})}}this.hideSettings()}cancelAndClose(){this.restoreOriginalSettings(),this.hideSettings()}getDifficulty(){return this.getSetting("difficulty","medium")}getCardYear(){return this.getSetting("cardYear","2025")}saveSetting(e,t){try{u.set(e,t)}catch(i){console.warn("Failed to save setting:",i)}}getSetting(e,t=null){return u.get(e)??t}getAllSettings(){return u.load()}loadSettings(){const e=u.load();this.applyGameSettings(e),this.applyTrainingSettings(e),this.applyDifficultySettings(e),this.applyYearSettings(e),this.applyHouseRuleSettings(e),this.applyAudioSettings(e)}applyGameSettings(e){const t=document.getElementById("skipCharlestonCheckbox");t&&Object.prototype.hasOwnProperty.call(e,"skipCharleston")&&(t.checked=e.skipCharleston)}applyTrainingSettings(e){const t=document.getElementById("trainCheckbox"),i=document.getElementById("handSelect"),n=document.getElementById("numTileSelect");t&&Object.prototype.hasOwnProperty.call(e,"trainingMode")&&(t.checked=e.trainingMode),i&&e.trainingHand&&(i.value=e.trainingHand),n&&e.trainingTileCount&&(n.value=e.trainingTileCount.toString()),this.updateTrainingFormVisibility()}applyDifficultySettings(e){const t=document.getElementById("difficultySelect");t&&e.difficulty&&(t.value=e.difficulty)}applyYearSettings(e){const t=document.getElementById("yearSelect");t&&e.cardYear&&(t.value=e.cardYear)}updateTrainingFormVisibility(){const e=document.getElementById("trainCheckbox"),t=document.getElementById("trainfieldset2");e&&t&&(t.disabled=!e.checked)}saveGameSettings(){var t;const e={};e.skipCharleston=((t=document.getElementById("skipCharlestonCheckbox"))==null?void 0:t.checked)??u.getDefault("skipCharleston"),u.save(e)}saveTrainingSettings(){var t,i,n;const e={};e.trainingMode=((t=document.getElementById("trainCheckbox"))==null?void 0:t.checked)??u.getDefault("trainingMode"),e.trainingHand=((i=document.getElementById("handSelect"))==null?void 0:i.value)??u.getDefault("trainingHand"),e.trainingTileCount=parseInt(((n=document.getElementById("numTileSelect"))==null?void 0:n.value)??u.getDefault("trainingTileCount").toString(),10),u.save(e)}saveDifficultySettings(){var t;const e={};e.difficulty=((t=document.getElementById("difficultySelect"))==null?void 0:t.value)??u.getDefault("difficulty"),u.save(e)}saveYearSettings(){var t;const e={};e.cardYear=parseInt(((t=document.getElementById("yearSelect"))==null?void 0:t.value)??u.getDefault("cardYear").toString(),10),u.save(e)}saveHouseRuleSettings(){var t;const e={};e.useBlankTiles=((t=document.getElementById("useBlankTiles"))==null?void 0:t.checked)??u.getDefault("useBlankTiles"),u.save(e)}saveAudioSettings(){var t,i,n,s;const e={};e.bgmVolume=parseInt(((t=document.getElementById("bgmVolume"))==null?void 0:t.value)??u.getDefault("bgmVolume").toString(),10),e.bgmMuted=((i=document.getElementById("bgmMute"))==null?void 0:i.checked)??u.getDefault("bgmMuted"),e.sfxVolume=parseInt(((n=document.getElementById("sfxVolume"))==null?void 0:n.value)??u.getDefault("sfxVolume").toString(),10),e.sfxMuted=((s=document.getElementById("sfxMute"))==null?void 0:s.checked)??u.getDefault("sfxMuted"),u.save(e)}applyHouseRuleSettings(e){const t=document.getElementById("useBlankTiles");t&&Object.prototype.hasOwnProperty.call(e,"useBlankTiles")&&(t.checked=e.useBlankTiles)}applyAudioSettings(e){const t=document.getElementById("bgmVolume"),i=document.getElementById("bgmVolumeValue"),n=document.getElementById("bgmMute"),s=document.getElementById("sfxVolume"),a=document.getElementById("sfxVolumeValue"),o=document.getElementById("sfxMute");if(t){const r=e.bgmVolume??u.getDefault("bgmVolume");t.value=r,i&&(i.textContent=`${r}%`)}if(n&&(n.checked=e.bgmMuted??u.getDefault("bgmMuted")),s){const r=e.sfxVolume??u.getDefault("sfxVolume");s.value=r,a&&(a.textContent=`${r}%`)}o&&(o.checked=e.sfxMuted??u.getDefault("sfxMuted"))}getUseBlankTiles(){return u.get("useBlankTiles")}setupAudioControls(){const e=document.getElementById("bgmVolume"),t=document.getElementById("bgmVolumeValue"),i=document.getElementById("bgmMute"),n=document.getElementById("sfxVolume"),s=document.getElementById("sfxVolumeValue"),a=document.getElementById("sfxMute");e&&e.addEventListener("input",o=>{const r=parseInt(o.target.value,10)/100;t&&(t.textContent=`${o.target.value}%`),this.updateAudioManager("bgmVolume",r)}),i&&i.addEventListener("change",o=>{const r=o.target.checked;this.updateAudioManager("bgmMuted",r)}),n&&n.addEventListener("input",o=>{const r=parseInt(o.target.value,10)/100;s&&(s.textContent=`${o.target.value}%`),this.updateAudioManager("sfxVolume",r)}),a&&a.addEventListener("change",o=>{const r=o.target.checked;this.updateAudioManager("sfxMuted",r)})}updateAudioManager(e,t){if(window.game&&window.game.scene&&window.game.scene.getScene("GameScene")){const i=window.game.scene.getScene("GameScene");if(H("GameScene found, audioManager exists:",!!i.audioManager),i.audioManager)switch(e){case"bgmVolume":i.audioManager.setBGMVolume(t);break;case"bgmMuted":i.audioManager.muteBGM(t);break;case"sfxVolume":i.audioManager.setSFXVolume(t);break;case"sfxMuted":i.audioManager.muteSFX(t);break}}}registerSettingSection(e,t){}}document.addEventListener("DOMContentLoaded",()=>{window.settingsManager=new oe;const m=document.getElementById("controldiv"),e=document.getElementById("uicenterdiv");m&&(m.style.visibility="visible"),e&&(e.style.display="none"),window.addEventListener("settingsChanged",t=>{const i=t.detail;if(t.detail.source!=="desktop"&&(window.settingsManager&&window.settingsManager.overlay.style.display!=="none"&&window.settingsManager.loadSettings(),window.game&&window.game.scene&&window.game.scene.getScene("GameScene"))){const n=window.game.scene.getScene("GameScene");if(n.gGameLogic){const s=window.settingsManager.getCardYear();i.cardYear&&s!==i.cardYear&&n.gGameLogic.init().then(()=>{H(`Card year updated to ${i.cardYear}`)})}}})});class re{constructor(e){this.scene=e,this.gameLogic=null,this.wall=new ne(e),this.discards=new se,this.boxes=[];for(let t=0;t<4;t++)this.boxes[t]=null;this.player02CourtesyVote=0,this.player13CourtesyVote=0}create(e=!1){for(let t=0;t<4;t++){const i=this.scene.add.graphics(0,0);this.boxes[t]=i}this.wall.create(e)}reset(){for(;this.discards.tileArray.length;)this.wall.insert(this.discards.tileArray.pop());const e=N();this.wall.tileArray.length!==e&&M("ERROR - table.reset() - total tile count is not "+e+". Tile count = "+this.wall.tileArray.length+`
`)}switchPlayer(e){for(let t=0;t<4;t++)this.boxes[t].visible=!1;this.boxes[e].visible=!0}}class le{constructor(e,t){this.scene=e,this.wall=t,this.tileArray=[],this.animationState="idle",this.isAnimating=!1,this.onAnimationComplete=null}createScatteredTiles(){const e=window.settingsManager?window.settingsManager.getUseBlankTiles():!1;let t=0;for(const i of ae)if(!(i.suit===C.BLANK&&!e))for(const n of i.prefix)for(let s=1;s<=i.maxNum;s++){let a=s;i.maxNum===1&&(i.suit===C.FLOWER?a=0:a=i.prefix.indexOf(n));let o=n;i.maxNum!==1&&(o=s+o),o+=".png";for(let r=0;r<i.count;r++){const l=new W(this.scene,i.suit,a,o);l.create(),l.index=t++,this.tileArray.push(l)}}for(let i=0;i<this.tileArray.length;i++){const n=this.tileArray[i],{x:s,y:a,scale:o,angle:r}=this.generateRandomPosition();n.x=s,n.y=a,n.scale=o,n.angle=r,n.sprite.setDepth(i),n.showTile(!0,!1),Math.random()<.7&&n.showTile(!0,!0)}}generateRandomPosition(){const e=this.scene.sys.game.config.width/2,t=this.scene.sys.game.config.height/2,i=200,n=100;let s=0,a=0;for(;s===0;)s=Math.random();for(;a===0;)a=Math.random();let o=Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*a);const r=e+o*i;for(s=0,a=0;s===0;)s=Math.random();for(;a===0;)a=Math.random();o=Math.sqrt(-2*Math.log(s))*Math.cos(2*Math.PI*a);const l=t+o*n,c=p.Math.FloatBetween(.55,.65),h=p.Math.Between(-90,90);return{x:r,y:l,scale:c,angle:h}}async animateToPileAndStartGame(){this.isAnimating=!0,this.animationState="gathering",await this.animateJumpAndFlip(),await this.animateFlyOffScreen(),this.isAnimating=!1,this.animationState="complete",this.onAnimationComplete&&this.onAnimationComplete()}animateJumpAndFlip(){const e=[];return this.tileArray.forEach(t=>{e.push(new Promise(i=>{const n=t.y,s=p.Math.Between(5,15),a=p.Math.Between(0,75);t.withRaisedDepth(()=>{const o=this.scene.tweens.add({targets:{},duration:400+a,onComplete:()=>{}});return this.scene.tweens.add({targets:t,y:n-s,scale:.65,duration:200,ease:p.Math.Easing.Cubic.Out,delay:a}),this.scene.tweens.add({targets:t,y:n,scale:.6,duration:200,ease:p.Math.Easing.Cubic.In,delay:a+200}),o}),this.scene.tweens.add({targets:{scaleY:t.sprite.scaleY},scaleY:0,duration:200,ease:p.Math.Easing.Cubic.In,delay:a,onUpdate:o=>{t.sprite.scaleY=o.targets[0].scaleY,t.spriteBack.scaleY=o.targets[0].scaleY},onComplete:()=>{t.showTile(!0,!1),this.scene.tweens.add({targets:{scaleY:0},scaleY:.6,duration:200,ease:p.Math.Easing.Cubic.Out,onUpdate:o=>{t.sprite.scaleY=o.targets[0].scaleY,t.spriteBack.scaleY=o.targets[0].scaleY},onComplete:()=>{i()}})}})}))}),Promise.all(e)}animateFlyOffScreen(){const e=[];for(let n=0;n<this.tileArray.length;n+=20){const s=this.tileArray.slice(n,n+20);e.push(new Promise(a=>{this.scene.time.delayedCall(n/20*75,()=>{const o=s.map(r=>new Promise(l=>{const c=p.Math.Between(600,1e3),h=p.Math.Between(-200,-50),g=p.Math.Between(-200,-50),T=p.Math.Between(r.x-100,r.x+100),w=p.Math.Between(r.y-200,r.y),y=new p.Curves.QuadraticBezier(new p.Math.Vector2(r.x,r.y),new p.Math.Vector2(T,w),new p.Math.Vector2(h,g)),x={t:0,vec:new p.Math.Vector2};this.scene.tweens.add({targets:x,t:1,duration:c,ease:"Cubic.In",onUpdate:()=>{y.getPoint(x.t,x.vec),r.x=x.vec.x,r.y=x.vec.y},onComplete:()=>{r.showTile(!1,!1),l()}})}));Promise.all(o).then(a)})}))}return Promise.all(e)}async transitionToWallSystem(){await this.wall.receiveOrganizedTilesFromHomePage(this.tileArray)}cleanup(){this.tileArray=[]}calculatePlayerHandPositions(){const e=[],i=I*.6,n=v*.6;for(let s=0;s<13;s++)e.push({x:E/2-6.5*i+s*i,y:D-n-10,angle:0});for(let s=0;s<13;s++)e.push({x:E/2-6.5*i+s*i,y:n+10,angle:180});for(let s=0;s<13;s++)e.push({x:n+10,y:D/2-6.5*i+s*i,angle:-90});for(let s=0;s<13;s++)e.push({x:E-n-10,y:D/2-6.5*i+s*i,angle:90});return e}}class ce{constructor(e,t){this.scene=e,this.settingsManager=t,this.bgm=null,this.currentBGMKey=null;const i=this.settingsManager.getSetting("bgmVolume",u.getDefault("bgmVolume")),n=this.settingsManager.getSetting("sfxVolume",u.getDefault("sfxVolume"));this.bgmVolume=i/100,this.bgmMuted=this.settingsManager.getSetting("bgmMuted",u.getDefault("bgmMuted")),this.sfxVolume=n/100,this.sfxMuted=this.settingsManager.getSetting("sfxMuted",u.getDefault("sfxMuted"))}playBGM(e){this.bgm&&this.bgm.isPlaying&&this.bgm.stop(),this.currentBGMKey=e,this.bgm=this.scene.sound.add(e,{loop:!0,volume:this.bgmMuted?0:this.bgmVolume}),this.bgm.play()}stopBGM(){this.bgm&&this.bgm.isPlaying&&this.bgm.stop()}setBGMVolume(e){this.bgmVolume=Math.max(0,Math.min(1,e)),this.bgm&&!this.bgmMuted&&this.bgm.setVolume(this.bgmVolume)}muteBGM(e){this.bgmMuted=e,this.bgm&&this.bgm.setVolume(this.bgmMuted?0:this.bgmVolume)}getBGMVolume(){return this.bgmVolume}isBGMMuted(){return this.bgmMuted}playSFX(e){this.sfxMuted||this.scene.sound.play(e,{volume:this.sfxVolume})}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}muteSFX(e){this.sfxMuted=e}getSFXVolume(){return this.sfxVolume}isSFXMuted(){return this.sfxMuted}destroy(){this.bgm&&(this.bgm.stop(),this.bgm.destroy())}}const R=[{id:d.BOTTOM,x:200,y:600,angle:0,rectX:0,rectY:600-v/2,rectWidth:E,rectHeight:v},{id:d.RIGHT,x:1e3,y:520,angle:270,rectX:1e3-v*A/2,rectY:0,rectWidth:v*A,rectHeight:D},{id:d.TOP,x:750,y:50,angle:180,rectX:0,rectY:50-v*A/2,rectWidth:E,rectHeight:v*A},{id:d.LEFT,x:50,y:50,angle:90,rectX:50-v*A/2,rectY:0,rectWidth:v*A,rectHeight:D}];class de{constructor(e,t,i){this.scene=e,this.wall=t,this.discards=i,this.tileSprites=new Map,this.selectedTiles=new Set,this.onTileSelected=null,this.onTileDeselected=null,this.dragEnabledPlayers=new Set}initializeFromWall(){var t;this.tileSprites.clear();const e=i=>{i&&typeof i.index=="number"&&this.tileSprites.set(i.index,i)};(t=this.wall)!=null&&t.tileArray&&this.wall.tileArray.forEach(e)}getOrCreateTile(e){if(!e||typeof e.index!="number")return null;if(this.tileSprites.has(e.index))return this.tileSprites.get(e.index);const t=this.findTileInWall(e.index);if(t)return this.tileSprites.set(e.index,t),t;const i=this.getTileSpriteName(e),n=new W(this.scene,e.suit,e.number,i);return n.index=e.index,n.create(),this.tileSprites.set(n.index,n),n}removeTileFromWall(e){var n;if(!((n=this.wall)!=null&&n.tileArray))return;const t=this.wall.tileArray,i=t.findIndex(s=>s.index===e);i>=0&&t.splice(i,1)}insertTileIntoHand(e,t){console.error("TileManager.insertTileIntoHand has been removed - use GameController HAND_UPDATED events")}removeTileFromHand(e,t){console.error("TileManager.removeTileFromHand has been removed - use GameController HAND_UPDATED events")}addTileToDiscardPile(e){var o;if(!e||!this.discards)return null;this.discards.insertDiscard(e);const t=this.discards.tileArray.length-1;this.discards.layoutTiles(e);const{x:i,y:n,scale:s}=this.discards.getTilePosition(t);e.scale=s,e.angle=0,e.showTile(!0,!0),e.sprite.depth=50,e.spriteBack.depth=50;const a=e.animate(i,n,0);return a&&((o=this.scene)!=null&&o.audioManager)&&a.once("complete",()=>{this.scene.audioManager.playSFX("tile_dropping")}),a}getTileSprite(e){const t=typeof e=="number"?e:e==null?void 0:e.index;return typeof t!="number"?null:this.tileSprites.get(t)||null}getHandLayout(e,t=14){const n=I*A+G;switch(e){case d.BOTTOM:return{startX:(E-t*n)/2,startY:D-80,spacing:n,direction:"horizontal"};case d.RIGHT:return{startX:E-60,startY:(D-t*n)/2,spacing:n,direction:"vertical"};case d.TOP:return{startX:(E+t*n)/2,startY:60,spacing:n,direction:"horizontal-reverse"};case d.LEFT:return{startX:40,startY:(D+t*n)/2,spacing:n,direction:"vertical-reverse"};default:throw new Error(`Invalid player index: ${e}`)}}getTileScreenPosition(e,t,i=14){const n=this.getHandLayout(e,i);switch(n.direction){case"horizontal":return{x:n.startX+t*n.spacing,y:n.startY};case"horizontal-reverse":return{x:n.startX-t*n.spacing,y:n.startY};case"vertical":return{x:n.startX,y:n.startY+t*n.spacing};case"vertical-reverse":return{x:n.startX,y:n.startY-t*n.spacing};default:return{x:0,y:0}}}getExposurePosition(e){switch(e){case d.BOTTOM:return{x:E-150,y:D-200,direction:"horizontal"};case d.RIGHT:return{x:E-150,y:100,direction:"vertical"};case d.TOP:return{x:150,y:60,direction:"horizontal"};case d.LEFT:return{x:40,y:D-150,direction:"vertical"};default:return{x:0,y:0}}}registerTileSprite(e,t){t&&this.tileSprites.set(e.index,t)}convertTileDataArray(e=[]){return e.map(t=>this.getOrCreateTile(t)).filter(Boolean)}findTileInWall(e){var t;return(t=this.wall)!=null&&t.tileArray&&this.wall.tileArray.find(i=>i.index===e)||null}getTileSpriteName(e){const{suit:t,number:i}=e;return t===C.CRACK?`${i}C.png`:t===C.BAM?`${i}B.png`:t===C.DOT?`${i}D.png`:t===C.WIND?`${["N","S","W","E"][i]||"N"}.png`:t===C.DRAGON?`${["DC","DB","DD"][i]||"DC"}.png`:t===C.FLOWER?`F${i%4+1}.png`:t===C.JOKER?"J.png":t===C.BLANK?"BLANK.png":`tile_${t}_${i}.png`}destroyTileSprite(e){const t=this.tileSprites.get(e.index);t&&(t.destroy(),this.tileSprites.delete(e.index))}updateHandDisplay(e,t){if(!t||t.length===0)return;const i=t.length;t.forEach((n,s)=>{if(n){const a=this.getTileScreenPosition(e,s,i);n.setPosition(a.x,a.y),n.setDepth(s)}})}updateExposuresDisplay(e,t){if(!t||t.length===0)return;const i=this.getExposurePosition(e);let n=i.x,s=i.y;const a=I*A+G;t.forEach(o=>{o&&o.tiles&&o.tiles.length>0&&(o.tiles.forEach((r,l)=>{if(r){let c=n,h=s;i.direction==="horizontal"?c=n+l*a:h=s+l*a,r.setPosition(c,h),r.setDepth(1e3+l)}}),i.direction==="horizontal"?n+=o.tiles.length*a+20:s+=o.tiles.length*a+20)})}selectTile(e){if(!e)return Promise.resolve();const t=this.findTileIndexBySprite(e);if(t===null||this.selectedTiles.has(t))return Promise.resolve();this.selectedTiles.add(t);const n=e.y-30;return new Promise(s=>{this.scene.tweens.add({targets:e,y:n,duration:150,ease:"Quad.easeOut",onComplete:()=>{this.onTileSelected&&this.onTileSelected(e,t),s()}})})}deselectTile(e){if(!e)return Promise.resolve();const t=this.findTileIndexBySprite(e);if(t===null||!this.selectedTiles.has(t))return Promise.resolve();this.selectedTiles.delete(t);const n=e.y+30;return new Promise(s=>{this.scene.tweens.add({targets:e,y:n,duration:150,ease:"Quad.easeOut",onComplete:()=>{this.onTileDeselected&&this.onTileDeselected(e,t),s()}})})}isSelectedTile(e){let t;return typeof e=="number"?t=e:t=this.findTileIndexBySprite(e),t!==null&&this.selectedTiles.has(t)}getSelectedTiles(){const e=[];return this.selectedTiles.forEach(t=>{const i=this.tileSprites.get(t);i&&e.push(i)}),e}getSelectedTileIndices(){return Array.from(this.selectedTiles)}async resetSelection(){const e=[],t=this.getSelectedTiles();for(const i of t)e.push(this.deselectTile(i));await Promise.all(e),this.selectedTiles.clear()}findTileIndexBySprite(e){for(const[t,i]of this.tileSprites)if(i===e)return t;return null}enableTileDragForPlayer(e){this.dragEnabledPlayers.add(e)}disableTileDragForPlayer(e){this.dragEnabledPlayers.delete(e)}sortTiles(e,t){return new Promise(i=>{this.updateHandDisplay(e,t);const n=300,s=[];t.forEach((a,o)=>{if(a){const r=this.getTileScreenPosition(e,o,t.length),l=new Promise(c=>{this.scene.tweens.add({targets:a,x:r.x,y:r.y,duration:n,ease:"Quad.easeOut",onComplete:c})});s.push(l)}}),Promise.all(s).then(i)})}highlightTile(e,t=16776960){e&&e.setTint(t)}unhighlightTile(e){e&&e.clearTint()}clearHighlights(){this.tileSprites.forEach(e=>{e.clearTint()})}getTileAtHandPosition(e,t){return console.error("TileManager.getTileAtHandPosition has been removed - use HandRenderer with HandData"),null}disableAllInteraction(){this.dragEnabledPlayers.clear(),this.tileSprites.forEach(e=>{e.setInteractive&&e.disableInteractive()})}enableAllInteraction(){}}class he{constructor(e,t,i=null){this.scene=e,this.gameController=t,this.selectionManager=i,this.buttons={button1:document.getElementById("button1"),button2:document.getElementById("button2"),button3:document.getElementById("button3"),button4:document.getElementById("button4"),start:document.getElementById("start"),settings:document.getElementById("settings"),sort1:document.getElementById("sort1"),sort2:document.getElementById("sort2")},this.buttonCallbacks=new Map,this.currentState=P.INIT,this.sortButtonsPinned=!1,this.setupButtonListeners()}setupButtonListeners(){this._domListeners=new Map,Object.entries(this.buttons).forEach(([e,t])=>{if(t){const i=()=>this.onButtonClicked(e);t.addEventListener("click",i),this._domListeners.set(e,{element:t,handler:i})}})}onButtonClicked(e){const t=this.buttonCallbacks.get(e);t&&typeof t=="function"&&t()}updateForState(e){switch(this.currentState=e,this.clearAllCallbacks(),e){case P.INIT:case P.START:this.showStartButtons();break;case P.DEAL:this.showDealButtons();break;case P.CHARLESTON1:this.showCharlestonPassButtons();break;case P.CHARLESTON_QUERY:this.showCharlestonContinueButtons();break;case P.CHARLESTON2:this.showCharlestonPassButtons();break;case P.COURTESY_QUERY:this.showCourtesyVoteButtons();break;case P.COURTESY:this.showCourtesyPassButtons();break;case P.LOOP_PICK_FROM_WALL:this.showWallPickButtons();break;case P.LOOP_CHOOSE_DISCARD:this.showDiscardChoiceButtons();break;case P.LOOP_QUERY_CLAIM_DISCARD:this.showClaimButtons();break;case P.LOOP_EXPOSE_TILES:this.showExposureButtons();break;case P.END:this.showGameEndButtons();break;default:this.hideAllGameButtons()}}showStartButtons(){this.show(["start","settings"]),this.hide(["button1","button2","button3","button4","sort1","sort2"]),this.buttonCallbacks.set("start",()=>{this.gameController.startGame()}),this.buttonCallbacks.set("settings",()=>{})}showDealButtons(){this.show(["sort1","sort2"]),this.hide(["start","settings","button1","button2","button3","button4"]),this.buttonCallbacks.set("sort1",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("suit")}),this.buttonCallbacks.set("sort2",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("rank")})}showCharlestonPassButtons(){this.show(["button1","sort1","sort2"]),this.hide(["button2","button3","button4","start","settings"]),this.setText("button1","Pass Tiles"),this.setDisabled("button1",!0),this.buttonCallbacks.set("button1",()=>{this.selectionManager&&this.gameController.onCharlestonPass&&this.selectionManager.getSelection().length===3&&this.gameController.onCharlestonPass()}),this.buttonCallbacks.set("sort1",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("suit")}),this.buttonCallbacks.set("sort2",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("rank")})}showCharlestonContinueButtons(){this.show(["button1","button2"]),this.hide(["button3","button4","start","settings","sort1","sort2"]),this.setText("button1","No"),this.setText("button2","Yes"),this.setDisabled("button1",!1),this.setDisabled("button2",!1),this.buttonCallbacks.set("button1",()=>{this.gameController.onCharlestonContinueQuery&&this.gameController.onCharlestonContinueQuery(!1)}),this.buttonCallbacks.set("button2",()=>{this.gameController.onCharlestonContinueQuery&&this.gameController.onCharlestonContinueQuery(!0)})}showCourtesyVoteButtons(){this.show(["button1","button2","button3","button4"]),this.hide(["start","settings","sort1","sort2"]),this.setText("button1","0 Tiles"),this.setText("button2","1 Tile"),this.setText("button3","2 Tiles"),this.setText("button4","3 Tiles"),this.buttonCallbacks.set("button1",()=>{this.gameController.onCourtesyVote&&this.gameController.onCourtesyVote(0)}),this.buttonCallbacks.set("button2",()=>{this.gameController.onCourtesyVote&&this.gameController.onCourtesyVote(1)}),this.buttonCallbacks.set("button3",()=>{this.gameController.onCourtesyVote&&this.gameController.onCourtesyVote(2)}),this.buttonCallbacks.set("button4",()=>{this.gameController.onCourtesyVote&&this.gameController.onCourtesyVote(3)})}showCourtesyPassButtons(){this.show(["button1"]),this.hide(["button2","button3","button4","start","settings","sort1","sort2"]),this.setText("button1","Exchange Tiles"),this.setDisabled("button1",!0),this.buttonCallbacks.set("button1",()=>{this.gameController.onCourtesyPass&&this.gameController.onCourtesyPass()})}showWallPickButtons(){this.hide(["button1","button2","button3","button4","start","settings","sort1","sort2"])}showDiscardChoiceButtons(){this.show(["button1","button2","button3","sort1","sort2"]),this.hide(["button4","start","settings"]),this.setText("button1","Discard"),this.setText("button2","Exchange Joker"),this.setText("button3","Mahjong!"),this.setDisabled("button1",!0),this.setDisabled("button2",!0),this.setDisabled("button3",!0),this.buttonCallbacks.set("button1",()=>{this.gameController.onChooseDiscard&&this.gameController.onChooseDiscard()}),this.buttonCallbacks.set("button2",()=>{this.gameController.onExchangeJoker&&this.gameController.onExchangeJoker()}),this.buttonCallbacks.set("button3",()=>{this.gameController.onMahjong&&this.gameController.onMahjong()}),this.buttonCallbacks.set("sort1",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("suit")}),this.buttonCallbacks.set("sort2",()=>{this.gameController.onSortHandRequest&&this.gameController.onSortHandRequest("rank")})}showClaimButtons(){this.show(["button1","button2","button3","button4"]),this.hide(["start","settings","sort1","sort2"]),this.setText("button1","Mahjong"),this.setText("button2","Pung"),this.setText("button3","Kong"),this.setText("button4","Pass"),this.buttonCallbacks.set("button1",()=>{this.gameController.onClaimDiscard&&this.gameController.onClaimDiscard("Mahjong")}),this.buttonCallbacks.set("button2",()=>{this.gameController.onClaimDiscard&&this.gameController.onClaimDiscard("Pung")}),this.buttonCallbacks.set("button3",()=>{this.gameController.onClaimDiscard&&this.gameController.onClaimDiscard("Kong")}),this.buttonCallbacks.set("button4",()=>{this.gameController.onClaimDiscard&&this.gameController.onClaimDiscard("Pass")})}showExposureButtons(){this.show(["button1","button2"]),this.hide(["button3","button4","start","settings","sort1","sort2"]),this.setText("button1","Select Exposure"),this.setText("button2","Skip"),this.buttonCallbacks.set("button1",()=>{this.gameController.onExposeTiles&&this.gameController.onExposeTiles()}),this.buttonCallbacks.set("button2",()=>{this.gameController.onSkipExposure&&this.gameController.onSkipExposure()})}showGameEndButtons(){this.show(["button1","start"]),this.hide(["button2","button3","button4","settings","sort1","sort2"]),this.setText("button1","View Results"),this.setText("start","Start New Game"),this.buttonCallbacks.set("button1",()=>{}),this.buttonCallbacks.set("start",()=>{this.gameController.startGame()})}show(e){e.forEach(t=>{this.buttons[t]&&(this.buttons[t].style.display="block",this.buttons[t].disabled=!1)})}hide(e){e.forEach(t=>{this.sortButtonsPinned&&(t==="sort1"||t==="sort2")||this.buttons[t]&&(this.buttons[t].style.display="none")})}setText(e,t){this.buttons[e]&&(this.buttons[e].textContent=t)}setDisabled(e,t){this.buttons[e]&&(this.buttons[e].disabled=t)}hideAllGameButtons(){this.hide(["button1","button2","button3","button4","sort1","sort2"])}clearAllCallbacks(){this.buttonCallbacks.clear()}destroy(){this._domListeners&&(this._domListeners.forEach(({element:e,handler:t})=>{try{e.removeEventListener("click",t)}catch{}}),this._domListeners.clear(),this._domListeners=null),this.clearAllCallbacks(),this.buttons={},this.selectionManager=null,this.gameController=null}registerCallback(e,t){typeof t=="function"&&this.buttonCallbacks.set(e,t)}enableButton(e){this.setDisabled(e,!1)}disableButton(e){this.setDisabled(e,!0)}pinSortButtons(){this.sortButtonsPinned=!0,this.show(["sort1","sort2"])}}class ue{constructor(e){this.scene=e,this.dialogOverlay=null,this.pendingCallback=null,this.isOpen=!1}showYesNoDialog(e,t){return new Promise(i=>{this.pendingCallback=t,this.showModalDialog(e,[{label:"No",value:!1},{label:"Yes",value:!0}],n=>{t&&t(n),i(n)})})}showCharlestonPassDialog(e){return new Promise(t=>{this.pendingCallback=e,this.showModalDialog("Select 3 tiles to pass",[{label:"Cancel",value:null},{label:"Pass Selected",value:"pass"}],i=>{e&&e(i),t(i)})})}showCourtesyPassDialog(e=3,t){return new Promise(i=>{this.pendingCallback=t;const n=[{label:"Cancel",value:null},{label:`Exchange ${e} Tiles`,value:e}];this.showModalDialog(`Select up to ${e} tiles to exchange`,n,s=>{t&&t(s),i(s)})})}showSelectTilesDialog(e=1,t=3,i){return new Promise(n=>{this.pendingCallback=i;const s=[{label:"Cancel",value:null},{label:"Confirm Selection",value:"select"}];this.showModalDialog(`Select ${e}â€“${t} tiles`,s,a=>{i&&i(a),n(a)})})}showExposureDialog(e,t){return new Promise(i=>{this.pendingCallback=t;const n=(e||[]).map(s=>({label:s,value:s}));n.push({label:"Cancel",value:null}),this.showModalDialog("Select how to expose these tiles",n,s=>{t&&t(s),i(s)})})}showClaimDialog(e,t){return new Promise(i=>{this.pendingCallback=t;const n=(e||[]).map(s=>({label:s,value:s}));n.push({label:"Pass",value:"pass"}),this.showModalDialog("Claim this discard?",n,s=>{t&&t(s),i(s)})})}showCourtesyVoteDialog(e){return new Promise(t=>{this.pendingCallback=e,this.showModalDialog("How many tiles for courtesy pass?",[{label:"0 Tiles",value:0},{label:"1 Tile",value:1},{label:"2 Tiles",value:2},{label:"3 Tiles",value:3}],i=>{e&&e(i),t(i)})})}showMessageDialog(e,t){return new Promise(i=>{this.showModalDialog(e,[{label:"OK",value:!0}],n=>{t&&t(),i(n)})})}showModalDialog(e,t,i){this.closeDialog(),this.dialogOverlay=document.createElement("div"),this.dialogOverlay.className="dialog-overlay",this.dialogOverlay.style.cssText=`
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        `;const n=document.createElement("div");n.className="dialog-box",n.style.cssText=`
            background: white;
            border-radius: 8px;
            padding: 30px;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            text-align: center;
        `;const s=document.createElement("p");s.textContent=e,s.style.cssText=`
            margin: 0 0 20px 0;
            font-size: 18px;
            color: #333;
        `,n.appendChild(s);const a=document.createElement("div");a.className="dialog-buttons",a.style.cssText=`
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        `,t.forEach(o=>{const r=document.createElement("button");r.textContent=o.label,r.className="dialog-button",r.style.cssText=`
                padding: 10px 20px;
                margin: 5px;
                font-size: 14px;
                border: none;
                border-radius: 4px;
                background: #007bff;
                color: white;
                cursor: pointer;
                transition: background 0.3s;
            `,r.addEventListener("mouseover",()=>{r.style.background="#0056b3"}),r.addEventListener("mouseout",()=>{r.style.background="#007bff"}),r.addEventListener("click",()=>{this.closeDialog(),i&&i(o.value)}),a.appendChild(r)}),n.appendChild(a),this.dialogOverlay.appendChild(n),document.body.appendChild(this.dialogOverlay),this.isOpen=!0,this.scene&&this.scene.input&&(this.scene.input.enabled=!1)}closeDialog(){this.dialogOverlay&&this.dialogOverlay.parentNode&&this.dialogOverlay.parentNode.removeChild(this.dialogOverlay),this.dialogOverlay=null,this.isOpen=!1,this.pendingCallback=null,this.scene&&this.scene.input&&(this.scene.input.enabled=!0)}hasOpenDialog(){return this.isOpen}showError(e){const t=document.createElement("div");return t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        `,t.textContent=e,document.body.appendChild(t),new Promise(i=>{setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),i()},3e3)})}showSuccess(e){const t=document.createElement("div");return t.style.cssText=`
            position: fixed;
            top: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        `,t.textContent=e,document.body.appendChild(t),new Promise(i=>{setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),i()},2e3)})}showNotification(e,t="info",i=3e3){const n={info:"#17a2b8",success:"#28a745",error:"#dc3545",warning:"#ffc107"},s=document.createElement("div");s.style.cssText=`
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: ${n[t]||n.info};
            color: ${t==="warning"?"black":"white"};
            padding: 15px 20px;
            border-radius: 4px;
            z-index: 9999;
            animation: slideUp 0.3s ease-out;
        `,s.textContent=e,document.body.appendChild(s),setTimeout(()=>{s.parentNode&&s.parentNode.removeChild(s)},i)}}class ge{constructor(e,t,i=null){this.handRenderer=e,this.playerIndex=0,this.playerAngle=t,this.buttonManager=i,this.selectedTiles=new Set,this.minCount=1,this.maxCount=3,this.mode=null,this._isEnabled=!1,this._activeButtonId="button1",this.discardTile=null,this.clickHandlers=new Map,this.onSelectionChanged=null}enableTileSelection(e,t,i){this.minCount=e,this.maxCount=t,this.mode=i,this._isEnabled=!0,this.clearSelection(),this._attachClickHandlers(),this._updateButtonState()}disableTileSelection(){this._isEnabled=!1,this.clearSelection(),this._removeClickHandlers(),this.mode=null,this.minCount=1,this.maxCount=3,this.discardTile=null}destroy(){try{this.disableTileSelection()}catch{}this.selectedTiles.clear(),this.clickHandlers.clear(),this.onSelectionChanged=null,this.handRenderer=null,this.buttonManager=null}toggleTile(e){return e.selected?!this.deselectTile(e):(this.maxCount===1&&this.clearSelection(),this.selectTile(e))}selectTile(e){return e.selected?!0:this.getSelectionCount()>=this.maxCount||!this._validateTileForMode(e)?!1:(e.selected=!0,this.selectedTiles.add(e),this.visualizeTile(e,!0),this._updateButtonState(),!0)}deselectTile(e){return e.selected?(e.selected=!1,this.selectedTiles.delete(e),this.visualizeTile(e,!1),this._updateButtonState(),!0):!1}clearSelection(){const e=Array.from(this.selectedTiles);for(const t of e)this.deselectTile(t);this.selectedTiles.clear(),this.unhighlightTiles(),this._updateButtonState()}getSelection(){const e=[],t=this.handRenderer.getHiddenTiles(this.playerIndex);for(const i of t)i.selected&&e.push(i);return e}getSelectionCount(){return this.selectedTiles.size}getSelectedTileIndices(){const e=[],t=this.handRenderer.getHiddenTiles(this.playerIndex);for(let i=0;i<t.length;i++)t[i].selected&&e.push(i);return e}isValidSelection(){const e=this.getSelectionCount();return e>=this.minCount&&e<=this.maxCount}canSelectMore(){return this.getSelectionCount()<this.maxCount}canDeselectMore(){return this.getSelectionCount()>this.minCount}visualizeTile(e,t){const i=this.playerAngle;t?(e.sprite.setDepth(150),e.spriteBack&&e.spriteBack.setDepth(150),e.animate(e.origX,$.TILE_SELECTED_Y,i),e._isVisuallySelected=!0):(e.sprite.setDepth(0),e.spriteBack&&e.spriteBack.setDepth(0),e.animate(e.origX,$.TILE_NORMAL_Y,i),e._isVisuallySelected=!1)}highlightSelectedTiles(){const e=this.getSelection();for(const t of e)this.visualizeTile(t,!0)}unhighlightTiles(){const e=this.handRenderer.getHiddenTiles(this.playerIndex);for(const t of e)(t.selected||t._isVisuallySelected)&&this.visualizeTile(t,!1)}isEnabled(){return this._isEnabled}refreshHandlers(){this._isEnabled&&(this._removeClickHandlers(),this._attachClickHandlers())}getCurrentMode(){return this.mode}requestSelection({min:e,max:t,mode:i,buttonId:n="button1"}){return new Promise(s=>{this._activeButtonId=n,this.enableTileSelection(e,t,i);const a=()=>{const o=this.getSelection();this.isValidSelection()?(this.clearSelection(),this.disableTileSelection(),this.onSelectionChanged=null,s(o)):console.warn(`SelectionManager: Invalid selection. Expected ${e}-${t} tiles, got ${o.length}.`)};this.buttonManager?this.buttonManager.registerCallback(n,a):console.warn(`SelectionManager: No ButtonManager available. Button "${n}" will not be wired.`),this.onSelectionChanged=()=>{var o,r;this.isValidSelection()?(o=this.buttonManager)==null||o.enableButton(n):(r=this.buttonManager)==null||r.disableButton(n)},this.buttonManager&&(this.isValidSelection()?this.buttonManager.enableButton(n):this.buttonManager.disableButton(n))})}_validateTileForMode(e){if(!this.mode)return!1;switch(this.mode){case"charleston":case"courtesy":return!(e.suit===C.JOKER||e.suit===C.BLANK);case"play":return!0;case"expose":return!!(e.suit===C.JOKER||this.discardTile&&e.suit===this.discardTile.suit&&e.number===this.discardTile.number);default:return!1}}_updateButtonState(){const e=this._activeButtonId||"button1";if(this.buttonManager)this.isValidSelection()?this.buttonManager.enableButton(e):this.buttonManager.disableButton(e);else{const t=window.document.getElementById(e);t&&(t.disabled=!this.isValidSelection())}this.onSelectionChanged&&this.onSelectionChanged()}_attachClickHandlers(){const e=this.handRenderer.getHiddenTiles(this.playerIndex);for(const t of e){if(!t){console.warn("[SelectionManager] Null tile in hiddenTiles array");continue}if(!t.sprite){console.warn("[SelectionManager] Tile has no sprite:",t);continue}t.sprite.setInteractive({useHandCursor:!0}),t.sprite.input&&(t.sprite.input.enabled=!0);const i=()=>{this._isEnabled&&(t.drag||this.toggleTile(t))};this.clickHandlers.set(t,i),t.sprite.on("pointerup",i)}}_removeClickHandlers(){for(const[e,t]of this.clickHandlers.entries())e.sprite&&e.sprite.off("pointerup",t);this.clickHandlers.clear()}}class me{constructor({discardPile:e,selectionManager:t,buttonManager:i,gameController:n}){this.discardPile=e,this.selectionManager=t,this.buttonManager=i,this.gameController=n,this.inDiscardPrompt=!1,this.isSelectingDiscard=!1}handleDiscardPromptStart(){this.inDiscardPrompt=!0,this.refreshButton()}handleDiscardPromptEnd(){this.inDiscardPrompt=!1,this.cancelSwapFlow(!1),this.hideSwapButton()}handleHandUpdated(e){e===d.BOTTOM&&this.inDiscardPrompt&&this.refreshButton()}handleDiscardPileChanged(){this.inDiscardPrompt&&this.refreshButton()}handleBlankExchangeEvent(){var e,t,i,n;this.isSelectingDiscard=!1,(t=(e=this.discardPile)==null?void 0:e.disableDiscardSelection)==null||t.call(e),(n=(i=this.selectionManager)==null?void 0:i.clearSelection)==null||n.call(i),this.printDefaultPrompt(),this.refreshButton()}refreshButton(){if(this.buttonManager){if(!this.inDiscardPrompt||!this.isSwapPossible()){this.hideSwapButton();return}this.buttonManager.show(["button4"]),this.buttonManager.setText("button4","Swap Blank"),this.buttonManager.enableButton("button4"),this.buttonManager.registerCallback("button4",()=>this.beginSwapFlow())}}hideSwapButton(){this.buttonManager&&(this.buttonManager.hide(["button4"]),this.buttonManager.registerCallback("button4",()=>{}))}isSwapPossible(){var s,a,o,r,l,c,h;if(!((a=(s=this.gameController)==null?void 0:s.settings)!=null&&a.useBlankTiles))return!1;const e=(l=(r=(o=this.gameController)==null?void 0:o.players)==null?void 0:r[d.BOTTOM])==null?void 0:l.hand,i=((e==null?void 0:e.tiles)||[]).some(g=>g.suit===C.BLANK),n=((h=(c=this.discardPile)==null?void 0:c.getSelectableDiscards)==null?void 0:h.call(c))||[];return i&&n.length>0}beginSwapFlow(){var t,i,n,s,a;if(this.isSelectingDiscard)return;const e=((i=(t=this.selectionManager)==null?void 0:t.getSelection)==null?void 0:i.call(t))||[];if(e.length!==1||e[0].suit!==C.BLANK){S("Select exactly one blank tile before swapping.");return}if(!this.discardPile||(((s=(n=this.discardPile).getSelectableDiscards)==null?void 0:s.call(n))||[]).length===0){S("No discard tiles are available to retrieve.");return}this.isSelectingDiscard=!0,(a=this.buttonManager)==null||a.disableButton("button4"),S("Select a discard tile to retrieve with your blank."),this.discardPile.enableDiscardSelection(o=>{this.discardPile.disableDiscardSelection(),this.isSelectingDiscard=!1,this.commitSwap(e[0],o)})}cancelSwapFlow(e=!0){var t,i;this.isSelectingDiscard&&((i=(t=this.discardPile)==null?void 0:t.disableDiscardSelection)==null||i.call(t),this.isSelectingDiscard=!1),e&&this.printDefaultPrompt()}commitSwap(e,t){var i,n;if(!e||!t){(i=this.buttonManager)==null||i.enableButton("button4"),this.printDefaultPrompt();return}try{const s=b.fromPhaserTile(e),a=b.fromPhaserTile(t);this.gameController.exchangeBlankWithDiscard(s,a)}catch(s){M(`Blank exchange failed: ${s.message}`),(n=this.buttonManager)==null||n.enableButton("button4"),this.printDefaultPrompt()}}printDefaultPrompt(){S("Select a tile to discard.")}destroy(){try{this.cancelSwapFlow(!1)}catch{}this.discardPile=null,this.selectionManager=null,this.buttonManager=null,this.gameController=null}}class pe{constructor(e,t){this.scene=e,this.tileManager=t,this.playerHands=[{hiddenTiles:[],exposedSets:[],rackGraphics:null},{hiddenTiles:[],exposedSets:[],rackGraphics:null},{hiddenTiles:[],exposedSets:[],rackGraphics:null},{hiddenTiles:[],exposedSets:[],rackGraphics:null}]}syncAndRender(e,t){if(e<0||e>3){console.error(`HandRenderer.syncAndRender: Invalid playerIndex ${e}`);return}const i=this.playerHands[e];i.hiddenTiles=t.tiles.map(n=>{const s=this.tileManager.getOrCreateTile(n);return s||console.error(`HandRenderer.syncAndRender: Could not find/create Phaser tile for index ${n.index}`),s}).filter(n=>n!=null),i.exposedSets=t.exposures.map(n=>n.tiles.map(s=>{const a=this.tileManager.getOrCreateTile(s);return a||console.error(`HandRenderer.syncAndRender: Could not find/create Phaser tile for exposure index ${s.index}`),a}).filter(s=>s!=null)),this.showHand(e,e===d.BOTTOM)}showHand(e,t=!1){if(e<0||e>3){console.error(`HandRenderer.showHand: Invalid playerIndex ${e}`);return}const i=R[e],n=this.playerHands[e];this.updateRackGraphics(e,i);const s=t||i.id===d.BOTTOM;this.renderHiddenTiles(e,i,n,s),this.renderExposedTiles(e,i,n)}getHandRackPosition(e){const t=this.calculateTileScale(e),i=I*t,n=v*t,s=G,a=8,o=14;let r,l,c,h;switch(e.id){case d.BOTTOM:r=o*(i+s)-s+2*a,l=2*n+s+2*a,c=E/2-r/2,h=D-l-10;break;case d.TOP:r=o*(i+s)-s+2*a,l=2*n+s+2*a,c=E/2-r/2,h=10;break;case d.LEFT:l=o*(i+s)-s+2*a,r=2*n+s+2*a,c=10,h=D/2-l/2;break;case d.RIGHT:default:l=o*(i+s)-s+2*a,r=2*n+s+2*a,c=E-r-10,h=D/2-l/2;break}return{x:c,y:h,width:r,height:l}}calculateTileScale(e){return e.id===d.BOTTOM?1:A}prepareTileForAnimation(e,t){const i=R[t],n=this.calculateTileScale(i);e.scale=n,e.angle=i.angle}calculateHiddenTilePositions(e,t){const i=this.getHandRackPosition(e),n=this.calculateTileScale(e),s=I*n,a=v*n,o=G;let r,l;switch(e.id){case d.BOTTOM:r=i.x+8+s/2,l=i.y+i.height-a/2-5;break;case d.TOP:r=i.x+8+s/2,l=i.y+a/2+5;break;case d.LEFT:r=i.x+a/2+5,l=i.y+8+s/2;break;case d.RIGHT:default:r=i.x+i.width-a/2-5,l=i.y+8+s/2;break}return{startX:r,startY:l,tileWidth:s,tileHeight:a,gap:o}}calculateExposedTilePositions(e,t){const i=this.getHandRackPosition(e),n=this.calculateTileScale(e),s=I*n,a=v*n,o=G;let r,l;switch(e.id){case d.BOTTOM:r=i.x+8+s/2,l=i.y+a/2+5;break;case d.TOP:r=i.x+8+s/2,l=i.y+i.height-a/2-5;break;case d.LEFT:r=i.x+i.width-a/2-5,l=i.y+8+s/2;break;case d.RIGHT:default:r=i.x+a/2+5,l=i.y+8+s/2;break}return{startX:r,startY:l,tileWidth:s,tileHeight:a,gap:o}}renderHiddenTiles(e,t,i,n){const s=i.hiddenTiles;if(s.length===0)return;const a=this.calculateHiddenTilePositions(t,s.length);t.id===d.BOTTOM||t.id===d.TOP?this.positionTilesHorizontal(s,t,a.startX,a.startY,n,a.tileWidth,a.gap):this.positionTilesVertical(s,t,a.startX,a.startY,n,a.tileWidth,a.gap)}renderExposedTiles(e,t,i){const n=i.exposedSets;if(n.length===0)return;const s=n.reduce((l,c)=>l+c.length,0),a=this.calculateExposedTilePositions(t,s);let o=a.startX,r=a.startY;for(const l of n)t.id===d.BOTTOM||t.id===d.TOP?(this.positionTilesHorizontal(l,t,o,r,!0,a.tileWidth,a.gap),o+=l.length*(a.tileWidth+a.gap)):(this.positionTilesVertical(l,t,o,r,!0,a.tileWidth,a.gap),r+=l.length*(a.tileWidth+a.gap))}positionTilesHorizontal(e,t,i,n,s,a,o){const r=this.calculateTileScale(t);e.forEach((l,c)=>{const h=i+c*(a+o),g=n;l.x=h,l.y=g,l.scale=r,l.angle=t.angle,l.sprite.setDepth(10+c),l.spriteBack.setDepth(10+c),l.origX=h,l.origY=g,l.showTile(!0,s)})}positionTilesVertical(e,t,i,n,s,a,o){const r=this.calculateTileScale(t);e.forEach((l,c)=>{const h=i,g=n+c*(a+o);l.x=h,l.y=g,l.scale=r,l.angle=t.angle,l.sprite.setDepth(10+c),l.spriteBack.setDepth(10+c),l.origX=h,l.origY=g,l.showTile(!0,s)})}updateRackGraphics(e,t){const i=this.playerHands[e],n=this.getHandRackPosition(t);i.rackGraphics&&i.rackGraphics.destroy(),i.rackGraphics=this.scene.add.graphics(),i.rackGraphics.fillStyle(0,.15),i.rackGraphics.fillRoundedRect(n.x,n.y,n.width,n.height,8),i.rackGraphics.setDepth(0)}getHiddenTiles(e){return this.playerHands[e].hiddenTiles}getExposedSets(e){return this.playerHands[e].exposedSets}calculateTilePosition(e,t,i=-1){const n=R[e],s=this.getHandRackPosition(n),a=this.calculateTileScale(n),o=I*a,r=v*a,l=G;let c,h;switch(n.id){case d.BOTTOM:return c=s.x+8+o/2,h=s.y+s.height-r/2-5,{x:c+t*(o+l),y:h};case d.TOP:return c=s.x+8+o/2,h=s.y+r/2+5,{x:c+t*(o+l),y:h};case d.LEFT:return c=s.x+r/2+5,h=s.y+8+o/2,{x:c,y:h+t*(o+l)};case d.RIGHT:default:return c=s.x+s.width-r/2-5,h=s.y+8+o/2,{x:c,y:h+t*(o+l)}}}}class Y{constructor(e,t,i,n){this.gameController=e,this.scene=t,this.tileManager=i,this.handRenderer=n,this.isAnimating=!1,this.currentSequence=null,this.cancelRequested=!1}async executeSequence(e){if(this.isAnimating){console.warn("Animation already in progress, skipping new sequence");return}this.isAnimating=!0,this.cancelRequested=!1,this.currentSequence={steps:e,currentStep:0};try{await this.onSequenceStart();for(let t=0;t<e.length;t++){if(this.cancelRequested){H("Animation sequence cancelled");break}this.currentSequence.currentStep=t;const i=e[t];if(typeof i!="function"){console.warn(`Step ${t} is not a function, skipping`);continue}await i()}await this.onSequenceComplete()}catch(t){throw await this.onSequenceError(t),t}finally{this.isAnimating=!1,this.currentSequence=null,this.cancelRequested=!1}}delay(e){return this.cancelRequested?Promise.resolve():new Promise(t=>setTimeout(t,e))}isRunning(){return this.isAnimating}cancel(){this.isAnimating&&(this.cancelRequested=!0)}getTileSprites(e){return this.tileManager?e.map(t=>this.tileManager.getOrCreateTile(t)).filter(Boolean):(console.warn("TileManager not available"),[])}calculateDirection(e,t){const i=t.x-e.x,n=t.y-e.y,s=Math.sqrt(i*i+n*n);return{dx:i,dy:n,distance:s}}async onSequenceStart(){}async onSequenceComplete(){}onSequenceError(e){return console.error("Animation sequence error:",e),Promise.resolve()}}class fe extends Y{constructor(e,t,i,n,s){super(e,t,i,n),this.onTilesRemoved=s,this.dealAnimationHands=null,this.pendingHumanGlowTile=null,this.TILE_DEAL_STAGGER=50,this.TILE_FLY_DURATION=200,this.BATCH_TRANSITION_DELAY=50}async animateDeal(e={}){const t=Array.isArray(e.sequence)?e.sequence:[];if(!t.length){console.warn("DealingAnimationSequencer: Empty sequence, skipping animation"),this.gameController.emit("DEALING_COMPLETE");return}this.dealAnimationHands=Array.from({length:4},()=>({tiles:[],exposures:[]})),await this.executeSequence(t.map((i,n)=>()=>this.dealBatch(i,n,t.length)))}async dealBatch(e,t,i){var h,g,T,w,y;const n=typeof e.player=="number"?e.player:d.BOTTOM,s=Array.isArray(e.tiles)?e.tiles:[],a=(h=this.dealAnimationHands)==null?void 0:h[n];if(!s.length)return;const o=a?a.tiles.length:0,r=o+s.length,l=s.map((x,B)=>this.dealSingleTile(x,n,o,r,B));await Promise.all(l);const c=(g=this.dealAnimationHands)==null?void 0:g[n];c?this.handRenderer.syncAndRender(n,c):(y=(w=(T=this.gameController)==null?void 0:T.players)==null?void 0:w[n])!=null&&y.hand&&this.handRenderer.syncAndRender(n,this.gameController.players[n].hand),t<i-1&&await this.delay(this.BATCH_TRANSITION_DELAY)}async dealSingleTile(e,t,i,n,s){var w;s>0&&await this.delay(this.TILE_DEAL_STAGGER);const a=b.fromJSON(e),o=this.tileManager.getOrCreateTile(a);if(!o){V(`Could not find Phaser Tile for index ${a.index} during dealing`);return}this.tileManager.removeTileFromWall(a.index);const r=50,l=50;o.x=r,o.y=l,o.sprite.setAlpha(0),o.spriteBack&&o.spriteBack.setAlpha(0),this.handRenderer.prepareTileForAnimation(o,t),o.showTile(!0,t===d.BOTTOM);const c=i+s,h=this.handRenderer.calculateTilePosition(t,c,n),g=(w=this.dealAnimationHands)==null?void 0:w[t];g&&g.tiles.splice(c,0,a);const T=o.animate(h.x,h.y,R[t].angle,this.TILE_FLY_DURATION);this.scene.tweens.add({targets:[o.sprite,o.spriteBack],alpha:1,duration:this.TILE_FLY_DURATION}),t===d.BOTTOM&&(this.pendingHumanGlowTile=o),this.onTilesRemoved&&this.onTilesRemoved(1),T&&await new Promise(y=>{T.once("complete",()=>{this.scene.audioManager&&this.scene.audioManager.playSFX("rack_tile"),y()})})}onSequenceComplete(){const e=this.gameController.players[d.BOTTOM].hand;return e&&(e.sortBySuit(),this.handRenderer.syncAndRender(d.BOTTOM,e)),this.pendingHumanGlowTile&&typeof this.pendingHumanGlowTile.addGlowEffect=="function"&&this.pendingHumanGlowTile.addGlowEffect(this.scene,1981066,.5,10),this.scene&&typeof this.scene.handleDealAnimationComplete=="function"&&this.scene.handleDealAnimationComplete(),this.dealAnimationHands=null,this.pendingHumanGlowTile=null,this.gameController.emit("DEALING_COMPLETE"),Promise.resolve()}onSequenceError(e){console.error("Dealing animation error:",e),this.dealAnimationHands=null,this.pendingHumanGlowTile=null,this.gameController.emit("DEALING_COMPLETE")}}class Te extends Y{constructor(e,t,i,n){super(e,t,i,n),this.receivedTileIds=new Set,this.directionVectors={right:{exit:{x:100,y:-30},entry:{x:-100,y:30}},across:{exit:{x:0,y:-100},entry:{x:0,y:100}},left:{exit:{x:-100,y:-30},entry:{x:100,y:30}}},this.PASS_OUT_DURATION=300,this.TRAVEL_DELAY=200,this.RECEIVE_DURATION=300}async animateCharlestonPass(e,t){if(e.player!==d.BOTTOM)return;const{direction:i}=e;await this.executeSequence([()=>this.animateTilesLeaving(t,i),()=>this.delay(this.TRAVEL_DELAY)])}async handleTilesReceived(e){var n;if(e.player!==d.BOTTOM)return;const t=((n=e.animation)==null?void 0:n.direction)||e.direction,i=e.tiles.map(s=>b.fromJSON(s));H("[CharlestonAnimationSequencer] handleTilesReceived:",{count:i.length}),this.receivedTileIds=new Set(i.map(s=>s.index)),await this.executeSequence([()=>this.animateTilesArriving(i,t),()=>this.applyGlowToReceivedTiles(i)])}async animateTilesLeaving(e,t){const i=this.getTileSprites(e);if(i.length===0)return;const n=this.getDirectionVector(t);if(!n){console.warn(`Unknown direction: ${t}`);return}const s=i.map(a=>new Promise(o=>{this.scene.tweens.add({targets:a,x:a.x+n.exit.x,y:a.y+n.exit.y,alpha:0,duration:this.PASS_OUT_DURATION,ease:"Cubic.easeIn",onComplete:o}),this.scene.tweens.add({targets:[a.sprite,a.spriteBack],alpha:0,duration:this.PASS_OUT_DURATION,ease:"Cubic.easeIn"})}));await Promise.all(s),i.forEach(a=>{a.sprite.visible=!1,a.spriteBack&&(a.spriteBack.visible=!1)})}async animateTilesArriving(e,t){const i=this.getTileSprites(e);if(i.length===0)return;const n=this.getDirectionVector(t);if(!n){console.warn(`Unknown direction: ${t}`);return}const s=this.gameController.players[d.BOTTOM].hand;if(!s)return;this.handRenderer.syncAndRender(d.BOTTOM,s);const a=i.map(o=>{const r=o.x,l=o.y;return o.x=r+n.entry.x,o.y=l+n.entry.y,o.sprite.setAlpha(0),o.spriteBack&&o.spriteBack.setAlpha(0),o.sprite.visible=!0,o.spriteBack&&(o.spriteBack.visible=!0),new Promise(c=>{this.scene.tweens.add({targets:o,x:r,y:l,alpha:1,duration:this.RECEIVE_DURATION,ease:"Cubic.easeOut",onComplete:c}),this.scene.tweens.add({targets:[o.sprite,o.spriteBack],alpha:1,duration:this.RECEIVE_DURATION,ease:"Cubic.easeOut"})})});await Promise.all(a)}applyGlowToReceivedTiles(e){this.getTileSprites(e).forEach(i=>{typeof i.addGlowEffect=="function"&&i.addGlowEffect(this.scene,1981066,.5,10)})}getDirectionVector(e){return this.directionVectors[e]||null}onSequenceComplete(){const e=this.gameController.players[d.BOTTOM].hand;return e&&this.handRenderer.syncAndRender(d.BOTTOM,e),Promise.resolve()}onSequenceError(e){return console.error("Charleston animation error:",e),Promise.resolve()}}class we extends Y{constructor(e,t,i,n,s={}){super(e,t,i,n),this.clearHumanDrawGlow=s.clearHumanDrawGlow,this.blankSwapManager=s.blankSwapManager,this.lastDiscardGlowTile=null}async animateDiscard(e){if(!(e!=null&&e.tile))return;const{player:t,tile:i}=e,n=b.fromJSON(i);await this.executeSequence([()=>this.prepareDiscard(t,n),()=>this.animateTileToDiscard(t,n),()=>this.applyDiscardGlow(n),()=>this.finalizeDiscard()])}prepareDiscard(e,t){const i=this.tileManager.getOrCreateTile(t);if(!i)throw V(`Could not find Phaser Tile for index ${t.index}`),new Error(`Tile sprite not found: ${t.index}`);e===d.BOTTOM&&this.clearHumanDrawGlow&&this.clearHumanDrawGlow(i),this.lastDiscardGlowTile&&typeof this.lastDiscardGlowTile.removeGlowEffect=="function"&&(this.lastDiscardGlowTile.removeGlowEffect(),this.lastDiscardGlowTile=null)}async animateTileToDiscard(e,t){const i=this.tileManager.getOrCreateTile(t);if(!i)return;const n=this.tileManager.addTileToDiscardPile(i);n&&await new Promise(s=>{n.once("complete",s)})}applyDiscardGlow(e){const t=this.tileManager.getOrCreateTile(e);!t||typeof t.addGlowEffect!="function"||(t.addGlowEffect(this.scene,2450411,.9,5),this.lastDiscardGlowTile=t)}finalizeDiscard(){var e;(e=this.blankSwapManager)!=null&&e.handleDiscardPileChanged&&this.blankSwapManager.handleDiscardPileChanged()}getLastDiscardGlowTile(){return this.lastDiscardGlowTile}clearLastDiscardReference(){this.lastDiscardGlowTile=null}onSequenceError(e){return console.error("Discard animation error:",e),Promise.resolve()}}class ye extends J{constructor(e,t,i){super(e),this.gameController=e,this.scene=t,this.table=i,this.tilesRemovedFromWall=0,this.tileManager=new de(t,i.wall,i.discards),this.dialogManager=new ue(t),this.handRenderer=new pe(t,this.tileManager),this.pendingHumanGlowTile=null,this.activeHumanGlowTile=null,this.buttonManager=new he(t,e);const n=R[d.BOTTOM].angle;this.selectionManager=new ge(this.handRenderer,n,this.buttonManager),this.buttonManager.selectionManager=this.selectionManager,this.blankSwapManager=new me({discardPile:i.discards,selectionManager:this.selectionManager,buttonManager:this.buttonManager,gameController:e}),this.skipNextDrawHandUpdate=!1,this.dealingSequencer=new fe(e,t,this.tileManager,this.handRenderer,s=>{this.tilesRemovedFromWall+=s,this.updateWallTileCounter()}),this.charlestonSequencer=new Te(e,t,this.tileManager,this.handRenderer),this.discardSequencer=new we(e,t,this.tileManager,this.handRenderer,{clearHumanDrawGlow:s=>this.clearHumanDrawGlow(s),blankSwapManager:this.blankSwapManager}),this.setupEventListeners()}onWallCreated(){this.tileManager.initializeFromWall()}setupEventListeners(){this.registerEventHandlers({STATE_CHANGED:e=>this.onStateChanged(e),GAME_STARTED:e=>this.onGameStarted(e),GAME_ENDED:e=>this.onGameEnded(e),WALL_CREATED:e=>this.onWallCreated(e),TILES_DEALT:e=>this.onTilesDealt(e),TILE_DRAWN:e=>this.onTileDrawn(e),TILE_DISCARDED:e=>this.onTileDiscarded(e),TILES_RECEIVED:e=>this.onTilesReceived(e),BLANK_EXCHANGED:e=>this.onBlankExchanged(e),DISCARD_CLAIMED:e=>this.onDiscardClaimed(e),TILES_EXPOSED:e=>this.onTilesExposed(e),JOKER_SWAPPED:e=>this.onJokerSwapped(e),HAND_UPDATED:e=>this.onHandUpdated(e),TURN_CHANGED:e=>this.onTurnChanged(e),CHARLESTON_PHASE:e=>this.onCharlestonPhase(e),CHARLESTON_PASS:e=>this.onCharlestonPass(e),COURTESY_VOTE:e=>this.onCourtesyVote(e),COURTESY_PASS:e=>this.onCourtesyPass(e),MESSAGE:e=>this.onMessage(e),UI_PROMPT:e=>this.onUIPrompt(e)})}updateWallTileCounter(){if(!this.scene.updateWallTileCounter)return;const t=N()-this.tilesRemovedFromWall;this.scene.updateWallTileCounter(Math.max(t,0))}onStateChanged(e){const{oldState:t,newState:i}=e;switch(this.buttonManager.updateForState(i),i){case"LOOP_CHOOSE_DISCARD":S("Select one tile to discard or declare Mahjong");break;case"LOOP_EXPOSE_TILES":S("Form a pung/kong/quint with claimed tile");break;case"LOOP_QUERY_CLAIM_DISCARD":S("Claim discard?");break;default:this.selectionManager&&this.selectionManager.disableTileSelection();break}}onGameStarted(){var s,a,o;M("Game started!"),this.clearHumanDrawGlow();const e=((s=this.gameController)==null?void 0:s.settings)||{},t=e.year||"2025",i=[`Difficulty: ${e.difficulty||"medium"}`,`Charleston: ${e.skipCharleston?"skipped":"full"}`,`Blanks: ${e.useBlankTiles?"on":"off"}`];M(`Starting card ${t} â€¢ ${i.join(" â€¢ ")}`),this.scene.audioManager&&this.scene.audioManager.playBGM("bgm"),this.scene&&typeof this.scene.hideWallGameNotice=="function"&&this.scene.hideWallGameNotice(),this.scene&&typeof this.scene.setActionPanelDisabled=="function"&&this.scene.setActionPanelDisabled(!1),this.table.reset(),this.tileManager.initializeFromWall();const n=document.getElementById("start");n&&(n.style.display="none"),this.tilesRemovedFromWall=0,(o=(a=this.buttonManager)==null?void 0:a.pinSortButtons)==null||o.call(a)}onGameEnded(e){const{reason:t,winner:i,mahjong:n}=e;let s="";if(n){const a=this.getPlayerName(i);s=`Mahjong!

${a} wins!`,M(`${a} wins with Mahjong!`),this.scene.audioManager&&this.scene.audioManager.playFireworks()}else if(t==="wall_game"){s=`Wall Game

No tiles remaining. No winner.`,M("Wall game - no winner"),S("Wall game reached. No moves available.");for(let a=0;a<4;a++)this.handRenderer.showHand(a,!0);this.scene.audioManager&&this.scene.audioManager.playSFX("wall_fail"),this.scene&&typeof this.scene.handleWallGameEnd=="function"&&this.scene.handleWallGameEnd()}if(s)this.dialogManager.showModalDialog(s,[{label:"OK",value:!0}],()=>{const a=document.getElementById("start");a&&(a.style.display="block")});else{const a=document.getElementById("start");a&&(a.style.display="block")}}onTilesDealt(e={}){this.dealingSequencer.animateDeal(e)}onTileDrawn(e){const{player:t,tile:i}=e,n=b.fromJSON(i),s=this.tileManager.getOrCreateTile(n);if(!s){V(`Could not find Phaser Tile for index ${n.index}.`);return}s.sprite.setPosition(50,50),s.sprite.setAlpha(0),this.handRenderer.prepareTileForAnimation(s,t),this.tileManager.removeTileFromWall(n.index);const r=this.gameController.players[t].hand;this.handRenderer.syncAndRender(t,r),this.skipNextDrawHandUpdate=!0,t===d.BOTTOM&&this.setPendingHumanGlowTile(s);const l=this.handRenderer.getHiddenTiles(t),c=l.findIndex(w=>w===s),h=this.handRenderer.calculateTilePosition(t,c>=0?c:l.length-1),g=s.animate(h.x,h.y,R[t].angle,200);g&&this.scene.audioManager&&g.once("complete",()=>{this.scene.audioManager.playSFX("rack_tile")}),this.scene.tweens.add({targets:s.sprite,alpha:1,duration:200}),s.isNewlyInserted=!1;const T=()=>{t===d.BOTTOM?(this.autoSortHumanHand(),this.applyHumanDrawGlow()):this.handRenderer.showHand(t,!1)};if(g?g.on("complete",T):T(),this.tilesRemovedFromWall++,this.updateWallTileCounter(),t===d.BOTTOM){const w=b.fromPhaserTile(s);S(`You drew: ${w.getText()}`)}}onTilesReceived(e){const{player:t,tiles:i}=e;if(t!==d.BOTTOM)return;const n=i.map(s=>b.fromJSON(s)).map(s=>this.tileManager.getOrCreateTile(s)).filter(Boolean);this.activeHumanGlowTile&&(this.activeHumanGlowTile.removeGlowEffect(),this.activeHumanGlowTile=null),n.forEach(s=>{typeof s.addGlowEffect=="function"&&s.addGlowEffect(this.scene,1981066,.5,10)}),n.length>0&&(this.activeHumanGlowTile=n[n.length-1])}onTileDiscarded(e){const{player:t,tile:i}=e;this.discardSequencer.animateDiscard(e);const n=b.fromJSON(i),s=this.getPlayerName(t);M(`${s} discarded ${n.getText()}`)}onBlankExchanged(e){var l;const{player:t,blankTile:i,retrievedTile:n}=e;if(t!==d.BOTTOM)return;const s=b.fromJSON(i),a=b.fromJSON(n),o=this.tileManager.getTileSprite(s),r=this.tileManager.getTileSprite(a);r&&(this.table.discards.removeDiscardTile(r),r.sprite.visible=!1,r.spriteBack.visible=!1,this.setPendingHumanGlowTile(r)),o?this.table.discards.insertDiscard(o):console.warn("Blank exchange: Could not find blank tile sprite",s),this.table.discards.layoutTiles(),(l=this.blankSwapManager)==null||l.handleBlankExchangeEvent(),this.scene.time.delayedCall(100,()=>this.applyHumanDrawGlow())}onDiscardClaimed(e){var r;const{claimingPlayer:t,tile:i,claimType:n}=e,s=b.fromJSON(i);if(t<0||t>=4){console.error("Invalid claiming player index:",t,e);return}const a=this.tileManager.getOrCreateTile(s);a&&((r=this.table)!=null&&r.discards)&&(this.table.discards.removeDiscardTile(a),this.table.discards.layoutTiles()),t===d.BOTTOM&&a&&(this.setPendingHumanGlowTile(a),this.applyHumanDrawGlow());const o=this.getPlayerName(t);M(`${o} claimed ${s.getText()} for ${n}`)}onTilesExposed(e){const{player:t,exposureType:i,tiles:n}=e,s=this.tileManager.convertTileDataArray(n.map(o=>b.fromJSON(o)));t===d.BOTTOM&&s.forEach(o=>this.clearHumanDrawGlow(o));const a=this.getPlayerName(t);M(`${a} exposed ${i}: ${s.length} tiles`)}onJokerSwapped(e){const{player:t,replacementTile:i,recipient:n}=e,s=this.getPlayerName(t),a=i instanceof b?i:i?b.fromJSON(i):null;if(a&&S(`${s} swapped a joker for ${a.getText()}`),n===d.BOTTOM&&a){const o=this.tileManager.getOrCreateTile(a);o&&(this.setPendingHumanGlowTile(o),this.scene.time.delayedCall(100,()=>this.applyHumanDrawGlow()))}}onHandUpdated(e){var s;const{player:t,hand:i}=e;if(!(this.dealingSequencer&&this.dealingSequencer.isRunning())&&!this.skipNextDrawHandUpdate&&this.handRenderer.syncAndRender(t,i),this.skipNextDrawHandUpdate&&(this.skipNextDrawHandUpdate=!1),t===d.BOTTOM&&this.selectionManager&&this.selectionManager.refreshHandlers(),t===d.BOTTOM&&this.selectionManager){const a=this.selectionManager.getSelection();if(a.length>0){const o=this.handRenderer.getHiddenTiles(d.BOTTOM);a.some(l=>!o.includes(l))&&this.selectionManager.clearSelection()}}t===d.BOTTOM&&this.scene.hintAnimationManager&&this.scene.hintAnimationManager.updateHintsForNewTiles(),(s=this.blankSwapManager)==null||s.handleHandUpdated(t)}onTurnChanged(e){const{currentPlayer:t}=e;this.table.switchPlayer(t);const i=this.getPlayerName(t);M(`${i}'s turn`)}onCharlestonPhase(e){const{phase:t,passCount:i,direction:n}=e;M(`Charleston Phase ${t}, Pass ${i}: Pass ${n}`)}onCharlestonPass(e){const{fromPlayer:t,direction:i}=e,n=this.getPlayerName(t);M(`${n} passed 3 tiles ${i}`)}onCourtesyVote(e){const{player:t,vote:i}=e,n=this.getPlayerName(t);M(`${n} voted ${i?"YES":"NO"} for courtesy pass`)}onCourtesyPass(e){const{fromPlayer:t,toPlayer:i,tiles:n}=e,s=n.map(r=>b.fromJSON(r).getText()).join(", "),a=this.getPlayerName(t),o=this.getPlayerName(i);M(`Courtesy pass: ${a} â†’ ${o} (${s})`)}onMessage(e){const{text:t,type:i}=e;if(i==="info")S(t);else if(i==="error")M(`ERROR: ${t}`),this.dialogManager.showError(t);else if(i==="hint"){const n=document.getElementById("hint-content");if(n){const s=document.createElement("div");s.className="hint-message",s.textContent=t,n.appendChild(s),n.scrollTop=n.scrollHeight}}else M(t)}onUIPrompt(e){const{promptType:t,options:i,callback:n}=e;switch(t){case"CHOOSE_DISCARD":this.handleDiscardPrompt(n);break;case"CLAIM_DISCARD":this.handleClaimPrompt(i,n);break;case"CHARLESTON_PASS":this.handleCharlestonPassPrompt(i,n);break;case"CHARLESTON_CONTINUE":this.handleCharlestonContinuePrompt(n);break;case"COURTESY_VOTE":this.handleCourtesyVotePrompt(n);break;case"COURTESY_PASS":this.handleCourtesyPassPrompt(i,n);break;case"SELECT_TILES":this.handleSelectTilesPrompt(i,n);break;default:console.warn(`Unknown prompt type: ${t}`),n&&n(null)}}handleDiscardPrompt(e){var t;if(!this.selectionManager){e&&e(null);return}S("Select a tile to discard"),(t=this.blankSwapManager)==null||t.handleDiscardPromptStart(),this.selectionManager.requestSelection({min:1,max:1,mode:"play"}).then(i=>{if(!i||i.length===0){e==null||e(null);return}const n=b.fromPhaserTile(i[0]);e==null||e(n)}).catch(i=>{console.warn("Discard selection cancelled:",i),e==null||e(null)}).finally(()=>{var i;(i=this.blankSwapManager)==null||i.handleDiscardPromptEnd()})}handleClaimPrompt(e,t){const{discardedTile:i}=e;S(`Claim ${i?i.getText():"this discard"}?`),this.buttonManager.registerCallback("button1",()=>{t&&t("Mahjong")}),this.buttonManager.registerCallback("button2",()=>{t&&t("Pung")}),this.buttonManager.registerCallback("button3",()=>{t&&t("Kong")}),this.buttonManager.registerCallback("button4",()=>{t&&t("Pass")})}handleCharlestonPassPrompt(e,t){const{direction:i,requiredCount:n}=e;S(`Select ${n} tiles to pass ${i}`),this.selectionManager.requestSelection({min:n,max:n,mode:"charleston"}).then(s=>{const a=s.map(o=>b.fromPhaserTile(o));t&&t(a)}).catch(s=>{console.warn("Charleston selection cancelled:",s),t==null||t([])})}handleCharlestonContinuePrompt(e){S("Continue to next Charleston phase?"),this.buttonManager.setText("button1","No"),this.buttonManager.setText("button2","Yes"),this.buttonManager.show(["button1","button2"]),this.buttonManager.enableButton("button1"),this.buttonManager.enableButton("button2"),this.buttonManager.registerCallback("button1",()=>{this.buttonManager.hide(["button1","button2"]),e&&e(!1)}),this.buttonManager.registerCallback("button2",()=>{this.buttonManager.hide(["button1","button2"]),e&&e(!0)})}handleCourtesyVotePrompt(e){this.dialogManager.showCourtesyVoteDialog(t=>{e&&e(t)})}handleCourtesyPassPrompt(e,t){const{maxTiles:i}=e;this.dialogManager.showCourtesyPassDialog(i,n=>{t&&t(n)})}handleSelectTilesPrompt(e,t){const{minTiles:i=1,maxTiles:n=3,mode:s,question:a}=e||{};if(!this.selectionManager){t==null||t([]);return}if(a)S(a);else{const o=i===n?`Select exactly ${i} tile${i!==1?"s":""}`:`Select ${i}â€“${n} tiles`;S(o)}this.selectionManager.requestSelection({min:i,max:n,mode:s||(n===1?"play":"courtesy")}).then(o=>{const r=o.map(l=>b.fromPhaserTile(l));t==null||t(r)}).catch(()=>{t==null||t([])})}getPlayerName(e){if(e<0||e>=4)return`Player ${e}`;if(this.gameController&&Array.isArray(this.gameController.players)){const i=this.gameController.players[e];if(i&&i.name)return i.name}return["You","Opponent 1","Opponent 2","Opponent 3"][e]||`Player ${e}`}destroy(){var e,t,i,n,s;try{super.destroy()}catch{}try{(e=this.selectionManager)==null||e.disableTileSelection()}catch{}try{(t=this.blankSwapManager)==null||t.handleDiscardPromptEnd()}catch{}try{(i=this.dialogManager)==null||i.closeDialog()}catch{}try{typeof((n=this.buttonManager)==null?void 0:n.destroy)=="function"&&this.buttonManager.destroy()}catch{}try{typeof((s=this.handRenderer)==null?void 0:s.destroy)=="function"&&this.handRenderer.destroy()}catch{}this.selectionManager=null,this.blankSwapManager=null,this.buttonManager=null,this.dialogManager=null,this.handRenderer=null}autoSortHumanHand(){const e=this.gameController.players[d.BOTTOM].hand;e.sortBySuit(),this.handRenderer.syncAndRender(d.BOTTOM,e)}setPendingHumanGlowTile(e){e&&(this.pendingHumanGlowTile=e)}applyHumanDrawGlow(){this.pendingHumanGlowTile&&(this.activeHumanGlowTile&&this.activeHumanGlowTile!==this.pendingHumanGlowTile&&this.activeHumanGlowTile.removeGlowEffect(),typeof this.pendingHumanGlowTile.addGlowEffect=="function"&&this.pendingHumanGlowTile.addGlowEffect(this.scene,1981066,.5,10),this.activeHumanGlowTile=this.pendingHumanGlowTile,this.pendingHumanGlowTile=null)}clearHumanDrawGlow(e=null){const t=e??this.activeHumanGlowTile;t&&typeof t.removeGlowEffect=="function"&&t.removeGlowEffect(),(!e||t===e)&&(t===this.pendingHumanGlowTile&&(this.pendingHumanGlowTile=null),t===this.activeHumanGlowTile&&(this.activeHumanGlowTile=null))}}class be{constructor(e,t,i,n,s){this.scene=e,this.gameController=t,this.aiEngine=i,this.card=n,this.tileManager=s,this.savedGlowData=null,this.currentHintData=null,this.isPanelExpanded=!1,this.glowedTiles=[]}applyGlowToDiscardSuggestions(e){this.clearAllGlows();const t=e.filter(s=>s.tile.suit!==C.INVALID&&s.tile.suit!==C.JOKER&&s.tile.suit!==C.BLANK&&s.recommendation==="DISCARD"),i=this.gameController.players[d.BOTTOM].hand,n=new Set;t.forEach((s,a)=>{H(`Processing tile ${a+1}: ${s.tile.getText()} with recommendation ${s.recommendation}`);const o=this.findNextUnhighlightedTileInHand(i,s.tile,n);o?(H(`Applying red glow to tile: ${s.tile.getText()}`),o.addGlowEffect(this.scene,16711680,.6,0),this.glowedTiles.push(o),n.add(o)):H(`Could not find tile for: ${s.tile.getText()}`)}),H(`Applied glow to ${this.glowedTiles.length} tiles out of ${t.length} discard tiles requested`),this.currentHintData={recommendations:[...e]},this.isPanelExpanded=!0}findNextUnhighlightedTileInHand(e,t,i){const n=e.tiles;for(const s of n)if(s.suit===t.suit&&s.number===t.number){const a=this.tileManager.getOrCreateTile(s);if(a&&!i.has(a))return a}return null}clearAllGlows(){if(this.glowedTiles.length>0){let e=null;this.currentHintData&&(e=this.currentHintData.recommendations),this.savedGlowData={recommendations:e,timestamp:Date.now()}}this.glowedTiles.forEach(e=>e.removeGlowEffect()),this.glowedTiles=[],this.isPanelExpanded=!1}restoreGlowEffects(){this.savedGlowData&&this.savedGlowData.recommendations?(this.applyGlowToDiscardSuggestions(this.savedGlowData.recommendations),this.isPanelExpanded=!0,this.savedGlowData=null):this.currentHintData&&this.currentHintData.recommendations&&(this.applyGlowToDiscardSuggestions(this.currentHintData.recommendations),this.isPanelExpanded=!0)}isHintPanelExpanded(){const e=window.document.getElementById("hint-content");return e&&!e.classList.contains("hidden")}buildHandDataForHintEngine(){const e=this.gameController.players[d.BOTTOM].hand.clone();return e.getLength()===13&&e.addTile(new b(C.INVALID,K.INVALID)),e}getRecommendations(){const e=this.buildHandDataForHintEngine(),t=this.aiEngine.getTileRecommendations(e,1);return{recommendations:t.recommendations.reverse(),consideredPatternCount:t.consideredPatternCount}}getAllPlayerTiles(){const e=this.gameController.players[d.BOTTOM].hand,t=[];for(const i of e.tiles){const n=this.tileManager.getOrCreateTile(i);n&&t.push(n)}for(const i of e.exposures)for(const n of i.tiles){const s=this.tileManager.getOrCreateTile(n);s&&t.push(s)}return t}getHiddenPlayerTiles(){const e=this.gameController.players[d.BOTTOM].hand,t=[];for(const i of e.tiles){const n=this.tileManager.getOrCreateTile(i);n&&t.push(n)}return t}updateHintsForNewTiles(){if(!this.isHintPanelExpanded()){this.updateHintDisplayOnly();return}const e=this.getRecommendations(),t=this.buildHandDataForHintEngine(),i=this.card.rankHandArray14(t);this.card.sortHandRankArray(i),this.applyGlowToDiscardSuggestions(e.recommendations),this.updateHintDisplay(i,e.recommendations,e.consideredPatternCount)}updateHintDisplayOnly(){const e=this.getRecommendations(),t=this.buildHandDataForHintEngine(),i=this.card.rankHandArray14(t);this.card.sortHandRankArray(i),this.updateHintDisplay(i,e.recommendations,e.consideredPatternCount)}updateHintDisplay(e,t,i){var h,g,T,w,y,x,B;const n=this.gameController.players[d.BOTTOM].hand,s=n.getAllTilesIncludingExposures(),a=n.tiles,o=((g=(h=this.gameController)==null?void 0:h.settings)==null?void 0:g.year)||((T=this.card)==null?void 0:T.year)||"";let r="<h3>Top Possible Hands:</h3>";r+='<div class="hint-item">';for(let f=0;f<Math.min(3,e.length);f++){const k=e[f],O=f===0||f<i,L=O?"":"opacity: 0.4;",_=!O&&f>0?" <em>(not considered)</em>":"",F=Q(k,s,a),q=((w=k.group)==null?void 0:w.groupDescription)||"",U=((y=k.hand)==null?void 0:y.description)||"",z=((x=k.rank)==null?void 0:x.toFixed(2))||"0.00",X=((B=k.hand)==null?void 0:B.concealed)===!0?'<span class="concealed-badge" title="Concealed">C</span>':"",j=[o,q,U].filter(Boolean);r+=`
                <div class="hint-pattern" style="${L}">
                    <div class="hint-pattern-header">
                        <strong>${j.join(" - ")}</strong> <span class="hint-rank">(Rank: ${z})${_}</span>${X}
                    </div>
                    ${F}
                </div>
            `}r+="</div>",r+="<h3>Discard Suggestions (Best to Discard First):</h3>";const l=t.filter(f=>f.tile.suit!==C.INVALID&&f.recommendation==="DISCARD"),c=l.length;for(let f=0;f<c;f++){const k=l[f];r+=`<p>${k.tile.getText()}</p>`}Z(r)}}class Ce extends p.Scene{constructor(){super({key:"GameScene"}),this.commandBarManualPosition=!1,this.commandBarPosition=null,this.homePageTileManager=null,this.actionPanelEl=null,this.waitingForCommandBarReveal=!1,this.isActionPanelDisabled=!1,this.wallGameBanner=null}preload(){this.load.atlas("tiles","assets/tiles.png","assets/tiles.json"),this.load.image("back","assets/back.png");const e=document.createElement("canvas");e.width=4,e.height=4;const t=e.getContext("2d");t&&(t.fillStyle="white",t.fillRect(0,0,4,4)),this.textures.addCanvas("particle",e),this.load.audio("bgm","assets/audio/2406haidao_bgm_loop.mp3"),this.load.audio("rack_tile","assets/audio/rack_tile.mp3"),this.load.audio("tile_dropping","assets/audio/tile_dropping.mp3"),this.load.audio("fireworks","assets/audio/fireworks.mp3"),this.load.audio("wall_fail","assets/audio/normalflyin.mp3")}async create(){var s,a,o,r,l,c,h,g,T,w,y,x;this.input.dragDistanceThreshold=20,this.scale.on("resize",this.resize,this),this.audioManager=new ce(this,window.settingsManager||{}),this.gTable=new re(this);let e=2025;if(window.settingsManager&&window.settingsManager.getCardYear){const B=window.settingsManager.getCardYear();B&&(e=parseInt(B))}const t=new ee(e);await t.init(),this.populateTrainingForm(t);const i=new te(t);this.gameController=new ie,await this.gameController.init({wallGenerator:()=>this.captureWallTiles(),aiEngine:i,cardValidator:t,settings:{year:e,difficulty:window.settingsManager&&((a=(s=window.settingsManager).getDifficulty)==null?void 0:a.call(s))||"medium",useBlankTiles:window.settingsManager&&((r=(o=window.settingsManager).getUseBlankTiles)==null?void 0:r.call(o))||!1,skipCharleston:window.settingsManager&&((c=(l=window.settingsManager).getSetting)==null?void 0:c.call(l,"skipCharleston",!1))||!1,trainingMode:window.settingsManager&&((g=(h=window.settingsManager).getSetting)==null?void 0:g.call(h,"trainingMode",!1))||!1,trainingHand:window.settingsManager&&((w=(T=window.settingsManager).getSetting)==null?void 0:w.call(T,"trainingHand",""))||"",trainingTileCount:window.settingsManager&&((x=(y=window.settingsManager).getSetting)==null?void 0:x.call(y,"trainingTileCount",13))||13}}),this.gameController.on("GAME_STARTED",()=>{this.prepareActionPanelForNewGame()}),this.hintAnimationManager=null,this.adapter=new ye(this.gameController,this,this.gTable),this.events.once(p.Scenes.Events.SHUTDOWN,()=>{var B,f,k,O,L;try{(B=this.adapter)==null||B.destroy()}catch{}try{(k=(f=this.hintAnimationManager)==null?void 0:f.destroy)==null||k.call(f)}catch{}try{(L=(O=this.homePageTileManager)==null?void 0:O.cleanup)==null||L.call(O)}catch{}this.adapter=null,this.hintAnimationManager=null,this.homePageTileManager=null}),this.hintAnimationManager=new be(this,this.gameController,this.gameController.aiEngine,this.gameController.cardValidator,this.adapter.tileManager),window.gameController=this.gameController,window.addEventListener("settingsChanged",B=>{const f=B.detail;this.gameController&&this.gameController.settings&&(f.difficulty!==void 0&&(this.gameController.settings.difficulty=f.difficulty),f.cardYear!==void 0&&(this.gameController.settings.year=f.cardYear),f.useBlankTiles!==void 0&&(this.gameController.settings.useBlankTiles=f.useBlankTiles),f.skipCharleston!==void 0&&(this.gameController.settings.skipCharleston=f.skipCharleston))}),this.wallCounter=this.createWallTileCounter(),this.errorText=this.add.text(400,400,"",{font:"14px Arial",fill:"#ff8080",backgroundColor:"rgba(0,0,0,1)",align:"left"}),this.errorText.visible=!1,this.wallGameBanner=this.add.text(E/2,D/2,"Wall Game",{font:"48px 'Trebuchet MS', sans-serif",fill:"#facc15",backgroundColor:"rgba(0,0,0,0.65)",padding:{x:24,y:16},align:"center"}),this.wallGameBanner.setOrigin(.5),this.wallGameBanner.setDepth(500),this.wallGameBanner.setVisible(!1),this.gTable.create(!0),this.homePageTileManager=new le(this,this.gTable.wall),this.homePageTileManager.createScatteredTiles(),this.enableCommandBarDrag(),this.resize(this.sys.game.canvas.width,this.sys.game.canvas.height),this.initializeActionPanel();const n=document.getElementById("start");n&&n.addEventListener("click",async()=>{n.style.display="none",this.prepareActionPanelForNewGame(),this.updateGameControllerSettings(),this.homePageTileManager?(this.homePageTileManager.onAnimationComplete=async()=>{await this.homePageTileManager.transitionToWallSystem(),this.homePageTileManager.cleanup(),this.homePageTileManager=null,this.adapter.tileManager.initializeFromWall(),await this.gameController.startGame()},this.homePageTileManager.animateToPileAndStartGame()):await this.gameController.startGame()})}initializeActionPanel(){this.actionPanelEl=document.getElementById("uicenterdiv"),this.actionPanelEl&&(this.actionPanelEl.classList.add("command-bar--hidden"),this.actionPanelEl.setAttribute("aria-hidden","true"),this.actionPanelEl.classList.remove("command-bar--disabled"),this.waitingForCommandBarReveal=!1)}prepareActionPanelForNewGame(){this.actionPanelEl||this.initializeActionPanel(),this.waitingForCommandBarReveal=!0,this.hideActionPanel(),this.setActionPanelDisabled(!1),this.hideWallGameNotice()}hideActionPanel(){this.actionPanelEl&&(this.actionPanelEl.classList.add("command-bar--hidden"),this.actionPanelEl.setAttribute("aria-hidden","true"))}showActionPanel(){this.actionPanelEl&&(this.actionPanelEl.classList.remove("command-bar--hidden"),this.actionPanelEl.removeAttribute("aria-hidden"),this.actionPanelEl.style.display="")}setActionPanelDisabled(e){this.actionPanelEl&&(this.isActionPanelDisabled=e,e?(this.actionPanelEl.classList.add("command-bar--disabled"),this.actionPanelEl.setAttribute("aria-disabled","true")):(this.actionPanelEl.classList.remove("command-bar--disabled"),this.actionPanelEl.removeAttribute("aria-disabled")))}handleDealAnimationComplete(){this.waitingForCommandBarReveal&&(this.waitingForCommandBarReveal=!1,this.showActionPanel())}showWallGameNotice(e="Wall Game - No Winner"){this.wallGameBanner&&(this.wallGameBanner.setText(e),this.wallGameBanner.setAlpha(0),this.wallGameBanner.setVisible(!0),this.tweens.add({targets:this.wallGameBanner,alpha:1,duration:350,ease:"Quad.easeOut"}))}hideWallGameNotice(){!this.wallGameBanner||!this.wallGameBanner.visible||this.wallGameBanner.setVisible(!1)}handleWallGameEnd(){this.showWallGameNotice(),this.setActionPanelDisabled(!0),this.waitingForCommandBarReveal=!1}captureWallTiles(){return!this.gTable||!this.gTable.wall||!Array.isArray(this.gTable.wall.tileArray)?[]:this.gTable.wall.tileArray.map((e,t)=>({suit:e.suit,number:e.number,index:typeof e.index=="number"?e.index:t}))}createWallTileCounter(){const e=this.add.container(E/2-150,160),t=this.add.graphics();t.fillStyle(2763306,1),t.fillRoundedRect(0,0,300,20,5);const i=this.add.graphics(),n=N(),s=this.add.text(150,10,"Wall Tiles Remaining: "+n,{fontFamily:"Arial, sans-serif",fontSize:"16px",fontStyle:"bold",color:"#ffffff",stroke:"#000000",strokeThickness:4});return s.setOrigin(.5,.5),s.setResolution(2),e.add([t,i,s]),e.setVisible(!1),e.setDepth(100),{bar:e,fill:i,text:s,maxTiles:n}}updateWallTileCounter(e){if(!this.wallCounter)return;const{bar:t,fill:i,text:n,maxTiles:s}=this.wallCounter;i.clear(),(e<0||e>s)&&(console.error("Invalid wall count:",e),e=Math.max(0,Math.min(e,s))),i.fillStyle(4886754,1);const a=e/s*300;i.fillRoundedRect(0,0,a,20,5),n.setText(`Wall Tiles Remaining: ${e}`),t.setVisible(!0)}update(){}getDragBounds(){const e=document.getElementById("parentdiv");return e?e.getBoundingClientRect():this.sys.canvas.getBoundingClientRect()}getClampedCommandBarPosition(e,t,i,n){const a=i.getBoundingClientRect(),o=(a.width||i.offsetWidth||0)/2,r=a.height||i.offsetHeight||0;let l=n.left+o+16,c=n.right-o-16;if(l>c){const y=n.left+n.width/2;l=y,c=y}let h=n.top+16,g=n.bottom-r-16;if(h>g){const y=n.top+n.height/2;h=y,g=y}const T=Math.min(Math.max(e,l),c),w=Math.min(Math.max(t,h),g);return{left:T,top:w}}getDefaultCommandBarPosition(e,t,i){const n=e.offsetWidth||0,s=e.offsetHeight||0,a=this.sys.canvas,o=a?t.width/a.width:1,r=a?t.height/a.height:1,l=Math.max(36*o,24),c=Math.max(140*r,120),h=t.right-n/2-l,g=t.bottom-s-c;return this.getClampedCommandBarPosition(h,g,e,i)}enableCommandBarDrag(){const e=document.getElementById("uicenterdiv"),t=this.sys.canvas;if(!e||!t)return;const i=document.documentElement.style;let n=!1,s=0,a=0;const o=c=>{if(!n)return;const h=this.getDragBounds(),g=e.getBoundingClientRect(),T=c.clientX-s+(g.width||e.offsetWidth||0)/2,w=c.clientY-a,{left:y,top:x}=this.getClampedCommandBarPosition(T,w,e,h);i.setProperty("--command-bar-left",`${y}px`),i.setProperty("--command-bar-top",`${x}px`),this.commandBarPosition={left:y,top:x},this.commandBarManualPosition=!0},r=c=>{if(n){n=!1,e.classList.remove("command-bar--dragging");try{e.releasePointerCapture(c.pointerId)}catch{}window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),window.removeEventListener("pointercancel",r)}},l=c=>{if(c.button!==0||c.target.closest("#buttondiv"))return;const h=e.getBoundingClientRect();s=c.clientX-h.left,a=c.clientY-h.top,n=!0,e.classList.add("command-bar--dragging");try{e.setPointerCapture(c.pointerId)}catch{}window.addEventListener("pointermove",o),window.addEventListener("pointerup",r),window.addEventListener("pointercancel",r),c.preventDefault()};e.addEventListener("pointerdown",l),this.events.once(p.Scenes.Events.SHUTDOWN,()=>{e.removeEventListener("pointerdown",l),window.removeEventListener("pointermove",o),window.removeEventListener("pointerup",r),window.removeEventListener("pointercancel",r)})}resize(e,t,i,n){const s=this.actionPanelEl||document.getElementById("uicenterdiv"),a=this.sys.canvas;if(!s||!a)return;this.actionPanelEl=s;const o=a.getBoundingClientRect(),r=this.getDragBounds(),l=document.documentElement.style;if(this.commandBarManualPosition&&this.commandBarPosition){const{left:g,top:T}=this.getClampedCommandBarPosition(this.commandBarPosition.left,this.commandBarPosition.top,s,r);this.commandBarPosition={left:g,top:T},l.setProperty("--command-bar-left",`${g}px`),l.setProperty("--command-bar-top",`${T}px`);return}const{left:c,top:h}=this.getDefaultCommandBarPosition(s,o,r);this.commandBarPosition={left:c,top:h},l.setProperty("--command-bar-left",`${c}px`),l.setProperty("--command-bar-top",`${h}px`)}createFireworksDisplay(e){return new Promise(t=>{if(!e.mahjong||e.winner!==0){t();return}const i=this.sys.game.canvas.width,n=this.sys.game.canvas.height,s=p.Math.Between(5,7),a=[];try{for(let r=0;r<s;r++){const l=p.Math.Between(100,i-100),c=p.Math.Between(100,n-200),h=this.add.particles(l,c,"particle",{speed:{min:200,max:400},angle:{min:0,max:360},lifespan:{min:1200,max:1800},gravityY:300,scale:{start:.8,end:0},alpha:{start:1,end:0},tint:[16773222,6737151,16737988,65382,16737792,13395711],blendMode:"ADD"});h.setDepth(300),a.push(h),this.time.delayedCall(r*300,()=>{const g=p.Math.Between(15,25);h.emitParticleAt(l,c,g)})}const o=(s-1)*300+2e3;this.time.delayedCall(o,()=>{a.forEach(r=>r.destroy()),t()})}catch(o){console.warn("[GameScene] Fireworks display failed:",o),a.forEach(r=>{try{r.destroy()}catch{}}),t()}})}updateGameControllerSettings(){!this.gameController||!window.settingsManager||(this.gameController.settings={...this.gameController.settings,skipCharleston:window.settingsManager.getSetting("skipCharleston",!1)||!1,trainingMode:window.settingsManager.getSetting("trainingMode",!1)||!1,trainingHand:window.settingsManager.getSetting("trainingHand","")||"",trainingTileCount:window.settingsManager.getSetting("trainingTileCount",13)||13})}populateTrainingForm(e){const t=document.getElementById("handSelect");if(t&&e.validHandGroups){t.innerHTML="";for(const n of e.validHandGroups){const s=document.createElement("optgroup");s.label=n.groupDescription,t.add(s);for(const a of n.hands){const o=document.createElement("option");o.text=a.description,t.add(o)}}}const i=document.getElementById("numTileSelect");if(i){i.innerHTML="";for(let n=1;n<=14;n++){const s=document.createElement("option");s.text=n,s.value=n,i.add(s)}i.selectedIndex=8}}}const Se=window.location.search.includes("playwright=true")||window.navigator.userAgent.includes("Playwright"),xe={type:Se?p.CANVAS:p.AUTO,width:E,height:D,transparent:!0,hideBanner:!0,parent:"gamediv",scene:[Ce],scale:{mode:p.Scale.FIT,autoCenter:p.Scale.CENTER_BOTH},render:{antialias:!0,mipmapFilter:"LINEAR_MIPMAP_LINEAR",powerPreference:"high-performance"}},Me=new p.Game(xe);window.game=Me;Ee();async function Ee(){if(!("serviceWorker"in navigator)){console.log("Service workers not supported");return}if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){console.log("Skipping service worker registration in development mode");return}try{const m=await navigator.serviceWorker.register("/mahjong/service-worker.js",{scope:"/mahjong/"});console.log("Service worker registered:",m),m.update(),m.addEventListener("updatefound",()=>{const e=m.installing;console.log("Service worker update found"),e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&(console.log("New service worker installed, ready to activate"),De(m))})})}catch(m){console.error("Service worker registration failed:",m)}}function De(m){const e=document.createElement("div");e.id="update-banner",e.innerHTML=`
        <div style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ffd166;
            color: #1f1400;
            padding: 12px;
            text-align: center;
            font-family: 'Courier New', monospace;
            z-index: 10001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        ">
            <strong>Update Available!</strong>
            <button onclick="location.reload()" style="
                margin-left: 16px;
                padding: 6px 16px;
                background: #044328;
                color: white;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-family: 'Courier New', monospace;
            ">Reload to Update</button>
        </div>
    `,document.body.appendChild(e),m.waiting&&m.waiting.postMessage({type:"SKIP_WAITING"})}
