const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/card2017-rTUffqN1.js","assets/GameController-B57f0Yu6.js","assets/card_test-CHgoUicD.js","assets/card2018-VfaFKqMx.js","assets/card_test-Tew7Z6JG.js","assets/card2019-CUYyqQIu.js","assets/card_test-B5ORVZH9.js","assets/card2020-CaUL017g.js","assets/card_test-BrpsfRmD.js","assets/card2025-DM20dX9_.js"])))=>i.map(i=>d[i]);
import{S as M,f as o,r as R,q as B,n as D,e as H,V as N,H as q,T as U,t as J,d as P,G as W}from"./GameController-B57f0Yu6.js";class F{constructor(){this.deferredPrompt=null,this.installBanner=null,this.init()}init(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,console.log("PWA install prompt captured"),this.checkShouldShowPrompt()}),window.addEventListener("appinstalled",()=>{console.log("PWA installed successfully"),this.markAsInstalled(),this.hidePrompt()}),this.createBannerUI()}checkShouldShowPrompt(){if(this.isAlreadyInstalled()){console.log("App already installed, skipping prompt");return}if(this.wasRecentlyDismissed()){console.log("User dismissed prompt recently, skipping");return}const e=this.getGamesPlayed();console.log(`Games played: ${e}`),e>=2&&setTimeout(()=>{this.showPrompt()},2e3)}getGamesPlayed(){return parseInt(localStorage.getItem("gamesPlayed")||"0",10)}static incrementGamesPlayed(){const e=parseInt(localStorage.getItem("gamesPlayed")||"0",10);localStorage.setItem("gamesPlayed",(e+1).toString()),console.log(`Games played: ${e+1}`)}isAlreadyInstalled(){return window.matchMedia("(display-mode: standalone)").matches?!0:localStorage.getItem("appInstalled")==="true"}wasRecentlyDismissed(){const e=localStorage.getItem("installPromptDismissedAt");if(!e)return!1;const t=parseInt(e,10),n=7*24*60*60*1e3;return Date.now()-t<n}markAsInstalled(){localStorage.setItem("appInstalled","true")}createBannerUI(){this.installBanner=document.createElement("div"),this.installBanner.id="install-banner",this.installBanner.className="install-banner",this.installBanner.style.display="none",this.installBanner.innerHTML=`
            <div class="install-banner__content">
                <div class="install-banner__icon">
                    <svg width="48" height="48" viewBox="0 0 64 64">
                        <rect x="4" y="4" width="56" height="56" rx="12" fill="#0c6d3a"/>
                        <rect x="15" y="15" width="34" height="34" rx="6" fill="rgba(4, 24, 14, 0.65)" stroke="#f5fbf7" stroke-width="2"/>
                        <rect x="19" y="19" width="26" height="26" rx="4" fill="#ffd166"/>
                    </svg>
                </div>
                <div class="install-banner__text">
                    <h3 class="install-banner__title">Install Mahjong</h3>
                    <p class="install-banner__message">Add to home screen for quick access</p>
                </div>
                <div class="install-banner__actions">
                    <button class="install-banner__btn install-banner__btn--install" id="install-btn">
                        Install
                    </button>
                    <button class="install-banner__btn install-banner__btn--dismiss" id="dismiss-btn">
                        Not Now
                    </button>
                </div>
            </div>
        `,document.body.appendChild(this.installBanner);const e=this.installBanner.querySelector("#install-btn"),t=this.installBanner.querySelector("#dismiss-btn");e.addEventListener("click",()=>this.handleInstall()),t.addEventListener("click",()=>this.handleDismiss()),this.injectStyles()}injectStyles(){const e=document.createElement("style");e.textContent=`
            .install-banner {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to top, rgba(4, 36, 21, 0.98), rgba(4, 36, 21, 0.95));
                backdrop-filter: blur(10px);
                border-top: 2px solid #ffd166;
                padding: 16px;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                animation: slideUp 0.3s ease-out;
            }

            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }

            .install-banner__content {
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 600px;
                margin: 0 auto;
            }

            .install-banner__icon {
                flex-shrink: 0;
            }

            .install-banner__text {
                flex: 1;
                min-width: 0;
            }

            .install-banner__title {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
                color: #f5fbf7;
                font-family: 'Courier New', monospace;
            }

            .install-banner__message {
                margin: 4px 0 0;
                font-size: 13px;
                color: rgba(245, 251, 247, 0.8);
                font-family: 'Courier New', monospace;
            }

            .install-banner__actions {
                display: flex;
                flex-direction: column;
                gap: 8px;
                flex-shrink: 0;
            }

            .install-banner__btn {
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                font-family: 'Courier New', monospace;
                cursor: pointer;
                transition: all 0.2s;
                min-width: 100px;
            }

            .install-banner__btn--install {
                background: #ffd166;
                color: #1f1400;
            }

            .install-banner__btn--install:hover {
                background: #ffda7a;
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(255, 209, 102, 0.4);
            }

            .install-banner__btn--dismiss {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(245, 251, 247, 0.9);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .install-banner__btn--dismiss:hover {
                background: rgba(255, 255, 255, 0.15);
            }

            /* Mobile responsive */
            @media (max-width: 480px) {
                .install-banner__content {
                    flex-wrap: wrap;
                }

                .install-banner__actions {
                    flex-direction: row;
                    width: 100%;
                    margin-top: 8px;
                }

                .install-banner__btn {
                    flex: 1;
                }
            }
        `,document.head.appendChild(e)}showPrompt(){if(!this.deferredPrompt){console.log("No deferred prompt available");return}this.installBanner.style.display="block",console.log("Install banner shown")}hidePrompt(){this.installBanner&&(this.installBanner.style.display="none")}async handleInstall(){if(!this.deferredPrompt){console.error("No deferred prompt available");return}this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;console.log(`Install prompt outcome: ${e}`),e==="accepted"?(console.log("User accepted install"),this.markAsInstalled()):(console.log("User dismissed install"),this.handleDismiss()),this.deferredPrompt=null,this.hidePrompt()}handleDismiss(){localStorage.setItem("installPromptDismissedAt",Date.now().toString()),console.log("Install prompt dismissed by user"),this.hidePrompt()}}class z{constructor(){this.sheet=null,this.settingsButton=null,this.isOpen=!1,this.createUI(),this.loadSettings(),this.attachEventListeners()}createUI(){const e=document.createElement("div");e.id="settings-overlay-mobile",e.className="settings-overlay-mobile";const t=document.createElement("div");t.id="settings-sheet",t.className="settings-sheet",t.innerHTML=`
            <div class="settings-sheet__header">
                <h2 class="settings-sheet__title">Settings</h2>
                <button class="settings-sheet__close" aria-label="Close settings">×</button>
            </div>

            <div class="settings-sheet__content">
                <!-- Game Settings Section -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Game</h3>

                    <div class="settings-item">
                        <label for="mobile-year">Card Year</label>
                        <select id="mobile-year" class="settings-select">
                            <option value="2025">2025</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                        </select>
                    </div>

                    <div class="settings-item">
                        <label for="mobile-difficulty">AI Difficulty</label>
                        <select id="mobile-difficulty" class="settings-select">
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>

                    <div class="settings-item settings-item--toggle">
                        <label for="mobile-blank-tiles">Use Blank Tiles</label>
                        <input type="checkbox" id="mobile-blank-tiles" class="settings-checkbox">
                    </div>
                </section>

                <!-- Audio Settings Section -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Audio</h3>

                    <div class="settings-item">
                        <label for="mobile-bgm-volume">
                            Music Volume
                            <span class="volume-value" id="mobile-bgm-value">70</span>
                        </label>
                        <div class="volume-control">
                            <input type="range" id="mobile-bgm-volume" class="settings-slider"
                                   min="0" max="100" step="1" value="70">
                            <label class="mute-toggle">
                                <input type="checkbox" id="mobile-bgm-mute">
                                <span>Mute</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label for="mobile-sfx-volume">
                            Sound Effects
                            <span class="volume-value" id="mobile-sfx-value">80</span>
                        </label>
                        <div class="volume-control">
                            <input type="range" id="mobile-sfx-volume" class="settings-slider"
                                   min="0" max="100" step="1" value="80">
                            <label class="mute-toggle">
                                <input type="checkbox" id="mobile-sfx-mute">
                                <span>Mute</span>
                            </label>
                        </div>
                    </div>
                </section>

                <!-- Training Mode Section (Optional) -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Training Mode</h3>

                    <div class="settings-item settings-item--toggle">
                        <label for="mobile-training-mode">Enable Training Mode</label>
                        <input type="checkbox" id="mobile-training-mode" class="settings-checkbox">
                    </div>

                    <div class="settings-item" id="mobile-training-controls" style="display: none;">
                        <label for="mobile-training-tiles">Starting Tiles</label>
                        <select id="mobile-training-tiles" class="settings-select">
                            <option value="9">9 tiles</option>
                            <option value="10">10 tiles</option>
                            <option value="11">11 tiles</option>
                            <option value="12">12 tiles</option>
                            <option value="13">13 tiles</option>
                            <option value="14">14 tiles</option>
                        </select>
                    </div>

                    <div class="settings-item settings-item--toggle" id="mobile-training-skip" style="display: none;">
                        <label for="mobile-skip-charleston">Skip Charleston</label>
                        <input type="checkbox" id="mobile-skip-charleston" class="settings-checkbox">
                    </div>
                </section>
            </div>

            <div class="settings-sheet__footer">
                <button class="settings-btn settings-btn--secondary" id="mobile-settings-reset">
                    Reset to Defaults
                </button>
                <button class="settings-btn settings-btn--primary" id="mobile-settings-save">
                    Save & Close
                </button>
            </div>
        `,e.appendChild(t),document.body.appendChild(e),this.sheet=t,this.overlay=e}loadSettings(){const e=M.load();document.getElementById("mobile-year").value=e.cardYear,document.getElementById("mobile-difficulty").value=e.difficulty,document.getElementById("mobile-blank-tiles").checked=e.useBlankTiles,document.getElementById("mobile-bgm-volume").value=e.bgmVolume,document.getElementById("mobile-bgm-value").textContent=e.bgmVolume,document.getElementById("mobile-bgm-mute").checked=e.bgmMuted,document.getElementById("mobile-sfx-volume").value=e.sfxVolume,document.getElementById("mobile-sfx-value").textContent=e.sfxVolume,document.getElementById("mobile-sfx-mute").checked=e.sfxMuted,document.getElementById("mobile-training-mode").checked=e.trainingMode,document.getElementById("mobile-training-tiles").value=e.trainingTileCount,document.getElementById("mobile-skip-charleston").checked=e.skipCharleston,this.updateTrainingVisibility(e.trainingMode)}attachEventListeners(){const e=document.getElementById("mobile-settings-btn");e&&e.addEventListener("click",()=>this.open()),this.sheet.querySelector(".settings-sheet__close").addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.close()}),document.getElementById("mobile-bgm-volume").addEventListener("input",t=>{document.getElementById("mobile-bgm-value").textContent=t.target.value}),document.getElementById("mobile-sfx-volume").addEventListener("input",t=>{document.getElementById("mobile-sfx-value").textContent=t.target.value}),document.getElementById("mobile-training-mode").addEventListener("change",t=>{this.updateTrainingVisibility(t.target.checked)}),document.getElementById("mobile-settings-save").addEventListener("click",()=>{this.saveSettings(),this.close()}),document.getElementById("mobile-settings-reset").addEventListener("click",()=>{window.confirm("Reset all settings to defaults?")&&(M.reset(),this.loadSettings())})}saveSettings(){const e={cardYear:parseInt(document.getElementById("mobile-year").value),difficulty:document.getElementById("mobile-difficulty").value,useBlankTiles:document.getElementById("mobile-blank-tiles").checked,bgmVolume:parseInt(document.getElementById("mobile-bgm-volume").value),bgmMuted:document.getElementById("mobile-bgm-mute").checked,sfxVolume:parseInt(document.getElementById("mobile-sfx-volume").value),sfxMuted:document.getElementById("mobile-sfx-mute").checked,trainingMode:document.getElementById("mobile-training-mode").checked,trainingTileCount:parseInt(document.getElementById("mobile-training-tiles").value),skipCharleston:document.getElementById("mobile-skip-charleston").checked,trainingHand:""};M.save(e),console.log("Settings saved:",e),window.dispatchEvent(new window.CustomEvent("settingsChanged",{detail:e}))}updateTrainingVisibility(e){const t=document.getElementById("mobile-training-controls"),n=document.getElementById("mobile-training-skip");t&&(t.style.display=e?"block":"none"),n&&(n.style.display=e?"flex":"none")}open(){this.isOpen=!0,this.overlay.classList.add("open"),this.sheet.classList.add("open"),document.body.style.overflow="hidden"}close(){this.isOpen=!1,this.overlay.classList.remove("open"),this.sheet.classList.remove("open"),document.body.style.overflow=""}}const Q={[o.CRACK]:"CRACK",[o.BAM]:"BAM",[o.DOT]:"DOT",[o.WIND]:"WIND",[o.DRAGON]:"DRAGON",[o.FLOWER]:"FLOWER",[o.JOKER]:"JOKER",[o.BLANK]:"BLANK"},Z={[R.NORTH]:"N",[R.SOUTH]:"S",[R.WEST]:"W",[R.EAST]:"E"},ee={[B.RED]:"R",[B.GREEN]:"G",[B.WHITE]:"0"};class te{constructor(e,t){if(!e)throw new Error("HandRenderer requires a container element");this.container=e,this.gameController=t,this.tiles=[],this.selectedIndices=new Set,this.selectionKeyByIndex=new Map,this.unsubscribeFns=[],this.interactive=!0,this.handContainer=null,this.exposedSection=null,this.currentHandData=null,this.setupDOM(),this.setupEventListeners()}setupDOM(){this.container.innerHTML="",this.container.classList.add("hand-section"),this.exposedSection=document.createElement("div"),this.exposedSection.className="exposed-section",this.container.appendChild(this.exposedSection),this.handContainer=document.createElement("div"),this.handContainer.className="hand-container hand-grid",this.container.appendChild(this.handContainer)}setupEventListeners(){if(!this.gameController||typeof this.gameController.on!="function")return;const e=(n={})=>{n.player===0&&this.render(n.hand)};this.unsubscribeFns.push(this.gameController.on("HAND_UPDATED",e));const t=(n={})=>{if(typeof n.index=="number"){this.selectTile(n.index,{toggle:n.toggle!==!1,clearOthers:!!n.exclusive,state:n.state});return}Array.isArray(n.indices)&&(n.clearExisting&&this.clearSelection(),n.indices.forEach(s=>{typeof s=="number"&&this.selectTile(s,{state:n.state??"on",toggle:!1})}))};this.unsubscribeFns.push(this.gameController.on("TILE_SELECTED",t))}render(e){if(!e){this.renderExposures([]),this.clearTiles(),this.currentHandData=null;return}this.currentHandData=e,this.renderExposures(Array.isArray(e.exposures)?e.exposures:[]),this.clearTiles();const t=new Set;this.selectionKeyByIndex.clear(),(Array.isArray(e.tiles)?e.tiles:[]).forEach((s,i)=>{const r=this.getTileSelectionKey(s,i);this.selectionKeyByIndex.set(i,r);const l=this.createTileButton(s,i,r);this.selectedIndices.has(r)&&(l.classList.add("selected"),t.add(r)),this.tiles.push(l),this.handContainer.appendChild(l)}),this.selectedIndices=t,this.setInteractive(this.interactive)}renderExposures(e){this.exposedSection&&(this.exposedSection.innerHTML="",!(!Array.isArray(e)||e.length===0)&&e.forEach(t=>{if(!t||!Array.isArray(t.tiles))return;const n=document.createElement("div");n.className="exposure-set",t.type&&(n.dataset.type=t.type),t.tiles.forEach(s=>{const i=document.createElement("button");i.type="button",i.className="exposed-tile",i.dataset.suit=this.getSuitName(s==null?void 0:s.suit),i.dataset.number=this.getDataNumber(s),i.textContent=this.formatTileText(s),n.appendChild(i)}),this.exposedSection.appendChild(n)}))}clearTiles(){this.tiles.forEach(e=>{const t=e.__handRendererHandler;t&&(e.removeEventListener("click",t),delete e.__handRendererHandler)}),this.tiles=[],this.selectionKeyByIndex.clear(),this.handContainer&&(this.handContainer.innerHTML="")}createTileButton(e,t,n){const s=document.createElement("button");s.type="button",s.className="tile-btn",s.dataset.suit=this.getSuitName(e==null?void 0:e.suit),s.dataset.number=this.getDataNumber(e),s.dataset.selectionKey=n,s.textContent=this.formatTileText(e),s.disabled=!this.interactive;const i=r=>{r.preventDefault(),r.stopPropagation(),this.interactive&&this.selectTile(t)};return s.__handRendererHandler=i,s.addEventListener("click",i),s}selectTile(e,t={}){const n=this.tiles[e];if(!n)return;const s=this.selectionKeyByIndex.get(e);if(!s)return;const{state:i,toggle:r=!0,clearOthers:l=!1}=t;l&&this.clearSelection();let c;i==="on"?c=!0:i==="off"?c=!1:r?c=!this.selectedIndices.has(s):c=!0,c?(this.selectedIndices.add(s),n.classList.add("selected")):(this.selectedIndices.delete(s),n.classList.remove("selected"))}clearSelection(){this.selectedIndices.clear(),this.tiles.forEach(e=>e.classList.remove("selected"))}sortHand(e="suit"){var n;if(!this.currentHandData)return;if(typeof((n=this.gameController)==null?void 0:n.sortHand)=="function"){this.gameController.sortHand(0,e);return}const t=this.cloneHandData(this.currentHandData);t&&(e==="rank"?typeof t.sortByRank=="function"?t.sortByRank():Array.isArray(t.tiles)&&t.tiles.sort((s,i)=>s.number!==i.number?s.number-i.number:s.suit-i.suit):typeof t.sortBySuit=="function"?t.sortBySuit():Array.isArray(t.tiles)&&t.tiles.sort((s,i)=>s.suit!==i.suit?s.suit-i.suit:s.number-i.number),this.render(t))}setInteractive(e){this.interactive=!!e,this.tiles.forEach(t=>{t.disabled=!this.interactive})}destroy(){this.unsubscribeFns.forEach(e=>{typeof e=="function"&&e()}),this.unsubscribeFns=[],this.clearTiles(),this.clearSelection(),this.exposedSection&&(this.exposedSection.innerHTML=""),this.container=null,this.gameController=null,this.handContainer=null,this.exposedSection=null,this.currentHandData=null}getSuitName(e){return Q[e]||"UNKNOWN"}getDataNumber(e){return!e||typeof e.number>"u"?"":String(e.number)}formatTileText(e){if(!e)return"";const{suit:t,number:n}=e;return t===o.CRACK?`${n}C`:t===o.BAM?`${n}B`:t===o.DOT?`${n}D`:t===o.WIND?Z[n]||"":t===o.DRAGON?ee[n]||"D":t===o.FLOWER?`F${typeof n=="number"?n+1:1}`:t===o.JOKER?"J":t===o.BLANK?"BL":`${n??""}`}getTileSelectionKey(e,t){return e?typeof e.index=="number"&&e.index>=0?`idx-${e.index}`:`${e.suit}:${e.number}:${t}`:`missing-${t}`}cloneHandData(e){return e?typeof e.clone=="function"?e.clone():{tiles:Array.isArray(e.tiles)?e.tiles.map(t=>({...t})):[],exposures:Array.isArray(e.exposures)?e.exposures.map(t=>({type:t==null?void 0:t.type,tiles:Array.isArray(t==null?void 0:t.tiles)?t.tiles.map(n=>({...n})):[]})):[]}:null}}class ne{constructor(e,t){this.container=e,this.playerData=t,this.element=null,this.render()}render(){this.element=document.createElement("div"),this.element.className="opponent-bar",this.element.dataset.player=this.playerData.position,this.element.innerHTML=`
            <div class="opponent-info">
                <span class="opponent-name"></span>
                <span class="tile-count"></span>
            </div>
            <div class="exposures"></div>
        `,this.container.appendChild(this.element),this.update(this.playerData)}update(e){if(!this.element)return;this.playerData=e;const t=this.element.querySelector(".opponent-name");t.textContent=`${e.name} (${this.getPositionName(e.position)})`;const n=this.element.querySelector(".tile-count"),s=e.tileCount;n.textContent=`${s} tile${s!==1?"s":""}`,this.updateExposures(e.exposures),this.setCurrentTurn(e.isCurrentTurn)}getPositionName(e){return["Bottom","East","North","West"][e]||"Unknown"}updateExposures(e){const t=this.element.querySelector(".exposures");t.innerHTML="",!(!e||e.length===0)&&e.forEach(n=>{const s=document.createElement("span");s.className=`exposure-icon ${n.type.toLowerCase()}`,s.textContent=this.getExposureLabel(n.type),s.title=this.getExposureTooltip(n),t.appendChild(s)})}getExposureLabel(e){return{PUNG:"P",KONG:"K",QUINT:"Q"}[e]||"?"}getExposureTooltip(e){const t=e.tiles.map(n=>n.getText()).join(", ");return`${e.type}: ${t}`}setCurrentTurn(e){this.element&&(e?this.element.classList.add("current-turn"):this.element.classList.remove("current-turn"))}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}}class se{constructor(e,t){this.container=e,this.gameController=t,this.discards=[],this.element=null,this.eventUnsubscribers=[],this.render(),this.setupEventListeners()}render(){this.element=document.createElement("div"),this.element.className="discard-pile",this.container.appendChild(this.element)}setupEventListeners(){this.eventUnsubscribers.push(this.gameController.on("TILE_DISCARDED",e=>{const t=D.fromJSON(e.tile);this.addDiscard(t,e.player)})),this.eventUnsubscribers.push(this.gameController.on("DISCARD_CLAIMED",()=>{this.removeLatestDiscard()})),this.eventUnsubscribers.push(this.gameController.on("GAME_STARTED",()=>{this.clear()}))}addDiscard(e,t){this.discards.push({tile:e,player:t});const n=this.createDiscardTile(e,t);this.element.appendChild(n),this.highlightLatest(n),this.scrollToBottom()}createDiscardTile(e,t){const n=document.createElement("div");return n.className="discard-tile",n.dataset.player=t,n.title=`Discarded by ${this.getPlayerName(t)}`,n.innerHTML=`
            <div class="discard-tile-face">
                <span class="tile-text">${this.getTileText(e)}</span>
            </div>
        `,n.addEventListener("click",()=>{this.showDiscardInfo(e,t)}),n}getTileText(e){return e.getText()}getPlayerName(e){return["You","Opponent 1","Opponent 2","Opponent 3"][e]||"Unknown"}highlightLatest(e){this.element.querySelectorAll(".discard-tile").forEach(t=>{t.classList.remove("latest")}),e.classList.add("latest")}removeLatestDiscard(){if(this.discards.length>0){this.discards.pop();const e=this.element.querySelector(".discard-tile:last-child");e&&e.remove()}}showDiscardInfo(e,t){alert(`${e.getText()}
Discarded by: ${this.getPlayerName(t)}`)}scrollToBottom(){this.element.scrollTop=this.element.scrollHeight}clear(){this.discards=[],this.element.innerHTML=""}destroy(){this.eventUnsubscribers.forEach(e=>e()),this.eventUnsubscribers=[],this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}}const O=["tile-drawing","tile-discarding","tile-claiming-pulse","tile-claiming-move","tile-exposing"],G=["turn-starting","turn-ending"],K="hand-sorting",V="invalid-action",ie=[{x:0,y:0},{x:90,y:-60},{x:0,y:-140},{x:-90,y:-60}],oe=500,re=400,ae=600,le=300,ce=500,j=50,de=16,v=(f,e=0)=>`${typeof f=="number"&&!Number.isNaN(f)?f:e}px`,ue=f=>f?Array.isArray(f)?f.filter(Boolean):Array.from(f).filter(Boolean):[];class me{constructor(e={}){this.duration=typeof e.duration=="number"?e.duration:300,this.easing=e.easing||"ease-out",this.prefersReducedMotion=typeof window<"u"&&typeof window.matchMedia=="function"?window.matchMedia("(prefers-reduced-motion: reduce)").matches:!1,this._elementTimers=new WeakMap}animateTileDraw(e,t={},n={}){return new Promise(s=>{if(!e){s();return}this._resetElementAnimation(e,O);const i={"--start-x":v(t.x,0),"--start-y":v(t.y,-200),"--end-x":v(n.x,0),"--end-y":v(n.y,0),"--tile-draw-duration":`${this.duration}ms`,"--tile-draw-easing":this.easing};this._setCssVariables(e,i),this._applyAnimationClass(e,"tile-drawing"),this._scheduleTimer(e,this.duration,()=>{e.classList.remove("tile-drawing"),this._clearCssVariables(e,Object.keys(i)),s()})})}animateTileDiscard(e,t={}){return new Promise(n=>{if(!e){n();return}this._resetElementAnimation(e,O);const s=this.duration+100,i={"--start-x":v(0),"--start-y":v(0),"--target-x":v(t.x,0),"--target-y":v(t.y,100),"--tile-discard-duration":`${s}ms`,"--tile-discard-easing":"ease-in"};this._setCssVariables(e,i),this._applyAnimationClass(e,"tile-discarding"),this._scheduleTimer(e,s,()=>{e.classList.remove("tile-discarding"),this._clearCssVariables(e,Object.keys(i)),n()})})}animateTileClaim(e,t=0,n={}){return new Promise(s=>{if(!e){s();return}this._resetElementAnimation(e,O);const i=ie[t]||{x:0,y:-200},r={"--claim-offset-x":v(i.x,0),"--claim-offset-y":v(i.y,-200),"--target-x":v(n.x,0),"--target-y":v(n.y,0),"--tile-claim-duration":`${this.duration}ms`};this._setCssVariables(e,r),this._applyAnimationClass(e,"tile-claiming-pulse"),this._scheduleTimer(e,oe,()=>{e.classList.remove("tile-claiming-pulse"),this._applyAnimationClass(e,"tile-claiming-move"),this._scheduleTimer(e,this.duration,()=>{e.classList.remove("tile-claiming-move"),this._clearCssVariables(e,Object.keys(r)),s()})})})}animateTurnStart(e){return this._runSimpleAnimation(e,"turn-starting",ae)}animateTurnEnd(e){return this._runSimpleAnimation(e,"turn-ending",le)}animateHandSort(e){return this._runSimpleAnimation(e,K,re)}animateExposure(e,t={}){const n=ue(e);return new Promise(s=>{if(!n.length){s();return}n.forEach((l,c)=>{this._resetElementAnimation(l,O);const d={"--target-x":v(t.x,0),"--target-y":v(t.y,0)};this._setCssVariables(l,d),l.style.animationDelay=this.prefersReducedMotion?"0ms":`${c*j}ms`,this._applyAnimationClass(l,"tile-exposing")});const i=this.duration+n.length*j,r=n[0];this._scheduleTimer(r,i,()=>{n.forEach(l=>{l.classList.remove("tile-exposing"),l.style.animationDelay="",this._clearCssVariables(l,["--target-x","--target-y"])}),s()})})}animateInvalidAction(e){return this._runSimpleAnimation(e,V,ce)}_runSimpleAnimation(e,t,n){return new Promise(s=>{if(!e){s();return}const i=[];G.includes(t)?i.push(...G):t===K?i.push(K):t===V&&i.push(V),this._resetElementAnimation(e,i),this._applyAnimationClass(e,t),this._scheduleTimer(e,n,()=>{e.classList.remove(t),s()})})}_resetElementAnimation(e,t=[]){e&&(this._cancelTimers(e),t.forEach(n=>e.classList.remove(n)))}_setCssVariables(e,t={}){!e||!e.style||Object.entries(t).forEach(([n,s])=>{s==null?e.style.removeProperty(n):e.style.setProperty(n,s)})}_clearCssVariables(e,t=[]){!e||!e.style||t.forEach(n=>e.style.removeProperty(n))}_applyAnimationClass(e,t){e&&(e.classList.remove(t),e.offsetWidth,e.classList.add(t))}_scheduleTimer(e,t,n){const s=this.prefersReducedMotion?Math.min(t,de):t,i=setTimeout(()=>{this._deregisterTimer(e,i),n()},s);return this._registerTimer(e,i),i}_registerTimer(e,t){if(!e)return;let n=this._elementTimers.get(e);n||(n=new Set,this._elementTimers.set(e,n)),n.add(t)}_deregisterTimer(e,t){if(!e)return;const n=this._elementTimers.get(e);n&&(n.delete(t),n.size===0&&this._elementTimers.delete(e))}_cancelTimers(e){if(!e)return;const t=this._elementTimers.get(e);t&&(t.forEach(n=>clearTimeout(n)),this._elementTimers.delete(e))}}const S={IDLE:"idle",TOUCHING:"touching",MOVED:"moved"};class he{constructor(e,t={}){this.rootElement=e,this.options={tapMaxDuration:300,tapMaxMovement:10,doubleTapWindow:500,doubleTapDistance:20,longPressDuration:500,swipeMinDistance:50,enableDoubleTap:!1,enableLongPress:!1,enableSwipe:!1,...t},this.listeners={tap:[],doubletap:[],longpress:[],swipeup:[]},this.state=this.createInitialState(),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleTouchCancel=this.handleTouchCancel.bind(this)}createInitialState(){return{current:S.IDLE,startTime:null,startX:null,startY:null,currentX:null,currentY:null,element:null,lastTapTime:null,lastTapX:null,lastTapY:null,longPressTimer:null}}init(){this.rootElement.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.rootElement.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.rootElement.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),this.rootElement.addEventListener("touchcancel",this.handleTouchCancel,{passive:!1})}on(e,t){if(!this.listeners[e])throw new Error(`Unknown gesture type: ${e}`);this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(n=>n!==t))}emit(e,t){t.element&&!document.body.contains(t.element)||this.listeners[e]&&this.listeners[e].forEach(n=>n(t))}destroy(){this.rootElement.removeEventListener("touchstart",this.handleTouchStart),this.rootElement.removeEventListener("touchmove",this.handleTouchMove),this.rootElement.removeEventListener("touchend",this.handleTouchEnd),this.rootElement.removeEventListener("touchcancel",this.handleTouchCancel),clearTimeout(this.state.longPressTimer)}getElementAtPoint(e,t){return document.elementFromPoint(e,t)}resetState(){clearTimeout(this.state.longPressTimer),this.state=this.createInitialState()}handleTouchStart(e){if(e.touches.length>1){this.resetState();return}const t=e.touches[0];this.state.current=S.TOUCHING,this.state.startTime=Date.now(),this.state.startX=t.clientX,this.state.startY=t.clientY,this.state.currentX=t.clientX,this.state.currentY=t.clientY,this.state.element=this.getElementAtPoint(t.clientX,t.clientY),this.options.enableLongPress&&(this.state.longPressTimer=setTimeout(()=>{this.state.current===S.TOUCHING&&Math.sqrt(Math.pow(this.state.currentX-this.state.startX,2)+Math.pow(this.state.currentY-this.state.startY,2))<this.options.tapMaxMovement&&(this.emit("longpress",{type:"longpress",element:this.state.element,coordinates:{x:this.state.startX,y:this.state.startY},timestamp:Date.now()}),this.resetState())},this.options.longPressDuration))}handleTouchMove(e){if(this.state.current===S.IDLE)return;const t=e.touches[0];this.state.currentX=t.clientX,this.state.currentY=t.clientY;const n=this.state.currentX-this.state.startX,s=this.state.currentY-this.state.startY;Math.sqrt(n*n+s*s)>this.options.tapMaxMovement&&(this.state.current=S.MOVED,clearTimeout(this.state.longPressTimer))}handleTouchEnd(e){if(this.state.current===S.IDLE)return;const t=e.changedTouches[0],n=Date.now()-this.state.startTime,s=Math.abs(t.clientX-this.state.startX),i=Math.abs(t.clientY-this.state.startY),r=Math.sqrt(s*s+i*i);clearTimeout(this.state.longPressTimer),this.state.current===S.TOUCHING&&n<this.options.tapMaxDuration&&r<this.options.tapMaxMovement?(this.emit("tap",{type:"tap",element:this.state.element,coordinates:{x:t.clientX,y:t.clientY},timestamp:Date.now(),target:e.target}),this.options.enableDoubleTap?this.checkDoubleTap(t.clientX,t.clientY):this.resetState()):this.state.current===S.MOVED?this.resetState():this.resetState()}handleTouchCancel(e){this.resetState()}checkDoubleTap(e,t){const n=Date.now(),s=this.state.lastTapTime,i=this.state.lastTapX,r=this.state.lastTapY,l=this.state.element;if(this.resetState(),s!==null){const c=n-s,d=Math.abs(e-i),u=Math.abs(t-r),a=Math.sqrt(d*d+u*u);if(c<this.options.doubleTapWindow&&a<this.options.doubleTapDistance){this.emit("doubletap",{type:"doubletap",element:l,coordinates:{x:e,y:t},timestamp:n});return}}this.state.lastTapTime=n,this.state.lastTapX=e,this.state.lastTapY=t}}const k={KEEP:"KEEP",PASS:"PASS",DISCARD:"DISCARD"};class pe{constructor(e,t,n="medium"){this.card=e,this.tableData=t,this.difficulty=n,this.config=this.getDifficultyConfig(n)}getDifficultyConfig(e){const t={easy:{maxPatterns:2,minDiscardable:5,exposureThreshold:70,courtesyThresholds:[55,65,75],charlestonContinueThreshold:.8,blankExchangeRank:999,blankExchangeGain:999,jokerTopHands:1,jokerRankThreshold:60,jokerScaling:.8,discardRandomness:.3},medium:{maxPatterns:5,minDiscardable:4,exposureThreshold:55,courtesyThresholds:[50,60,68],charlestonContinueThreshold:.65,blankExchangeRank:85,blankExchangeGain:25,jokerTopHands:2,jokerRankThreshold:55,jokerScaling:.9,discardRandomness:.1},hard:{maxPatterns:999,minDiscardable:3,exposureThreshold:45,courtesyThresholds:[45,55,65],charlestonContinueThreshold:.6,blankExchangeRank:80,blankExchangeGain:20,jokerTopHands:3,jokerRankThreshold:50,jokerScaling:1,discardRandomness:0}};return t[e]||t.medium}calculateTileNeeds(e,t){const n=new Map;for(const s of t){const i=new Map;for(const r of s.componentInfoArray)for(const l of r.tileArray){const c=`${l.suit}-${l.number}`;i.set(c,(i.get(c)||0)+1)}for(const[r,l]of i.entries()){n.has(r)||n.set(r,{needed:0,have:0});const c=n.get(r);c.needed=Math.max(c.needed,l)}}for(const s of e){if(s.suit===o.JOKER||s.suit===o.BLANK)continue;const i=`${s.suit}-${s.number}`;n.has(i)||n.set(i,{needed:0,have:0}),n.get(i).have++}for(const s of n.values())s.needed=Math.min(s.needed,s.have);return n}countDiscardableTiles(e,t){const n=this.calculateTileNeeds(e,t);let s=0;for(const i of e){if(i.suit===o.JOKER||i.suit===o.BLANK)continue;const r=`${i.suit}-${i.number}`,l=n.get(r);(!l||l.needed===0)&&s++}return s}getTileRecommendations(e){const t=[],s=[...this.card.rankHandArray14(e)].sort((d,u)=>u.rank-d.rank),i=e.getTileArray();let r=s.length;for(this.config.maxPatterns<999&&(r=Math.min(r,this.config.maxPatterns));r>1;){const d=s.slice(0,r);if(this.countDiscardableTiles(i,d)>=this.config.minDiscardable)break;r--}r===0&&(r=1);const l=s.slice(0,r),c=this.calculateTileNeeds(i,l);for(const d of i){let u=k.DISCARD;if(d.suit===o.JOKER||d.suit===o.BLANK)u=k.KEEP;else{const a=`${d.suit}-${d.number}`,p=c.get(a);p&&p.needed>0&&(u=k.KEEP,p.needed--)}t.push({tile:d,recommendation:u})}return t.sort((d,u)=>{const a={[k.KEEP]:0,[k.PASS]:1,[k.DISCARD]:2},p=a[d.recommendation]-a[u.recommendation];if(p===0){const m=d.tile.suit===o.JOKER||d.tile.suit===o.BLANK?1:0;return(u.tile.suit===o.JOKER||u.tile.suit===o.BLANK?1:0)-m}return p}),{recommendations:t,consideredPatternCount:r}}chooseDiscard(e){const n=this.getTileRecommendations(e).recommendations;let s=null;const i=n.filter(r=>r.recommendation==="DISCARD"&&r.tile.suit!==o.BLANK);if(this.config.discardRandomness>0&&Math.random()<this.config.discardRandomness&&i.length>0){const r=Math.floor(Math.random()*Math.min(3,i.length));s=i[r].tile}else for(let r=n.length-1;r>=0;r--){const l=n[r].tile;if(l.suit!==o.BLANK){s=l;break}}return!s&&n.length>0&&(s=n[n.length-1].tile),s}claimDiscard(e,t,n,s=!1){const i=n.clone();if(i.addTile(e.clone()),this.card.validateHand14(i).valid)return{playerOption:H.MAHJONG,tileArray:null};const l=this.card.rankHandArray14(i);this.card.sortHandRankArray(l);const c=l[0],d=n.exposures.length>0,u=s||c.rank>this.config.exposureThreshold;if(d||!c.hand.concealed&&u){let a=null;e:for(const p of c.componentInfoArray)for(const m of p.tileArray)if(m.equals(e)){a=p;break e}if(a&&this.validateComponentForExposure(a))return{playerOption:H.EXPOSE_TILES,tileArray:a.tileArray}}return{playerOption:H.DISCARD_TILE,tileArray:[e]}}validateComponentForExposure(e){return!(e.component.count<3||e.tileArray.length!==e.component.count)}charlestonPass(e){const t=[],n=e.clone(),s=new D(o.INVALID,N.INVALID);n.addTile(s);const l=this.getTileRecommendations(n).recommendations.filter(c=>!c.tile.equals(s)&&c.tile.suit!==o.JOKER&&c.tile.suit!==o.BLANK);l.sort((c,d)=>{const u={[k.DISCARD]:0,[k.PASS]:1,[k.KEEP]:2};return u[c.recommendation]-u[d.recommendation]});for(let c=0;c<3;c++)if(l.length>c){const d=l[c].tile;t.push(d)}return t}courtesyVote(e){const t=e.clone(),n=new D(o.INVALID,N.INVALID);t.addTile(n);const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s);const r=s[0].rank;this.card.printHandRankArray(s,1);const l=this.config.courtesyThresholds;return r<l[0]?3:r<l[1]?2:r<l[2]?1:0}charlestonContinueVote(e){const t=e.clone(),n=new D(o.INVALID,N.INVALID);t.addTile(n);const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s);const r=s[0].rank,l=this.config.charlestonContinueThreshold||.7;let c=l;const d=this.config.courtesyThresholds;return r>=d[2]?c=l+.2:r>=d[1]?c=l+.1:r>=d[0]?c=l:c=Math.max(l-.2,.3),Math.random()<c}courtesyPass(e,t){const s=this.getTileRecommendations(e).recommendations,i=[];for(let r=s.length-1;r>=0&&i.length<t;r--){const l=s[r].tile;l.suit===o.JOKER||l.suit===o.BLANK||i.push(l)}return i}exchangeTilesForJokers(e,t){if(!t||t.length===0)return{shouldExchange:!1,tile:null};const n=this.card.rankHandArray14(e),s=[...n].sort((c,d)=>d.rank-c.rank);let i=-1e5,r=null;const l=e.tiles;for(let c=0;c<l.length;c++){const d=l[c];let u=!1;for(const b of t)if(d.suit===b.suit&&d.number===b.number){u=!0;break}if(!u)continue;const a=e.clone();a.tiles[c]=new D(o.JOKER,0);const p=this.card.rankHandArray14(a);let m=0;const h=Math.min(this.config.jokerTopHands,s.length);for(let b=0;b<h;b++){const g=s[b],y=n.indexOf(g);let C=1;g.rank>this.config.jokerRankThreshold&&(C=Math.min(g.rank*this.config.jokerScaling,100)),m+=(p[y].rank-n[y].rank)*C}m>i&&(i=m,r=d)}return r&&i>0?{shouldExchange:!0,tile:r}:{shouldExchange:!1,tile:null}}}const fe="modulepreload",ge=function(f){return"/mahjong/"+f},Y={},_=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),l=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=Promise.allSettled(t.map(c=>{if(c=ge(c),c in Y)return;Y[c]=!0;const d=c.endsWith(".css"),u=d?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${u}`))return;const a=document.createElement("link");if(a.rel=d?"stylesheet":fe,d||(a.as="script"),a.crossOrigin="",a.href=c,l&&a.setAttribute("nonce",l),document.head.appendChild(a),d)return new Promise((p,m)=>{a.addEventListener("load",p),a.addEventListener("error",()=>m(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(r){const l=new Event("vite:preloadError",{cancelable:!0});if(l.payload=r,window.dispatchEvent(l),!l.defaultPrevented)throw r}return s.then(r=>{for(const l of r||[])l.status==="rejected"&&i(l.reason);return e().catch(i)})},ye=(f,e,t)=>{const n=f[e];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((s,i)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(i.bind(null,new Error("Unknown variable dynamic import: "+e+(e.split("/").length!==t?". Note that variables only represent file names one level deep.":""))))})};class be{constructor(e){this.year=e,this.validHandGroups=null}async init(){const e=this.year,{validHandGroups:t}=await ye(Object.assign({"./2017/card2017.js":()=>_(()=>import("./card2017-rTUffqN1.js"),__vite__mapDeps([0,1])),"./2017/card_test.js":()=>_(()=>import("./card_test-CHgoUicD.js"),__vite__mapDeps([2,1])),"./2018/card2018.js":()=>_(()=>import("./card2018-VfaFKqMx.js"),__vite__mapDeps([3,1])),"./2018/card_test.js":()=>_(()=>import("./card_test-Tew7Z6JG.js"),__vite__mapDeps([4,1])),"./2019/card2019.js":()=>_(()=>import("./card2019-CUYyqQIu.js"),__vite__mapDeps([5,1])),"./2019/card_test.js":()=>_(()=>import("./card_test-B5ORVZH9.js"),__vite__mapDeps([6,1])),"./2020/card2020.js":()=>_(()=>import("./card2020-CaUL017g.js"),__vite__mapDeps([7,1])),"./2020/card_test.js":()=>_(()=>import("./card_test-BrpsfRmD.js"),__vite__mapDeps([8,1])),"./2025/card2025.js":()=>_(()=>import("./card2025-DM20dX9_.js"),__vite__mapDeps([9,1]))}),`./${e}/card${e}.js`,3);this.validHandGroups=t}generateHand(e,t){let n=t;const s=[o.CRACK,o.BAM,o.DOT],i=new q(!1);let r=null;n||(n=14);e:for(const d of this.validHandGroups)for(const u of d.hands)if(u.description.valueOf()===e.valueOf()){r=u;break e}if(!r)return i;const l=[];for(let d=0;d<r.components.length;d++)l.push(0);let c=0;for(let d=0;d<n;d++){const u=r.components[c];let a=u.suit,p=u.number;if(l[c]>=4)i.insertHidden(new U(o.JOKER,0));else{let h=1;i.even&&(h=2),a>=o.VSUIT1_DRAGON?(p=s[a-o.VSUIT1_DRAGON],a=o.DRAGON):a>=o.VSUIT1&&(a=s[a-o.VSUIT1],p>9&&(p=h+p-N.CONSECUTIVE1)),i.insertHidden(new U(a,p))}l[c]++;let m=!1;for(let h=0;h<r.components.length;h++)if(c++,c>=r.components.length&&(c=0),l[c]<r.components[c].count){m=!0;break}if(!m)break}return i}validateHand14(e){const t=e.getTileArray();return this.validateHand(t,e.isAllHidden())}diagnoseInvalidHand(e){const t=this.rankHandArray14(e);this.sortHandRankArray(t);const n=t[0],s=new Set;for(const c of n.componentInfoArray)for(const d of c.tileArray)s.add(d);const i=[];i.push(...e.getHiddenTileArray());for(const c of e.exposedTileSetArray)i.push(...c.tileArray);const r=[],l=[];for(const c of i)s.has(c)?r.push(c):l.push(c);return{closestHand:n.hand.description,closestGroup:n.group.groupDescription,rank:n.rank,matchingTiles:r,nonMatchingTiles:l}}validateHand13(e,t){const n=e.getTileArray();return t&&n.push(t),this.validateHand(n,e.isAllHidden())}validateHand(e,t){const n=e.filter(r=>r.suit!==o.BLANK);if(n.length!==14)return{valid:!1,tileCount:e.length,numJokers:0,minNumLow:9999,minNumHigh:9999,suits:[],allHidden:t};const s={valid:!1,tileCount:0,numJokers:0,minNumLow:9999,minNumHigh:9999,suits:[],allHidden:t};for(const r of n){let l=r.suit;l===o.DRAGON&&(l=r.number),s.suits.indexOf(l)===-1&&s.suits.push(l),l===o.JOKER&&s.numJokers++}s.minNumLow=9999,s.minNumHigh=9999;for(const r of n)(r.suit===o.CRACK||r.suit===o.BAM||r.suit===o.DOT)&&r.number<s.minNumHigh&&(s.minNumHigh=r.number);if(s.numJokers>=3?s.minNumLow=1:s.minNumLow=s.minNumHigh,s.tileCount=n.length,s.tileCount!==14)return s;let i=!1;e:for(const r of this.validHandGroups)for(const l of r.hands)if(J("Match hand: "+l.description+`
`),this.matchHand(n,s,r,l)){i=!0;break e}return i&&(s.valid=!0),s}matchHand(e,t,n,s){let i=!1;if(s.concealed&&!t.allHidden||t.suits.length<s.vsuitCount)return!1;const r=[[-1,-1,-1]],l=[[o.CRACK,-1,-1],[o.BAM,-1,-1],[o.DOT,-1,-1]],c=[[o.CRACK,o.BAM,-1],[o.CRACK,o.DOT,-1],[o.BAM,o.CRACK,-1],[o.BAM,o.DOT,-1],[o.DOT,o.CRACK,-1],[o.DOT,o.BAM,-1]],d=[[o.CRACK,o.BAM,o.DOT],[o.CRACK,o.DOT,o.BAM],[o.BAM,o.CRACK,o.DOT],[o.BAM,o.DOT,o.CRACK],[o.DOT,o.CRACK,o.BAM],[o.DOT,o.BAM,o.CRACK]];let u=null;switch(s.vsuitCount){case 1:u=l;break;case 2:u=c;break;case 3:u=d;break;default:u=r;break}for(let a=t.minNumLow;a<=t.minNumHigh;a++){for(const p of u)if(i=this.matchComponents(e,t,s,p,a),i)break;if(i)break}return i}matchComponents(e,t,n,s,i){let r=!0;if(i!==9999&&(n.even&&i&1||n.odd&&!(i&1)))return!1;const l=[];for(const c of e)l.push(c);for(const c of n.components){let d=0,u=c.suit,a=c.number;u>=o.VSUIT1_DRAGON?(a=s[u-o.VSUIT1_DRAGON],u=o.DRAGON):u>=o.VSUIT1&&(u=s[u-o.VSUIT1],a>9&&(a=i+a-N.CONSECUTIVE1));let p=!1;do{p=!1;for(const m of l)if(m.suit===u&&m.number===a){p=!0;const h=l.indexOf(m);l.splice(h,1),d++;break}if(!p&&c.count>2){for(const m of l)if(m.suit===o.JOKER){p=!0;const h=l.indexOf(m);l.splice(h,1),d++;break}}}while(p&&d<c.count);if(d!==c.count){r=!1;break}}return r}printValidationInfo(e){}rankHandArray14(e){const t=[];for(const n of this.validHandGroups)for(const s of n.hands){const i={group:n,hand:s,rank:0,componentInfoArray:[],vsuitArray:null};t.push(i),this.rankHand(e,i,s)}return t}rankHand(e,t,n){if(n.concealed&&!e.isAllHidden()){t.rank=0;return}const s=[[-1,-1,-1]],i=[[o.CRACK,-1,-1],[o.BAM,-1,-1],[o.DOT,-1,-1]],r=[[o.CRACK,o.BAM,-1],[o.CRACK,o.DOT,-1],[o.BAM,o.CRACK,-1],[o.BAM,o.DOT,-1],[o.DOT,o.CRACK,-1],[o.DOT,o.BAM,-1]],l=[[o.CRACK,o.BAM,o.DOT],[o.CRACK,o.DOT,o.BAM],[o.BAM,o.CRACK,o.DOT],[o.BAM,o.DOT],o.CRACK,[o.DOT,o.CRACK,o.BAM],[o.DOT,o.BAM,o.CRACK]];let c=null;switch(n.vsuitCount){case 1:c=i;break;case 2:c=r;break;case 3:c=l;break;default:c=s;break}let d=!1;for(const m of n.components)if(m.number>9){d=!0;break}let u=1,a=1,p=1;d&&(a=9,n.odd?(u=1,a=9,p=2):n.even&&(u=2,a=8,p=2));for(let m=u;m<=a;m+=p)for(const h of c){const b=this.rankFormComponents(e,m,n,h);let g=0;for(const y of b){const C=y.component,x=y.tileArray.length;g+=100*C.count/14*(x/C.count)}g>t.rank&&(t.rank=g,t.componentInfoArray=b,t.vsuitArray=h)}}rankMatchComp(e,t,n,s){let i=n.suit,r=n.number;const l={match:!1,tileArray:[]};if(e.length===0)return l;i>=o.VSUIT1_DRAGON?(r=s[i-o.VSUIT1_DRAGON],i=o.DRAGON):i>=o.VSUIT1&&(i=s[i-o.VSUIT1],r>9&&(r=t+r-N.CONSECUTIVE1));for(const c of e){let d=!1;if((c.suit===i&&c.number===r||c.suit===o.JOKER)&&(d=!0),d&&(l.tileArray.push(c),l.tileArray.length===n.count))break}return e.length===n.count&&l.tileArray.length===n.count&&(l.match=!0),l}rankFormComponents(e,t,n,s){const i=[];for(const u of n.components){const a={component:u,tileArray:[]};i.push(a)}const r=[];for(const u of i)r.push(u);for(const u of e.exposedTileSetArray){for(const p of i){if(p.tileArray.length>0)continue;const m=this.rankMatchComp(u.tileArray,t,p.component,s);if(m.match){p.tileArray=m.tileArray;break}}let a=!0;for(const p of u.tileArray){let m=!1;for(const h of i)if(h.tileArray.includes(p)){m=!0;break}if(!m){a=!1;break}}if(!a)return i}const l=e.getHiddenTileArray(),c=[],d=[];for(const u of l)u.suit===o.JOKER?d.push(u):c.push(u);for(const u of i){const a=u.component;if(u.tileArray.length>0)continue;const p=this.rankMatchComp(c,t,a,s);u.tileArray=p.tileArray;for(const m of p.tileArray){const h=c.indexOf(m);h!==-1&&c.splice(h,1)}}for(const u of d){let a=null,p=null,m=null;for(const h of r){const b=h.component.count-h.tileArray.length;if(h.component.count>=3&&b)switch(b){case 2:a=h;break;case 1:p=h;break;default:m=h;break}}p?p.tileArray.push(u):a?a.tileArray.push(u):m&&m.tileArray.push(u)}return i}sortHandRankArray(e){e.sort((t,n)=>n.rank-t.rank)}printHandRankArray(e,t){let n=e.length;t&&(n=Math.min(t,n));for(let s=0;s<n;s++){const i=e[s];P("Group = "+i.group.groupDescription+`
`),P("Hand = "+i.hand.description+`
`),P("Rank = "+i.rank+`
`);let r="";for(const l of i.componentInfoArray){r+="["+l.component.count+"] ";for(const c of l.tileArray)r+=c.getText()+" "}}}}let E,X;const L=[];let T,$;function Te(){F.incrementGamesPlayed()}function Ee(){const f=document.createElement("div");return f.className="bottom-menu",document.body.appendChild(f),f}document.addEventListener("DOMContentLoaded",()=>{console.log("Mobile Mahjong app initializing...");const f=document.getElementById("loading");if(f&&(f.style.display="none"),!document.getElementById("mobile-settings-btn")){const e=document.querySelector(".bottom-menu")||Ee(),t=document.createElement("button");t.id="mobile-settings-btn",t.className="menu-btn",t.innerHTML="⚙️ SETTINGS",e.appendChild(t)}Ae()});async function Ae(){console.log("Initializing mobile game...");const f=document.getElementById("hand-container"),e=document.getElementById("discard-container"),t=document.getElementById("game-status"),n=document.getElementById("opponent-left"),s=document.getElementById("opponent-top"),i=document.getElementById("opponent-right"),r=new be(2025);await r.init(),X=new pe(r,null,"medium"),E=new W,await E.init({aiEngine:X,cardValidator:r,settings:{year:2025,difficulty:"medium",skipCharleston:!1}}),new me,new te(f,E),new se(e,E);const l=[{container:i,playerIndex:1,position:"RIGHT"},{container:s,playerIndex:2,position:"TOP"},{container:n,playerIndex:3,position:"LEFT"}];for(const{container:a,playerIndex:p}of l){const m=E.players[p],h=new ne(a,m);L.push({bar:h,playerIndex:p})}new he(f,{enableSwipe:!0,enableLongPress:!0}).init(),T=t,E.on("GAME_ENDED",()=>{Te(),T.textContent="Game Ended!"}),E.on("STATE_CHANGED",a=>{console.log("State changed:",a),T.textContent=`State: ${a.newState}`}),E.on("MESSAGE",a=>{console.log("Game message:",a.text),T.textContent=a.text}),E.on("HAND_UPDATED",a=>{const p=E.players[a.player];T.textContent=`Player ${a.player} (${p.name}):
${a.hand.tiles.length} hidden tiles
${a.hand.exposures.length} exposures`;const m=L.find(h=>h.playerIndex===a.player);m&&m.bar.update(p)}),E.on("TURN_CHANGED",a=>{const p=a.currentPlayer??E.currentPlayer;L.forEach(({bar:m,playerIndex:h})=>{const b=E.players[h];b.isCurrentTurn=h===p,m.update(b)})}),E.on("TILES_EXPOSED",a=>{const p=L.find(m=>m.playerIndex===a.player);if(p){const m=E.players[a.player];p.bar.update(m)}}),E.on("UI_PROMPT",a=>{var p;if(console.log("UI_PROMPT received:",a.promptType,a.options),a.promptType==="CHOOSE_DISCARD"){const h=E.players[0].hand.tiles,b=h.map((C,x)=>`${x}: ${C.getText()}`).join(`
`),g=window.prompt(`Choose a tile to discard:
${b}
Enter tile index (0-${h.length-1}):`),y=parseInt(g,10);!isNaN(y)&&y>=0&&y<h.length?(T.textContent=`Discarding ${h[y].getText()}...`,a.callback(h[y])):(T.textContent="Invalid choice, discarding first tile...",a.callback(h[0]))}else if(a.promptType==="CLAIM_DISCARD"){const{tile:m,options:h}=a.options,b=D.fromJSON(m).getText(),g=h.join(", "),y=window.prompt(`Claim ${b}? Options: ${g}`);h.includes(y)?(T.textContent=`Claiming: ${y}`,a.callback(y)):(T.textContent="Passing claim...",a.callback("Pass"))}else if(a.promptType==="SELECT_TILES"){const{minTiles:m=1,maxTiles:h=3}=a.options||{},g=E.players[0].hand.tiles,y=g.map((w,I)=>`${I}: ${w.getText()}`).join(`
`),C=`Select ${m}-${h} tiles (comma-separated indices):
${y}
Example: 0,2,5`,x=window.prompt(C);if(x){const I=x.split(",").map(A=>parseInt(A.trim(),10)).filter(A=>!isNaN(A)).filter(A=>A>=0&&A<g.length).map(A=>g[A]);I.length>=m&&I.length<=h?(T.textContent=`Selected ${I.length} tiles...`,a.callback(I)):(T.textContent=`Invalid selection (need ${m}-${h} tiles)`,a.callback(g.slice(0,h)))}else T.textContent="Selection cancelled",a.callback(g.slice(0,m))}else if(a.promptType==="EXPOSE_TILES"){const m=window.prompt("Expose tiles? (yes/no)");m&&m.toLowerCase()==="yes"?(T.textContent="Exposing tiles...",a.callback(!0)):(T.textContent="Not exposing tiles...",a.callback(!1))}else if(a.promptType==="YES_NO"){const m=((p=a.options)==null?void 0:p.message)||"Continue?",h=window.prompt(`${m} (yes/no)`);h&&(h.toLowerCase()==="yes"||h.toLowerCase()==="y")?a.callback(!0):a.callback(!1)}else if(a.promptType==="CHARLESTON_PASS"){const{direction:m="?",requiredCount:h=3}=a.options||{},g=E.players[0].hand.tiles,y=g.map((w,I)=>`${I}: ${w.getText()}`).join(`
`),C=`Charleston Pass [${m}]:
Select ${h} tiles to pass (comma-separated indices):
${y}
Example: 0,2,5`,x=window.prompt(C);if(x){const I=x.split(",").map(A=>parseInt(A.trim(),10)).filter(A=>!isNaN(A)).filter(A=>A>=0&&A<g.length).map(A=>g[A]);I.length===h?(T.textContent=`Passing ${h} tiles ${m}...`,a.callback(I)):(T.textContent=`Invalid selection (need exactly ${h} tiles)`,a.callback(g.slice(0,h)))}else T.textContent="Charleston pass cancelled, using first tiles...",a.callback(g.slice(0,h))}else if(a.promptType==="CHARLESTON_CONTINUE"){const{question:m="Continue to Charleston phase 2?"}=a.options||{},h=window.prompt(`${m} (Yes/No)`);h&&(h.toLowerCase()==="yes"||h.toLowerCase()==="y")?(T.textContent="Voting YES to continue...",a.callback("Yes")):(T.textContent="Voting NO to end...",a.callback("No"))}else if(a.promptType==="COURTESY_VOTE"){const{question:m="Courtesy Pass: How many tiles to exchange?",options:h=["0","1","2","3"]}=a.options||{},b=h.join("/"),g=window.prompt(`${m}
Options: ${b}`),y=parseInt(g,10);!isNaN(y)&&y>=0&&y<=3?(T.textContent=`Voted for ${y} tiles...`,a.callback(String(y))):(T.textContent="Invalid vote, defaulting to 0...",a.callback("0"))}else console.log("Unhandled prompt type:",a.promptType),a.callback&&a.callback(null)});const d=document.getElementById("new-game-btn");d&&(d.onclick=async()=>{console.log("NEW GAME button clicked!");try{console.log("Starting game...",E),await E.startGame(),console.log("Game started successfully")}catch(a){console.error("Error starting game:",a),T.textContent=`Error: ${a.message}`}});const u=document.getElementById("mobile-settings-btn");u&&!$&&($=new z,u.onclick=()=>{$.open()}),T.textContent="Ready to play! Click NEW GAME to start.",console.log("Mobile game initialized successfully")}
