const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/card_test-B4_Wmi16.js","assets/gameObjects-Db5NOQXf.js","assets/card_test-DjzaGVxo.js","assets/card_test-Bt0FLsk1.js","assets/card_test-eUKPfWxD.js"])))=>i.map(i=>d[i]);
(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const o of i.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&n(o)}).observe(document,{childList:!0,subtree:!0});function t(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function n(s){if(s.ep)return;s.ep=!0;const i=t(s);fetch(s.href,i)}})();function _e(l){const e=window.document.getElementById("messages");if(!e)return;const t=l.endsWith(`
`)?l:`${l}
`;e.value+=t,e.scrollTop=e.scrollHeight}function Pe(l){const e=window.document.getElementById("info");e.value=l}let I=function(){},se=function(){},F=function(){},ke=function(){};function ve(l){const e=window.document.getElementById("hint-content");e.innerHTML=l}const x={cardYear:2025,useBlankTiles:!1,difficulty:"medium",trainingMode:!1,trainingHand:"",trainingTileCount:9,skipCharleston:!1,bgmVolume:20,bgmMuted:!1,sfxVolume:20,sfxMuted:!1},B="mahjong_";class He{static load(){const e={};for(const[t,n]of Object.entries(x)){const s=B+t,i=localStorage.getItem(s);i===null?e[t]=n:e[t]=this.parseValue(i,typeof n)}return e}static save(e){for(const[t,n]of Object.entries(e)){if(!(t in x)){console.warn(`Unknown setting key: ${t}`);continue}const s=B+t;localStorage.setItem(s,String(n))}}static get(e){if(!(e in x)){console.warn(`Unknown setting key: ${e}`);return}const t=B+e,n=localStorage.getItem(t);return n===null?x[e]:this.parseValue(n,typeof x[e])}static set(e,t){if(!(e in x)){console.warn(`Unknown setting key: ${e}`);return}const n=typeof x[e],s=typeof t;if(s!==n){console.error(`Type mismatch for ${e}: expected ${n}, got ${s}`);return}const i=B+e;localStorage.setItem(i,String(t))}static reset(){for(const e of Object.keys(x)){const t=B+e;localStorage.removeItem(t)}}static getDefault(e){return x[e]}static getDefaults(){return{...x}}static parseValue(e,t){switch(t){case"number":return parseInt(e,10);case"boolean":return e==="true";case"string":return e;default:return console.warn(`Unknown type: ${t}`),e}}static isAvailable(){try{const e="__storage_test__";return localStorage.setItem(e,"test"),localStorage.removeItem(e),!0}catch(e){return console.error("localStorage is not available:",e),!1}}static exportJSON(){const e=this.load();return JSON.stringify(e,null,2)}static importJSON(e){try{const t=JSON.parse(e);for(const n of Object.keys(t))if(!(n in x))return console.error(`Invalid setting key in import: ${n}`),!1;return this.save(t),!0}catch(t){return console.error("Failed to import settings:",t),!1}}static subscribe(e,t){const n=s=>{if(s.key===B+e){const i=this.parseValue(s.newValue,typeof x[e]);t(i)}};return window.addEventListener("storage",n),()=>{window.removeEventListener("storage",n)}}}const Le=648,Me=1052,Ve=69,Ue=52,Ge=.75,Be=4,S={INIT:0,START:1,DEAL:2,CHARLESTON1:3,CHARLESTON_QUERY:4,CHARLESTON2:6,COURTESY_QUERY:7,COURTESY:9,COURTESY_COMPLETE:10,LOOP_PICK_FROM_WALL:11,LOOP_CHOOSE_DISCARD:12,LOOP_QUERY_CLAIM_DISCARD:13,LOOP_EXPOSE_TILES:15,LOOP_EXPOSE_TILES_COMPLETE:16,END:17},$={EXPOSE_TILES:0,DISCARD_TILE:1,MAHJONG:2},A={BOTTOM:0,RIGHT:1,TOP:2,LEFT:3},r={CRACK:0,BAM:1,DOT:2,WIND:3,DRAGON:4,FLOWER:5,JOKER:6,BLANK:7,VSUIT1:8,VSUIT2:9,VSUIT3:10,VSUIT1_DRAGON:11,VSUIT2_DRAGON:12,VSUIT3_DRAGON:13,INVALID:99},R={CONSECUTIVE1:10,CONSECUTIVE2:11,CONSECUTIVE3:12,CONSECUTIVE4:13,CONSECUTIVE5:14,CONSECUTIVE6:15,CONSECUTIVE7:16,INVALID:99},_={NORTH:0,SOUTH:1,WEST:2,EAST:3},C={RED:0,GREEN:1,WHITE:2},W={DISCARD_ANIMATION_HUMAN:300,DISCARD_ANIMATION_AI:200,TILE_DRAWN_DELAY:300,DISCARD_COMPLETE_DELAY:500},Ke={TILE_SELECTED_Y:575,TILE_NORMAL_Y:600};function Je(){return!window.settingsManager||typeof window.settingsManager.getUseBlankTiles!="function"?152:window.settingsManager.getUseBlankTiles()?160:152}class re{constructor(){this.listeners=new Map}on(e,t){return this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e).push(t),()=>{const n=this.listeners.get(e);if(!n||n.length===0)return;const s=n.indexOf(t);s>-1&&(n.splice(s,1),n.length===0&&this.listeners.delete(e))}}once(e,t){const n=this.on(e,s=>{n(),t(s)})}emit(e,t){const n=this.listeners.get(e);n&&n.slice().forEach(s=>{try{s(t)}catch(i){console.error(`Error in event handler for ${e}:`,i)}})}off(e){this.listeners.delete(e)}clear(){this.listeners.clear()}}const ne=[{suit:r.CRACK,textArray:["Crack"],prefix:["C"],maxNum:9,count:4},{suit:r.BAM,textArray:["Bam"],prefix:["B"],maxNum:9,count:4},{suit:r.DOT,textArray:["Dot"],prefix:["D"],maxNum:9,count:4},{suit:r.WIND,textArray:["North","South","West","East"],prefix:["N","S","W","E"],maxNum:1,count:4},{suit:r.DRAGON,textArray:["Red dragon","Green dragon","White dragon"],prefix:["DC","DB","DD"],maxNum:1,count:4},{suit:r.FLOWER,textArray:["Flower"],prefix:["F1","F2","F3","F4","F1","F2","F3","F4"],maxNum:1,count:1},{suit:r.JOKER,textArray:["Joker"],prefix:["J"],maxNum:1,count:8},{suit:r.BLANK,textArray:["Blank"],prefix:["BLANK"],maxNum:1,count:8}];class D{constructor(e,t,n=-1){this.suit=e,this.number=t,this.index=n}getText(){for(const e of ne)if(e.suit===this.suit){if(this.suit<=r.DOT)return`${e.textArray[0]} ${this.number}`;if(this.suit===r.WIND)return`${e.textArray[this.number]} wind`;if(this.suit===r.DRAGON)return`${e.textArray[this.number]}`;if(this.suit===r.FLOWER)return`${e.textArray[0]} ${this.number+1}`;if(this.suit===r.JOKER)return"Joker";if(this.suit===r.BLANK)return"Blank"}return this.suit===r.INVALID?"Invalid":`Unknown tile (${this.suit}:${this.number})`}equals(e){return e?this.suit===e.suit&&this.number===e.number:!1}isSameTile(e){return e?this.index===e.index:!1}clone(){return new D(this.suit,this.number,this.index)}isJoker(){return this.suit===r.JOKER}isBlank(){return this.suit===r.BLANK}isFlower(){return this.suit===r.FLOWER}isWind(){return this.suit===r.WIND}isDragon(){return this.suit===r.DRAGON}isNumberedSuit(){return this.suit>=r.CRACK&&this.suit<=r.DOT}isInvalid(){return this.suit===r.INVALID}static fromPhaserTile(e){return new D(e.suit,e.number,e.index)}toJSON(){return{suit:this.suit,number:this.number,index:this.index}}static fromJSON(e){return new D(e.suit,e.number,e.index)}}class G{constructor(){this.tiles=[],this.exposures=[]}get exposedTileSetArray(){return this.exposures}getLength(){const e=this.exposures.reduce((t,n)=>t+n.tiles.length,0);return this.tiles.length+e}getHiddenCount(){return this.tiles.length}getHiddenTileArray(){return this.tiles}getTileArray(){return this.tiles}getAllTilesIncludingExposures(){const e=[...this.tiles];return this.exposures.forEach(t=>{e.push(...t.tiles)}),e}addTile(e){this.tiles.push(e)}removeTile(e){const t=this.tiles.findIndex(n=>n.isSameTile(e));return t!==-1?(this.tiles.splice(t,1),!0):!1}addExposure(e){this.exposures.push(e)}hasTile(e){return this.tiles.some(t=>t.equals(e))}isAllHidden(){return this.exposures.length===0}countTile(e,t){return this.tiles.filter(n=>n.suit===e&&n.number===t).length}sortBySuit(){this.tiles.sort((e,t)=>e.suit!==t.suit?e.suit-t.suit:e.number-t.number)}sortByRank(){this.tiles.sort((e,t)=>e.number!==t.number?e.number-t.number:e.suit-t.suit)}clear(){this.tiles=[],this.exposures=[]}clone(){const e=new G;return e.tiles=this.tiles.map(t=>t.clone()),e.exposures=this.exposures.map(t=>t.clone()),e}static fromPhaserHand(e){const t=new G,n=e.getHiddenTileArray();return t.tiles=n.map(s=>D.fromPhaserTile(s)),e.exposedTileSetArray.forEach(s=>{const i=new K;i.type=ie(s.tileArray.length),i.tiles=s.tileArray.map(o=>D.fromPhaserTile(o)),t.exposures.push(i)}),t}toJSON(){return{tiles:this.tiles.map(e=>e.toJSON()),exposures:this.exposures.map(e=>e.toJSON())}}static fromJSON(e){const t=new G;return t.tiles=e.tiles.map(n=>D.fromJSON(n)),t.exposures=e.exposures.map(n=>K.fromJSON(n)),t}}class K{constructor(e={}){this.type=e.type||"",this.tiles=e.tiles||[]}clone(){const e=new K;return e.type=this.type,e.tiles=this.tiles.map(t=>t.clone()),e}toJSON(){return{type:this.type,tiles:this.tiles.map(e=>e.toJSON())}}get tileArray(){return this.tiles}getTileArray(){return this.tiles}getLength(){return this.tiles.length}static fromJSON(e){const t=new K;return t.type=e.type,t.tiles=e.tiles.map(n=>D.fromJSON(n)),t}}function ie(l){return l===3?"PUNG":l===4?"KONG":l===5?"QUINT":"UNKNOWN"}class U{constructor(e,t=""){this.position=e,this.name=t||this.getDefaultName(),this.hand=new G,this.isHuman=e===A.BOTTOM,this.isCurrentTurn=!1,this.wind=""}getDefaultName(){return["You","Opponent 1","Opponent 2","Opponent 3"][this.position]||`Player ${this.position+1}`}clone(){const e=new U(this.position,this.name);return e.hand=this.hand.clone(),e.isHuman=this.isHuman,e.isCurrentTurn=this.isCurrentTurn,e.wind=this.wind,e}static fromPhaserPlayer(e){const t=new U(e.playerInfo.playerNum,e.playerInfo.name);return t.hand=G.fromPhaserHand(e.hand),t.wind=e.playerInfo.wind,t}toJSON(){return{position:this.position,name:this.name,hand:this.hand.toJSON(),isHuman:this.isHuman,isCurrentTurn:this.isCurrentTurn,wind:this.wind}}static fromJSON(e){const t=new U(e.position,e.name);return t.hand=G.fromJSON(e.hand),t.isHuman=e.isHuman,t.isCurrentTurn=e.isCurrentTurn,t.wind=e.wind,t}}function oe(l,e){return{type:"STATE_CHANGED",oldState:l,newState:e,timestamp:Date.now()}}function ae(l){return{type:"GAME_STARTED",players:l,timestamp:Date.now()}}function le(l=[]){return{type:"TILES_DEALT",sequence:l,timestamp:Date.now()}}function ce(l,e,t={}){return{type:"TILE_DRAWN",player:l,tile:e,animation:{type:t.type||"deal-slide",fromPosition:t.fromPosition||{x:640,y:360},toPosition:t.toPosition||{x:450,y:575},duration:t.duration||400,easing:t.easing||"Quad.easeOut",...t},timestamp:Date.now()}}function ue(l,e,t={}){return{type:"TILE_DISCARDED",player:l,tile:e,animation:{type:t.type||"discard-slide",fromPosition:t.fromPosition||{x:450,y:575},toPosition:t.toPosition||{x:350,y:420},duration:t.duration||300,easing:t.easing||"Power2.easeInOut",glow:t.glow||{color:1981066,alpha:.9},...t},timestamp:Date.now()}}function he(l,e,t,n){return{type:"BLANK_EXCHANGED",player:l,blankTile:e,retrievedTile:t,discardIndex:n,timestamp:Date.now()}}function P(l,e){return{type:"HAND_UPDATED",player:l,hand:e,timestamp:Date.now()}}function Q(l,e){return{type:"TURN_CHANGED",currentPlayer:l,previousPlayer:e,timestamp:Date.now()}}function de(l,e,t){return{type:"CHARLESTON_PHASE",phase:l,passCount:e,direction:t,timestamp:Date.now()}}function fe(l,e,t,n,s={}){const o={right:1,across:2,left:3}[t]||1;return{type:"CHARLESTON_PASS",fromPlayer:l,toPlayer:e,direction:t,tiles:n,animation:{type:s.type||"pass-tiles",direction:s.direction||t,duration:s.duration||500,easing:s.easing||"Sine.easeInOut",offset:o,...s},timestamp:Date.now()}}function me(l,e){return{type:"COURTESY_VOTE",player:l,vote:e,timestamp:Date.now()}}function pe(l,e,t,n={}){return{type:"COURTESY_PASS",fromPlayer:l,toPlayer:e,tiles:t,animation:{type:n.type||"courtesy-exchange",duration:n.duration||600,easing:n.easing||"Sine.easeInOut",glow:n.glow||{color:2003199,alpha:.7},...n},timestamp:Date.now()}}function X(l,e,t,n={}){return{type:"TILES_RECEIVED",player:l,fromPlayer:t,tiles:e,animation:{type:n.type||"receive-tiles",duration:n.duration||400,easing:n.easing||"Power2.easeOut",glow:n.glow||{color:2003199,alpha:.7},...n},timestamp:Date.now()}}function ge(l,e,t){return{type:"DISCARD_CLAIMED",claimingPlayer:l,tile:e,claimType:t,timestamp:Date.now()}}function Ee(l,e,t,n={}){return{type:"TILES_EXPOSED",player:l,exposureType:e,tiles:t,animation:{type:n.type||"expose-tiles",duration:n.duration||300,easing:n.easing||"Power2.easeOut",effect:n.effect||"highlight",...n},timestamp:Date.now()}}function Te(l,e,t){return{type:"GAME_ENDED",reason:l,winner:e,mahjong:t,timestamp:Date.now()}}function w(l,e="info"){return{type:"MESSAGE",text:l,messageType:e,timestamp:Date.now()}}class Ae extends Error{constructor(e,t="UNKNOWN",n=!1){super(e),this.name="GameError",this.code=t,this.recoverable=n}}class j extends Ae{constructor(e){super(e,"STATE_ERROR",!1),this.name="StateError"}}const z={1:["right","across","left"],2:["left","across","right"]},ye={right:A.RIGHT,across:A.TOP,left:A.LEFT},Se=[[A.BOTTOM,4],[A.RIGHT,4],[A.TOP,4],[A.LEFT,4],[A.BOTTOM,4],[A.RIGHT,4],[A.TOP,4],[A.LEFT,4],[A.BOTTOM,4],[A.RIGHT,4],[A.TOP,4],[A.LEFT,4],[A.BOTTOM,1],[A.RIGHT,1],[A.TOP,1],[A.LEFT,1],[A.BOTTOM,1]];class $e extends re{constructor(){super(),this.state=S.INIT,this.players=[],this.wallTiles=[],this.discards=[],this.currentPlayer=0,this.settings={year:2025,difficulty:"medium",useBlankTiles:!1,skipCharleston:!1,trainingMode:!1,trainingHand:"",trainingTileCount:13},this.debug=!1,this.charlestonState={phase:0,passCount:0,continueToPhase2:!1,courtesyVotes:[]},this.gameResult={mahjong:!1,winner:-1,winningHand:null},this.aiEngine=null,this.cardValidator=null,this.wallGenerator=null}init(e={}){this.aiEngine=e.aiEngine,this.cardValidator=e.cardValidator,this.wallGenerator=e.wallGenerator||null,e.settings&&(this.settings={...this.settings,...e.settings}),this.players=[new U(A.BOTTOM,"You"),new U(A.RIGHT,"Bot Bob"),new U(A.TOP,"Sally Bot"),new U(A.LEFT,"Stephen Bot")],this.assignPlayerWinds();const t=w(`Game initialized with ${this.settings.year} card`,"info");this.emit("MESSAGE",t)}assignPlayerWinds(){const e={[A.BOTTOM]:_.EAST,[A.RIGHT]:_.NORTH,[A.TOP]:_.WEST,[A.LEFT]:_.SOUTH};Object.entries(e).forEach(([t,n])=>{const s=this.players[t];s&&(s.wind=n)})}async startGame(){if(this.state!==S.INIT&&this.state!==S.END)return;this.setState(S.START),this.gameResult={mahjong:!1,winner:-1,winningHand:null},this.charlestonState={phase:0,passCount:0,continueToPhase2:!1,courtesyVotes:[]},this.discards=[],this.currentPlayer=A.BOTTOM,this.players.forEach(t=>t.hand.clear()),this.createWall();const e=ae(this.players.map(t=>t.toJSON()));this.emit("GAME_STARTED",e),await this.dealTiles(),this.settings.skipCharleston?await this.gameLoop():await this.charlestonPhase()}createWall(){const e=this.wallGenerator?this.wallGenerator():Oe(this.settings.useBlankTiles);if(!Array.isArray(e)||e.length===0)throw new j("Failed to generate wall tiles. Wall generator returned empty set.");const t=e.map((n,s)=>Y(n,s));this.wallTiles=Ce(t),this.emit("WALL_CREATED",{tileCount:this.wallTiles.length}),this.emit("MESSAGE",{text:`Wall created with ${this.wallTiles.length} tiles`,type:"info"})}dealTiles(){this.setState(S.DEAL);const e=this.buildInitialDealSequence(),t=le(e);return this.emit("TILES_DEALT",t),new Promise(n=>{let s=null,i=!1;const o=()=>{i||(i=!0,s!==null&&clearTimeout(s),this.players.forEach((a,c)=>{const u=P(c,a.hand.toJSON());this.emit("HAND_UPDATED",u)}),n())};this.once("DEALING_COMPLETE",o),s=setTimeout(()=>{this.off("DEALING_COMPLETE",o),o()},3e4)})}buildInitialDealSequence(){const e=[];let t=null,n=0;if(this.settings.trainingMode&&this.settings.trainingHand){const i=this.cardValidator.generateHand(this.settings.trainingHand,this.settings.trainingTileCount).getTileArray();t=[];for(const o of i){const a=this.wallTiles.findIndex(c=>c.suit===o.suit&&c.number===o.number);if(a!==-1){const c=this.wallTiles.splice(a,1)[0];t.push(c)}else F(`Could not find matching tile for ${o.suit}-${o.number}`),t.push(o)}this.debug&&(I("Training Mode Settings:",{trainingMode:this.settings.trainingMode,trainingHand:this.settings.trainingHand,trainingTileCount:this.settings.trainingTileCount}),I("Generated hand tiles:",t.map(o=>`${o.suit}-${o.number} (index: ${o.index})`))),this.emit("MESSAGE",{text:`Training Mode: Dealing ${this.settings.trainingTileCount} tiles for "${this.settings.trainingHand}"`,type:"info"})}for(const[s,i]of Se){const o=[],a=this.players[s];for(let c=0;c<i;c++){let u;s===A.BOTTOM&&t&&n<t.length?u=t[n++]:u=this.drawTileFromWall(),a.hand.addTile(u),o.push(u.toJSON())}a.hand.sortBySuit(),e.push({player:s,tiles:o})}return e}async charlestonPhase(){if(this.settings.skipCharleston){await this.gameLoop();return}this.charlestonState.phase=1,await this.executeCharlestonPasses(1),this.setState(S.CHARLESTON_QUERY),await this.queryCharlestonContinue()&&(this.charlestonState.phase=2,await this.executeCharlestonPasses(2)),await this.courtesyPhase(),await this.gameLoop()}async executeCharlestonPasses(e){const t=z[e]||z[1];for(let n=0;n<t.length;n++){const s=t[n],i=ye[s];if(typeof i!="number")continue;this.setState(e===1?S.CHARLESTON1:S.CHARLESTON2);const o=de(e,n+1,s);this.emit("CHARLESTON_PHASE",o);const a=[];for(let c=0;c<4;c++){const u=this.players[c];let f;u.isHuman?f=await this.promptUI("CHARLESTON_PASS",{direction:s,requiredCount:3}):f=await this.aiEngine.charlestonPass(u.hand),f.forEach(d=>u.hand.removeTile(d)),I(`[GameController] Player ${c} removed ${f.length} tiles, hand now has ${u.hand.tiles.length} tiles`),a[c]=f;const h=P(c,this.players[c].hand.toJSON());this.emit("HAND_UPDATED",h);const m=(c+i)%4,p=fe(c,m,s,f.map(d=>({suit:d.suit,number:d.number,index:d.index})),{type:"charleston-pass",direction:s,duration:600,easing:"ease-in-out"});this.emit("CHARLESTON_PASS",p)}for(let c=0;c<4;c++){const u=c,f=(c+i)%4;a[u].forEach(d=>{this.players[f].hand.addTile(d)}),I(`[GameController] Player ${f} received ${a[u].length} tiles, hand now has ${this.players[f].hand.tiles.length} tiles`);const h=a[u].map(d=>({suit:d.suit,number:d.number,index:d.index})),m=X(f,h,u,{type:"charleston-receive",direction:s,duration:600,glow:{persist:!0,color:2003199}});this.emit("TILES_RECEIVED",m);const p=P(f,this.players[f].hand.toJSON());this.emit("HAND_UPDATED",p)}await this.sleep(500)}}async queryCharlestonContinue(){const e=await this.promptUI("CHARLESTON_CONTINUE",{question:"Continue Charleston to phase 2?",options:["Yes","No"]});[...this.players.filter(s=>!s.isHuman).map(s=>this.aiEngine.charlestonContinueVote(s.hand))];const n=!0;{const s=w("All players voted YES - continuing to Charleston phase 2","info");this.emit("MESSAGE",s)}return n}async courtesyPhase(){this.setState(S.COURTESY_QUERY);const e=[];for(const n of this.players){let s;if(n.isHuman){const o=await this.promptUI("COURTESY_VOTE",{question:"Courtesy Pass: How many tiles to exchange with opposite player?",options:["0","1","2","3"]});s=parseInt(o,10),(isNaN(s)||s<0||s>3)&&(s=0)}else s=await this.aiEngine.courtesyVote(n.hand);e.push({player:n.position,vote:s});const i=me(n.position,s);this.emit("COURTESY_VOTE",i)}if(e.filter(n=>n.vote>0).length>=2){this.setState(S.COURTESY);const n=Math.min(e[0].vote,e[2].vote),s=Math.min(e[1].vote,e[3].vote);if(n>0||s>0){const i=[];for(let u=0;u<4;u++){const f=this.players[u].name,h=e[u].vote;i.push(`${f} voted ${h}`)}const o=w(`Courtesy pass: ${i.join(", ")}. Passing ${n>0?n+" tile(s) with opposite player":"no tiles"}.`,"info");this.emit("MESSAGE",o);const a=[];for(let u=0;u<4;u++){const f=this.players[u],h=u===0||u===2?n:s;if(h===0){a[u]=[];continue}let m;if(f.isHuman){const g=this.players[(u+2)%4],y=e[(u+2)%4].vote,T=e[u].vote;m=await this.promptUI("SELECT_TILES",{question:`${g.name} voted ${y}, you voted ${T}. Select exactly ${h} tile(s) to pass.`,minTiles:h,maxTiles:h})}else m=await this.aiEngine.courtesyPass(f.hand,h);a[u]=m,m.forEach(g=>f.hand.removeTile(g));const p=(u+2)%4,d=pe(u,p,m.map(g=>({suit:g.suit,number:g.number,index:g.index})),{duration:500});this.emit("COURTESY_PASS",d)}for(let u=0;u<4;u++){const f=(u+2)%4,h=a[f];if(h.forEach(m=>this.players[u].hand.addTile(m)),h.length>0){const m=X(u,h.map(p=>({suit:p.suit,number:p.number,index:p.index})),f,{duration:500});this.emit("TILES_RECEIVED",m)}}this.players.forEach(u=>u.hand.sortBySuit()),this.players.forEach((u,f)=>{const h=P(f,u.hand.toJSON());this.emit("HAND_UPDATED",h)});const c=w("Courtesy pass complete.","info");this.emit("MESSAGE",c)}else{const i=w("Courtesy pass skipped (opposite players must both agree).","info");this.emit("MESSAGE",i)}await this.sleep(1e3)}this.setState(S.COURTESY_COMPLETE)}async gameLoop(){for(this.setState(S.LOOP_PICK_FROM_WALL);this.state!==S.END&&this.wallTiles.length>0;){if(this.shouldDrawTile()&&(await this.pickFromWall(),this.checkMahjong())){this.endGame("mahjong");return}await this.chooseDiscard();const e=await this.queryClaimDiscard();if(e.claimed){if(this.handleDiscardClaim(e),this.gameResult.mahjong)return;await this.chooseDiscard()}else this.advanceTurn()}this.wallTiles.length===0&&!this.gameResult.mahjong&&this.endGame("wall_game")}drawTileFromWall(){if(this.wallTiles.length===0)throw new j("Attempted to draw from an empty wall");return this.wallTiles.pop()}shouldDrawTile(){const e=this.players[this.currentPlayer];return!e||!e.hand?!1:e.hand.getLength()===13}canPlayerFormExposure(e,t){if(!e||!e.hand)return!1;const n=e.hand.tiles||[];if(n.length===0)return!1;const s=n.filter(o=>o.suit===t.suit&&o.number===t.number).length,i=n.filter(o=>o.isJoker()).length;return s+i>=2}canPlayerMahjongWithTile(e,t){if(!this.cardValidator||!e||!e.hand)return!1;const n=e.hand.clone(),s=t.clone?t.clone():new D(t.suit,t.number,t.index);n.addTile(s);const i=n.getAllTilesIncludingExposures?n.getAllTilesIncludingExposures():n.tiles,o=n.exposures.length===0;try{const a=this.cardValidator.validateHand(i,o);return!!(a&&a.valid)}catch{return!1}}async pickFromWall(){if(this.setState(S.LOOP_PICK_FROM_WALL),this.wallTiles.length===0)return;const e=this.players[this.currentPlayer],t=this.drawTileFromWall();e.hand.addTile(t),e.hand.sortBySuit();const n=ce(this.currentPlayer,t.toJSON(),{type:"wall-draw",duration:300,easing:"Quad.easeOut"});this.emit("TILE_DRAWN",n);const s=P(this.currentPlayer,e.hand.toJSON());this.emit("HAND_UPDATED",s),await this.sleep(W.TILE_DRAWN_DELAY)}async chooseDiscard(){this.setState(S.LOOP_CHOOSE_DISCARD);const e=this.players[this.currentPlayer];let t;if(e.isHuman?t=await this.promptUI("CHOOSE_DISCARD",{hand:e.hand.toJSON()}):t=await this.aiEngine.chooseDiscard(e.hand),!t)if(e.hand.tiles.length>0)F(`chooseDiscard: No tile returned for player ${this.currentPlayer}, falling back to first tile.`),t=e.hand.tiles[0];else throw new j(`chooseDiscard: Player ${this.currentPlayer} hand is empty, cannot discard.`);const n=e.hand.tiles.findIndex(u=>u.isSameTile(t));if(!e.hand.removeTile(t))throw new j(`chooseDiscard: Failed to remove tile ${t.toString()} from player ${this.currentPlayer} hand.`);this.discards.push(t);const i={suit:t.suit,number:t.number,index:t.index},o={type:"discard-arc",duration:this.currentPlayer===0?W.DISCARD_ANIMATION_HUMAN:W.DISCARD_ANIMATION_AI,easing:"ease-out",rotation:this.currentPlayer===0?360:180};n>=0&&(o.tileIndex=n);const a=ue(this.currentPlayer,i,o);this.emit("TILE_DISCARDED",a);const c=P(this.currentPlayer,e.hand.toJSON());this.emit("HAND_UPDATED",c),await this.sleep(W.DISCARD_COMPLETE_DELAY)}async queryClaimDiscard(){this.setState(S.LOOP_QUERY_CLAIM_DISCARD);const e=this.discards[this.discards.length-1];if(!e||e.isJoker()||e.isBlank())return{claimed:!1};for(let t=1;t<=3;t++){const n=(this.currentPlayer+t)%4,s=this.players[n];let i;if(s.isHuman){const o=this.canPlayerFormExposure(s,e),a=this.canPlayerMahjongWithTile(s,e);if(!o&&!a)continue;i=await this.promptUI("CLAIM_DISCARD",{tile:e.toJSON(),options:["Mahjong","Pung","Kong","Pass"]})}else{const o=await this.aiEngine.claimDiscard(e,n,s.hand);if(o.playerOption===$.MAHJONG)i="Mahjong";else if(o.playerOption===$.EXPOSE_TILES){const a=o.tileArray.length;a===3?i="Pung":a===4?i="Kong":a===5&&(i="Quint")}else i="Pass"}if(i!=="Pass")return{claimed:!0,player:n,claimType:i}}return{claimed:!1}}exchangeBlankWithDiscard(e,t){if(!this.settings.useBlankTiles)throw new Error("Blank exchange is disabled (house rule off)");if(this.state!==S.LOOP_CHOOSE_DISCARD)throw new Error("Blank exchange only allowed during discard selection");const n=this.players[A.BOTTOM];if(!n||!n.isHuman)throw new Error("Blank exchange only available to human player");const s=Y(e),i=Y(t);if(!s.isBlank())throw new Error("Selected tile is not a blank");if(!n.hand.removeTile(s))throw new Error("Blank tile not found in hand");const a=this.discards.findIndex(p=>p.isSameTile(i));if(a===-1)throw new Error("Selected discard tile no longer available");if(this.discards[a].isJoker())throw new Error("Cannot exchange blank for a joker");const[u]=this.discards.splice(a,1);this.discards.push(s),n.hand.addTile(u),n.hand.sortBySuit();const f=he(A.BOTTOM,s.toJSON(),u.toJSON(),this.discards.length-1);this.emit("BLANK_EXCHANGED",f);const h=P(A.BOTTOM,n.hand.toJSON());this.emit("HAND_UPDATED",h);const m=w(`Blank exchanged for ${u.getText()} from discards.`,"info");return this.emit("MESSAGE",m),!0}handleDiscardClaim(e){const{player:t,claimType:n}=e,s=this.discards.pop(),i=this.players[t];if(n==="Mahjong"){i.hand.addTile(s);const u=i.hand.getAllTilesIncludingExposures?i.hand.getAllTilesIncludingExposures():i.hand.tiles,f=i.hand.exposures.length===0;try{const h=this.cardValidator.validateHand(u,f);if(h&&h.valid){this.gameResult.mahjong=!0,this.gameResult.winner=t,this.endGame("mahjong");return}else{i.hand.removeTile(s),this.discards.push(s),F(`Player ${t} made invalid Mahjong claim - continuing play`),this.emit("MESSAGE",w("Invalid Mahjong claim - hand does not match any winning pattern","error"));return}}catch{i.hand.removeTile(s),this.discards.push(s),this.emit("MESSAGE",w("Invalid Mahjong claim - validation error","error"));return}}i.hand.addTile(s);const o={suit:s.suit,number:s.number,index:s.index},a=ge(t,o,n);this.emit("DISCARD_CLAIMED",a),this.setState(S.LOOP_EXPOSE_TILES),this.exposeTiles(t,n,s),this.currentPlayer=t;const c=Q(this.currentPlayer,(this.currentPlayer+3)%4);this.emit("TURN_CHANGED",c)}exposeTiles(e,t,n){const s=this.players[e],i=s.hand.tiles.filter(T=>T.equals(n)&&!T.isSameTile(n)),o=s.hand.tiles.filter(T=>T.isJoker()),a=t==="Pung"?2:t==="Kong"?3:4;if(i.length+o.length<a){console.warn("Exposure attempted without enough tiles",{playerIndex:e,exposureType:t,claimedTile:n}),this.setState(S.LOOP_EXPOSE_TILES_COMPLETE);return}s.hand.removeTile(n)||console.warn("Failed to remove claimed tile from hand during exposure",{playerIndex:e,claimedTile:n});const f=i.slice(0,Math.min(a,i.length)),h=a-f.length,m=o.slice(0,Math.max(0,h)),p=[n,...f,...m];[...f,...m].forEach(T=>{s.hand.removeTile(T)||console.warn("Failed to remove tile during exposure",{playerIndex:e,tile:T})});const d=new K({type:t.toUpperCase(),tiles:p});s.hand.addExposure(d);const g=Ee(e,t,p.map(T=>({suit:T.suit,number:T.number,index:T.index})),{duration:300});this.emit("TILES_EXPOSED",g);const y=P(e,s.hand.toJSON());this.emit("HAND_UPDATED",y),this.setState(S.LOOP_EXPOSE_TILES_COMPLETE)}checkMahjong(){const e=this.players[this.currentPlayer];if(e.hand.getLength()!==14)return!1;if(this.cardValidator){const t=e.hand.getAllTilesIncludingExposures?e.hand.getAllTilesIncludingExposures():e.hand.tiles,n=e.hand.exposures.length===0,s=this.cardValidator.validateHand(t,n);if(s&&s.valid)return this.gameResult.mahjong=!0,this.gameResult.winner=this.currentPlayer,!0}return!1}advanceTurn(){const e=this.currentPlayer;this.currentPlayer=(this.currentPlayer+1)%4,this.players[e].isCurrentTurn=!1,this.players[this.currentPlayer].isCurrentTurn=!0;const t=Q(this.currentPlayer,e);this.emit("TURN_CHANGED",t)}endGame(e){this.setState(S.END);const t=Te(e,this.gameResult.winner,this.gameResult.mahjong);if(this.emit("GAME_ENDED",t),e==="mahjong"){const n=this.players[this.gameResult.winner],s=w(`${n.name} wins with Mahjong!`,"info");this.emit("MESSAGE",s)}else if(e==="wall_game"){const n=w("Wall game - no winner","info");this.emit("MESSAGE",n)}}setState(e){const t=this.state;this.state=e;const n=oe(t,e);this.emit("STATE_CHANGED",n)}onSortHandRequest(e="suit"){const t=this.players[A.BOTTOM];if(!t||!t.hand)return;e==="rank"?t.hand.sortByRank():t.hand.sortBySuit();const n=P(A.BOTTOM,t.hand.toJSON());this.emit("HAND_UPDATED",n)}async onExchangeJoker(){const e=this.players[A.BOTTOM];if(!e||!e.hand)return!1;if([S.INIT,S.DEAL,S.CHARLESTON1,S.CHARLESTON2,S.CHARLESTON_QUERY,S.COURTESY_QUERY,S.COURTESY].includes(this.state))return this.emit("MESSAGE",w("Cannot exchange jokers during this phase","warning")),!1;const n=[];for(let p=0;p<4;p++)this.players[p].hand.exposures.forEach((g,y)=>{g.tiles.forEach((T,N)=>{T.suit===r.JOKER&&n.push({playerIndex:p,exposureIndex:y,tileIndex:N,jokerTile:T,requiredTiles:this.getRequiredTilesForJoker(g)})})});if(n.length===0)return this.emit("MESSAGE",w("No exposed jokers available","info")),!1;const s=n.filter(p=>p.requiredTiles.some(d=>e.hand.tiles.some(g=>g.suit===d.suit&&g.number===d.number)));if(s.length===0)return this.emit("MESSAGE",w("No matching tiles to exchange","info")),!1;let i;if(s.length>1){const p=s.map(d=>{const g=d.requiredTiles[0],y=this.players[d.playerIndex];return{label:`Trade your ${this.formatTileForDisplay(g)} for Joker from ${y.name}`,value:d}});i=await this.promptUI("JOKER_EXCHANGE_CHOICE",{question:"Multiple joker exchanges available. Choose one:",options:p})}else i=s[0];const o=i.requiredTiles[0],a=e.hand.tiles.findIndex(p=>p.suit===o.suit&&p.number===o.number);if(a===-1)return!1;const c=e.hand.tiles[a],u=i.jokerTile;e.hand.removeTile(c),e.hand.addTile(u);const f=this.players[i.playerIndex];f.hand.exposures[i.exposureIndex].tiles[i.tileIndex]=c,this.emit("JOKER_SWAPPED",{player:i.playerIndex,exposureIndex:i.exposureIndex,jokerIndex:u.index,replacementTile:c,recipient:A.BOTTOM});const h=P(A.BOTTOM,e.hand.toJSON());this.emit("HAND_UPDATED",h);const m=P(i.playerIndex,f.hand.toJSON());return this.emit("HAND_UPDATED",m),this.emit("MESSAGE",w(`Exchanged ${c.getText()} for joker`,"info")),!0}formatTileForDisplay(e){if(!e)return"";const{suit:t,number:n}=e;return t===r.CRACK?`${n} Crack`:t===r.BAM?`${n} Bam`:t===r.DOT?`${n} Dot`:t===r.WIND?{[_.NORTH]:"North Wind",[_.SOUTH]:"South Wind",[_.EAST]:"East Wind",[_.WEST]:"West Wind"}[n]||"Wind":t===r.DRAGON?{[C.RED]:"Red Dragon",[C.GREEN]:"Green Dragon",[C.WHITE]:"White Dragon"}[n]||"Dragon":t===r.FLOWER?`Flower ${typeof n=="number"?n+1:1}`:t===r.JOKER?"Joker":t===r.BLANK?"Blank":`${n??""}`}getRequiredTilesForJoker(e){const t=e.tiles.filter(n=>n.suit!==r.JOKER);return t.length>0?[t[0]]:[]}promptUI(e,t){return new Promise(n=>{this.emit("UI_PROMPT",{promptType:e,options:t,callback:s=>n(s)})})}sleep(e){return new Promise(t=>setTimeout(t,e))}getGameState(){return{state:this.state,currentPlayer:this.currentPlayer,players:this.players.map(e=>e.toJSON()),wallCount:this.wallTiles.length,discardCount:this.discards.length,gameResult:this.gameResult}}}function Y(l,e=-1){if(l instanceof D)return l.clone();if(l&&typeof l=="object"&&typeof l.suit=="number"){const t=typeof l.index=="number"?l.index:e;return new D(l.suit,l.number??0,t)}throw new Error("Wall generator produced invalid tile data")}function Oe(l=!1){const e=[];let t=0;for(const n of ne){if(n.suit===r.BLANK&&!l)continue;const s=Array.isArray(n.prefix)?n.prefix:[n.prefix];for(const i of s)for(let o=1;o<=n.maxNum;o++){let a=o;n.maxNum===1&&(n.suit===r.FLOWER?a=0:a=s.indexOf(i));for(let c=0;c<n.count;c++)e.push(new D(n.suit,a,t++))}}return e}function Ce(l){const e=l.slice();for(let t=e.length-1;t>0;t--){const n=Math.floor(Math.random()*(t+1));[e[t],e[n]]=[e[n],e[t]]}return e}class We{constructor(e){this.gameController=e,this.subscriptions=[]}registerEventHandlers(e={}){Object.entries(e).forEach(([t,n])=>{const s=this.gameController.on(t,n);typeof s=="function"&&this.subscriptions.push(s)})}destroy(){Array.isArray(this.subscriptions)&&(this.subscriptions.forEach(e=>{try{typeof e=="function"&&e()}catch{}}),this.subscriptions=[])}}const V={[r.VSUIT1]:"green",[r.VSUIT2]:"red",[r.VSUIT3]:"blue",[r.FLOWER]:"black",[r.WIND]:"black",[r.DRAGON]:"blue",[r.JOKER]:"gray",[r.CRACK]:"red",[r.BAM]:"green",[r.DOT]:"blue"};function q(l,e=!1,t=null,n=null){if(l.suit===r.JOKER)return{char:"J",color:V[r.JOKER],tile:l};if(l.suit===r.FLOWER)return{char:"F",color:V[r.FLOWER],tile:l};if(l.suit===r.WIND)return{char:{[_.NORTH]:"N",[_.EAST]:"E",[_.SOUTH]:"S",[_.WEST]:"W"}[l.number]||"?",color:V[r.WIND],tile:l};if(l.suit===r.DRAGON||l.suit>=r.VSUIT1_DRAGON&&l.suit<=r.VSUIT3_DRAGON){if(l.suit===r.DRAGON&&l.number===C.WHITE)return{char:"0",color:"blue",tile:l};let s="blue";if(l.suit===r.DRAGON)if(l._originalVsuit!==void 0&&n&&n.has(l._originalVsuit)){const i=n.get(l._originalVsuit);s={[C.RED]:"red",[C.GREEN]:"green",[C.WHITE]:"blue"}[i]||"blue"}else s={[C.RED]:"red",[C.GREEN]:"green",[C.WHITE]:"blue"}[l.number]||"blue";else if(l.suit>=r.VSUIT1_DRAGON&&l.suit<=r.VSUIT3_DRAGON)if(n&&n.has(l.suit)){const i=n.get(l.suit);s={[C.RED]:"red",[C.GREEN]:"green",[C.WHITE]:"blue"}[i]||"blue"}else if(t){const i=l.suit-r.VSUIT1_DRAGON,o=t[i];o>=0&&o<=2?s={[C.RED]:"red",[C.GREEN]:"green",[C.WHITE]:"blue"}[o]||"blue":s=["red","green","blue"][i]||"blue"}else{const i=l.suit-r.VSUIT1_DRAGON;s=["red","green","blue"][i]||"blue"}return{char:"D",color:s,tile:l}}if(l.number>=1&&l.number<=9){if(t&&l.suit>=r.VSUIT1&&l.suit<=r.VSUIT3){const s=t[l.suit-r.VSUIT1],i=V[s]||"blue";return{char:l.number.toString(),color:i,tile:l}}return{char:l.number.toString(),color:V[l.suit]||"blue",tile:l}}if(l.number>=R.CONSECUTIVE1&&l.number<=R.CONSECUTIVE7){const s=l.number-R.CONSECUTIVE1,i=e?2+s*2:1+s*2;if(t&&l.suit>=r.VSUIT1&&l.suit<=r.VSUIT3){const o=t[l.suit-r.VSUIT1],a=V[o]||"blue";return{char:i.toString(),color:a,tile:l}}return{char:i.toString(),color:V[l.suit]||"blue",tile:l}}return l.number===0?{char:"0",color:V[l.suit]||"gray",tile:l}:{char:"?",color:"gray",tile:l}}function Z(l){const e=new Map;return l.forEach(t=>{const n=`${t.suit}-${t.number}`;e.set(n,(e.get(n)||0)+1)}),e}function Ie(l,e,t,n,s=null,i=null,o=null,a=null){const c=Z(e),u=new Map,h=(i?Z(i):c).get(`${r.JOKER}-0`)||0;let m=0,p=0;return l.map((d,g)=>{let y;if(o&&d.number>=R.CONSECUTIVE1&&d.number<=R.CONSECUTIVE7){const b=o.get(d.number);if(b!==void 0){const k={...d,number:b};y=q(k,n,s,a)}else y=q(d,n,s,a)}else y=q(d,n,s,a);const T=`${d.suit}-${d.number}`,N=t[g];let E=!1;return(c.get(T)||0)-(u.get(T)||0)>0?(E=!0,u.set(T,(u.get(T)||0)+1),d.suit===r.JOKER&&m++):N>=3&&d.suit!==r.JOKER&&m+p<h&&(E=!0,p++,y.char="J",y.color="gray"),{...y,isMatched:E}})}const ee={inverted:{red:"bg-red-600 text-white border border-red-700",green:"bg-green-600 text-white border border-green-700",blue:"bg-blue-600 text-white border border-blue-700",black:"bg-black text-white border border-gray-800",gray:"bg-gray-600 text-white border border-gray-700"},normal:{red:"bg-white text-red-600 border border-red-200",green:"bg-white text-green-600 border border-green-200",blue:"bg-white text-blue-600 border border-blue-200",black:"bg-white text-black border border-gray-300",gray:"bg-white text-gray-700 border border-gray-300"}};function De(l,e=!0){const t="tile-char",n=e&&l.isMatched,s=l.color,i=n?ee.inverted:ee.normal,o=i[s]||i.gray;return`${t} ${o}`}function je(l,e,t=null){const n=[],s=[],i=l.hand.even||!1,o=new Map,a=new Map;l.componentInfoArray.forEach(E=>{const O=E.component.suit;if(O>=r.VSUIT1_DRAGON&&O<=r.VSUIT3_DRAGON&&E.tileArray&&E.tileArray.length>0){const b=E.tileArray.find(k=>k.suit===r.DRAGON);b&&a.set(O,b.number)}});const c=[];l.componentInfoArray.forEach(E=>{const O=E.component.suit;O>=r.VSUIT1_DRAGON&&O<=r.VSUIT3_DRAGON&&(c.includes(O)||c.push(O))});const u=new Set(a.values()),f=[C.RED,C.GREEN,C.WHITE],h=f.filter(E=>!u.has(E));let m=0;c.forEach(E=>{if(!a.has(E))if(m<h.length)a.set(E,h[m]),m++;else{const O=E-r.VSUIT1_DRAGON;a.set(E,f[O]||C.RED)}}),l.componentInfoArray.forEach(E=>{if(E.tileArray&&E.tileArray.length>0){const O=E.component.number;if(O>=R.CONSECUTIVE1&&O<=R.CONSECUTIVE7){const b=E.tileArray.find(k=>k.suit!==r.JOKER);if(b&&o.size===0){const k=O-R.CONSECUTIVE1,H=b.number-k;for(let v=0;v<7;v++)o.set(R.CONSECUTIVE1+v,H+v)}}}}),l.componentInfoArray.forEach((E,O)=>{const b=E.component.count,k=E.tileArray?E.tileArray.length:0;if(E.tileArray&&E.tileArray.length>0&&E.tileArray.forEach(H=>{n.push(H),s.push(b)}),k<b){let H;const v=E.component.suit;if(v>=r.VSUIT1_DRAGON&&v<=r.VSUIT3_DRAGON){const J=a.get(v);H={suit:r.DRAGON,number:J!==void 0?J:0,_originalVsuit:v}}else H={suit:v||r.INVALID,number:E.component.number||0};for(let J=k;J<b;J++)n.push(H),s.push(b)}if(O<l.componentInfoArray.length-1){const H=l.componentInfoArray[O+1];E.component.count===1&&H.component.count===1||(n.push({isSpacer:!0}),s.push(0))}});const p=n.filter(E=>!E.isSpacer),d=s.filter((E,O)=>!n[O].isSpacer),g=Ie(p,e,d,i,l.vsuitArray,t,o,a),y=[];let T=0;n.forEach(E=>{E.isSpacer?y.push({isSpacer:!0}):y.push(g[T++])});let N='<div class="pattern-row">';return y.forEach(E=>{E.isSpacer?N+='<span class="component-spacer"></span>':N+=`<span class="${De(E)}">${E.char}</span>`}),N+="</div>",N}const L={KEEP:"KEEP",PASS:"PASS",DISCARD:"DISCARD"};class Fe{constructor(e,t,n="medium"){this.card=e,this.tableData=t,this.difficulty=n,this.config=this.getDifficultyConfig(n)}getDifficultyConfig(e){const t={easy:{maxPatterns:2,minDiscardable:5,exposureThreshold:70,courtesyThresholds:[55,65,75],charlestonContinueThreshold:.8,blankExchangeRank:999,blankExchangeGain:999,jokerTopHands:1,jokerRankThreshold:60,jokerScaling:.8,discardRandomness:.3},medium:{maxPatterns:5,minDiscardable:4,exposureThreshold:55,courtesyThresholds:[50,60,68],charlestonContinueThreshold:.65,blankExchangeRank:85,blankExchangeGain:25,jokerTopHands:2,jokerRankThreshold:55,jokerScaling:.9,discardRandomness:.1},hard:{maxPatterns:999,minDiscardable:3,exposureThreshold:45,courtesyThresholds:[45,55,65],charlestonContinueThreshold:.6,blankExchangeRank:80,blankExchangeGain:20,jokerTopHands:3,jokerRankThreshold:50,jokerScaling:1,discardRandomness:0}};return t[e]||t.medium}calculateTileNeeds(e,t){const n=new Map;for(const s of t){const i=new Map;for(const o of s.componentInfoArray){const a=new Map;for(const c of o.tileArray)if(c.suit!==r.JOKER&&c.suit!==r.BLANK){const u=`${c.suit}-${c.number}`;a.set(u,(a.get(u)||0)+1)}for(const[c,u]of a.entries())i.set(c,(i.get(c)||0)+u)}for(const[o,a]of i.entries()){n.has(o)||n.set(o,{needed:0,have:0});const c=n.get(o);c.needed=Math.max(c.needed,a)}}for(const s of e){if(s.suit===r.JOKER||s.suit===r.BLANK)continue;const i=`${s.suit}-${s.number}`;n.has(i)||n.set(i,{needed:0,have:0}),n.get(i).have++}for(const s of n.values())s.needed=Math.min(s.needed,s.have);return n}countDiscardableTiles(e,t){const n=this.calculateTileNeeds(e,t);let s=0;for(const i of e){if(i.suit===r.JOKER||i.suit===r.BLANK)continue;const o=`${i.suit}-${i.number}`,a=n.get(o);(!a||a.needed===0)&&s++}return s}getTileRecommendations(e,t=null){const n=[],s=e.clone();for(;s.getLength()<14;)s.addTile(new D(r.INVALID,R.INVALID));const o=[...this.card.rankHandArray14(s)].sort((d,g)=>g.rank-d.rank),a=e.getTileArray();let c=o.length;this.config.maxPatterns<999&&(c=Math.min(c,this.config.maxPatterns));const u=t!==null?t:this.config.minDiscardable,f=Math.min(3,c);let h=1;for(let d=f;d>=1;d--){const g=o.slice(0,d);if(this.countDiscardableTiles(a,g)>=u){h=d;break}}c=h;const m=o.slice(0,c),p=this.calculateTileNeeds(a,m);for(const[d,g]of p.entries())I(`  ${d}: needed=${g.needed}, have=${g.have}`);for(const d of a){let g=L.DISCARD;if(d.suit===r.JOKER||d.suit===r.BLANK)g=L.KEEP;else{const y=`${d.suit}-${d.number}`,T=p.get(y);T&&T.needed>0?(g=L.KEEP,I(`  ${d.getText()}: KEEP (need.needed=${T.needed} before decrement)`),T.needed--):I(`  ${d.getText()}: DISCARD (need=${T?`${T.needed}/${T.have}`:"not found"})`)}n.push({tile:d,recommendation:g})}return n.sort((d,g)=>{const y={[L.KEEP]:0,[L.PASS]:1,[L.DISCARD]:2},T=y[d.recommendation]-y[g.recommendation];if(T===0){const N=d.tile.suit===r.JOKER||d.tile.suit===r.BLANK?1:0;return(g.tile.suit===r.JOKER||g.tile.suit===r.BLANK?1:0)-N}return T}),{recommendations:n,consideredPatternCount:c}}chooseDiscard(e){const n=this.getTileRecommendations(e,1).recommendations;let s=null;const i=n.filter(o=>o.recommendation==="DISCARD"&&o.tile.suit!==r.BLANK);if(this.config.discardRandomness>0&&Math.random()<this.config.discardRandomness&&i.length>0){const o=Math.floor(Math.random()*Math.min(3,i.length));s=i[o].tile,I(`[AIEngine] Made suboptimal discard choice (difficulty: ${this.difficulty})`)}else for(let o=n.length-1;o>=0;o--){const a=n[o].tile;if(a.suit!==r.BLANK){s=a;break}}return!s&&n.length>0&&(s=n[n.length-1].tile),s}claimDiscard(e,t,n,s=!1){const i=n.clone();if(i.addTile(e.clone()),this.card.validateHand14(i).valid)return{playerOption:$.MAHJONG,tileArray:null};const a=this.card.rankHandArray14(i);this.card.sortHandRankArray(a);const c=a[0],u=n.exposures.length>0,f=s||c.rank>this.config.exposureThreshold;if(u||!c.hand.concealed&&f){let h=null;e:for(const m of c.componentInfoArray)for(const p of m.tileArray)if(p.equals(e)){h=m;break e}if(h&&this.validateComponentForExposure(h))return{playerOption:$.EXPOSE_TILES,tileArray:h.tileArray}}return{playerOption:$.DISCARD_TILE,tileArray:[e]}}validateComponentForExposure(e){return!(e.component.count<3||e.tileArray.length!==e.component.count)}charlestonPass(e){const t=[],s=this.getTileRecommendations(e,3).recommendations;I(`[Charleston] Total recommendations: ${s.length}`),I(`[Charleston] Jokers in hand: ${s.filter(o=>o.tile.suit===r.JOKER).length}`),I(`[Charleston] Blanks in hand: ${s.filter(o=>o.tile.suit===r.BLANK).length}`);const i=s.filter(o=>!o.tile.isJoker()&&!o.tile.isBlank());I(`[Charleston] Valid recommendations after filtering: ${i.length}`),I(`[Charleston] Jokers in valid: ${i.filter(o=>o.tile.suit===r.JOKER).length}`),I(`[Charleston] Blanks in valid: ${i.filter(o=>o.tile.suit===r.BLANK).length}`),i.sort((o,a)=>{const c={[L.DISCARD]:0,[L.PASS]:1,[L.KEEP]:2};return c[o.recommendation]-c[a.recommendation]});for(let o=0;o<3;o++)if(i.length>o){const a=i[o].tile;I(`[Charleston] Passing tile ${o}: ${a.getText()} (suit=${a.suit})`),t.push(a)}return t}courtesyVote(e){const t=e.clone(),n=new D(r.INVALID,R.INVALID);t.addTile(n);const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s);const o=s[0].rank;this.card.printHandRankArray(s,1);const a=this.config.courtesyThresholds;return o<a[0]?3:o<a[1]?2:o<a[2]?1:0}charlestonContinueVote(e){const t=e.clone(),n=new D(r.INVALID,R.INVALID);t.addTile(n);const s=this.card.rankHandArray14(t);this.card.sortHandRankArray(s);const o=s[0].rank,a=this.config.charlestonContinueThreshold||.7;let c=a;const u=this.config.courtesyThresholds;return o>=u[2]?c=a+.2:o>=u[1]?c=a+.1:o>=u[0]?c=a:c=Math.max(a-.2,.3),Math.random()<c}courtesyPass(e,t){const s=this.getTileRecommendations(e,t).recommendations,i=[];for(let o=s.length-1;o>=0&&i.length<t;o--){const a=s[o].tile;a.suit===r.JOKER||a.suit===r.BLANK||i.push(a)}return i}exchangeTilesForJokers(e,t){if(!t||t.length===0)return{shouldExchange:!1,tile:null};const n=this.card.rankHandArray14(e),s=[...n].sort((c,u)=>u.rank-c.rank);let i=-1e5,o=null;const a=e.tiles;for(let c=0;c<a.length;c++){const u=a[c];let f=!1;for(const g of t)if(u.suit===g.suit&&u.number===g.number){f=!0;break}if(!f)continue;const h=e.clone();h.tiles[c]=new D(r.JOKER,0);const m=this.card.rankHandArray14(h);let p=0;const d=Math.min(this.config.jokerTopHands,s.length);for(let g=0;g<d;g++){const y=s[g],T=n.indexOf(y);let N=1;y.rank>this.config.jokerRankThreshold&&(N=Math.min(y.rank*this.config.jokerScaling,100)),p+=(m[T].rank-n[T].rank)*N}p>i&&(i=p,o=u)}return o&&i>0?{shouldExchange:!0,tile:o}:{shouldExchange:!1,tile:null}}}const Ne="modulepreload",Re=function(l){return"/mahjong/"+l},te={},M=function(e,t,n){let s=Promise.resolve();if(t&&t.length>0){document.getElementsByTagName("link");const o=document.querySelector("meta[property=csp-nonce]"),a=(o==null?void 0:o.nonce)||(o==null?void 0:o.getAttribute("nonce"));s=Promise.allSettled(t.map(c=>{if(c=Re(c),c in te)return;te[c]=!0;const u=c.endsWith(".css"),f=u?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${f}`))return;const h=document.createElement("link");if(h.rel=u?"stylesheet":Ne,u||(h.as="script"),h.crossOrigin="",h.href=c,a&&h.setAttribute("nonce",a),document.head.appendChild(h),u)return new Promise((m,p)=>{h.addEventListener("load",m),h.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(o){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=o,window.dispatchEvent(a),!a.defaultPrevented)throw o}return s.then(o=>{for(const a of o||[])a.status==="rejected"&&i(a.reason);return e().catch(i)})},be=(l,e,t)=>{const n=l[e];return n?typeof n=="function"?n():Promise.resolve(n):new Promise((s,i)=>{(typeof queueMicrotask=="function"?queueMicrotask:setTimeout)(i.bind(null,new Error("Unknown variable dynamic import: "+e+(e.split("/").length!==t?". Note that variables only represent file names one level deep.":""))))})};class we{constructor(){this.tileArray=[]}insert(e){this.tileArray.push(e)}getLength(){return this.tileArray.length}getTileArray(){return[...this.tileArray]}}class xe{constructor(){this.hiddenTileSet=new we,this.exposedTileSetArray=[],this.even=!1}insertHidden(e){this.hiddenTileSet.insert(e)}getHiddenTileArray(){return this.hiddenTileSet.getTileArray()}getLength(){return this.hiddenTileSet.getLength()+this.exposedTileSetArray.reduce((e,t)=>e+t.getLength(),0)}getTileArray(){const e=[];e.push(...this.getHiddenTileArray());for(const t of this.exposedTileSetArray)e.push(...t.getTileArray());return e}isAllHidden(){return this.exposedTileSetArray.length===0}}class Ye{constructor(e){this.year=e,this.validHandGroups=null}async init(){const e=this.year,{validHandGroups:t}=await be(Object.assign({"./2017/card2017.js":()=>M(()=>import("./card2017-DmjKC5HW.js"),[]),"./2017/card_test.js":()=>M(()=>import("./card_test-B4_Wmi16.js"),__vite__mapDeps([0,1])),"./2018/card2018.js":()=>M(()=>import("./card2018-0wVXZPJC.js"),[]),"./2018/card_test.js":()=>M(()=>import("./card_test-DjzaGVxo.js"),__vite__mapDeps([2,1])),"./2019/card2019.js":()=>M(()=>import("./card2019-D1Rb-KRP.js"),[]),"./2019/card_test.js":()=>M(()=>import("./card_test-Bt0FLsk1.js"),__vite__mapDeps([3,1])),"./2020/card2020.js":()=>M(()=>import("./card2020-DBw4Upw4.js"),[]),"./2020/card_test.js":()=>M(()=>import("./card_test-eUKPfWxD.js"),__vite__mapDeps([4,1])),"./2025/card2025.js":()=>M(()=>import("./card2025-DFzLo-SD.js"),[])}),`./${e}/card${e}.js`,3);this.validHandGroups=t}generateHand(e,t){let n=t;const s=[r.CRACK,r.BAM,r.DOT],i=new xe;let o=null;n||(n=14);e:for(const u of this.validHandGroups)for(const f of u.hands)if(f.description.valueOf()===e.valueOf()){o=f;break e}if(!o)return i;const a=[];for(let u=0;u<o.components.length;u++)a.push(0);let c=0;for(let u=0;u<n;u++){const f=o.components[c];let h=f.suit,m=f.number;if(a[c]>=4)i.insertHidden(new D(r.JOKER,0));else{let d=1;i.even&&(d=2),h>=r.VSUIT1_DRAGON?(m=s[h-r.VSUIT1_DRAGON],h=r.DRAGON):h>=r.VSUIT1&&(h=s[h-r.VSUIT1],m>9&&(m=d+m-R.CONSECUTIVE1)),i.insertHidden(new D(h,m))}a[c]++;let p=!1;for(let d=0;d<o.components.length;d++)if(c++,c>=o.components.length&&(c=0),a[c]<o.components[c].count){p=!0;break}if(!p)break}return i}validateHand14(e){const t=e.getAllTilesIncludingExposures?e.getAllTilesIncludingExposures():e.getTileArray();return this.validateHand(t,e.isAllHidden())}diagnoseInvalidHand(e){const t=this.rankHandArray14(e);this.sortHandRankArray(t);const n=t[0],s=new Set;for(const c of n.componentInfoArray)for(const u of c.tileArray)s.add(u);const i=[];i.push(...e.getHiddenTileArray());for(const c of e.exposedTileSetArray)i.push(...c.tileArray);const o=[],a=[];for(const c of i)s.has(c)?o.push(c):a.push(c);return{closestHand:n.hand.description,closestGroup:n.group.groupDescription,rank:n.rank,matchingTiles:o,nonMatchingTiles:a}}validateHand13(e,t){const n=e.getTileArray();return t&&n.push(t),this.validateHand(n,e.isAllHidden())}validateHand(e,t){const n=e.filter(o=>o.suit!==r.BLANK);if(n.length!==14)return{valid:!1,tileCount:e.length,numJokers:0,minNumLow:9999,minNumHigh:9999,suits:[],allHidden:t};const s={valid:!1,tileCount:0,numJokers:0,minNumLow:9999,minNumHigh:9999,suits:[],allHidden:t};for(const o of n){let a=o.suit;a===r.DRAGON&&(a=o.number),s.suits.indexOf(a)===-1&&s.suits.push(a),a===r.JOKER&&s.numJokers++}s.minNumLow=9999,s.minNumHigh=9999;for(const o of n)(o.suit===r.CRACK||o.suit===r.BAM||o.suit===r.DOT)&&o.number<s.minNumHigh&&(s.minNumHigh=o.number);if(s.numJokers>=3?s.minNumLow=1:s.minNumLow=s.minNumHigh,s.tileCount=n.length,s.tileCount!==14)return s;let i=!1;e:for(const o of this.validHandGroups)for(const a of o.hands)if(se("Match hand: "+a.description+`
`),this.matchHand(n,s,o,a)){i=!0;break e}return i&&(s.valid=!0),s}matchHand(e,t,n,s){let i=!1;if(s.concealed&&!t.allHidden)return!1;const o=this._getEffectiveVsuitCount(s);if(t.suits.length<s.vsuitCount)return!1;const a=[[-1,-1,-1]],c=[[r.CRACK,-1,-1],[r.BAM,-1,-1],[r.DOT,-1,-1]],u=[[r.CRACK,r.BAM,-1],[r.CRACK,r.DOT,-1],[r.BAM,r.CRACK,-1],[r.BAM,r.DOT,-1],[r.DOT,r.CRACK,-1],[r.DOT,r.BAM,-1]],f=[[r.CRACK,r.BAM,r.DOT],[r.CRACK,r.DOT,r.BAM],[r.BAM,r.CRACK,r.DOT],[r.BAM,r.DOT,r.CRACK],[r.DOT,r.CRACK,r.BAM],[r.DOT,r.BAM,r.CRACK]];let h=null;switch(o){case 1:h=c;break;case 2:h=u;break;case 3:h=f;break;default:h=a;break}for(let m=t.minNumLow;m<=t.minNumHigh;m++){for(const p of h)if(i=this.matchComponents(e,t,s,p,m),i)break;if(i)break}return i}matchComponents(e,t,n,s,i){let o=!0;if(i!==9999&&(n.even&&i&1||n.odd&&!(i&1)))return!1;const a=[];for(const c of e)a.push(c);for(const c of n.components){let u=0,f=c.suit,h=c.number;f>=r.VSUIT1_DRAGON?(h=s[f-r.VSUIT1_DRAGON],f=r.DRAGON):f>=r.VSUIT1&&(f=s[f-r.VSUIT1],h>9&&(h=i+h-R.CONSECUTIVE1));let m=!1;do{m=!1;for(const p of a)if(p.suit===f&&p.number===h){m=!0;const d=a.indexOf(p);a.splice(d,1),u++;break}if(!m&&c.count>2){for(const p of a)if(p.suit===r.JOKER){m=!0;const d=a.indexOf(p);a.splice(d,1),u++;break}}}while(m&&u<c.count);if(u!==c.count){o=!1;break}}return o}printValidationInfo(e){}rankHandArray14(e){const t=[];for(const n of this.validHandGroups)for(const s of n.hands){const i={group:n,hand:s,rank:0,componentInfoArray:[],vsuitArray:null};t.push(i),this.rankHand(e,i,s)}return t}rankHand(e,t,n){if(n.concealed&&!e.isAllHidden()){t.rank=0;return}const s=this._getEffectiveVsuitCount(n),i=[[-1,-1,-1]],o=[[r.CRACK,-1,-1],[r.BAM,-1,-1],[r.DOT,-1,-1]],a=[[r.CRACK,r.BAM,-1],[r.CRACK,r.DOT,-1],[r.BAM,r.CRACK,-1],[r.BAM,r.DOT,-1],[r.DOT,r.CRACK,-1],[r.DOT,r.BAM,-1]],c=[[r.CRACK,r.BAM,r.DOT],[r.CRACK,r.DOT,r.BAM],[r.BAM,r.CRACK,r.DOT],[r.BAM,r.DOT,r.CRACK],[r.DOT,r.CRACK,r.BAM],[r.DOT,r.BAM,r.CRACK]];let u=null;switch(s){case 1:u=o;break;case 2:u=a;break;case 3:u=c;break;default:u=i;break}let f=!1;for(const d of n.components)if(d.number>9){f=!0;break}let h=1,m=1,p=1;f&&(m=9,n.odd?(h=1,m=9,p=2):n.even&&(h=2,m=8,p=2));for(let d=h;d<=m;d+=p)for(const g of u){const y=this.rankFormComponents(e,d,n,g);let T=0;for(const N of y){const E=N.component,O=N.tileArray.length;T+=100*E.count/14*(O/E.count)}T>t.rank&&(t.rank=T,t.componentInfoArray=y,t.vsuitArray=g)}}rankMatchComp(e,t,n,s){let i=n.suit,o=n.number;const a={match:!1,tileArray:[]};if(e.length===0)return a;i>=r.VSUIT1_DRAGON?(o=s[i-r.VSUIT1_DRAGON],i=r.DRAGON):i>=r.VSUIT1&&(i=s[i-r.VSUIT1],o>9&&(o=t+o-R.CONSECUTIVE1));for(const c of e){let u=!1;if((c.suit===i&&c.number===o||c.suit===r.JOKER)&&(u=!0),u&&(a.tileArray.push(c),a.tileArray.length===n.count))break}return e.length===n.count&&a.tileArray.length===n.count&&(a.match=!0),a}rankFormComponents(e,t,n,s){const i=[];for(const f of n.components){const h={component:f,tileArray:[]};i.push(h)}const o=[];for(const f of i)o.push(f);for(const f of e.exposedTileSetArray){for(const m of i){if(m.tileArray.length>0)continue;const p=this.rankMatchComp(f.tileArray,t,m.component,s);if(p.match){m.tileArray=p.tileArray;break}}let h=!0;for(const m of f.tileArray){let p=!1;for(const d of i)if(d.tileArray.includes(m)){p=!0;break}if(!p){h=!1;break}}if(!h)return i}const a=e.getHiddenTileArray(),c=[],u=[];for(const f of a)f.suit===r.JOKER?u.push(f):c.push(f);for(const f of i){const h=f.component;if(f.tileArray.length>0)continue;const m=this.rankMatchComp(c,t,h,s);f.tileArray=m.tileArray;for(const p of m.tileArray){const d=c.indexOf(p);d!==-1&&c.splice(d,1)}}for(const f of u){let h=null,m=null,p=null;for(const d of o){const g=d.component.count-d.tileArray.length;if(d.component.count>=3&&g)switch(g){case 2:h=d;break;case 1:m=d;break;default:p=d;break}}m?m.tileArray.push(f):h?h.tileArray.push(f):p&&p.tileArray.push(f)}return i}_getEffectiveVsuitCount(e){let t=-1;for(const n of e.components)if(n.suit>=r.VSUIT1_DRAGON&&n.suit<=r.VSUIT3_DRAGON){const s=n.suit-r.VSUIT1_DRAGON;t=Math.max(t,s)}else if(n.suit>=r.VSUIT1&&n.suit<=r.VSUIT3){const s=n.suit-r.VSUIT1;t=Math.max(t,s)}return t>=0?t+1:0}sortHandRankArray(e){e.sort((t,n)=>n.rank-t.rank)}printHandRankArray(e,t){let n=e.length;t&&(n=Math.min(t,n));for(let s=0;s<n;s++){const i=e[s];I("Group = "+i.group.groupDescription+`
`),I("Hand = "+i.hand.description+`
`),I("Rank = "+i.rank+`
`);let o="";for(const a of i.componentInfoArray){o+="["+a.component.count+"] ";for(const c of a.tileArray)o+=c.getText()+" "}}}}export{Fe as A,We as B,Ye as C,C as D,$e as G,G as H,A as P,He as S,Be as T,Ke as U,R as V,Le as W,M as _,r as a,Me as b,Ue as c,I as d,Ve as e,Ge as f,Je as g,S as h,Pe as i,D as j,ke as k,ve as l,_ as m,xe as n,_e as p,je as r};
