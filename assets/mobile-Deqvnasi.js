import{S as v,r as ce,H as Y,a as m,D as R,n as C,k as I,P as L,d as U,B as de,i as b,_ as he,C as ue,A as me,G as pe}from"./card-CqysdcTl.js";class ge{constructor(){this.deferredPrompt=null,this.installBanner=null,this.init()}init(){window.addEventListener("beforeinstallprompt",e=>{e.preventDefault(),this.deferredPrompt=e,console.log("PWA install prompt captured"),this.checkShouldShowPrompt()}),window.addEventListener("appinstalled",()=>{console.log("PWA installed successfully"),this.markAsInstalled(),this.hidePrompt()}),this.createBannerUI(),this.isIOS()&&!this.isInStandaloneMode()&&this.checkShouldShowPrompt()}isIOS(){return/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream}isInStandaloneMode(){return window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0}checkShouldShowPrompt(){if(this.isAlreadyInstalled()){console.log("App already installed, skipping prompt");return}if(this.wasRecentlyDismissed()){console.log("User dismissed prompt recently, skipping");return}const e=this.getGamesPlayed();console.log(`Games played: ${e}`),e>=2&&setTimeout(()=>{this.showPrompt()},2e3)}getGamesPlayed(){return parseInt(localStorage.getItem("gamesPlayed")||"0",10)}static incrementGamesPlayed(){const e=parseInt(localStorage.getItem("gamesPlayed")||"0",10);localStorage.setItem("gamesPlayed",(e+1).toString()),console.log(`Games played: ${e+1}`)}isAlreadyInstalled(){return window.matchMedia("(display-mode: standalone)").matches?!0:localStorage.getItem("appInstalled")==="true"}wasRecentlyDismissed(){const e=localStorage.getItem("installPromptDismissedAt");if(!e)return!1;const t=parseInt(e,10),i=7*24*60*60*1e3;return Date.now()-t<i}markAsInstalled(){localStorage.setItem("appInstalled","true")}createBannerUI(){this.installBanner=document.createElement("div"),this.installBanner.id="install-banner",this.installBanner.className="install-banner",this.installBanner.style.display="none";const e=this.isIOS();this.installBanner.innerHTML=`
            <div class="install-banner__content">
                <div class="install-banner__icon">
                    <svg width="48" height="48" viewBox="0 0 64 64">
                        <rect x="4" y="4" width="56" height="56" rx="12" fill="#0c6d3a"/>
                        <rect x="15" y="15" width="34" height="34" rx="6" fill="rgba(4, 24, 14, 0.65)" stroke="#f5fbf7" stroke-width="2"/>
                        <rect x="19" y="19" width="26" height="26" rx="4" fill="#ffd166"/>
                    </svg>
                </div>
                <div class="install-banner__text">
                    <h3 class="install-banner__title">Install Mahjong</h3>
                    <p class="install-banner__message">${e?'Tap <strong style="font-size: 20px;">⎙</strong> then "Add to Home Screen"':"Add to home screen for quick access"}</p>
                </div>
                <div class="install-banner__actions">
                    ${e?"":`
                        <button class="install-banner__btn install-banner__btn--install" id="install-btn">
                            Install
                        </button>
                    `}
                    <button class="install-banner__btn install-banner__btn--dismiss" id="dismiss-btn">
                        ${e?"Got It":"Not Now"}
                    </button>
                </div>
            </div>
        `,document.body.appendChild(this.installBanner);const t=this.installBanner.querySelector("#install-btn"),i=this.installBanner.querySelector("#dismiss-btn");t&&t.addEventListener("click",()=>this.handleInstall()),i&&i.addEventListener("click",()=>this.handleDismiss()),this.injectStyles()}injectStyles(){const e=document.createElement("style");e.textContent=`
            .install-banner {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: linear-gradient(to top, rgba(4, 36, 21, 0.98), rgba(4, 36, 21, 0.95));
                backdrop-filter: blur(10px);
                border-top: 2px solid #ffd166;
                padding: 16px;
                box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                animation: slideUp 0.3s ease-out;
            }

            @keyframes slideUp {
                from {
                    transform: translateY(100%);
                }
                to {
                    transform: translateY(0);
                }
            }

            .install-banner__content {
                display: flex;
                align-items: center;
                gap: 12px;
                max-width: 600px;
                margin: 0 auto;
            }

            .install-banner__icon {
                flex-shrink: 0;
            }

            .install-banner__text {
                flex: 1;
                min-width: 0;
            }

            .install-banner__title {
                margin: 0;
                font-size: 16px;
                font-weight: 600;
                color: #f5fbf7;
                font-family: var(--font-stack, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif);
            }

            .install-banner__message {
                margin: 4px 0 0;
                font-size: 13px;
                color: rgba(245, 251, 247, 0.8);
                font-family: var(--font-stack, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif);
            }

            .install-banner__actions {
                display: flex;
                flex-direction: column;
                gap: 8px;
                flex-shrink: 0;
            }

            .install-banner__btn {
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                font-size: 14px;
                font-weight: 600;
                font-family: var(--font-stack, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif);
                cursor: pointer;
                transition: all 0.2s;
                min-width: 100px;
            }

            .install-banner__btn--install {
                background: #ffd166;
                color: #1f1400;
            }

            .install-banner__btn--install:hover {
                background: #ffda7a;
                transform: translateY(-1px);
                box-shadow: 0 2px 8px rgba(255, 209, 102, 0.4);
            }

            .install-banner__btn--dismiss {
                background: rgba(255, 255, 255, 0.1);
                color: rgba(245, 251, 247, 0.9);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }

            .install-banner__btn--dismiss:hover {
                background: rgba(255, 255, 255, 0.15);
            }

            /* Mobile responsive */
            @media (max-width: 480px) {
                .install-banner__content {
                    flex-wrap: wrap;
                }

                .install-banner__actions {
                    flex-direction: row;
                    width: 100%;
                    margin-top: 8px;
                }

                .install-banner__btn {
                    flex: 1;
                }
            }
        `,document.head.appendChild(e)}showPrompt(){if(this.isIOS()){this.installBanner.style.display="block",console.log("Install banner shown (iOS manual instructions)");return}if(!this.deferredPrompt){console.log("No deferred prompt available");return}this.installBanner.style.display="block",console.log("Install banner shown")}hidePrompt(){this.installBanner&&(this.installBanner.style.display="none")}async handleInstall(){if(!this.deferredPrompt){console.error("No deferred prompt available");return}this.deferredPrompt.prompt();const{outcome:e}=await this.deferredPrompt.userChoice;console.log(`Install prompt outcome: ${e}`),e==="accepted"?(console.log("User accepted install"),this.markAsInstalled()):(console.log("User dismissed install"),this.handleDismiss()),this.deferredPrompt=null,this.hidePrompt()}handleDismiss(){localStorage.setItem("installPromptDismissedAt",Date.now().toString()),console.log("Install prompt dismissed by user"),this.hidePrompt()}}class fe{constructor(){this.sheet=null,this.settingsButton=null,this.isOpen=!1,this.createUI(),this.loadSettings(),this.attachEventListeners()}createUI(){const e=v.getDefaults(),t=document.createElement("div");t.id="settings-overlay-mobile",t.className="settings-overlay-mobile";const i=document.createElement("div");i.id="settings-sheet",i.className="settings-sheet",i.innerHTML=`
            <div class="settings-sheet__header">
                <h2 class="settings-sheet__title">Settings</h2>
                <button class="settings-sheet__close" aria-label="Close settings">×</button>
            </div>

            <div class="settings-sheet__content">
                <!-- Game Settings Section -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Game</h3>

                    <div class="settings-item">
                        <label for="mobile-year">Card Year</label>
                        <select id="mobile-year" class="settings-select">
                            <option value="2025">2025</option>
                            <option value="2020">2020</option>
                            <option value="2019">2019</option>
                            <option value="2018">2018</option>
                            <option value="2017">2017</option>
                        </select>
                    </div>

                    <div class="settings-item">
                        <label for="mobile-difficulty">AI Difficulty</label>
                        <select id="mobile-difficulty" class="settings-select">
                            <option value="easy">Easy</option>
                            <option value="medium">Medium</option>
                            <option value="hard">Hard</option>
                        </select>
                    </div>

                    <div class="settings-item settings-item--toggle">
                        <label for="mobile-blank-tiles">Use Blank Tiles</label>
                        <input type="checkbox" id="mobile-blank-tiles" class="settings-checkbox">
                    </div>

                    <div class="settings-item settings-item--toggle">
                        <label for="mobile-skip-charleston">Skip Charleston</label>
                        <input type="checkbox" id="mobile-skip-charleston" class="settings-checkbox">
                    </div>
                </section>

                <!-- Display Settings Section -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Display</h3>

                    <div class="settings-item settings-item--toggle">
                        <label for="mobile-text-mode">
                            Text Mode
                            <span class="settings-hint">Display tiles as colorized text instead of sprites (accessibility)</span>
                        </label>
                        <input type="checkbox" id="mobile-text-mode" class="settings-checkbox">
                    </div>
                </section>

                <!-- Audio Settings Section -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Audio</h3>

                    <div class="settings-item">
                        <label for="mobile-bgm-volume">
                            Music Volume
                            <span class="volume-value" id="mobile-bgm-value">${e.bgmVolume}</span>
                        </label>
                        <div class="volume-control">
                            <input type="range" id="mobile-bgm-volume" class="settings-slider"
                                   min="0" max="100" step="1" value="${e.bgmVolume}">
                            <label class="mute-toggle">
                                <input type="checkbox" id="mobile-bgm-mute">
                                <span>Mute</span>
                            </label>
                        </div>
                    </div>

                    <div class="settings-item">
                        <label for="mobile-sfx-volume">
                            Sound Effects
                            <span class="volume-value" id="mobile-sfx-value">${e.sfxVolume}</span>
                        </label>
                        <div class="volume-control">
                            <input type="range" id="mobile-sfx-volume" class="settings-slider"
                                   min="0" max="100" step="1" value="${e.sfxVolume}">
                            <label class="mute-toggle">
                                <input type="checkbox" id="mobile-sfx-mute">
                                <span>Mute</span>
                            </label>
                        </div>
                    </div>
                </section>

                <!-- Training Mode Section (Optional) -->
                <section class="settings-section">
                    <h3 class="settings-section__title">Training Mode</h3>

                    <div class="settings-item settings-item--toggle">
                        <label for="mobile-training-mode">Enable Training Mode</label>
                        <input type="checkbox" id="mobile-training-mode" class="settings-checkbox">
                    </div>

                    <div id="mobile-training-controls" style="display: none;">
                        <div class="settings-item">
                            <label for="mobile-training-hand">Starting Hand Pattern</label>
                            <select id="mobile-training-hand" class="settings-select">
                                <option value="">Select a hand...</option>
                            </select>
                        </div>
                        <div class="settings-item">
                            <label for="mobile-training-tiles">Number of Tiles</label>
                            <select id="mobile-training-tiles" class="settings-select">
                                <option value="9">9 tiles</option>
                                <option value="10">10 tiles</option>
                                <option value="11">11 tiles</option>
                                <option value="12">12 tiles</option>
                                <option value="13">13 tiles</option>
                                <option value="14">14 tiles</option>
                            </select>
                        </div>
                    </div>
                </section>
            </div>

            <div class="settings-sheet__footer">
                <button class="settings-btn settings-btn--secondary" id="mobile-settings-reset">
                    Reset to Defaults
                </button>
                <button class="settings-btn settings-btn--primary" id="mobile-settings-save">
                    Save & Close
                </button>
            </div>
        `,t.appendChild(i),document.body.appendChild(t),this.sheet=i,this.overlay=t}loadSettings(){const e=v.load();document.getElementById("mobile-year").value=e.cardYear,document.getElementById("mobile-difficulty").value=e.difficulty,document.getElementById("mobile-blank-tiles").checked=e.useBlankTiles,document.getElementById("mobile-bgm-volume").value=e.bgmVolume,document.getElementById("mobile-bgm-value").textContent=e.bgmVolume,document.getElementById("mobile-bgm-mute").checked=e.bgmMuted,document.getElementById("mobile-sfx-volume").value=e.sfxVolume,document.getElementById("mobile-sfx-value").textContent=e.sfxVolume,document.getElementById("mobile-sfx-mute").checked=e.sfxMuted,document.getElementById("mobile-text-mode").checked=e.textMode||!1,document.getElementById("mobile-training-mode").checked=e.trainingMode,document.getElementById("mobile-training-hand").value=e.trainingHand,document.getElementById("mobile-training-tiles").value=e.trainingTileCount,document.getElementById("mobile-skip-charleston").checked=e.skipCharleston,this.updateTrainingVisibility(e.trainingMode)}attachEventListeners(){const e=document.getElementById("mobile-settings-btn");e&&e.addEventListener("click",()=>this.open()),this.sheet.querySelector(".settings-sheet__close").addEventListener("click",()=>this.close()),this.overlay.addEventListener("click",t=>{t.target===this.overlay&&this.close()}),document.getElementById("mobile-bgm-volume").addEventListener("input",t=>{document.getElementById("mobile-bgm-value").textContent=t.target.value}),document.getElementById("mobile-sfx-volume").addEventListener("input",t=>{document.getElementById("mobile-sfx-value").textContent=t.target.value}),document.getElementById("mobile-training-mode").addEventListener("change",t=>{this.updateTrainingVisibility(t.target.checked)}),document.getElementById("mobile-settings-save").addEventListener("click",()=>{this.saveSettings(),this.close()}),document.getElementById("mobile-settings-reset").addEventListener("click",()=>{window.confirm("Reset all settings to defaults?")&&(v.reset(),this.loadSettings())})}saveSettings(){var t,i,s,n,r,o,a,c,h,u,g,S;const e={cardYear:parseInt(((t=document.getElementById("mobile-year"))==null?void 0:t.value)??v.getDefault("cardYear").toString()),difficulty:((i=document.getElementById("mobile-difficulty"))==null?void 0:i.value)??v.getDefault("difficulty"),useBlankTiles:((s=document.getElementById("mobile-blank-tiles"))==null?void 0:s.checked)??v.getDefault("useBlankTiles"),bgmVolume:parseInt(((n=document.getElementById("mobile-bgm-volume"))==null?void 0:n.value)??v.getDefault("bgmVolume").toString()),bgmMuted:((r=document.getElementById("mobile-bgm-mute"))==null?void 0:r.checked)??v.getDefault("bgmMuted"),sfxVolume:parseInt(((o=document.getElementById("mobile-sfx-volume"))==null?void 0:o.value)??v.getDefault("sfxVolume").toString()),sfxMuted:((a=document.getElementById("mobile-sfx-mute"))==null?void 0:a.checked)??v.getDefault("sfxMuted"),textMode:((c=document.getElementById("mobile-text-mode"))==null?void 0:c.checked)??!1,trainingMode:((h=document.getElementById("mobile-training-mode"))==null?void 0:h.checked)??v.getDefault("trainingMode"),trainingHand:((u=document.getElementById("mobile-training-hand"))==null?void 0:u.value)??v.getDefault("trainingHand"),trainingTileCount:parseInt(((g=document.getElementById("mobile-training-tiles"))==null?void 0:g.value)??v.getDefault("trainingTileCount").toString()),skipCharleston:((S=document.getElementById("mobile-skip-charleston"))==null?void 0:S.checked)??v.getDefault("skipCharleston")};v.save(e),console.log("Settings saved:",e),window.dispatchEvent(new window.CustomEvent("settingsChanged",{detail:e}))}updateTrainingVisibility(e){const t=document.getElementById("mobile-training-controls");t&&(t.style.display=e?"block":"none")}populateHandSelector(e){const t=document.getElementById("mobile-training-hand");if(!(!t||!e||!e.validHandGroups)){t.innerHTML='<option value="">Select a hand...</option>';for(const i of e.validHandGroups){const s=document.createElement("optgroup");s.label=i.groupDescription,t.appendChild(s);for(const n of i.hands){const r=document.createElement("option");r.value=n.description,r.text=n.description,t.appendChild(r)}}console.log("Hand selector populated with",e.validHandGroups.length,"groups")}}open(){this.isOpen=!0,this.overlay.classList.add("open"),this.sheet.classList.add("open"),document.body.style.overflow="hidden"}close(){this.isOpen=!1,this.overlay.classList.remove("open"),this.sheet.classList.remove("open"),document.body.style.overflow=""}}class ye{constructor(e,t){if(!e)throw new Error("WallCounter requires a container element");if(!t)throw new Error("WallCounter requires a gameController instance");this.container=e,this.gameController=t,this.unsubscribeFns=[],this.render(),this.setupListeners()}render(){const e=this.container.querySelector(".wall-tiles");e&&(e.textContent=this.getWallCount())}setupListeners(){const e=()=>this.update();this.unsubscribeFns.push(this.gameController.on("TILE_DRAWN",e));const t=()=>this.update();this.unsubscribeFns.push(this.gameController.on("GAME_STARTED",t));const i=()=>this.update();this.unsubscribeFns.push(this.gameController.on("TILES_DEALT",i))}getWallCount(){return this.gameController.wallTiles?this.gameController.wallTiles.length:0}update(){const e=this.container.querySelector(".wall-tiles");if(e){const t=this.getWallCount();e.textContent=t,t<=8?e.classList.add("low-count"):e.classList.remove("low-count")}}destroy(){this.unsubscribeFns.forEach(e=>{typeof e=="function"&&e()}),this.unsubscribeFns=[],this.container=null,this.gameController=null}}class be{constructor(e,t,i){if(!e)throw new Error("HintsPanel requires a container element");if(!t)throw new Error("HintsPanel requires a gameController instance");if(!i)throw new Error("HintsPanel requires an aiEngine instance");this.container=e,this.gameController=t,this.aiEngine=i,this.isExpanded=!0,this.unsubscribeFns=[],this._disabled=!1,this.latestHandData=null,this._onToggle=this.toggle.bind(this),this.touchStartY=0,this.touchStartX=0,this._onTouchStart=this.handleTouchStart.bind(this),this._onTouchEnd=this.handleTouchEnd.bind(this),this.render(),this.setupListeners()}render(){if(this.toggleBtn=this.container.querySelector("#hints-toggle"),this.contentEl=this.container.querySelector("#hints-content"),!this.toggleBtn||!this.contentEl){console.error("HintsPanel: Missing required DOM elements"),this._disabled=!0,this.destroy();return}this.toggleBtn.addEventListener("click",this._onToggle),this.toggleBtn.addEventListener("touchstart",this._onTouchStart,{passive:!0}),this.toggleBtn.addEventListener("touchend",this._onTouchEnd),this.toggleBtn.setAttribute("aria-expanded","true"),this.contentEl.style.display="block",this.showSkeletonHints()}setupListeners(){const e=i=>{if(i.player===0){const s=Y.fromJSON(i.hand);this.updateHints(s)}};this.unsubscribeFns.push(this.gameController.on("HAND_UPDATED",e));const t=()=>{this.clearHints()};this.unsubscribeFns.push(this.gameController.on("GAME_ENDED",t))}updateHints(e){if(!(this._disabled||!this.contentEl)){if(this.latestHandData=e,!e||!e.tiles||e.tiles.length===0){this.clearHints();return}this.isExpanded&&(this.showSkeletonHints(),setTimeout(()=>{this.computeAndRenderHints(e)},300))}}showSkeletonHints(){if(this._disabled||!this.contentEl)return;let e='<div class="hint-item">';for(let t=0;t<3;t++)e+=`
                <div class="hint-pattern hint-pattern-skeleton">
                    <div class="hint-pattern-header">
                        <strong>&nbsp;</strong>
                        <span class="hint-rank">&nbsp;</span>
                    </div>
                    <div class="hint-pattern-tiles" style="min-height: 32px;">&nbsp;</div>
                </div>
            `;e+="</div>",this.contentEl.innerHTML=e}computeAndRenderHints(e){if(!(this._disabled||!this.contentEl))try{const t=this.aiEngine.card.rankHandArray14(e);if(!t||t.length===0){this.contentEl.innerHTML=`
                    <div class="hint-item">
                        <span class="hint-label">No patterns available</span>
                    </div>
                `;return}const s=[...t].sort((u,g)=>g.rank-u.rank).slice(0,3),n=this.aiEngine.getTileRecommendations(e,1),r=n.consideredPatternCount,o=n.recommendations.filter(u=>u.recommendation==="DISCARD"&&u.tile).map(u=>u.tile);this.isExpanded&&this.emitDiscardRecommendations(o,!0);const a=e.getAllTilesIncludingExposures(),c=e.tiles;let h='<div class="hint-item">';s.forEach((u,g)=>{var X,j,z,J,Q,Z;const S=g===0||g<r,E=S?"":"opacity: 0.4;",T=!S&&g>0?" <em>(not considered)</em>":"",w=ce(u,a,c),l=this.compactText((X=u.group)==null?void 0:X.groupDescription),f=this.compactText((j=u.hand)==null?void 0:j.description),_=((z=u.rank)==null?void 0:z.toFixed(2))||"0.00",q=((J=u.card)==null?void 0:J.year)||((Q=this.gameController.settings)==null?void 0:Q.year)||"",ae=((Z=u.hand)==null?void 0:Z.concealed)===!0?'<span class="concealed-badge" title="Concealed">C</span>':"",le=[q,l,f].filter(Boolean);h+=`
                    <div class="hint-pattern" style="${E}" title="${l}${f?" - "+f:""}">
                        <div class="hint-pattern-header">
                            <strong>${le.join(" - ")}</strong>
                            <span class="hint-rank">(Rank: ${_})${T}</span>
                            ${ae}
                        </div>
                        ${w}
                    </div>
                `}),h+="</div>",this.contentEl.innerHTML=h}catch(t){console.error("HintsPanel: Error generating hints:",t),this.contentEl.innerHTML=`
                <div class="hint-item">
                    <span class="hint-label">Unable to generate hints</span>
                </div>
            `}}formatTile(e){if(!e)return"Unknown";if(typeof e.getText=="function")return e.getText();const{suit:t,number:i}=e;return t===0||t==="CRACK"?`${i}C`:t===1||t==="BAM"?`${i}B`:t===2||t==="DOT"?`${i}D`:t===3||t==="WIND"?["N","S","W","E"][i]||`W${i}`:t===4||t==="DRAGON"?["Red","Green","White"][i]||`D${i}`:t===5||t==="FLOWER"?`F${i+1}`:t===6||t==="JOKER"?"J":`${t}-${i}`}compactText(e=""){return e.replace(/\s*\(.*?\)/g,"").trim()}clearHints(){this._disabled||!this.contentEl||(this.contentEl.innerHTML=`
            <div class="hint-item">
                <span class="hint-label">Play to see recommendations</span>
            </div>
        `,this.isExpanded&&this.emitDiscardRecommendations([],!1))}handleTouchStart(e){e.touches.length>0&&(this.touchStartY=e.touches[0].clientY,this.touchStartX=e.touches[0].clientX)}handleTouchEnd(e){if(e.changedTouches.length>0){const t=e.changedTouches[0].clientY,i=e.changedTouches[0].clientX,s=t-this.touchStartY,n=i-this.touchStartX;Math.abs(s)>Math.abs(n)&&Math.abs(s)>30&&(e.preventDefault(),s<0&&!this.isExpanded?this.expand():s>0&&this.isExpanded&&this.collapse())}}toggle(){this.isExpanded?this.collapse():this.expand()}expand(){this._disabled||!this.contentEl||!this.toggleBtn||(this.isExpanded=!0,this.contentEl.style.display="block",this.toggleBtn.setAttribute("aria-expanded","true"),this.latestHandData&&(this.showSkeletonHints(),setTimeout(()=>{this.computeAndRenderHints(this.latestHandData)},500)))}collapse(){this._disabled||!this.contentEl||!this.toggleBtn||(this.isExpanded=!1,this.contentEl.style.display="none",this.toggleBtn.setAttribute("aria-expanded","false"),this.emitDiscardRecommendations([],!1))}destroy(){this.unsubscribeFns.forEach(e=>{typeof e=="function"&&e()}),this.unsubscribeFns=[],this.toggleBtn&&(this._onToggle&&this.toggleBtn.removeEventListener("click",this._onToggle),this._onTouchStart&&this.toggleBtn.removeEventListener("touchstart",this._onTouchStart),this._onTouchEnd&&this.toggleBtn.removeEventListener("touchend",this._onTouchEnd)),this._disabled=!0,this.container=null,this.gameController=null,this.aiEngine=null,this.toggleBtn=null,this.contentEl=null,this._onToggle=null}emitDiscardRecommendations(e=[],t=!0){!this.gameController||typeof this.gameController.emit!="function"||this.gameController.emit("HINT_DISCARD_RECOMMENDATIONS",{tiles:e,active:t})}}class Se{constructor(){this.tileIndices=new Map,this.initMapping()}initMapping(){let e=0;for(let t=1;t<=9;t++)this.tileIndices.set(`BAM-${t}`,e++),this.tileIndices.set(`CRACK-${t}`,e++),this.tileIndices.set(`DOT-${t}`,e++);this.tileIndices.set("DRAGON-1",e++),this.tileIndices.set("DRAGON-0",e++),this.tileIndices.set("DRAGON-2",e++),this.tileIndices.set("WIND-3",30);for(let t=0;t<8;t++){const i=t%4;this.tileIndices.set(`FLOWER-${t}`,31+i),this.tileIndices.set(`FLOWER-${t+1}`,31+i)}for(let t=0;t<8;t++)this.tileIndices.set(`JOKER-${t}`,35);this.tileIndices.set("WIND-0",36),this.tileIndices.set("WIND-1",37),this.tileIndices.set("WIND-2",38);for(let t=0;t<8;t++)this.tileIndices.set(`BLANK-${t}`,-1)}getSpritePosition(e){const t=this.getTileKey(e),i=this.tileIndices.get(t);return i===void 0?(console.warn("No sprite index found for tile:",e,t),{xPct:0,yPct:0}):{xPct:i/38*100,yPct:0}}getTileKey(e){if(!e)return"unknown";let t=e.suit;const i=e.number;return(t===0||t==="CRACK")&&(t="CRACK"),(t===1||t==="BAM")&&(t="BAM"),(t===2||t==="DOT")&&(t="DOT"),(t===3||t==="WIND")&&(t="WIND"),(t===4||t==="DRAGON")&&(t="DRAGON"),(t===5||t==="FLOWER")&&(t="FLOWER"),(t===6||t==="JOKER")&&(t="JOKER"),(t===7||t==="BLANK")&&(t="BLANK"),`${t}-${i}`}createTileElement(e,t="normal"){const i=document.createElement("div");i.className=`tile tile--${t}`;const s=this.getTileKey(e),n=this.tileIndices.get(s);if(n===-1)i.style.backgroundImage="url('/mahjong/assets/back.png')",i.style.backgroundPosition="center",i.style.backgroundSize="contain";else if(n===void 0)console.error("createTileElement: No sprite index for tile",e,"key:",s),i.style.backgroundImage="url('/mahjong/assets/back.png')",i.style.backgroundPosition="center",i.style.backgroundSize="contain";else{const r=this.getSpritePosition(e);i.style.backgroundPosition=`${r.xPct}% ${r.yPct}%`}return i.dataset.tileId=s,i}}const H=new Se,O={[m.CRACK]:"red",[m.BAM]:"green",[m.DOT]:"blue",[m.WIND]:"black",[m.DRAGON]:"blue",[m.FLOWER]:"black",[m.JOKER]:"gray",[m.BLANK]:"gray"};function Te(d){if(!d)return{char:"?",color:"gray"};const{suit:e,number:t}=d;return e===m.JOKER?{char:"J",color:O[m.JOKER]}:e===m.FLOWER?{char:"F",color:O[m.FLOWER]}:e===m.WIND?{char:{[C.NORTH]:"N",[C.EAST]:"E",[C.SOUTH]:"S",[C.WEST]:"W"}[t]||"?",color:O[m.WIND]}:e===m.DRAGON?t===R.WHITE?{char:"0",color:"blue"}:{char:"D",color:{[R.RED]:"red",[R.GREEN]:"green",[R.WHITE]:"blue"}[t]||"blue"}:t>=1&&t<=9?{char:t.toString(),color:O[e]||"blue"}:e===m.BLANK?{char:"BL",color:O[m.BLANK]}:{char:"?",color:"gray"}}function ee(d,e="normal"){const t=Te(d),i=document.createElement("div");i.className=`tile tile--text-mode tile--${e}`,i.dataset.suit=d.suit,i.dataset.number=d.number,d.index!==void 0&&(i.dataset.index=d.index);const s=Ee(t.color);return i.className+=` ${s}`,i.textContent=t.char,i.setAttribute("role","img"),i.setAttribute("aria-label",ve(d)),i}function Ee(d){const e={red:"bg-red-600 text-white border-red-700",green:"bg-green-600 text-white border-green-700",blue:"bg-blue-600 text-white border-blue-700",black:"bg-black text-white border-gray-800",gray:"bg-gray-600 text-white border-gray-700"};return e[d]||e.gray}function ve(d){if(!d)return"Unknown tile";const{suit:e,number:t}=d;if(e===m.JOKER)return"Joker";if(e===m.FLOWER)return`Flower ${t+1}`;if(e===m.BLANK)return"Blank tile";if(e===m.WIND)return`${{[C.NORTH]:"North",[C.EAST]:"East",[C.SOUTH]:"South",[C.WEST]:"West"}[t]||"Unknown"} Wind`;if(e===m.DRAGON)return`${{[R.RED]:"Red",[R.GREEN]:"Green",[R.WHITE]:"White"}[t]||"Unknown"} Dragon`;const i={[m.CRACK]:"Crack",[m.BAM]:"Bam",[m.DOT]:"Dot"};return i[e]&&t>=1&&t<=9?`${t} ${i[e]}`:"Unknown tile"}const we={[m.CRACK]:"CRACK",[m.BAM]:"BAM",[m.DOT]:"DOT",[m.WIND]:"WIND",[m.DRAGON]:"DRAGON",[m.FLOWER]:"FLOWER",[m.JOKER]:"JOKER",[m.BLANK]:"BLANK"},xe={[C.NORTH]:"N",[C.SOUTH]:"S",[C.WEST]:"W",[C.EAST]:"E"},Ce={[R.RED]:"R",[R.GREEN]:"G",[R.WHITE]:"0"};class Ae{constructor(e){if(!e)throw new Error("HandRenderer requires a container element");this.container=e,this.debug=!1,this.tiles=[],this.interactive=!0,this.handContainer=null,this.exposedSection=null,this.currentHandData=null,this.currentSortMode=null,this.textMode=!1,this.selectionManager=null,this.eventCoordinator=null,this.setupDOM()}setSelectionManager(e){this.selectionManager=e}setEventCoordinator(e){this.eventCoordinator=e}setTextMode(e){this.textMode!==e&&(this.textMode=e,this.currentHandData&&this.render(this.currentHandData))}isTextMode(){return this.textMode}renderWithGlow(e,t){this.render(e),(Array.isArray(t)?t:Array.from(t||[])).forEach(s=>{const n=this.tiles[s];n&&n.classList.add("tile--newly-drawn")})}getTileElementsByIndices(e){return e.map(t=>this.tiles[t]).filter(Boolean)}hideTemporarily(e){e.forEach(t=>{const i=this.tiles[t];i&&(i.style.visibility="hidden")})}showWithAnimation(e,t){e.forEach(i=>{const s=this.tiles[i];s&&(s.style.visibility="visible",s.classList.add(t))})}setupDOM(){this.container.innerHTML="",this.container.classList.add("hand-section"),this.exposedSection=document.createElement("div"),this.exposedSection.className="exposed-section",this.container.appendChild(this.exposedSection),this.handContainer=document.createElement("div"),this.handContainer.className="hand-container hand-grid",this.container.appendChild(this.handContainer)}render(e){if(!e){this.renderExposures([]),this.clearTiles(),this.currentHandData=null;return}this.currentSortMode===null&&e.sortBySuit&&e.sortBySuit(),this.currentHandData=e,this.renderExposures(Array.isArray(e.exposures)?e.exposures:[]),this.clearTiles();const t=Array.isArray(e.tiles)?e.tiles:[];if(this.debug&&console.log(`[HandRenderer] Rendering ${t.length} tiles`),t.forEach((i,s)=>{var r,o;const n=this.createTileButton(i,s);if(this.selectionManager){const a=this.getTileSelectionKey(i,s);this.selectionManager.registerTile(s,a)}(r=this.selectionManager)!=null&&r.isSelected(s)&&n.classList.add("selected"),((o=this.eventCoordinator)==null?void 0:o.newlyDrawnTileIndex)===i.index&&n.classList.add("tile--newly-drawn"),this.tiles.push(n),this.handContainer.appendChild(n)}),this.setInteractive(this.interactive),this.selectionManager){const i=this.selectionManager.getSelectionState(e);this.applySelectionIndices(i.indices)}}renderExposures(e){this.exposedSection&&(this.exposedSection.innerHTML="",!(!Array.isArray(e)||e.length===0)&&e.forEach(t=>{if(!t||!Array.isArray(t.tiles))return;const i=document.createElement("div");i.className="exposure-set",t.type&&(i.dataset.type=t.type),t.tiles.forEach(s=>{let n;if(this.textMode)n=ee(s,"small");else{if(n=document.createElement("div"),n.className="tile tile--small",n.setAttribute("role","img"),s){const o=H.getSpritePosition(s);n.style.backgroundPosition=`${o.xPct}% ${o.yPct}%`}n.dataset.suit=this.getSuitName(s==null?void 0:s.suit),n.dataset.number=this.getDataNumber(s);const r=this.formatTileText(s);r&&n.setAttribute("aria-label",r)}i.appendChild(n)}),this.exposedSection.appendChild(i)}))}clearTiles(){var e;this.debug&&console.log(`[HandRenderer] Clearing ${this.tiles.length} tiles from DOM`),this.tiles.forEach(t=>{const i=t.__handRendererHandler;i&&(t.removeEventListener("click",i),delete t.__handRendererHandler)}),this.selectionManager&&(e=this.selectionManager.selectionKeyByIndex)!=null&&e.clear&&this.selectionManager.selectionKeyByIndex.clear(),this.tiles=[],this.handContainer&&(this.handContainer.innerHTML="",this.debug&&console.log(`[HandRenderer] DOM cleared, handContainer.children.length = ${this.handContainer.children.length}`))}createTileButton(e,t){let i;if(this.textMode){i=ee(e,"default");const n=document.createElement("button");n.type="button",n.className=i.className,n.dataset.suit=i.dataset.suit,n.dataset.number=i.dataset.number,n.dataset.index=String(t),n.textContent=i.textContent,n.setAttribute("role",i.getAttribute("role")),n.setAttribute("aria-label",i.getAttribute("aria-label")),i=n}else{if(i=document.createElement("button"),i.type="button",i.className="tile tile--default",e){const r=H.getSpritePosition(e);i.style.backgroundPosition=`${r.xPct}% ${r.yPct}%`}i.dataset.suit=this.getSuitName(e==null?void 0:e.suit),i.dataset.number=this.getDataNumber(e),i.dataset.index=String(t);const n=this.formatTileText(e);n&&i.setAttribute("aria-label",n)}i.disabled=!this.interactive;const s=n=>{n.preventDefault(),n.stopPropagation(),this.interactive&&this.selectionManager&&this.selectionManager.handleTileClick(t)};return i.__handRendererHandler=s,i.addEventListener("click",s),i}getLastTileElement(){return this.tiles&&this.tiles.length>0?this.tiles[this.tiles.length-1]:null}getTileElementByIndex(e){return this.tiles&&e>=0&&e<this.tiles.length?this.tiles[e]:null}applySelectionIndices(e=[]){const t=e instanceof Set?e:new Set(e);this.tiles.forEach((i,s)=>{i&&(t.has(s)?i.classList.add("selected"):i.classList.remove("selected"))})}sortHand(e="suit"){if(!this.currentHandData)return;this.currentSortMode=e;const t=this.cloneHandData(this.currentHandData);t&&(e==="rank"?typeof t.sortByRank=="function"?t.sortByRank():Array.isArray(t.tiles)&&t.tiles.sort((i,s)=>i.number!==s.number?i.number-s.number:i.suit-s.suit):typeof t.sortBySuit=="function"?t.sortBySuit():Array.isArray(t.tiles)&&t.tiles.sort((i,s)=>i.suit!==s.suit?i.suit-s.suit:i.number-s.number),this.render(t))}setInteractive(e){this.interactive=!!e,this.tiles.forEach(t=>{t.disabled=!this.interactive})}destroy(){this.clearTiles(),this.exposedSection&&(this.exposedSection.innerHTML=""),this.container=null,this.handContainer=null,this.exposedSection=null,this.currentHandData=null,this.selectionManager=null,this.eventCoordinator=null}getSuitName(e){return we[e]||"UNKNOWN"}getDataNumber(e){return!e||typeof e.number>"u"?"":String(e.number)}formatTileText(e){if(!e)return"";const{suit:t,number:i}=e;return t===m.CRACK?`${i}C`:t===m.BAM?`${i}B`:t===m.DOT?`${i}D`:t===m.WIND?xe[i]||"":t===m.DRAGON?Ce[i]||"D":t===m.FLOWER?`F${typeof i=="number"?i+1:1}`:t===m.JOKER?"J":t===m.BLANK?"BL":`${i??""}`}cloneHandData(e){return e?typeof e.clone=="function"?e.clone():{tiles:Array.isArray(e.tiles)?e.tiles.map(t=>({...t})):[],exposures:Array.isArray(e.exposures)?e.exposures.map(t=>({type:t==null?void 0:t.type,tiles:Array.isArray(t==null?void 0:t.tiles)?t.tiles.map(i=>({...i})):[]})):[]}:null}toTileData(e){return e?e instanceof I?e.clone():I.fromJSON(e):null}getTileSelectionKey(e,t){if(!e)return`missing-${t}`;if(typeof e.index=="number"&&e.index>=0)return`idx-${e.index}`;const i=e.suit??"unknown",s=e.number??"unknown";return`${i}:${s}:${t}`}}class Ie{constructor(){this.selectedIndices=new Set,this.selectionKeyByIndex=new Map,this.selectionBehavior={mode:"multiple",maxSelectable:1/0,allowToggle:!0,validationMode:void 0},this.selectionListener=null}setSelectionBehavior(e={}){this.selectionBehavior={...this.selectionBehavior,...e}}setSelectionListener(e){this.selectionListener=typeof e=="function"?e:null}handleTileClick(e){const t=this.selectionKeyByIndex.get(e);if(!t)return;const i=this.selectedIndices.has(t),{mode:s,maxSelectable:n,allowToggle:r,validationMode:o}=this.selectionBehavior;if(!(!i&&!this.canSelectTile(e,o))){if(s==="single"){i&&r!==!1?this.selectTile(e,{state:"off",toggle:!1}):(this.clearSelection(!0),this.selectTile(e,{state:"on",toggle:!1}));return}if(i)r!==!1&&this.selectTile(e,{state:"off",toggle:!1});else{if(this.selectedIndices.size>=n)return;this.selectTile(e,{state:"on",toggle:!1})}}}selectTile(e,t={}){const i=this.selectionKeyByIndex.get(e);if(!i)return!1;const{state:s,toggle:n=!0,clearOthers:r=!1,silent:o=!1}=t;r&&this.clearSelection(!0);let a;s==="on"?a=!0:s==="off"?a=!1:n?a=!this.selectedIndices.has(i):a=!0;let c=!1;return a?this.selectedIndices.has(i)||(this.selectedIndices.add(i),c=!0):this.selectedIndices.delete(i)&&(c=!0),c&&!o&&this.notifySelectionChange(),c}clearSelection(e=!1){return this.selectedIndices.size===0?!1:(this.selectedIndices.clear(),e||this.notifySelectionChange(),!0)}getSelectedTileIndices(e=null){if(e&&Array.isArray(e.tiles)){const i=[];for(let s=0;s<e.tiles.length;s++){const n=e.tiles[s];if(!n)continue;let r;if(typeof n.index=="number"&&n.index>=0)r=`idx-${n.index}`;else{const o=n.suit??"unknown",a=n.number??"unknown";r=`${o}:${a}:${s}`}this.selectedIndices.has(r)&&i.push(s)}return i}const t=[];for(const[i,s]of this.selectionKeyByIndex.entries())this.selectedIndices.has(s)&&t.push(i);return t}getSelectedTiles(e){if(!e||!Array.isArray(e.tiles))return[];const t=[],i=new Map;for(const s of e.tiles){if(!s)continue;let n;if(typeof s.index=="number"&&s.index>=0)n=`idx-${s.index}`;else continue;i.set(n,s)}for(const s of this.selectedIndices){const n=i.get(s);if(!n)continue;const r=this.toTileData(n);r&&t.push(r)}return t}getSelectionState(e){const t=this.getSelectedTileIndices(e),i=Array.isArray(e==null?void 0:e.tiles)?this.getSelectedTiles(e):[];return{count:t.length,indices:t,tiles:i}}isSelected(e){const t=this.selectionKeyByIndex.get(e);return this.selectedIndices.has(t)}validateSelection(e,t={}){const i=this.selectedIndices.size===e,s=i?"Selection valid":this.selectedIndices.size<e?`Select ${e-this.selectedIndices.size} more tiles`:`Select only ${e} tiles`;return{valid:i,message:s,count:this.selectedIndices.size}}registerTile(e,t){this.selectionKeyByIndex.set(e,t)}notifySelectionChange(){typeof this.selectionListener=="function"&&this.selectionListener(this.getSelectionState())}canSelectTile(e,t){return t?["charleston","courtesy","play","blank-only"].includes(t):!0}toTileData(e){return e?e instanceof I?e.clone():I.fromJSON(e):null}destroy(){this.selectedIndices.clear(),this.selectionKeyByIndex.clear(),this.selectionListener=null}}function k(d){if(!d||!d.getBoundingClientRect)return{x:0,y:0};const e=d.getBoundingClientRect();return{x:e.left+e.width/2,y:e.top+e.height/2}}class ke{constructor(e,t,i,s=null){this.gameController=e,this.handRenderer=t,this.selectionManager=i,this.mobileRenderer=s,this.unsubscribeFns=[],this.hintRecommendationKeys=new Set,this.newlyDrawnTileIndex=null,this.previousHandSnapshot=null,this.setupEventListeners()}setupEventListeners(){!this.gameController||typeof this.gameController.on!="function"||(this.unsubscribeFns.push(this.gameController.on("HAND_UPDATED",e=>this.onHandUpdated(e))),this.unsubscribeFns.push(this.gameController.on("TILE_SELECTED",e=>this.onTileSelected(e))),this.unsubscribeFns.push(this.gameController.on("TILE_DRAWN",e=>this.onTileDrawn(e))),this.unsubscribeFns.push(this.gameController.on("TILE_DISCARDED",e=>this.onTileDiscarded(e))),this.unsubscribeFns.push(this.gameController.on("HINT_DISCARD_RECOMMENDATIONS",e=>this.onHintRecommendations(e))))}onHandUpdated(e={}){var t,i,s,n,r,o;if(e.player===0){if((t=this.mobileRenderer)!=null&&t.isDealingAnimationRunning||(i=this.mobileRenderer)!=null&&i.isDiscardAnimationRunning)return;const a=Y.fromJSON(e.hand);if((s=this.mobileRenderer)!=null&&s.justCompletedDealingAnimation){this.mobileRenderer.justCompletedDealingAnimation=!1,this.previousHandSnapshot=a.clone(),this.mobileRenderer&&(this.mobileRenderer.latestHandSnapshot=a,this.mobileRenderer.previousHandSnapshot=a.clone());return}const h=this.previousHandSnapshot&&a.tiles.length===this.previousHandSnapshot.tiles.length?this._findNewlyReceivedTiles(this.previousHandSnapshot,a):[];if(this.handRenderer&&(this.handRenderer.currentSortMode=null),this.handRenderer&&(this.handRenderer.render(a),this.applyHintRecommendations()),(n=this.mobileRenderer)!=null&&n.playerRack&&this.mobileRenderer.playerRack.update(a.toJSON()),this.mobileRenderer&&(this.mobileRenderer.updateJokerSwapButton(),this.mobileRenderer.updateBlankSwapButton(),this.mobileRenderer.updateMahjongButton()),h.length>0&&this.handRenderer&&((r=this.mobileRenderer)!=null&&r.animationController)){const T=a.tiles;h.forEach(w=>{const l=T.findIndex(f=>(f==null?void 0:f.index)===w);if(l>=0){const f=this.handRenderer.getTileElementByIndex(l);f&&this.mobileRenderer.animationController.applyReceivedTileGlow(f)}})}const u=this.previousHandSnapshot&&a.tiles.length>this.previousHandSnapshot.tiles.length,g=!this.previousHandSnapshot,S=h.length>0;if((g||u||S)&&(this.previousHandSnapshot=a.clone(),this.mobileRenderer&&(this.mobileRenderer.previousHandSnapshot=a.clone())),this.mobileRenderer&&(this.mobileRenderer.latestHandSnapshot=a),a.tiles.length%3===2&&this.handRenderer&&((o=this.mobileRenderer)!=null&&o.animationController)){const T=this.handRenderer.getLastTileElement();if(T){const w={x:window.innerWidth*-.2,y:window.innerHeight*-.2},l=k(T);this.mobileRenderer.animationController.animateTileDraw(T,w,l)}}}else if(this.mobileRenderer&&this.gameController){const a=this.gameController.players[e.player];if(a){const c=this.mobileRenderer.opponentBars.find(h=>h.playerIndex===e.player);c&&c.bar.update(a)}}}onTileSelected(e={}){if(this.selectionManager){if(typeof e.index=="number"){this.selectionManager.selectTile(e.index,{toggle:e.toggle!==!1,clearOthers:!!e.exclusive,state:e.state});return}Array.isArray(e.indices)&&(e.clearExisting&&this.selectionManager.clearSelection(),e.indices.forEach(t=>{typeof t=="number"&&this.selectionManager.selectTile(t,{state:e.state??"on",toggle:!1})}))}}onTileDrawn(e={}){e.player===0&&e.tile&&(this.newlyDrawnTileIndex=e.tile.index,this.handRenderer&&(this.handRenderer.newlyDrawnTileIndex=this.newlyDrawnTileIndex))}onTileDiscarded(e={}){e.player===0&&(this.newlyDrawnTileIndex=null,this.handRenderer&&(this.handRenderer.newlyDrawnTileIndex=null,this.handRenderer.tiles.forEach(t=>{t&&t.classList.remove("tile--newly-drawn")})))}onHintRecommendations(e={}){const t=Array.isArray(e.tiles)?e.tiles:[];if(!(e.active!==!1)||t.length===0){this.hintRecommendationKeys.clear(),this.applyHintRecommendations();return}const s=t.map((n,r)=>this.getTileSelectionKey(n,r)).filter(Boolean);this.hintRecommendationKeys=new Set(s),this.applyHintRecommendations()}applyHintRecommendations(){var t;if(!this.handRenderer)return;const e=((t=this.handRenderer.currentHandData)==null?void 0:t.tiles)||[];this.handRenderer.tiles.forEach((i,s)=>{const n=this.getTileSelectionKey(e[s],s);if(!n){i.classList.remove("tile--hint-discard");return}this.hintRecommendationKeys.has(n)?i.classList.add("tile--hint-discard"):i.classList.remove("tile--hint-discard")})}getTileSelectionKey(e,t){return e?typeof e.index=="number"&&e.index>=0?`idx-${e.index}`:`${e.suit}:${e.number}:${t}`:`missing-${t}`}_findNewlyReceivedTiles(e,t){if(!e||!t)return[];const i=new Set(e.tiles.map(r=>r==null?void 0:r.index).filter(r=>typeof r=="number"&&!isNaN(r)));return t.tiles.map(r=>r==null?void 0:r.index).filter(r=>typeof r=="number"&&!isNaN(r)).filter(r=>!i.has(r))}destroy(){this.unsubscribeFns.forEach(e=>{typeof e=="function"&&e()}),this.unsubscribeFns=[],this.hintRecommendationKeys.clear(),this.newlyDrawnTileIndex=null,this.gameController=null,this.handRenderer=null,this.selectionManager=null}}class D{constructor(e,t={}){this.tileData=e;const i=t.size||"normal",s=this._getSizeDefaults(i);this.options={width:s.width,height:s.height,state:"normal",size:i,...t},this.element=null,this.currentState=this.options.state}createElement(){const e=H.createTileElement(this.tileData,this.options.size);e.classList.add("mobile-tile"),e.dataset.suit=this.tileData.suit,e.dataset.number=this.tileData.number,this.tileData.index!==void 0&&(e.dataset.index=this.tileData.index);const t=this._getSizeDefaults(this.options.size);if(this.options.width!==t.width||this.options.height!==t.height){e.style.width=`${this.options.width}px`,e.style.height=`${this.options.height}px`;const i=this.options.width/33.33,s=Math.round(1300*i);e.style.backgroundSize=`${s}px auto`}return this.element=e,this.setState(this.options.state),e}_getSizeDefaults(e){const t={normal:{width:52,height:69},small:{width:40,height:54},discard:{width:26,height:34}};return t[e]||t.normal}setState(e){if(this.currentState=e,!!this.element)switch(this.element.classList.remove("selected","disabled","highlighted"),e){case"selected":this.element.classList.add("selected");break;case"disabled":this.element.classList.add("disabled");break;case"highlighted":this.element.classList.add("highlighted");break}}getData(){return this.tileData}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}static createHandTile(e,t="normal"){return new D(e,{size:"normal",state:t})}static createExposedTile(e,t="normal"){return new D(e,{size:"small",state:t})}static createDiscardTile(e,t="normal"){return new D(e,{size:"discard",state:t})}}const Re=Object.freeze(Object.defineProperty({__proto__:null,MobileTile:D},Symbol.toStringTag,{value:"Module"}));class _e{constructor(e,t=null){this.container=e,this.gameController=t,this.discards=[],this.element=null,this.eventUnsubscribers=[],this._onResize=this.updateTileSizing.bind(this),this.lastDiscard=null,this.render(),this.gameController&&this.setupEventListeners()}render(){this.element=document.createElement("div"),this.element.className="discard-pile",this.container.appendChild(this.element),this.updateTileSizing(),window.addEventListener("resize",this._onResize,{passive:!0})}setupEventListeners(){!this.gameController||typeof this.gameController.on!="function"||(this.eventUnsubscribers.push(this.gameController.on("TILE_DISCARDED",e=>{const t=I.fromJSON(e.tile);this.addDiscard(t,e.player)})),this.eventUnsubscribers.push(this.gameController.on("DISCARD_CLAIMED",()=>{this.removeLatestDiscard()})),this.eventUnsubscribers.push(this.gameController.on("GAME_STARTED",()=>{this.clear()})))}addDiscard(e,t){const i={tile:e,player:t};this.discards.push(i),this.lastDiscard=i,this.rerender(i),this.scrollToLatest()}rerender(e=null){this.element.innerHTML="",this.discards.forEach(({tile:t,player:i})=>{const s=this.createDiscardTile(t,i);e&&t===e.tile&&i===e.player&&s.classList.add("latest"),this.element.appendChild(s)})}createDiscardTile(e,t){const i=D.createDiscardTile(e).createElement();return i.classList.add("discard-tile"),i.dataset.player=t,i.title=`Discarded by ${this.getPlayerName(t)}`,i.addEventListener("click",()=>{this.showDiscardInfo(e,t)}),i}getTileText(e){return e.getText()}getPlayerName(e){return["You","Opponent 1","Opponent 2","Opponent 3"][e]||"Unknown"}removeLatestDiscard(){if(this.discards.length!==0){if(this.lastDiscard){const e=this.discards.indexOf(this.lastDiscard);e!==-1?this.discards.splice(e,1):this.discards.pop()}else this.discards.pop();this.lastDiscard=null,this.rerender()}}getLatestDiscardElement(){const e=this.element.querySelector(".discard-tile.latest");return e||this.element.querySelector(".discard-tile:last-child")}showDiscardInfo(e,t){alert(`${e.getText()}
Discarded by: ${this.getPlayerName(t)}`)}scrollToLatest(){this.element.scrollTo({left:this.element.scrollWidth,behavior:"smooth"})}calculateResponsiveSizing(){if(!this.container||!this.element)return{tileWidth:48,gap:4,padding:8};const e=this.container.clientWidth||window.innerWidth,t=4,i=8;return{tileWidth:Math.max(26,Math.floor((e-9*t-2*i)/10)),gap:t,padding:i}}updateTileSizing(){if(!this.container||!this.element)return;const{tileWidth:e,gap:t,padding:i}=this.calculateResponsiveSizing();this.element.style.setProperty("--discard-tile-width",`${e}px`),this.element.style.setProperty("--discard-gap",`${t}px`),this.element.style.setProperty("--discard-padding",`${i}px`)}getNextTilePosition(){if(!this.element)return{x:0,y:0};const e=this.element.getBoundingClientRect(),{tileWidth:t,gap:i}=this.calculateResponsiveSizing(),s=10,n=this.discards.length,r=Math.floor(n/s),o=n%s;return{x:e.left+o*(t+i)+t/2,y:e.top+r*(t+i)+t/2}}getLastTilePosition(){const e=this.getLatestDiscardElement();if(!e)return null;const t=e.getBoundingClientRect();return{x:t.left+t.width/2,y:t.top+t.height/2}}clear(){this.discards=[],this.element.innerHTML="",this.lastDiscard=null}destroy(){this.eventUnsubscribers.forEach(e=>e()),this.eventUnsubscribers=[],window.removeEventListener("resize",this._onResize),this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}}class Pe{constructor(e,t){this.container=e,this.playerData=t,this.element=null,this.render()}render(){this.element=document.createElement("div"),this.element.className="opponent-bar",this.element.dataset.player=this.playerData.position,this.element.innerHTML=`
            <div class="opponent-info">
                <span class="opponent-name"></span>
                <span class="tile-count"></span>
            </div>
            <div class="exposures"></div>
        `,this.container.appendChild(this.element),this.update(this.playerData)}update(e){if(!this.element)return;this.playerData=e;const t=this.element.querySelector(".opponent-name"),i=this.getWindLabel(e);t.textContent=i?`${e.name} (${i})`:e.name;const s=this.element.querySelector(".tile-count");s.textContent="",this.updateExposures(this.getExposures(e)),this.setCurrentTurn(e.isCurrentTurn)}getWindLabel(e={}){if(typeof e.wind=="string"&&e.wind)return e.wind;const t=e.wind,i={[C.NORTH]:"North",[C.SOUTH]:"South",[C.WEST]:"West",[C.EAST]:"East"};return t in i?i[t]:{[L.RIGHT]:"North",[L.TOP]:"West",[L.LEFT]:"South",[L.BOTTOM]:"East"}[e.position]||""}getTileCount(e={}){if(typeof e.tileCount=="number")return e.tileCount;const t=e.hand;if(!t)return null;const i=Array.isArray(t.tiles)?t.tiles.length:0,s=Array.isArray(t.exposures)?t.exposures.reduce((r,o)=>r+(Array.isArray(o.tiles)?o.tiles.length:0),0):0,n=i+s;return n>0?n:0}getExposures(e={}){return Array.isArray(e.exposures)?e.exposures:e.hand&&Array.isArray(e.hand.exposures)?e.hand.exposures:[]}updateExposures(e){const t=this.element.querySelector(".exposures");if(t.innerHTML="",!e||e.length===0){t.classList.remove("compact");return}let i=0;e.forEach(s=>{Array.isArray(s.tiles)&&(i+=s.tiles.length)}),i>4?t.classList.add("compact"):t.classList.remove("compact"),e.forEach(s=>{s.tiles.forEach(n=>{const r=D.createExposedTile(n).createElement();r.classList.add("exposure-icon"),r.title=this.getExposureTooltip(s),t.appendChild(r)})})}addDealingTiles(e){const t=this.element.querySelector(".exposures"),i=[];for(let s=0;s<e;s++){const n=document.createElement("div");n.className="mobile-tile tile-back dealing-tile",n.style.width="24px",n.style.height="32px",n.style.display="inline-block",n.style.marginRight="2px",t.appendChild(n),i.push(n)}return i}clearDealingTiles(){this.element.querySelector(".exposures").querySelectorAll(".dealing-tile").forEach(i=>i.remove())}getExposureLabel(e){return{PUNG:"P",KONG:"K",QUINT:"Q"}[e]||"?"}getExposureTooltip(e){const t=e.tiles.map(i=>i.getText()).join(", ");return`${e.type}: ${t}`}setCurrentTurn(e){this.element&&(e?this.element.classList.add("current-turn"):this.element.classList.remove("current-turn"))}destroy(){this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.element=null}}class Le{constructor(e){this.container=e,this.element=null,e&&this.render()}render(){this.element=document.createElement("div"),this.element.className="player-rack",this.element.innerHTML=`
            <div class="player-rack__exposed"></div>
        `,this.container.appendChild(this.element)}update(e){if(!this.element||!e)return;const t=this.element.querySelector(".player-rack__exposed");if(!t){console.warn("PlayerRack.update: exposedSection element not found");return}e.exposures&&e.exposures.length>0?this.renderExposures(e.exposures,t):t.innerHTML=""}renderExposures(e,t){if(!t||!t.innerHTML){console.warn("PlayerRack.renderExposures: Invalid container provided");return}if(t.innerHTML="",!e||!Array.isArray(e)){console.warn("PlayerRack.renderExposures: Invalid exposures array provided");return}e.forEach((i,s)=>{if(!i){console.warn(`PlayerRack.renderExposures: Skipping null/undefined exposure at index ${s}`);return}const n=Array.isArray(i.tiles)?i.tiles:[];n.length===0&&console.warn(`PlayerRack.renderExposures: Empty or invalid tiles array for exposure at index ${s}`);const r=document.createElement("div");r.className="exposure-set",n.forEach(o=>{if(o){const a=H.createTileElement(o,"small");a.classList.add("exposed-tile"),r.appendChild(a)}}),r.children.length>0&&t.appendChild(r)})}}const B=["tile-drawing","tile-discarding","tile-claiming-pulse","tile-claiming-move","tile-exposing"],te=["turn-starting","turn-ending"],W="hand-sorting",V="invalid-action",Me=500,De=400,Be=600,Ne=300,He=500,ie=50,Oe=16,p=(d,e=0)=>`${typeof d=="number"&&!Number.isNaN(d)?d:e}px`,F=d=>d?Array.isArray(d)?d.filter(Boolean):Array.from(d).filter(Boolean):[],$=(d,e)=>{const t=e.x-d.x,i=e.y-d.y,s=Math.sqrt(t*t+i*i);return{dx:t,dy:i,distance:s}};class $e{constructor(e={}){this.duration=typeof e.duration=="number"?e.duration:350,this.easing=e.easing||"var(--ease-smooth)",this.prefersReducedMotion=typeof window<"u"&&typeof window.matchMedia=="function"?window.matchMedia("(prefers-reduced-motion: reduce)").matches:!1,this._elementTimers=new WeakMap}animateTileDraw(e,t=null,i=null){return new Promise(s=>{if(!e){s();return}this._resetElementAnimation(e,B);const n=i||k(e),r=t||{x:n.x,y:n.y-200},o=$(r,n),a={"--start-x":p(r.x),"--start-y":p(r.y),"--end-x":p(n.x),"--end-y":p(n.y),"--movement-dx":p(o.dx),"--movement-dy":p(o.dy),"--tile-draw-duration":`${this.duration}ms`,"--tile-draw-easing":this.easing};this._setCssVariables(e,a),this._applyAnimationClass(e,"tile-drawing"),this._scheduleTimer(e,this.duration,()=>{e.classList.remove("tile-drawing"),this._clearCssVariables(e,Object.keys(a)),s()})})}animateTileDeal(e,t=0,i=null,s=null){return new Promise(n=>{if(!e){n();return}this._resetElementAnimation(e,B);const r=s||k(e),o=i||{x:window.innerWidth/2,y:-50},a=$(o,r),c=this.duration+50,h={"--start-x":p(o.x),"--start-y":p(o.y),"--end-x":p(r.x),"--end-y":p(r.y),"--movement-dx":p(a.dx),"--movement-dy":p(a.dy),"--tile-deal-duration":`${c}ms`,"--tile-deal-easing":this.easing};this._setCssVariables(e,h),this._applyAnimationClass(e,"tile-dealing"),this._scheduleTimer(e,c,()=>{e.classList.remove("tile-dealing"),this._clearCssVariables(e,Object.keys(h)),n()})})}animateOpponentTilesFadeOut(e){const t=F(e);return new Promise(i=>{if(!t.length){i();return}const s=300;t.forEach(r=>{this._resetElementAnimation(r,["tile-fading-out"]),this._applyAnimationClass(r,"tile-fading-out")});const n=t[0];this._scheduleTimer(n,s,()=>{t.forEach(r=>{r.classList.remove("tile-fading-out")}),i()})})}animateTileClaim(e,t=0,i=null,s=null){return new Promise(n=>{if(!e){n();return}this._resetElementAnimation(e,B);const r=k(e),o=i||(s?k(s):{x:r.x,y:r.y-150}),a=$(r,o),c={"--start-x":p(r.x),"--start-y":p(r.y),"--target-x":p(o.x),"--target-y":p(o.y),"--movement-dx":p(a.dx),"--movement-dy":p(a.dy),"--tile-claim-duration":`${this.duration}ms`};this._setCssVariables(e,c),this._applyAnimationClass(e,"tile-claiming-pulse"),this._scheduleTimer(e,Me,()=>{e.classList.remove("tile-claiming-pulse"),this._applyAnimationClass(e,"tile-claiming-move"),this._scheduleTimer(e,this.duration,()=>{e.classList.remove("tile-claiming-move"),this._clearCssVariables(e,Object.keys(c)),n()})})})}animateTurnStart(e){return this._runSimpleAnimation(e,"turn-starting",Be)}animateTurnEnd(e){return this._runSimpleAnimation(e,"turn-ending",Ne)}animateHandSort(e){return this._runSimpleAnimation(e,W,De)}animateExposure(e,t={}){const i=F(e);return new Promise(s=>{if(!i.length){s();return}i.forEach((o,a)=>{this._resetElementAnimation(o,B);const c={"--target-x":p(t.x,0),"--target-y":p(t.y,0)};this._setCssVariables(o,c),o.style.animationDelay=this.prefersReducedMotion?"0ms":`${a*ie}ms`,this._applyAnimationClass(o,"tile-exposing")});const n=this.duration+i.length*ie,r=i[0];this._scheduleTimer(r,n,()=>{i.forEach(o=>{o.classList.remove("tile-exposing"),o.style.animationDelay="",this._clearCssVariables(o,["--target-x","--target-y"])}),s()})})}animateTileSwap(e,t,i=null){return new Promise(s=>{if(!e&&!t){s();return}const n=[];if(e){this._resetElementAnimation(e,B);const r=k(e),o=document.getElementById("discard-pile"),a=o?k(o):{x:window.innerWidth/2,y:window.innerHeight/2},c=$(r,a),h={"--start-x":p(r.x),"--start-y":p(r.y),"--end-x":p(a.x),"--end-y":p(a.y),"--movement-dx":p(c.dx),"--movement-dy":p(c.dy),"--tile-discard-duration":`${this.duration}ms`,"--tile-discard-easing":this.easing};this._setCssVariables(e,h),this._applyAnimationClass(e,"tile-discarding");const u=new Promise(g=>{this._scheduleTimer(e,this.duration,()=>{e.classList.remove("tile-discarding"),this._clearCssVariables(e,Object.keys(h)),g()})});n.push(u)}if(t){this._resetElementAnimation(t,B);const r=k(t),o=document.getElementById("hand-area"),a=i||(o?k(o):r),c=$(r,a),h={"--start-x":p(r.x),"--start-y":p(r.y),"--target-x":p(a.x),"--target-y":p(a.y),"--movement-dx":p(c.dx),"--movement-dy":p(c.dy),"--tile-claim-duration":`${this.duration}ms`};this._setCssVariables(t,h),this._applyAnimationClass(t,"tile-claiming-move");const u=new Promise(g=>{this._scheduleTimer(t,this.duration,()=>{t.classList.remove("tile-claiming-move"),this._clearCssVariables(t,Object.keys(h)),g()})});n.push(u)}Promise.all(n).then(()=>s())})}animateInvalidAction(e){return this._runSimpleAnimation(e,V,He)}applyReceivedTileGlow(e){e&&e.classList.add("tile--newly-drawn")}removeReceivedTileGlow(e){e&&e.classList.remove("tile--newly-drawn")}removeReceivedTileGlowFromAll(e){F(e).forEach(t=>this.removeReceivedTileGlow(t))}_runSimpleAnimation(e,t,i){return new Promise(s=>{if(!e){s();return}const n=[];te.includes(t)?n.push(...te):t===W?n.push(W):t===V&&n.push(V),this._resetElementAnimation(e,n),this._applyAnimationClass(e,t),this._scheduleTimer(e,i,()=>{e.classList.remove(t),s()})})}_resetElementAnimation(e,t=[]){e&&(this._cancelTimers(e),t.forEach(i=>e.classList.remove(i)))}_setCssVariables(e,t={}){!e||!e.style||Object.entries(t).forEach(([i,s])=>{s==null?e.style.removeProperty(i):e.style.setProperty(i,s)})}_clearCssVariables(e,t=[]){!e||!e.style||t.forEach(i=>e.style.removeProperty(i))}_applyAnimationClass(e,t){e&&(e.classList.remove(t),e.offsetWidth,e.classList.add(t))}_scheduleTimer(e,t,i){const s=this.prefersReducedMotion?Math.min(t,Oe):t,n=setTimeout(()=>{this._deregisterTimer(e,n),i()},s);return this._registerTimer(e,n),n}_registerTimer(e,t){if(!e)return;let i=this._elementTimers.get(e);i||(i=new Set,this._elementTimers.set(e,i)),i.add(t)}_deregisterTimer(e,t){if(!e)return;const i=this._elementTimers.get(e);i&&(i.delete(t),i.size===0&&this._elementTimers.delete(e))}_cancelTimers(e){if(!e)return;const t=this._elementTimers.get(e);t&&(t.forEach(i=>clearTimeout(i)),this._elementTimers.delete(e))}}class K{constructor(e,t,i){this.gameController=e,this.handRenderer=t,this.animationController=i,this.isAnimating=!1,this.currentSequence=null,this.cancelRequested=!1}async executeSequence(e){if(this.isAnimating){console.warn("Animation already in progress, skipping new sequence");return}this.isAnimating=!0,this.cancelRequested=!1,this.currentSequence={steps:e,currentStep:0};try{await this.onSequenceStart();for(let t=0;t<e.length;t++){if(this.cancelRequested){U("Animation sequence cancelled");break}this.currentSequence.currentStep=t;const i=e[t];if(typeof i!="function"){console.warn(`Step ${t} is not a function, skipping`);continue}await i()}await this.onSequenceComplete()}catch(t){throw await this.onSequenceError(t),t}finally{this.isAnimating=!1,this.currentSequence=null,this.cancelRequested=!1}}delay(e){return this.cancelRequested?Promise.resolve():new Promise(t=>setTimeout(t,e))}isRunning(){return this.isAnimating}cancel(){this.isAnimating&&(this.cancelRequested=!0)}getTileElements(e){var t;return(t=this.handRenderer)!=null&&t.getTileElementsByIndices?this.handRenderer.getTileElementsByIndices(e):(console.warn("HandRenderer does not support getTileElementsByIndices"),[])}calculateDirection(e,t){const i=t.x-e.x,s=t.y-e.y,n=Math.sqrt(i*i+s*s);return{dx:i,dy:s,distance:n}}async onSequenceStart(){}async onSequenceComplete(){}onSequenceError(e){return console.error("Animation sequence error:",e),Promise.resolve()}}class Ge extends K{constructor(e,t,i,s){super(e,t,i),this.receivedTileIndices=new Set,this.refreshHints=s,this.directionVectors={right:{exit:{x:300,y:-100},entry:{x:-300,y:100}},across:{exit:{x:0,y:-300},entry:{x:0,y:300}},left:{exit:{x:-300,y:-100},entry:{x:300,y:100}}},this.PASS_OUT_DURATION=600,this.TRAVEL_DELAY=300,this.RECEIVE_DURATION=600,this.SORT_DURATION=800}async animateCharlestonPass(e,t){if(e.player!==0)return;const{direction:i}=e;await this.executeSequence([()=>this.animateTilesLeaving(t,i),()=>this.delay(this.TRAVEL_DELAY)])}async handleTilesReceived(e,t){var n,r,o;if(e.player!==0)return;const i=((n=e.animation)==null?void 0:n.direction)||e.direction;U("[CharlestonAnimationSequencer] handleTilesReceived:",{currentHandData:(o=(r=this.handRenderer.currentHandData)==null?void 0:r.tiles)==null?void 0:o.length});const s=this.handRenderer.currentHandData;if(s&&s.tiles){const a=t.map(c=>{var h;return(h=s.tiles[c])==null?void 0:h.index}).filter(c=>typeof c=="number");this.receivedTileIndices=new Set(a)}else this.receivedTileIndices=new Set(t);await this.executeSequence([()=>this.animateTilesArriving(t,i),()=>this.applyGlowToReceivedTiles(t),()=>this.animateSortWithGlow()])}async animateTilesLeaving(e,t){const i=this.getTileElements(e);if(i.length===0)return;const s=this.getDirectionVector(t);if(!s){console.warn(`Unknown direction: ${t}`);return}i.forEach(r=>{r.style.setProperty("--exit-x",`${s.exit.x}px`),r.style.setProperty("--exit-y",`${s.exit.y}px`),r.classList.add("tile-charleston-leaving")}),await this.delay(this.PASS_OUT_DURATION),[...e].sort((r,o)=>o-r).forEach(r=>{const o=this.handRenderer.tiles[r];o&&o.parentNode&&o.parentNode.removeChild(o),this.handRenderer.tiles.splice(r,1)})}async animateTilesArriving(e,t){const i=this.getTileElements(e);if(i.length===0)return;const s=this.getDirectionVector(t);if(!s){console.warn(`Unknown direction: ${t}`);return}i.forEach(n=>{n.style.setProperty("--entry-x",`${s.entry.x}px`),n.style.setProperty("--entry-y",`${s.entry.y}px`),n.classList.add("tile-charleston-arriving")}),await this.delay(this.RECEIVE_DURATION),i.forEach(n=>{n.classList.remove("tile-charleston-arriving"),n.style.removeProperty("--entry-x"),n.style.removeProperty("--entry-y")})}applyGlowToReceivedTiles(e){this.getTileElements(e).forEach(i=>{this.animationController.applyReceivedTileGlow(i)})}async animateSortWithGlow(){const e=this.gameController.players[0];if(!e||!e.hand){console.warn("CharlestonAnimationSequencer: Cannot sort - no human player hand");return}const t=e.hand,s=this.handRenderer.tiles.map(c=>({x:c.offsetLeft,y:c.offsetTop}));t.sortBySuit();const n=t.tiles,r=[];this.receivedTileIndices.forEach(c=>{const h=n.findIndex(u=>(u==null?void 0:u.index)===c);h>=0&&r.push(h)}),U(`[CharlestonAnimationSequencer] animateSortWithGlow: receivedTileIndices=${Array.from(this.receivedTileIndices).join(",")}, glowPositions=${r.join(",")}`),this.handRenderer.renderWithGlow(t,r),typeof this.refreshHints=="function"&&this.refreshHints();const o=this.handRenderer.tiles,a=o.map(c=>({x:c.offsetLeft,y:c.offsetTop}));o.forEach((c,h)=>{if(h>=s.length)return;const u=s[h].x-a[h].x,g=s[h].y-a[h].y;c.style.transform=`translate(${u}px, ${g}px)`,c.style.transition="none"}),document.body.offsetHeight,o.forEach(c=>{c.style.transition=`transform ${this.SORT_DURATION}ms cubic-bezier(0.4, 0.0, 0.2, 1)`,c.style.transform=""}),await this.delay(this.SORT_DURATION),o.forEach(c=>{c.style.transition=""})}getDirectionVector(e){return this.directionVectors[e]||null}async onSequenceStart(){}async onSequenceComplete(){}onSequenceError(e){return console.error("Charleston animation error:",e),Promise.resolve()}}const Ue="/mahjong/assets/audio/2406haidao_bgm_loop.mp3",qe="/mahjong/assets/audio/rack_tile.mp3",re="/mahjong/assets/audio/tile_dropping.mp3",We="/mahjong/assets/audio/fireworks.mp3",Ve="/mahjong/assets/audio/normalflyin.mp3";class oe{constructor(){this.bgm=null,this.bgmLoop=null;const e=v.load(),t=e.bgmVolume??50,i=e.sfxVolume??50;this.bgmVolume=t/100,this.bgmMuted=e.bgmMuted??!1,this.sfxVolume=i/100,this.sfxMuted=e.sfxMuted??!1,this.audioContext=null}initAudioContext(){if(!this.audioContext)try{const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e}catch(e){console.warn("Web Audio API not supported:",e)}}playBGM(e){if(this.stopBGM(),this.bgmMuted)return;let t;switch(e){case"bgm":t=Ue;break;default:return}try{this.bgm=new Audio(t),this.bgm.loop=!0,this.bgm.volume=this.bgmVolume,this.bgm.play().catch(i=>{console.warn("Could not play BGM:",i.message)})}catch(i){console.warn("Error playing BGM:",i)}}stopBGM(){this.bgm&&(this.bgm.pause(),this.bgm.currentTime=0,this.bgm=null)}setBGMVolume(e){this.bgmVolume=Math.max(0,Math.min(1,e)),this.bgm&&!this.bgmMuted&&(this.bgm.volume=this.bgmVolume)}muteBGM(e){this.bgmMuted=e,this.bgm&&(this.bgm.volume=this.bgmMuted?0:this.bgmVolume)}getBGMVolume(){return this.bgmVolume}isBGMMuted(){return this.bgmMuted}playSFX(e){if(this.sfxMuted)return;let t;switch(e){case"tile_dropping":t=re;break;case"rack_tile":t=qe;break;case"fireworks":t=We;break;case"wall_fail":t=Ve;break;default:return}try{const i=new Audio(t);i.volume=this.sfxVolume;const s=i.play();s!==void 0&&s.catch(n=>{console.warn(`Could not play SFX (${e}):`,n.message)})}catch(i){console.warn(`Error playing SFX (${e}):`,i)}}setSFXVolume(e){this.sfxVolume=Math.max(0,Math.min(1,e))}muteSFX(e){this.sfxMuted=e}getSFXVolume(){return this.sfxVolume}isSFXMuted(){return this.sfxMuted}destroy(){this.stopBGM(),this.audioContext&&(this.audioContext.close(),this.audioContext=null)}}class Fe extends K{constructor(e,t,i,s){super(e,t,i),this.audioManager=s||new oe,this.TILE_REVEAL_STAGGER=100,this.TILE_FLIP_DURATION=500,this.INITIAL_DELAY=500}async animateDeal(e){const t=this.gameController.players[0];if(!t||!this.handRenderer){console.error("DealingAnimationSequencer: Cannot animate deal - missing player or hand renderer"),this.gameController.emit("DEALING_COMPLETE");return}if(!t.hand||!t.hand.tiles||t.hand.tiles.length===0){console.error("DealingAnimationSequencer: Cannot animate deal - player hand is empty"),this.gameController.emit("DEALING_COMPLETE");return}await this.executeSequence([()=>this.renderHand(t.hand),()=>this.revealTilesSequentially(),()=>this.applyEastGlowIfNeeded()])}async renderHand(e){this.handRenderer.render(e);const t=this.handRenderer&&Array.isArray(this.handRenderer.tiles)?this.handRenderer.tiles:null;if(!t||t.length===0){console.warn("DealingAnimationSequencer: No valid tiles to render");return}t.forEach(i=>{i.classList.add("tile--face-down")}),await this.delay(this.INITIAL_DELAY)}async revealTilesSequentially(){const e=this.handRenderer&&Array.isArray(this.handRenderer.tiles)?this.handRenderer.tiles:null;if(!e||e.length===0){console.warn("DealingAnimationSequencer: No valid tiles to reveal");return}for(let t=0;t<e.length;t++){const i=e[t];this.audioManager&&this.audioManager.playSFX("wall_fail"),i.classList.remove("tile--face-down"),i.classList.add("tile--revealing"),t<e.length-1&&await this.delay(this.TILE_REVEAL_STAGGER)}await this.delay(this.TILE_FLIP_DURATION),this.audioManager&&this.audioManager.playSFX("rack_tile"),e.forEach(t=>{t.classList.remove("tile--revealing")})}applyEastGlowIfNeeded(){const e=this.gameController.players[0];if(e.wind==="E"&&e.hand.tiles.length===14){const t=this.handRenderer.tiles,i=t[t.length-1];i&&this.animationController.applyReceivedTileGlow(i)}}onSequenceComplete(){this.gameController.emit("DEALING_COMPLETE")}onSequenceError(e){console.error("Dealing animation error:",e),this.gameController.emit("DEALING_COMPLETE")}}const G=0;function se(){return window.matchMedia("(prefers-reduced-motion: reduce)").matches}class Ye extends K{constructor(e,t,i,s,n){super(e,t,i),this.discardPile=s,this.mobileRenderer=n,this.soundEnabled=!0}async animateDiscard(e){var u,g,S;if(!(e!=null&&e.tile))return;const{player:t,tile:i,animation:s}=e,n=I.fromJSON(i),r=s==null?void 0:s.tileIndex;if(t!==G||r===void 0){this.skipAnimation(n,t);return}const o=this.handRenderer.getTileElementByIndex(r);if(!o){this.skipAnimation(n,t);return}const a=o.getBoundingClientRect(),c={x:a.left,y:a.top},h=this.createDiscardTileClone(o,a);if(!h){this.skipAnimation(n,t);return}o.style.visibility="hidden",document.body.appendChild(h),(u=this.mobileRenderer)!=null&&u.selectionManager&&this.mobileRenderer.selectionManager.clearSelection(),this.mobileRenderer&&(this.mobileRenderer.isDiscardAnimationRunning=!0);try{await this.executeSequence([()=>this.prepareDiscard(t,h),()=>this.animateTileToDiscard(t,n,s,h,c),()=>this.settleTileInPile(n,t),()=>this.updateHandAfterDiscard(t,r,o)])}finally{this.mobileRenderer&&(this.mobileRenderer.isDiscardAnimationRunning=!1);const E=(S=(g=this.gameController)==null?void 0:g.players)==null?void 0:S[0];E!=null&&E.hand&&this.handRenderer.render(E.hand)}}async prepareDiscard(e,t){e!==G||!t||(t.classList.add("tile-discarding-prep"),t.getBoundingClientRect(),await this.delay(100),t.classList.remove("tile-discarding-prep"))}async animateTileToDiscard(e,t,i,s,n){this.discardPile.addDiscard(t,e);const r=this.discardPile.getLatestDiscardElement();if(!r){console.warn("Could not get discard tile element");return}const o=r.getBoundingClientRect(),a={x:o.left,y:o.top};r.style.opacity="0";const c=this.calculateDiscardTrajectory(n,a,e,i);await this.animateTileThrow(s,c),s.remove(),r.style.opacity=""}calculateDiscardTrajectory(e,t,i,s){const n=i===G,r=t.x-e.x,o=t.y-e.y,a=n?-100:-50,c={x:e.x+r*.5,y:e.y+o*.5+a};return{start:{x:e.x,y:e.y},control:c,end:{x:t.x,y:t.y},duration:Math.max(220,((s==null?void 0:s.duration)??(n?550:320))*((s==null?void 0:s.speedMultiplier)??1)),rotation:(s==null?void 0:s.rotation)||(n?360:180),easing:(s==null?void 0:s.easing)||"ease-out"}}async animateTileThrow(e,t){const i=t.end.x-t.start.x,s=t.end.y-t.start.y,n=t.control.x-t.start.x,r=t.control.y-t.start.y;e.style.setProperty("--delta-x",`${i}px`),e.style.setProperty("--delta-y",`${s}px`),e.style.setProperty("--mid-x",`${n}px`),e.style.setProperty("--mid-y",`${r}px`),e.style.setProperty("--rotation",`${t.rotation}deg`),e.style.setProperty("--duration",`${t.duration}ms`),e.getBoundingClientRect(),e.classList.add("tile-discard-throw"),se()||e.style.setProperty("animation",`tile-discard-throw ${t.duration}ms ${t.easing} forwards`,"important"),this.soundEnabled&&this.playDiscardSound();const o=se()?100:t.duration;await this.delay(o)}async settleTileInPile(e,t){const i=this.discardPile.getLatestDiscardElement();i&&(i.classList.add("tile-settle-bounce"),await this.delay(200),i.classList.remove("tile-settle-bounce"))}updateHandAfterDiscard(e,t,i){e===G&&i&&(i.style.visibility="",i.classList.remove("tile-discarding-prep"))}createDiscardTileClone(e,t){if(!e||!t)return null;const i=e.cloneNode(!0);i.classList.add("tile-clone-animating"),i.classList.remove("selected"),i.style.position="fixed",i.style.zIndex="9999",i.style.pointerEvents="none";const s=window.getComputedStyle(e);return i.style.width=s.width,i.style.height=s.height,i.style.left=`${t.left}px`,i.style.top=`${t.top}px`,i.style.transform="translate3d(0, 0, 0)",i}skipAnimation(e,t){this.discardPile.addDiscard(e,t),this.soundEnabled&&this.playDiscardSound()}playDiscardSound(){try{const e=v.load();if(e.sfxMuted)return;const t=new Audio(re);t.volume=(e.sfxVolume||50)/100;const i=t.play();i!==void 0&&i.then(()=>{}).catch(s=>{console.warn("Could not play discard sound:",s.message)})}catch(e){console.warn("Error creating discard audio:",e.message)}}}class Ke{constructor(e){this.container=e,this.tiles=[],this.isAnimating=!1}render(){for(let e=0;e<144;e++){const t=this.createRandomTile();t.classList.add("home-page-tile"),t.style.left=`${Math.random()*80+10}%`,t.style.top=`${Math.random()*60+20}%`,t.style.transform=`rotate(${Math.random()*360}deg)`,this.container.appendChild(t),this.tiles.push(t)}this.container.style.display="block"}createRandomTile(){const e=document.createElement("div");if(e.className="tile tile--micro home-page-tile",Math.random()<.3)e.classList.add("tile--back"),e.style.backgroundImage="url('/mahjong/assets/back.png')",e.style.backgroundSize="cover",e.style.backgroundRepeat="no-repeat";else{const t=Math.floor(Math.random()*3),i=Math.floor(Math.random()*9)+1;try{const s=H.getSpritePosition({suit:t,number:i});e.style.backgroundPosition=`${s.xPct}% ${s.yPct}%`}catch(s){console.error("Failed to get sprite position:",s),e.classList.add("tile--back"),e.style.backgroundImage="url('/mahjong/assets/back.png')",e.style.backgroundSize="cover"}}return e}async animateStart(){if(this.isAnimating||this.tiles.length===0)return;this.isAnimating=!0;const e=window.innerWidth,t=window.innerHeight,i=this.tiles.map(s=>new Promise(n=>{const r=1200+Math.random()*800,o=Math.random()*300,a=parseFloat(s.style.left)*e/100,c=parseFloat(s.style.top)*t/100,h=-e*.3+Math.random()*-150,u=-t*.3+Math.random()*-150,g=h-a,S=u-c;window.requestAnimationFrame(()=>{s.style.transition=`transform ${r}ms cubic-bezier(0.55, 0.085, 0.68, 0.53) ${o}ms`,s.style.transform=`translate(${g}px, ${S}px) rotate(${Math.random()*720+360}deg)`}),setTimeout(()=>{s.remove(),n()},r+o)}));await Promise.all(i),this.tiles=[],this.isAnimating=!1,this.container&&(this.container.style.display="none")}destroy(){this.isAnimating&&this.tiles.forEach(e=>{e.remove()}),this.tiles=[],this.isAnimating=!1,this.container&&(this.container.innerHTML="",this.container.style.display="none")}}class Xe{constructor(e,t,i){this.discards=e,this.onSelect=t,this.onCancel=i,this.element=null,this.isClosing=!1,this.render()}render(){this.element=document.createElement("div"),this.element.className="discard-selection-modal",this.element.innerHTML=`
            <div class="discard-selection-modal__backdrop"></div>
            <div class="discard-selection-modal__content">
                <div class="discard-selection-modal__header">
                    <h2 class="discard-selection-modal__title">Select a tile from discards</h2>
                    <p class="discard-selection-modal__hint">Tap a tile to exchange with your blank</p>
                </div>
                <div class="discard-selection-modal__grid"></div>
                <div class="discard-selection-modal__footer">
                    <button class="discard-selection-modal__cancel">Cancel</button>
                </div>
            </div>
        `;const e=this.element.querySelector(".discard-selection-modal__grid");this.discards.forEach((s,n)=>{const r=this.createTileElement(s,n);e.appendChild(r)}),this.element.querySelector(".discard-selection-modal__cancel").addEventListener("click",()=>this.close(null)),this.element.querySelector(".discard-selection-modal__backdrop").addEventListener("click",()=>this.close(null)),document.body.appendChild(this.element),window.requestAnimationFrame(()=>{this.element.classList.add("discard-selection-modal--visible")})}createTileElement(e,t){const i=document.createElement("button");i.className="discard-selection-modal__tile",i.dataset.index=t;const s=e.getText();i.title=s,i.setAttribute("aria-label",`Select ${s} from discards`);const n=H.createTileElement(e);return i.appendChild(n),i.addEventListener("click",()=>this.close(e)),i}close(e){this.isClosing||(this.isClosing=!0,this.element.classList.remove("discard-selection-modal--visible"),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),e?this.onSelect(e):this.onCancel()},300))}}class je{constructor(e,t,i){this.title=e,this.message=t,this.onClose=i,this.element=null,this.isClosing=!1,this.render()}render(){this.element=document.createElement("div"),this.element.className="game-end-modal",this.element.innerHTML=`
            <div class="game-end-modal__backdrop"></div>
            <div class="game-end-modal__content">
                <div class="game-end-modal__header">
                    <h1 class="game-end-modal__title">${this.escapeHtml(this.title)}</h1>
                </div>
                <div class="game-end-modal__body">
                    <p class="game-end-modal__message">${this.escapeHtml(this.message)}</p>
                </div>
                <div class="game-end-modal__footer">
                    <button class="game-end-modal__ok">OK</button>
                </div>
            </div>
        `,this.element.querySelector(".game-end-modal__ok").addEventListener("click",()=>this.close()),this.element.querySelector(".game-end-modal__backdrop").addEventListener("click",()=>this.close()),document.body.appendChild(this.element),window.requestAnimationFrame(()=>{this.element.classList.add("game-end-modal--visible")})}close(){this.isClosing||(this.isClosing=!0,this.element.classList.remove("game-end-modal--visible"),setTimeout(()=>{this.element&&this.element.parentNode&&this.element.parentNode.removeChild(this.element),this.onClose&&this.onClose()},300))}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}class ze{constructor(){this.assetsLoaded=new Map,this.errorCallbacks=[],this.testImage=null,this.hasDetectedError=!1}onAssetError(e){this.errorCallbacks.push(e)}testTilesAsset(e="/mahjong/assets/tiles.png"){return new Promise(t=>{if(this.hasDetectedError){t(!1);return}if(this.assetsLoaded.get(e)===!0){t(!0);return}const i=new Image;this.testImage=i,i.onload=()=>{this.assetsLoaded.set(e,!0),this.testImage=null,t(!0)},i.onerror=()=>{this.assetsLoaded.set(e,!1),this.hasDetectedError=!0,this.testImage=null,this.errorCallbacks.forEach(s=>{try{s("tiles.png",e)}catch(n){console.error("Error in asset error callback:",n)}}),t(!1)},i.src=e})}isAssetLoaded(e){return this.assetsLoaded.get(e)??null}reset(){this.assetsLoaded.clear(),this.errorCallbacks=[],this.hasDetectedError=!1,this.testImage&&(this.testImage.src="",this.testImage=null)}}const ne=new ze,A=L.BOTTOM;class Je extends de{constructor(e={}){if(!e.gameController)throw new Error("MobileRenderer requires a GameController instance");super(e.gameController),this.gameController=e.gameController,this.statusElement=e.statusElement||null,this.audioManager=new oe,this.handRenderer=new Ae(e.handContainer),this.selectionManager=new Ie,this.eventCoordinator=new ke(e.gameController,this.handRenderer,this.selectionManager,this),this.handRenderer.setSelectionManager(this.selectionManager),this.handRenderer.setEventCoordinator(this.eventCoordinator),this.discardPile=new _e(e.discardContainer),this.playerRack=new Le(document.getElementById("player-rack-container"));const t=document.getElementById("home-page-tiles");t?(this.homePageTiles=new Ke(t),this.homePageTiles.render()):(console.warn("MobileRenderer: home-page-tiles container not found"),this.homePageTiles=null),this.animationController=new $e,this.charlestonSequencer=new Ge(this.gameController,this.handRenderer,this.animationController,()=>{var i;return(i=this.eventCoordinator)==null?void 0:i.applyHintRecommendations()}),this.dealingSequencer=new Fe(this.gameController,this.handRenderer,this.animationController,this.audioManager),this.discardSequencer=new Ye(this.gameController,this.handRenderer,this.animationController,this.discardPile,this),this.justCompletedDealingAnimation=!1,this.isDealingAnimationRunning=!1,this.selectionManager.setSelectionBehavior({mode:"single",maxSelectable:1,allowToggle:!0}),this.selectionManager.setSelectionListener(()=>{const i=this.selectionManager.getSelectionState(this.latestHandSnapshot);this.handRenderer.applySelectionIndices(i.indices),this.onHandSelectionChange(i)}),this.opponentBars=this.createOpponentBars(e.opponentContainers||{}),this.actionButton=document.getElementById("new-game-btn"),this.drawButton=document.getElementById("draw-btn"),this.sortButton=document.getElementById("sort-btn"),this.jokerButton=document.getElementById("exchange-joker-btn"),this.mahjongButton=document.getElementById("mahjong-btn"),this.promptUI=this.createPromptUI(e.promptRoot||document.body),this.pendingPrompt=null,this.latestHandSnapshot=null,this.previousHandSnapshot=null,this.setupButtonListeners(),this.registerEventListeners(),this.sortButton&&(this.sortButton.style.display="none"),this.drawButton&&(this.drawButton.style.display="none"),this.updateActionButton({label:"Start",onClick:()=>this.startGame()})}destroy(){var e,t,i,s,n,r,o;try{super.destroy()}catch{}this.settingsChangedListener&&window.removeEventListener("settingsChanged",this.settingsChangedListener),(e=this.audioManager)==null||e.destroy(),(t=this.handRenderer)==null||t.destroy(),this.selectionManager=null,(i=this.eventCoordinator)==null||i.destroy(),this.eventCoordinator=null,(s=this.discardPile)==null||s.destroy(),(n=this.homePageTiles)==null||n.destroy(),(o=(r=this.promptUI)==null?void 0:r.container)==null||o.remove(),this.pendingPrompt=null}registerEventListeners(){this.registerEventHandlers({GAME_STARTED:t=>this.onGameStarted(t),GAME_ENDED:t=>this.onGameEnded(t),STATE_CHANGED:t=>this.onStateChanged(t),TILES_DEALT:t=>this.onTilesDealt(t),TURN_CHANGED:t=>this.onTurnChanged(t),TILE_DISCARDED:t=>this.onTileDiscarded(t),DISCARD_CLAIMED:t=>this.onTileClaimed(t),TILES_EXPOSED:t=>this.onTilesExposed(t),JOKER_SWAPPED:t=>this.onJokerSwapped(t),BLANK_EXCHANGED:t=>this.onBlankExchanged(t),MESSAGE:t=>this.onMessage(t),CHARLESTON_PHASE:t=>this.updateStatus(`Charleston ${t.phase}: Pass ${t.round}`),CHARLESTON_PASS:t=>this.onCharlestonPass(t),TILES_RECEIVED:t=>this.onTilesReceived(t),COURTESY_VOTE:t=>this.updateStatus(`Player ${t.player} voted ${t.vote} for courtesy pass`),COURTESY_PASS:()=>this.refreshOpponentBars(),UI_PROMPT:t=>this.handleUIPrompt(t)}),this.registerEventHandlers({GAME_STARTED:()=>this.audioManager.playBGM("bgm"),GAME_ENDED:()=>this.audioManager.stopBGM(),TILE_DRAWN:()=>this.audioManager.playSFX("rack_tile"),TILES_EXPOSED:t=>{var i;((i=t.exposure)==null?void 0:i.length)>0&&this.audioManager.playSFX("wall_fail")}});const e=t=>{const i=t.detail;i.bgmMuted!==void 0&&this.audioManager.muteBGM(i.bgmMuted),i.bgmVolume!==void 0&&this.audioManager.setBGMVolume(i.bgmVolume/100),i.sfxMuted!==void 0&&this.audioManager.muteSFX(i.sfxMuted),i.sfxVolume!==void 0&&this.audioManager.setSFXVolume(i.sfxVolume/100),i.textMode!==void 0&&this.handRenderer.setTextMode(i.textMode)};window.addEventListener("settingsChanged",e),this.settingsChangedListener=e,this.initializeAssetErrorDetection()}async initializeAssetErrorDetection(){ne.onAssetError((t,i)=>{console.error(`Asset loading failed: ${t} at ${i}`),this.handleAssetError(t,i)}),await ne.testTilesAsset()||console.warn("Tiles sprite sheet failed to load - text mode activated")}createOpponentBars(e){const t=[];return[{key:"top",playerIndex:L.RIGHT},{key:"left",playerIndex:L.TOP},{key:"right",playerIndex:L.LEFT}].forEach(({key:s,playerIndex:n})=>{const r=e[s];if(!r)return;const o=this.gameController.players[n],a=new Pe(r,o);t.push({playerIndex:n,bar:a})}),t}createPromptUI(e){const t=document.createElement("div");t.className="mobile-prompt hidden";const i=document.createElement("div");i.className="mobile-prompt__message",t.appendChild(i);const s=document.createElement("div");s.className="mobile-prompt__hint",t.appendChild(s);const n=document.createElement("div");return n.className="mobile-prompt__actions",t.appendChild(n),e.appendChild(t),{container:t,message:i,hint:s,actions:n,primaryButton:null}}setupButtonListeners(){const e=this.drawButton,t=this.sortButton,i=document.getElementById("swap-blank-btn"),s=this.jokerButton;e&&e.addEventListener("click",()=>this.onDrawClicked()),t&&t.addEventListener("click",()=>this.onSortClicked()),i&&i.addEventListener("click",()=>this.handleBlankSwap()),s&&s.addEventListener("click",()=>this.handleJokerSwap()),this.mahjongButton&&this.mahjongButton.addEventListener("click",()=>this.declareMahjong())}onDrawClicked(){this.canDrawTile()&&this.gameController.drawTile()}onSortClicked(){if(!this.latestHandSnapshot||!Array.isArray(this.latestHandSnapshot.tiles))return;const e=new Set;this.handRenderer.tiles.forEach((s,n)=>{if(s&&s.classList.contains("tile--newly-drawn")){const r=this.latestHandSnapshot.tiles[n];r&&typeof r.index=="number"&&e.add(r.index)}});const t=typeof this.latestHandSnapshot.clone=="function"?this.latestHandSnapshot.clone():Y.fromJSON(this.latestHandSnapshot);typeof t.sortBySuit=="function"?t.sortBySuit():t.tiles.sort((s,n)=>s.suit!==n.suit?s.suit-n.suit:s.number-n.number),this.latestHandSnapshot=t;const i=[];t.tiles.forEach((s,n)=>{s&&e.has(s.index)&&i.push(n)}),i.length>0?this.handRenderer.renderWithGlow(t,i):this.handRenderer.render(t),this.animationController.animateHandSort(this.handRenderer.container)}canDrawTile(){var t,i;const e=((t=this.gameController)==null?void 0:t.state)??((i=this.gameController)==null?void 0:i.gameState);return this.gameController.currentPlayer===A&&(e===b.LOOP_PICK_FROM_WALL||e==="LOOP_PICK_FROM_WALL")}canSwapJoker(){var s;const e=(s=this.gameController.players)==null?void 0:s[A];if(!e)return!1;let t=!1;for(let n=0;n<4;n++){const r=this.gameController.players[n];for(const o of r.hand.exposures)if(o.tiles.some(a=>a.suit===m.JOKER)){t=!0;break}if(t)break}return t?e.hand.tiles.some(n=>n.suit!==m.JOKER):!1}canDeclareMahjong(){var n;const e=(n=this.gameController.players)==null?void 0:n[A];if(!e||e.hand.getLength()!==14||!this.gameController.cardValidator)return!1;const t=e.hand.tiles,i=e.hand.exposures.length===0,s=this.gameController.cardValidator.validateHand(t,i);return s&&s.valid}declareMahjong(){if(!this.canDeclareMahjong()){this.showAlert("Invalid Hand","You don't have a valid mahjong hand.");return}this.gameController.gameResult.mahjong=!0,this.gameController.gameResult.winner=A,this.gameController.endGame("mahjong")}updateJokerSwapButton(){const e=this.jokerButton;if(!e)return;const t=this.canSwapJoker(),s=![b.INIT,b.DEAL,b.CHARLESTON1,b.CHARLESTON2,b.CHARLESTON_QUERY,b.COURTESY_QUERY,b.COURTESY].includes(this.gameController.state);e.style.display=t&&s?"flex":"none"}updateBlankSwapButton(){var o,a,c,h;const e=document.getElementById("swap-blank-btn");if(!e)return;const t=(o=this.gameController.players)==null?void 0:o[A],i=((c=(a=t==null?void 0:t.hand)==null?void 0:a.tiles)==null?void 0:c.some(u=>u.isBlank()))??!1,s=this.gameController.discards.length>0,n=this.gameController.state===b.LOOP_CHOOSE_DISCARD,r=((h=this.gameController.settings)==null?void 0:h.useBlankTiles)??!1;e.style.display=i&&s&&n&&r?"flex":"none"}updateMahjongButton(){const e=this.mahjongButton;if(!e)return;const t=this.canDeclareMahjong(),s=![b.INIT,b.DEAL,b.CHARLESTON1,b.CHARLESTON2,b.CHARLESTON_QUERY,b.COURTESY_QUERY,b.COURTESY].includes(this.gameController.state),n=this.gameController.currentPlayer===A;e.style.display=t&&s&&n?"flex":"none"}async handleJokerSwap(){try{const e=await this.gameController.onExchangeJoker()}catch(e){this.updateStatus(`Joker swap failed: ${e.message}`),console.error("Joker swap error:",e)}}_restorePromptState(e,t=!1){this.pendingPrompt=e,e&&(this.selectionManager.setSelectionBehavior({mode:e.max===1?"single":"multiple",maxSelectable:e.max,allowToggle:!0,validationMode:"play"}),t&&this.selectionManager.clearSelection(!0))}async handleBlankSwap(){if(this.gameController.players[A].hand.tiles.filter(s=>s.isBlank()).length===0){this.showAlert("No Blank Tiles","You don't have any blank tiles to swap.");return}if(this.gameController.discards.length===0){this.showAlert("No Discards","The discard pile is empty.");return}const i=this.pendingPrompt;try{const s=await new Promise(o=>{this.startTileSelectionPrompt({title:"Select a blank tile to swap",hint:"Choose which blank to exchange",min:1,max:1,validationMode:"blank-only",confirmLabel:"Select Blank",cancelLabel:"Cancel",callback:a=>{o(a&&a.length>0?a[0]:null)}})});if(!s){this._restorePromptState(i),this.updateStatus("Blank swap cancelled");return}const n=await this.showDiscardSelection();if(!n){this._restorePromptState(i),this.updateStatus("Blank swap cancelled");return}this.gameController.exchangeBlankWithDiscard(s,n)&&(this.showAlert("Swap Successful",`Blank exchanged for ${n.getText()}`),this._restorePromptState(i,!0))}catch(s){this._restorePromptState(i),this.showAlert("Swap Failed",s.message),console.error("Blank swap error:",s)}}showDiscardSelection(){return new Promise(e=>{const t=this.gameController.discards.filter(i=>!i.isJoker());if(t.length===0){this.showAlert("No Valid Discards","No tiles available to swap (jokers cannot be swapped)."),e(null);return}new Xe(t,i=>e(i),()=>e(null))})}showAlert(e,t){this.showChoicePrompt({title:e,hint:t,options:[{label:"OK",value:!0,primary:!0}],onSelect:()=>{}})}onGameStarted(){var e;(e=this.handRenderer)!=null&&e.container&&(this.handRenderer.container.style.visibility="hidden"),this.homePageTiles&&(this.homePageAnimationPromise=this.homePageTiles.animateStart().catch(t=>{console.error("HomePageTiles animation error:",t)})),this.discardPile.clear(),this.resetHandSelection(),this.updateStatus("Game started - dealing tiles..."),this.refreshOpponentBars(),this.updateActionButton({label:"Start",onClick:()=>this.startGame(),disabled:!0,visible:!0})}onGameEnded(e){var n;const t=(e==null?void 0:e.reason)??"end";let i="",s="";if(t==="mahjong"){const r=(n=this.gameController.players)==null?void 0:n[e.winner];i="Mahjong!",s=r?`${r.name} wins!`:"Mahjong!",this.updateStatus(s)}else t==="wall_game"?(i="Wall Game",s="No tiles remaining. No winner.",this.updateStatus("Wall game - no winner")):(i="Game Ended",s="The game has ended.",this.updateStatus("Game ended"));i&&new je(i,s,()=>{}),this.hidePrompt(),this.resetHandSelection(),this.updateActionButton({label:"Start",onClick:()=>this.startGame(),disabled:!1,visible:!0})}onStateChanged(e){if(!e)return;const t=this.drawButton,i=this.sortButton;if(t){const s=this.canDrawTile();t.style.display=s?"flex":"none",t.disabled=!s}if(i){const s=e.newState>=b.LOOP_PICK_FROM_WALL&&e.newState<=b.LOOP_EXPOSE_TILES_COMPLETE;i.style.display=s?"flex":"none"}this.updateJokerSwapButton(),this.updateBlankSwapButton(),this.updateMahjongButton(),this.updateActionButtonStateForGame(e.newState)}async onTilesDealt(e={}){var t;this.isDealingAnimationRunning=!0,this.justCompletedDealingAnimation=!0,this.homePageAnimationPromise&&(await this.homePageAnimationPromise,this.homePageAnimationPromise=null),(t=this.handRenderer)!=null&&t.container&&(this.handRenderer.container.style.visibility="visible");try{await this.dealingSequencer.animateDeal(e.sequence)}finally{this.isDealingAnimationRunning=!1;const i=this.gameController.players[0];i&&i.hand&&(this.latestHandSnapshot=i.hand.clone()),this.opponentBars.forEach(({playerIndex:s,bar:n})=>{if(s!==A){const r=this.gameController.players[s];r&&n&&n.update(r)}})}}onTurnChanged(e){const t=(e==null?void 0:e.currentPlayer)??this.gameController.currentPlayer;if(this.gameController.players.forEach((i,s)=>{i.isCurrentTurn=s===t}),this.refreshOpponentBars(),t===A)this.updateStatus("Your turn"),this.animationController.animateTurnStart(this.handRenderer.container);else{const i=this.opponentBars.find(s=>s.playerIndex===t);i&&i.bar.container&&this.animationController.animateTurnStart(i.bar.container)}this.updateActionButtonStateForGame(this.gameController.state)}async onTileDiscarded(e){if(e!=null&&e.tile){try{await this.discardSequencer.animateDiscard(e)}catch(t){console.error("Discard animation failed:",t);try{this.discardPile.addTile(e.tile)}catch(i){console.error("Failed to apply fallback discard update:",i)}}this.updateBlankSwapButton()}}onCharlestonPass(e){if(e.fromPlayer===A){if(!e||!this.charlestonSequencer){console.warn("MobileRenderer: Missing required data for Charleston pass animation");return}try{const t=Array.from(this.selectionManager.getSelectedTileIndices(this.latestHandSnapshot));this.charlestonSequencer.animateCharlestonPass(e,t)}catch(t){console.error("Charleston pass animation failed:",t),this.selectionManager.clearSelection()}}}onTilesReceived(e){var t;e.player===A&&((t=e.animation)==null||t.type)}_findReceivedTileIndices(e){if(!this.handRenderer.currentHandData)return[];const t=this.handRenderer.currentHandData.tiles,i=[],s=new Set(e.map(n=>n.index).filter(n=>typeof n=="number"&&!isNaN(n)));for(let n=0;n<t.length;n++){const r=t[n];(r==null?void 0:r.index)!==void 0&&s.has(r.index)&&i.push(n)}return i}async onTileClaimed(e){if((e==null?void 0:e.claimingPlayer)!==A){this.discardPile.removeLatestDiscard();return}if(!this.handRenderer||!this.animationController||!(e!=null&&e.tile)){console.warn("MobileRenderer: Missing required components for claim animation"),this.discardPile.removeLatestDiscard();return}let t=!1,i=null;try{const s=this.discardPile.getLatestDiscardElement();if(!s){console.warn("MobileRenderer: No discard element found for claim animation"),this.discardPile.removeLatestDiscard(),t=!0;return}const n=k(s);if(i=await this._createFloatingTile(e.tile,n),!i){this.discardPile.removeLatestDiscard(),t=!0;return}this.discardPile.removeLatestDiscard(),t=!0;const r=this.handRenderer.container,o=r?k(r):null;if(!o){i.remove(),i=null;return}await this.animationController.animateTileClaim(i,e.claimingPlayer,o,r),i.remove(),i=null}catch(s){console.error("MobileRenderer: Error during claim animation:",s),i&&i.parentNode&&i.remove(),t||this.discardPile.removeLatestDiscard()}}onTilesExposed(e){if(this.refreshOpponentBars(),this.updateJokerSwapButton(),this.updateBlankSwapButton(),this.updateMahjongButton(),(e==null?void 0:e.player)===A&&(e!=null&&e.tiles)&&this.playerRack&&this.animationController){const t=e.tiles.map(i=>i.index).filter(i=>typeof i=="number");setTimeout(()=>{this.playerRack.container.querySelectorAll(".exposure-tile").forEach(s=>{const n=parseInt(s.dataset.tileIndex);t.includes(n)&&this.animationController.applyReceivedTileGlow(s)})},100)}}onJokerSwapped(e){const{player:t,replacementTile:i}=e,s=this.getPlayerName(t),n=i instanceof I?i:i?I.fromJSON(i):null;n&&this.updateStatus(`${s} swapped a joker for ${n.getText()}`)}async onBlankExchanged(e){var a;const{player:t,blankTile:i,retrievedTile:s}=e;if(t!==A)return;const n=I.fromJSON(i),r=I.fromJSON(s);try{const c=(a=this.playerRack)==null?void 0:a.container,h=c==null?void 0:c.querySelectorAll(".tile");let u=null;if(h){for(const l of h)if(parseInt(l.dataset.tileIndex)===n.index){u=l;break}}const g=document.getElementById("discard-pile"),S=g==null?void 0:g.querySelectorAll(".tile");let E=null;if(S){for(const l of S)if(parseInt(l.dataset.tileIndex)===r.index){E=l;break}}let T=null,w=null;if(u){const l=k(u);T=await this._createFloatingTile(n,l)}if(E){const l=k(E);w=await this._createFloatingTile(r,l)}if(u&&(u.style.opacity="0"),E&&(E.style.opacity="0"),(T||w)&&(await this.animationController.animateTileSwap(T,w,c?k(c):null),T&&T.parentNode&&T.remove(),w&&w.parentNode&&w.remove()),this.discardPile.discards&&this.discardPile.discards.length>0){const l=this.discardPile.discards[this.discardPile.discards.length-1];this.discardPile.rerender(l)}setTimeout(()=>{const l=(c==null?void 0:c.querySelectorAll(".tile"))||[];for(const f of l)if(parseInt(f.dataset.tileIndex)===r.index){this.animationController.applyReceivedTileGlow(f);break}},100)}catch(c){if(console.error("Error animating blank swap:",c),this.discardPile.discards&&this.discardPile.discards.length>0){const h=this.discardPile.discards[this.discardPile.discards.length-1];this.discardPile.rerender(h)}}const o=this.getPlayerName(t);this.updateStatus(`${o} exchanged ${n.getText()} for ${r.getText()}`)}getPlayerName(e){var i;const t=(i=this.gameController.players)==null?void 0:i[e];return(t==null?void 0:t.name)||`Player ${e+1}`}async _createFloatingTile(e,t){try{const{MobileTile:i}=await he(async()=>{const{MobileTile:r}=await Promise.resolve().then(()=>Re);return{MobileTile:r}},void 0),n=i.createHandTile(e,"normal").createElement();return n.style.position="fixed",n.style.left=`${t.x}px`,n.style.top=`${t.y}px`,n.style.transform="translate(-50%, -50%)",n.style.zIndex="9999",n.style.pointerEvents="none",n.classList.add("floating-claim-tile"),document.body.appendChild(n),n}catch(i){return console.error("MobileRenderer: Error creating floating tile:",i),null}}onMessage(e){e!=null&&e.text&&this.updateStatus(e.text)}refreshOpponentBars(){this.opponentBars.forEach(({playerIndex:e,bar:t})=>{const i=this.gameController.players[e];i&&t.update(i)})}updateStatus(e){this.statusElement&&(this.statusElement.textContent=e)}handleUIPrompt(e){var t,i,s,n,r,o,a,c,h,u,g,S,E,T,w;if(e)try{switch(this.pendingPrompt&&(console.warn("MobileRenderer: New prompt received while previous prompt pending. Clearing previous prompt state."),this.resetHandSelection(),this.hidePrompt(),this.pendingPrompt=null),e.promptType){case"CHOOSE_DISCARD":this.startDiscardSelection(e.callback);break;case"CHARLESTON_PASS":this.startTileSelectionPrompt({title:`Charleston Pass (${((t=e.options)==null?void 0:t.direction)??"?"})`,hint:`Select ${((i=e.options)==null?void 0:i.requiredCount)??3} tiles to pass`,min:((s=e.options)==null?void 0:s.requiredCount)??3,max:((n=e.options)==null?void 0:n.requiredCount)??3,validationMode:"charleston",confirmLabel:"Pass Tiles",cancelLabel:null,fallback:null,callback:l=>e.callback(l),useActionButton:!0});break;case"SELECT_TILES":{const l=((r=e.options)==null?void 0:r.minTiles)??1,f=((o=e.options)==null?void 0:o.maxTiles)??3,_=l===f?`Select exactly ${l} tile${l!==1?"s":""}`:`Select ${l}–${f} tiles`;this.startTileSelectionPrompt({title:((a=e.options)==null?void 0:a.question)??"Select tiles",hint:_,min:l,max:f,validationMode:"courtesy",confirmLabel:"Confirm",cancelLabel:"Cancel",fallback:()=>this.getFallbackTiles(Math.max(1,l)),callback:q=>e.callback(q)});break}case"CLAIM_DISCARD":{const l=(c=e.options)==null?void 0:c.tile,f=l instanceof I?l:l?I.fromJSON(l):null;this.showChoicePrompt({title:f?`Claim ${f.getText()}?`:"Claim discard?",hint:"Choose how to react",options:(((h=e.options)==null?void 0:h.options)||[]).map(_=>({label:_,value:_})),onSelect:_=>e.callback(_)});break}case"EXPOSE_TILES":this.showChoicePrompt({title:"Expose selected tiles?",hint:"Exposed tiles become visible to everyone",options:[{label:"Expose",value:!0,primary:!0},{label:"Keep Hidden",value:!1}],onSelect:l=>e.callback(l)});break;case"YES_NO":this.showChoicePrompt({title:((u=e.options)==null?void 0:u.message)??"Continue?",hint:"",options:[{label:"Yes",value:!0,primary:!0},{label:"No",value:!1}],onSelect:l=>e.callback(l)});break;case"CHARLESTON_CONTINUE":this.showChoicePrompt({title:((g=e.options)==null?void 0:g.question)??"Continue to Charleston phase 2?",hint:"",options:[{label:"Yes",value:"Yes",primary:!0},{label:"No",value:"No"}],onSelect:l=>e.callback(l)});break;case"COURTESY_VOTE":this.showChoicePrompt({title:((S=e.options)==null?void 0:S.question)??"Courtesy pass vote",hint:"How many tiles to exchange?",options:(((E=e.options)==null?void 0:E.options)||["0","1","2","3"]).map(l=>({label:l,value:l})),onSelect:l=>e.callback(l)});break;case"JOKER_EXCHANGE_CHOICE":this.showChoicePrompt({title:((T=e.options)==null?void 0:T.question)??"Choose joker to exchange",hint:"Select which tile to trade for a joker",options:(((w=e.options)==null?void 0:w.options)||[]).map(l=>({label:l.label,value:l.value})),onSelect:l=>e.callback(l)});break;default:console.warn(`Unhandled UI prompt: ${e.promptType}`),e.callback(null)}}catch(l){if(U(`[MobileRenderer] Error in UI prompt handler: ${l.message}`),e.callback)try{e.callback(null)}catch(f){console.error("Failed to recover from UI prompt error via callback:",f)}}}startTileSelectionPrompt(e){this.updateStatus(e.title),this.pendingPrompt={type:"tile-selection",min:e.min,max:e.max,callback:e.callback,fallback:e.fallback,confirmUsesActionButton:!!e.useActionButton,baseLabel:e.confirmLabel??"Confirm"},this.selectionManager.setSelectionBehavior({mode:e.max===1?"single":"multiple",maxSelectable:e.max,allowToggle:!0,validationMode:e.validationMode}),this.selectionManager.clearSelection(!0),this.handRenderer.applySelectionIndices([]);const t=e.useActionButton?[]:[{label:e.confirmLabel??"Confirm",primary:!0,disabled:!0,onClick:()=>this.resolveTileSelectionPrompt()}];e.cancelLabel&&t.push({label:e.cancelLabel,onClick:()=>this.cancelTileSelectionPrompt()}),e.useActionButton?(this.updateActionButton({label:e.confirmLabel??"Confirm",onClick:()=>this.confirmPendingSelection(),disabled:!0,visible:!0}),this.hidePrompt()):this.showPrompt(e.title,e.hint,t),this.updateTileSelectionHint()}startDiscardSelection(e){this.pendingPrompt={type:"tile-selection",min:1,max:1,callback:t=>{const i=Array.isArray(t)&&t.length>0?t[0]:null;e(i)},fallback:null,confirmUsesActionButton:!0,baseLabel:"Discard"},this.selectionManager.setSelectionBehavior({mode:"single",maxSelectable:1,allowToggle:!0,validationMode:"play"}),this.selectionManager.clearSelection(!0),this.handRenderer.applySelectionIndices([]),this.hidePrompt(),this.updateActionButton({label:"Discard",onClick:()=>this.confirmPendingSelection(),disabled:!0,visible:!0}),this.updateTileSelectionHint()}onHandSelectionChange(e=this.selectionManager.getSelectionState(this.latestHandSnapshot)){!this.pendingPrompt||this.pendingPrompt.type!=="tile-selection"||this.updateTileSelectionHint(e)}updateTileSelectionHint(e=this.selectionManager.getSelectionState(this.latestHandSnapshot)){if(!this.pendingPrompt||this.pendingPrompt.type!=="tile-selection")return;const{min:t,max:i}=this.pendingPrompt,s=e.count,n=s>=t&&s<=i;if(this.setPromptHint(`Selected ${s}/${i}${t===i?"":` (need at least ${t})`}`),this.setPrimaryEnabled(n),this.actionButton&&this.pendingPrompt.confirmUsesActionButton){this.actionButton.disabled=!n;const r=this.pendingPrompt.baseLabel||"Confirm";this.actionButton.textContent=`${r} (${s}/${i})`}}resolveTileSelectionPrompt(){if(!this.pendingPrompt||this.pendingPrompt.type!=="tile-selection")return;const e=this.selectionManager.getSelectionState(this.latestHandSnapshot),{min:t,max:i}=this.pendingPrompt;if(e.count<t||e.count>i)return;const s=this.pendingPrompt.callback;this.resetHandSelection(),this.hidePrompt(),this.pendingPrompt=null,s(e.tiles)}cancelTileSelectionPrompt(){if(!this.pendingPrompt||this.pendingPrompt.type!=="tile-selection")return;const e=this.pendingPrompt.fallback,t=typeof e=="function"?e():[],i=this.pendingPrompt.callback;this.resetHandSelection(),this.hidePrompt(),this.pendingPrompt=null,i(t)}resetHandSelection(){this.selectionManager.clearSelection(!0),this.handRenderer.applySelectionIndices([]),this.selectionManager.setSelectionBehavior({mode:"single",maxSelectable:1,allowToggle:!0,validationMode:void 0})}showChoicePrompt({title:e,hint:t,options:i,onSelect:s}){this.updateStatus(e);const n=(i||[]).map(r=>({label:r.label,primary:r.primary,onClick:()=>{this.hidePrompt(),s(r.value)}}));this.showPrompt(e,t,n)}showPrompt(e,t,i){this.promptUI.message.textContent=e,this.setPromptHint(t),this.promptUI.actions.innerHTML="",this.promptUI.primaryButton=null,i.forEach(s=>{const n=document.createElement("button");n.textContent=s.label,s.primary&&(n.classList.add("primary"),this.promptUI.primaryButton=n),s.disabled&&(n.disabled=!0),n.addEventListener("click",s.onClick),this.promptUI.actions.appendChild(n)}),this.promptUI.container.classList.remove("hidden")}hidePrompt(){this.promptUI.container.classList.add("hidden"),this.promptUI.primaryButton=null}setPromptHint(e){this.promptUI.hint&&(this.promptUI.hint.textContent=e??"")}setPrimaryEnabled(e){this.promptUI.primaryButton&&(this.promptUI.primaryButton.disabled=!e)}getFallbackTiles(e=1){return!this.latestHandSnapshot||!Array.isArray(this.latestHandSnapshot.tiles)?[]:this.latestHandSnapshot.tiles.slice(0,e).map(t=>t instanceof I?t.clone():I.fromJSON(t)).filter(Boolean)}updateActionButton({label:e,onClick:t,disabled:i=!1,visible:s=!0,glowPlayerTurn:n=!1}={}){this.actionButton&&(e&&(this.actionButton.textContent=e),this.actionButton.onclick=t||null,this.actionButton.disabled=!!i,this.actionButton.style.display=s?"flex":"none",n?this.actionButton.classList.add("player-turn"):this.actionButton.classList.remove("player-turn"))}updateActionButtonStateForGame(e){var n;if(!this.actionButton)return;const t=this.gameController.currentPlayer===A;if(e===b.LOOP_CHOOSE_DISCARD&&t&&((n=this.pendingPrompt)==null?void 0:n.type)==="tile-selection"){this.pendingPrompt.confirmUsesActionButton=!0;const r=this.selectionManager.getSelectionState(this.latestHandSnapshot),o=r.count>=(this.pendingPrompt.min||1)&&r.count<=(this.pendingPrompt.max||1);this.updateActionButton({label:"Discard",onClick:()=>this.confirmPendingSelection(),disabled:!o,visible:!0,glowPlayerTurn:!0});return}const s=e===b.INIT||e===b.START||e===b.DEAL;this.updateActionButton({label:"Start",onClick:()=>this.startGame(),disabled:!1,visible:s,glowPlayerTurn:!1})}confirmPendingSelection(){var e;((e=this.pendingPrompt)==null?void 0:e.type)==="tile-selection"&&this.resolveTileSelectionPrompt()}startGame(){typeof this.gameController.startGame=="function"&&this.gameController.startGame()}handleAssetError(e,t){console.error(`Failed to load ${e}: ${t}`),e==="tiles.png"&&this.enableTextModeFallback()}enableTextModeFallback(){this.handRenderer&&(this.handRenderer.setTextMode(!0),console.log("Text mode activated - tiles will display as colored text"))}}const M={IDLE:"idle",TOUCHING:"touching",MOVED:"moved"};class Qe{constructor(e,t={}){this.rootElement=e,this.options={tapMaxDuration:300,tapMaxMovement:10,doubleTapWindow:500,doubleTapDistance:20,longPressDuration:500,swipeMinDistance:50,enableDoubleTap:!1,enableLongPress:!1,enableSwipe:!1,...t},this.listeners={tap:[],doubletap:[],longpress:[],swipeup:[]},this.state=this.createInitialState(),this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchMove=this.handleTouchMove.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleTouchCancel=this.handleTouchCancel.bind(this)}createInitialState(){return{current:M.IDLE,startTime:null,startX:null,startY:null,currentX:null,currentY:null,element:null,lastTapTime:null,lastTapX:null,lastTapY:null,longPressTimer:null}}init(){this.rootElement.addEventListener("touchstart",this.handleTouchStart,{passive:!1}),this.rootElement.addEventListener("touchmove",this.handleTouchMove,{passive:!1}),this.rootElement.addEventListener("touchend",this.handleTouchEnd,{passive:!1}),this.rootElement.addEventListener("touchcancel",this.handleTouchCancel,{passive:!1})}on(e,t){if(!this.listeners[e])throw new Error(`Unknown gesture type: ${e}`);this.listeners[e].push(t)}off(e,t){this.listeners[e]&&(this.listeners[e]=this.listeners[e].filter(i=>i!==t))}emit(e,t){t.element&&!document.body.contains(t.element)||this.listeners[e]&&this.listeners[e].forEach(i=>i(t))}destroy(){this.rootElement.removeEventListener("touchstart",this.handleTouchStart),this.rootElement.removeEventListener("touchmove",this.handleTouchMove),this.rootElement.removeEventListener("touchend",this.handleTouchEnd),this.rootElement.removeEventListener("touchcancel",this.handleTouchCancel),clearTimeout(this.state.longPressTimer)}getElementAtPoint(e,t){return document.elementFromPoint(e,t)}resetState(){clearTimeout(this.state.longPressTimer),this.state=this.createInitialState()}handleTouchStart(e){if(e.touches.length>1){this.resetState();return}const t=e.touches[0];this.state.current=M.TOUCHING,this.state.startTime=Date.now(),this.state.startX=t.clientX,this.state.startY=t.clientY,this.state.currentX=t.clientX,this.state.currentY=t.clientY,this.state.element=this.getElementAtPoint(t.clientX,t.clientY),this.options.enableLongPress&&(this.state.longPressTimer=setTimeout(()=>{this.state.current===M.TOUCHING&&Math.sqrt(Math.pow(this.state.currentX-this.state.startX,2)+Math.pow(this.state.currentY-this.state.startY,2))<this.options.tapMaxMovement&&(this.emit("longpress",{type:"longpress",element:this.state.element,coordinates:{x:this.state.startX,y:this.state.startY},timestamp:Date.now()}),this.resetState())},this.options.longPressDuration))}handleTouchMove(e){if(this.state.current===M.IDLE)return;const t=e.touches[0];this.state.currentX=t.clientX,this.state.currentY=t.clientY;const i=this.state.currentX-this.state.startX,s=this.state.currentY-this.state.startY;Math.sqrt(i*i+s*s)>this.options.tapMaxMovement&&(this.state.current=M.MOVED,clearTimeout(this.state.longPressTimer))}handleTouchEnd(e){if(this.state.current===M.IDLE)return;const t=e.changedTouches[0],i=Date.now()-this.state.startTime,s=Math.abs(t.clientX-this.state.startX),n=Math.abs(t.clientY-this.state.startY),r=Math.sqrt(s*s+n*n);if(clearTimeout(this.state.longPressTimer),this.state.current===M.TOUCHING&&i<this.options.tapMaxDuration&&r<this.options.tapMaxMovement)this.state.element&&this.state.element.closest(".tile")&&this.handleTileTap(this.state.element.closest(".tile")),this.emit("tap",{type:"tap",element:this.state.element,coordinates:{x:t.clientX,y:t.clientY},timestamp:Date.now(),target:e.target}),this.options.enableDoubleTap?this.checkDoubleTap(t.clientX,t.clientY):this.resetState();else if(n>this.options.swipeMinDistance&&n>s){const o=t.clientY<this.state.startY?"up":"down";o==="up"&&this.state.element&&this.state.element.closest(".tile")&&this.handleTileDrag(this.state.element.closest(".tile"),n),this.emit(`swipe${o}`,{type:`swipe${o}`,element:this.state.element,distance:n,timestamp:Date.now()}),this.resetState()}else if(s>this.options.swipeMinDistance&&s>n){const o=t.clientX<this.state.startX?"left":"right";this.emit(`swipe${o}`,{type:`swipe${o}`,element:this.state.element,distance:s,timestamp:Date.now()}),this.resetState()}else this.resetState();document.querySelectorAll(".tile--selected").forEach(o=>{o.classList.remove("tile--selected")})}handleTileTap(e){const t=e.dataset.tileId;this.emit("tile-touched",{tileId:t,element:e})}handleTileDrag(e,t){this.emit("tile-swiped",{tileId:e.dataset.tileId,direction:"up",element:e})}handleTouchCancel(e){this.resetState()}checkDoubleTap(e,t){const i=Date.now(),s=this.state.lastTapTime,n=this.state.lastTapX,r=this.state.lastTapY,o=this.state.element;if(this.resetState(),s!==null){const a=i-s,c=Math.abs(e-n),h=Math.abs(t-r),u=Math.sqrt(c*c+h*h);if(a<this.options.doubleTapWindow&&u<this.options.doubleTapDistance){this.emit("doubletap",{type:"doubletap",element:o,coordinates:{x:e,y:t},timestamp:i});return}}this.state.lastTapTime=i,this.state.lastTapX=e,this.state.lastTapY=t}}let y,P,x,N;function Ze(){ge.incrementGamesPlayed()}function et(){const d=document.createElement("div");return d.className="bottom-menu",document.body.appendChild(d),d}document.addEventListener("DOMContentLoaded",()=>{const d=document.getElementById("loading");if(d&&(d.style.display="none"),!document.getElementById("mobile-settings-btn")){const e=document.querySelector(".bottom-menu")||et(),t=document.createElement("button");t.id="mobile-settings-btn",t.className="menu-btn",t.innerHTML="⚙️ SETTINGS",e.appendChild(t)}tt().catch(e=>{console.error("Failed to initialize mobile game:",e);const t=document.getElementById("game-status");t&&(t.textContent=`ERROR: ${e.message}`,t.style.color="#ff6b6b")}),it()});async function tt(){console.log("Initializing mobile game...");const d=document.getElementById("hand-container"),e=document.getElementById("player-rack-container"),t=document.getElementById("discard-container"),i=document.getElementById("game-status"),s=document.getElementById("opponent-left"),n=document.getElementById("opponent-top"),r=document.getElementById("opponent-right"),o=v.load();console.log("Loaded settings:",o);const a=new ue(o.cardYear);await a.init(),P=new me(a,null,o.difficulty);const h=new URLSearchParams(window.location.search).get("skipCharleston"),u=h!==null?h==="true":o.skipCharleston;y=new pe,await y.init({aiEngine:P,cardValidator:a,settings:{year:o.cardYear,difficulty:o.difficulty,skipCharleston:u,trainingMode:o.trainingMode,trainingHand:o.trainingHand,trainingTileCount:o.trainingTileCount,useBlankTiles:o.useBlankTiles}}),x=new Je({gameController:y,handContainer:d,discardContainer:t,statusElement:i,opponentContainers:{left:s,top:n,right:r},playerRackContainer:e,promptRoot:document.body});const g=new Qe(document.body,{enableSwipe:!0,swipeMinDistance:30});g.init(),g.on("swipeup",l=>{if(l.element&&l.element.classList.contains("tile")){const f=parseInt(l.element.dataset.index,10);!isNaN(f)&&x.handRenderer&&x.handRenderer.handleTileClick(f)}});const S=document.getElementById("wall-counter");S&&(new ye(S,y),console.log("WallCounter initialized"));const E=document.getElementById("hints-panel");E&&new be(E,y,P),y.on("GAME_ENDED",()=>Ze()),y.on("GAME_STARTED",()=>{const l=document.getElementById("hints-panel"),f=document.getElementById("player-rack-container");l&&l.classList.remove("hide-on-home"),f&&f.classList.remove("hide-on-home")});const T=document.getElementById("new-game-btn");T&&(T.onclick=async()=>{console.log("Start button clicked!");try{console.log("Starting game...",y),x==null||x.updateStatus("Starting game...");const l=v.load();y.settings={...y.settings,skipCharleston:l.skipCharleston,trainingMode:l.trainingMode,trainingHand:l.trainingHand,trainingTileCount:l.trainingTileCount},await y.startGame(),console.log("Game started successfully")}catch(l){console.error("Error starting game:",l),x==null||x.updateStatus(`Error: ${l.message}`)}});const w=document.getElementById("mobile-settings-btn");w&&!N&&(N=new fe,w.onclick=()=>{N.open()},N.populateHandSelector(a)),window.addEventListener("settingsChanged",async l=>{console.log("Settings changed:",l.detail),x==null||x.updateStatus("Settings saved!"),l.detail.difficulty&&P&&(P.difficulty=l.detail.difficulty,console.log("AI difficulty updated to:",l.detail.difficulty)),l.detail.cardYear&&l.detail.cardYear!==a.year&&(console.log("Card year changed from",a.year,"to",l.detail.cardYear),a.year=l.detail.cardYear,await a.init(),N&&N.populateHandSelector(a),P&&(P.cardValidator=a),y&&(y.cardValidator=a)),y&&y.settings&&(y.settings.year=l.detail.cardYear,y.settings.difficulty=l.detail.difficulty,y.settings.skipCharleston=l.detail.skipCharleston,y.settings.trainingMode=l.detail.trainingMode,y.settings.trainingHand=l.detail.trainingHand,y.settings.trainingTileCount=l.detail.trainingTileCount,y.settings.useBlankTiles=l.detail.useBlankTiles,console.log("GameController settings updated:",y.settings))}),x==null||x.updateStatus("Ready"),window.location.search.includes("playwright=true")&&(window.gameController=y,window.aiEngine=P,window.mobileRenderer=x),console.log("Mobile game initialized successfully")}async function it(){if(!("serviceWorker"in navigator)){console.log("Service workers not supported");return}if(window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"){console.log("Skipping service worker registration in development mode");return}try{const d=await navigator.serviceWorker.register("/mahjong/service-worker.js",{scope:"/mahjong/"});console.log("Service worker registered:",d),d.update(),d.addEventListener("updatefound",()=>{const e=d.installing;console.log("Service worker update found"),e.addEventListener("statechange",()=>{e.state==="installed"&&navigator.serviceWorker.controller&&(console.log("New service worker installed, ready to activate"),st(d))})})}catch(d){console.error("Service worker registration failed:",d)}}function st(d){const e=document.createElement("div");e.id="update-banner",e.innerHTML=`
        <div style="
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #ffd166;
            color: #1f1400;
            padding: 12px;
            text-align: center;
            font-family: var(--font-stack, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif);
            z-index: 10001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        ">
            <strong>Update Available!</strong>
            <button onclick="location.reload()" style="
                margin-left: 16px;
                padding: 6px 16px;
                background: #044328;
                color: white;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                font-family: var(--font-stack, "Segoe UI", "Roboto", "Helvetica Neue", Arial, sans-serif);
            ">Reload to Update</button>
        </div>
    `,document.body.appendChild(e),d.waiting&&d.waiting.postMessage({type:"SKIP_WAITING"})}
